<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spell Creator — Home</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  .modal, .modal-backdrop { display: none; }
  .modal.open, .modal-backdrop.open { display: block; }
</style>
    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="portal.html">← Back Manager Selection</a>
    </div>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <h1>Spell Creator</h1>
    <div class="auth-inline">
      <div id="user-chip" class="user-chip">
        <span class="chip-name" id="chip-name"></span>
        <button id="chip-logout" class="btn linklike">Log Out</button>
      </div>
      <button id="open-login" class="btn btn-secondary small">Log In</button>
      <a id="open-signup" class="btn btn-secondary small" href="signup.html">Sign Up</a>
    </div>
  </div>

  <!-- Main actions -->
  <div class="container">
    <div class="home-card center-stack" id="actions-card">
      <a class="btn btn-full" href="index.html">✨ Create New Spell</a>
      <a class="btn btn-full" href="templates.html">📜 Load From Template</a>
      <a class="btn btn-full" href="export.html">📤 Export Spell</a>
      <a id="btn-browse"   class="btn btn-full" href="browse.html" style="display:none;">📚 Browse Database</a>
      <a id="btn-favs"     class="btn btn-full" href="browse.html?favorites=1" style="display:none;">⭐ My Favorites</a>
      <a id="btn-admin" class="btn btn-secondary btn-full" href="admin.html" style="display:none;">🛠️ Modify Database</a>
      <a id="btn-user_mgmt" class="btn btn-secondary btn-full" href="user_management.html" style="display:none;">👤 User Management</a>
      <a id="btn-import-effects" class="btn btn-secondary btn-full" href="scraper.html" style="display:none;">📥 Import Effects</a>
      <a id="btn-browse-effects" class="btn btn-secondary btn-full" href="browse_effects.html" style="display:none;">🧪 Browse Effects</a>
      <a id="btn-browse-schools" class="btn btn-secondary btn-full" href="browse_schools.html" style="display:none;">🏫 Browse Schools</a>

    </div>
  </div>

  <!-- Modal + Backdrop live at body level (not inside topbar) -->
  <div id="login-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title" aria-hidden="true">
    <div class="modal-card">
      <header>
        <div class="modal-title" id="login-title">Log In</div>
        <button class="modal-close" id="close-login" aria-label="Close">✕</button>
      </header>

      <label for="login-username">Username</label>
      <input type="text" id="login-username" placeholder="Enter username" />

      <label for="login-password" style="margin-top:10px;">Password</label>
      <input type="password" id="login-password" placeholder="Enter password" />

      <div id="login-status" style="opacity:.85; margin-top:8px;"></div>

      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancel-login">Cancel</button>
        <button class="btn" id="login-btn">Log In</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
<script>
  const API_BASE = "";

  // --- modal helpers ---
  const modal     = document.getElementById("login-modal");
  const backdrop  = document.getElementById("login-backdrop");
  const statusEl  = document.getElementById("login-status");

  function openLogin() {
    modal.classList.add("open");
    backdrop.classList.add("open");
    const u = document.getElementById("login-username");
    if (u) u.focus();
  }
  function closeLogin() {
    modal.classList.remove("open");
    backdrop.classList.remove("open");
    if (statusEl) statusEl.textContent = "";
  }

  // --- header UI state ---
  function setLoggedInUI(username, role) {
    const chip       = document.getElementById("user-chip");
    const chipName   = document.getElementById("chip-name");
    const loginBtn   = document.getElementById("open-login");
    const signupEl   = document.getElementById("open-signup");
    const adminBtn   = document.getElementById("btn-admin");
    const userMgmt   = document.getElementById("btn-user_mgmt");
    const browseBtn  = document.getElementById("btn-browse");
    const favsBtn    = document.getElementById("btn-favs");

    chipName.textContent = `${username} (${role})`;
    chip.style.display = "flex";
    loginBtn.style.display = "none";
    signupEl.style.display = "none";

    const adminOrMod = (role === "admin" || role === "moderator");
    adminBtn.style.display  = adminOrMod ? "inline-block" : "none";
    userMgmt.style.display  = (role === "admin") ? "inline-block" : "none";
    document.getElementById("btn-import-effects").style.display = adminOrMod ? "inline-block" : "none";
    document.getElementById("btn-browse-effects").style.display = adminOrMod ? "inline-block" : "none";
    document.getElementById("btn-browse-schools").style.display = adminOrMod ? "inline-block" : "none";

    browseBtn.style.display = "inline-block";
    favsBtn.style.display   = "inline-block";
  }

  function setLoggedOutUI(msg = "") {
    const chip     = document.getElementById("user-chip");
    const loginBtn = document.getElementById("open-login");
    const signupEl = document.getElementById("open-signup");
    if (statusEl) statusEl.textContent = msg;

    chip.style.display = "none";
    loginBtn.style.display = "inline-block";
    signupEl.style.display = "inline-block";

    document.getElementById("btn-admin").style.display          = "none";
    document.getElementById("btn-user_mgmt").style.display      = "none";
    document.getElementById("btn-browse").style.display         = "none";
    document.getElementById("btn-favs").style.display           = "none";
    document.getElementById("btn-import-effects").style.display = "none";
    document.getElementById("btn-browse-effects").style.display = "none";
    document.getElementById("btn-browse-schools").style.display = "none";

  }

  // --- auth calls ---
  async function login() {
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value;
    statusEl.textContent = "";

    const res = await fetch(`${API_BASE}/auth/login`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (data.status === "success") {
      localStorage.setItem("auth_token", data.token);
      localStorage.setItem("auth_username", data.username);
      localStorage.setItem("auth_role", data.role);
      setLoggedInUI(data.username, data.role);
      closeLogin();
    } else {
      statusEl.textContent = data.message || "Login failed";
    }
  }

  async function logout() {
    const token = localStorage.getItem("auth_token");
    if (token) {
      await fetch(`${API_BASE}/auth/logout`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      });
    }
    localStorage.removeItem("auth_token");
    localStorage.removeItem("auth_username");
    localStorage.removeItem("auth_role");
    setLoggedOutUI();
  }

  async function checkMe() {
    const token = localStorage.getItem("auth_token");
    if (!token) { setLoggedOutUI(); return; }
    const res = await fetch(`${API_BASE}/auth/me`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    if (data.status === "success") setLoggedInUI(data.username, data.role);
    else setLoggedOutUI();
  }

  // --- wire up events once DOM is ready ---
  document.addEventListener("DOMContentLoaded", () => {
    // Force hidden at startup (in case CSS was cached/overridden)
    modal.classList.remove("open");
    backdrop.classList.remove("open");

    document.getElementById("open-login").addEventListener("click", (e) => { e.preventDefault(); openLogin(); });
    document.getElementById("close-login").addEventListener("click", (e) => { e.preventDefault(); closeLogin(); });
    document.getElementById("cancel-login").addEventListener("click", (e) => { e.preventDefault(); closeLogin(); });
    document.getElementById("login-backdrop").addEventListener("click", closeLogin);
    document.getElementById("login-btn").addEventListener("click", (e) => { e.preventDefault(); login(); });
    document.getElementById("chip-logout").addEventListener("click", (e) => { e.preventDefault(); logout(); });

    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLogin(); });

    checkMe();
  });
</script>
</body>
</html>
