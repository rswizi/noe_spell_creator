<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create an Apotheosis</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .scroll-pad { max-height: 56vh; overflow:auto; border:1px solid #222; border-radius:10px; padding:10px; }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:8px 12px; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #444; border-radius:999px; margin-left:6px; font-size:.85rem; }
    .small { font-size:.9rem } .muted { opacity:.8 }
    .row { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Create an Apotheosis</h1>

    <div class="home-card">
      <div class="grid">
        <div>
          <label>Name</label>
          <input id="apo-name" type="text" placeholder="e.g. Ascension of Thorns" />
        </div>
        <div>
          <label>Stage</label>
          <select id="apo-stage">
            <option>Stage I</option>
            <option>Stage II</option>
            <option>Stage III</option>
            <option>Stage IV</option>
            <option>Stage V</option>
          </select>
        </div>
        <div>
          <label>Type</label>
          <select id="apo-type">
            <option>Personal</option>
            <option>Environmental</option>
            <option>Ritual</option>
          </select>
        </div>
        <div>
          <label>Characteristic Value</label>
          <input id="apo-char" type="number" step="1" value="0" />
        </div>
      </div>

      <label style="margin-top:10px;">Description</label>
      <textarea id="apo-desc" rows="4" placeholder="Describe the Apotheosis..."></textarea>
    </div>

    <div class="home-card">
      <h3>Constraints</h3>

      <div class="row">
        <input id="c-filter" type="text" placeholder="Filter by name‚Ä¶" />
        <button id="c-clear" class="btn btn-secondary small">Reset</button>
        <span class="small muted" id="forbid-note" style="margin-left:auto;"></span>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div>
          <div class="small muted" style="margin-bottom:4px;">Available</div>
          <div class="scroll-pad">
            <select id="c-available" size="12" style="width:100%;"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="c-add" class="btn small">Add ‚Üí</button>
          </div>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:4px;">Selected</div>
          <div class="scroll-pad">
            <select id="c-selected" size="12" style="width:100%;"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="c-remove" class="btn btn-secondary small">‚Üê Remove</button>
          </div>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:4px;">Constraint Info</div>
          <div id="c-info" class="scroll-pad small muted">Select a constraint to see details.</div>
        </div>
      </div>
    </div>

    <div class="home-card">
      <h3>Live Summary</h3>
      <div class="grid">
        <div>
          <div class="kv">
            <div><strong>Total Difficulty</strong></div><div id="diff-sum">‚Äî</div>
            <div><strong>Extra Stability Œî</strong></div><div id="stab-pen-sum">‚Äî</div>
            <div><strong>Amplitude Bonus</strong></div><div id="amp-bonus-sum">‚Äî</div>
          </div>
        </div>
        <div>
          <div class="kv">
            <div><strong>Power</strong></div><div id="out-power">‚Äî</div>
            <div><strong>Stability</strong></div><div id="out-stab">‚Äî</div>
            <div><strong>Amplitude</strong></div><div id="out-amp">‚Äî</div>
            <div><strong>Diameter</strong></div><div id="out-dia">‚Äî</div>
          </div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #222;margin:14px 0;">

      <h4>Trading</h4>
      <div class="small muted" style="margin-bottom:6px;">Allocate Power/Stability into Stability/Amplitude.</div>

      <div class="kv">
        <div>Power ‚Üí Stability</div>
        <div>
          <input id="trade-p2s" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-p2s">0</span>
        </div>

        <div>Power ‚Üí Amplitude</div>
        <div>
          <input id="trade-p2a" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-p2a">0</span>
        </div>

        <div>Stability ‚Üí Amplitude</div>
        <div>
          <input id="trade-s2a" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-s2a">0</span>
        </div>
      </div>
    </div>

    <div class="home-card">
      <button id="save" class="btn">üíæ Save</button>
      <a class="btn btn-secondary" href="apotheosis_home.html">‚Üê Back</a>
    </div>
  </div>

<script>
  const API_BASE = "";
  const $ = s => document.querySelector(s);
  
  let CACHE = [];
  let STARS = new Set(JSON.parse(localStorage.getItem("apoth_stars") || "[]"));
  let ME = null; // { username, role } or null
  
  function token() {
    return localStorage.getItem("token") || "";
  }
  function authHeaders() {
    const t = token();
    return t ? { "Authorization": "Bearer " + t } : {};
  }
  
  async function loadMe() {
    if (!token()) { ME = null; return; }
    try {
      const r = await fetch(`/auth/me`, { headers: authHeaders() });
      const j = await r.json();
      ME = j.status === "success" ? { username: j.username, role: j.role } : null;
    } catch { ME = null; }
  }
  
  function starToggle(id){
    if (STARS.has(id)) STARS.delete(id); else STARS.add(id);
    localStorage.setItem("apoth_stars", JSON.stringify(Array.from(STARS)));
    render(CACHE);
  }
  
  function canEdit(a){
    if (!ME) return false;
    return (ME.username === a.creator) || ["moderator","admin"].includes(ME.role);
  }
  function canDelete(a){
    if (!ME) return false;
    return ["moderator","admin"].includes(ME.role);
  }
  
  function row(a){
    const s = a.stats || {};
    const starred = STARS.has(a.id);
  
    const editBtn = canEdit(a)
      ? `<button class="btn" onclick="editApotheosis('${a.id}')">Edit</button>`
      : "";
    const delBtn = canDelete(a)
      ? `<button class="btn btn-danger" onclick="deleteApotheosis('${a.id}')">Delete</button>`
      : "";
    const dupBtn = `<button class="btn" onclick="duplicateApotheosis('${a.id}')">Duplicate</button>`;
  
    return `
      <div class="effect-entry">
        <div style="flex:1;">
          <div style="font-weight:bold">${a.name} <span style="opacity:.7">[${a.id}]</span></div>
          <div class="small" style="opacity:.85">${a.description||""}</div>
          <div class="small" style="margin-top:6px;">
            <span class="pill">${a.stage}</span>
            <span class="pill">Power ${s.power ?? "‚Äî"}</span>
            <span class="pill">Stability ${s.stability ?? "‚Äî"}</span>
            <span class="pill">Amplitude ${s.amplitude ?? "‚Äî"}</span>
          </div>
          <div class="small" style="margin-top:4px;opacity:.7;">Creator: ${a.creator || "‚Äî"}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" onclick="openDetails('${a.id}')">Details</button>
          ${dupBtn}
          ${editBtn}
          ${delBtn}
          <button class="${starred?'btn btn-secondary':'btn'}" onclick="starToggle('${a.id}')">${starred?'Unstar':'Star'}</button>
        </div>
      </div>
    `;
  }
  
  function render(list){
    const fName = $("#f-name").value.trim().toLowerCase();
  
    // Normalize stage filter to match API values ("Stage I"‚Ä¶)
    const fStage = $("#f-stage").value;
    const stageText = fStage ? `Stage ${["I","II","III","IV","V"][parseInt(fStage,10)-1]}` : "";
  
    const onlyStar = $("#f-star").checked;
  
    let out = list.slice();
    if (fName) out = out.filter(a => (a.name||"").toLowerCase().includes(fName));
    if (stageText) out = out.filter(a => String(a.stage) === stageText);
    if (onlyStar) out = out.filter(a => STARS.has(a.id));
    $("#results").innerHTML = out.length ? out.map(row).join("") : `<p>No results.</p>`;
  }
  
  async function load(){
    const res = await fetch(`/apotheoses`);
    const j = await res.json().catch(()=>({}));
    CACHE = j.apotheoses || [];
    render(CACHE);
  }
  
  // ----- Details modal -----
  function openDetails(id){
    const a = CACHE.find(x => String(x.id) === String(id));
    if (!a) return;
    const s = a.stats || {};
    $("#m-title").textContent = `${a.name} [${a.id}]`;
    $("#m-desc").textContent  = a.description || "‚Äî";
    $("#m-stage").textContent = a.stage;
    $("#m-char").textContent  = String(a.characteristic_value ?? "‚Äî");
    $("#m-power").textContent = String(s.power ?? "‚Äî");
    $("#m-stab").textContent  = String(s.stability ?? "‚Äî");
    $("#m-amp").textContent   = String(s.amplitude ?? "‚Äî");
  
    // constraints are stored as ids; show as pills
    const cs = (a.constraints || []).map(cid => `<span class="pill">${cid}</span>`).join("");
    $("#m-constraints").innerHTML = cs || "‚Äî";
  
    $("#modal").classList.remove("hidden");
    $("#modal").setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    $("#modal").classList.add("hidden");
    $("#modal").setAttribute("aria-hidden", "true");
  }
  
  // ----- Actions -----
  function editApotheosis(id){
    // Reuse creator page as an editor if you want; pass ?edit=<id>
    window.location.href = `apotheosis_create.html?edit=${encodeURIComponent(id)}`;
  }
  
  async function duplicateApotheosis(id){
    try{
      const r = await fetch(`/apotheoses/${id}/duplicate`, { method: "POST", headers: { ...authHeaders() }});
      const j = await r.json();
      if (j.status !== "success") throw new Error(j.message || "Duplicate failed");
      await load(); // refresh list
      alert(`Duplicated as ${j.apotheosis.id}`);
    }catch(e){
      alert(e.message || "Duplicate failed.");
    }
  }
  
  async function deleteApotheosis(id){
    if (!confirm(`Delete ${id}? This cannot be undone.`)) return;
    try{
      const r = await fetch(`/apotheoses/${id}`, { method: "DELETE", headers: { ...authHeaders() }});
      const j = await r.json();
      if (j.status !== "success") throw new Error(j.message || "Delete failed");
      // update local cache quickly
      CACHE = CACHE.filter(a => a.id !== id);
      render(CACHE);
    }catch(e){
      alert(e.message || "Delete failed.");
    }
  }
  
  function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
  
  document.addEventListener("DOMContentLoaded", async ()=>{
    await loadMe();
    await load();
    await loadConstraints();
  
    const run = debounce(()=>render(CACHE), 200);
    $("#f-name").addEventListener("input", run);
    $("#f-stage").addEventListener("change", run);
    $("#f-star").addEventListener("change", run);
    $("#f-reset").addEventListener("click", ()=>{
      $("#f-name").value="";
      $("#f-stage").value="";
      $("#f-star").checked=false;
      render(CACHE);
    });
  
    $("#modal-close").addEventListener("click", closeModal);
    $("#modal").addEventListener("click", e=>{ if(e.target.id==="modal") closeModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeModal(); });
  });

const token = () => localStorage.getItem("auth_token") || "";
const authHeaders = () => (token() ? { "Authorization": "Bearer " + token() } : {});

// Load constraints (call this during boot)
async function loadConstraints() {
  const res = await fetch(`/apotheosis/constraints`, { headers: authHeaders() });
  const txt = await res.text();
  const j = (() => { try { return JSON.parse(txt); } catch { return {status:"error", message: txt}; } })();
  if (j.status !== "success") throw new Error(j.message || "Failed to load constraints");

  const list = j.constraints || [];
  const avail = document.querySelector("#c-available");
  avail.innerHTML = list.map(c => `<option value="${c.id}" data-json='${JSON.stringify(c)}'>[${c.id}] ${c.name}</option>`).join("");
}
</script> 
</body>
</html>