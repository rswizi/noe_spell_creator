<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create / Edit Apotheosis</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }
    .listbox{ min-height: 200px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="page-title">Create an Apotheosis</h1>
    <div class="home-card">
      <div class="grid-2">
        <div>
          <label>Name</label>
          <input id="apo-name" type="text" placeholder="Untitled Apotheosis" />
        </div>
        <div>
          <label>Stage</label>
          <select id="apo-stage">
            <option value="Stage I">Stage I</option>
            <option value="Stage II">Stage II</option>
            <option value="Stage III">Stage III</option>
            <option value="Stage IV">Stage IV</option>
            <option value="Stage V">Stage V</option>
          </select>
        </div>
        <div>
          <label>Type</label>
          <select id="apo-type">
            <option value="Personal">Personal</option>
            <option value="Territory">Territory</option>
            <option value="Hybrid">Hybrid</option>
          </select>
        </div>
        <div>
          <label>Characteristic Value</label>
          <input id="apo-char" type="number" min="0" step="1" value="0" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Description</label>
        <textarea id="apo-desc" rows="4" placeholder="What does this Apotheosis look like / do?"></textarea>
      </div>
    </div>

    <div class="home-card">
      <h3>Constraints</h3>
      <div class="grid-2">
        <div>
          <label>Available</label>
          <select id="c-available" class="listbox" multiple></select>
        </div>
        <div>
          <label>Selected</label>
          <select id="c-selected" class="listbox" multiple></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn" id="add-constraints">Add →</button>
        <button class="btn" id="remove-constraints">← Remove</button>
      </div>
    </div>

    <div class="home-card">
      <h3>Trades</h3>
      <div class="grid-2">
        <div>
          <label>p2s (Power→Stability)</label>
          <input id="trade-p2s" type="number" min="0" step="1" value="0" />
        </div>
        <div>
          <label>p2a (Power→Amplitude)</label>
          <input id="trade-p2a" type="number" min="0" step="1" value="0" />
        </div>
        <div>
          <label>s2a (Stability→Amplitude)</label>
          <input id="trade-s2a" type="number" min="0" step="1" value="0" />
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="save" class="btn">💾 Save</button>
      <a class="btn btn-secondary" href="apotheosis_browse.html">← Back</a>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const API_BASE = "";

    // ---- auth helpers (same keys as working pages) ----
    const token = localStorage.getItem("auth_token") || "";
    const authHeaders = () => (token ? { "Authorization": "Bearer " + token } : {});
    const EDIT_ID = new URLSearchParams(location.search).get('edit');

    // ---- constraints cache ----
    let ALL = []; // [{id,name,difficulty,...}]

    function setVal(sel, val){ const el=$(sel); if(el) el.value = (val ?? ""); }

    function selectedIds(){
      const sel = $("#c-selected");
      return [...sel.options].map(o=>o.value);
    }
    function addSelectedConstraint(id, label){
      const sel = $("#c-selected");
      if ([...sel.options].some(o=>o.value===id)) return;
      const o = document.createElement("option");
      o.value = id;
      o.textContent = label || `[${id}]`;
      sel.appendChild(o);
    }
    function refreshAvailable(){
      const avail = $("#c-available");
      const taken = new Set(selectedIds());
      avail.innerHTML = "";
      ALL.forEach(c=>{
        if (!taken.has(c.id)){
          const o = document.createElement("option");
          o.value = c.id;
          o.textContent = `[${c.id}] ${c.name || ""}`;
          avail.appendChild(o);
        }
      });
    }
    async function loadConstraints(){
      try{
        const r = await fetch(`/apotheosis/constraints`, { headers: { ...authHeaders() }});
        const j = await r.json().catch(()=>({}));
        ALL = j.constraints || [];
      }catch{ ALL = []; }
      refreshAvailable();
    }

    // ---- Save (POST create or PUT update) ----
    async function save(){
      if(!token){ alert("Please log in to save."); return; }
      const body = {
        name: ($("#apo-name").value||"Untitled Apotheosis").trim(),
        description: $("#apo-desc").value.trim(),
        type: $("#apo-type").value,
        stage: $("#apo-stage").value,
        characteristic_value: Number($("#apo-char").value||0),
        constraints: selectedIds(),
        trade_p2s: Number($("#trade-p2s").value||0),
        trade_p2a: Number($("#trade-p2a").value||0),
        trade_s2a: Number($("#trade-s2a").value||0)
      };

      const method = EDIT_ID ? "PUT" : "POST";
      const url    = EDIT_ID ? `${API_BASE}/apotheoses/${EDIT_ID}` : `${API_BASE}/apotheoses`;

      const r = await fetch(url, {
        method,
        headers:{ "Content-Type":"application/json", ...authHeaders() },
        body: JSON.stringify(body)
      });
      const j = await r.json().catch(async()=>({status:'error', message: await r.text()}));
      if(r.ok && j.status==="success"){
        alert(EDIT_ID ? "Updated." : "Saved.");
        location.href = "apotheosis_browse.html";
      } else {
        alert(j.message || (EDIT_ID ? "Update failed." : "Save failed."));
      }
    }

    // ---- Edit loader ----
    async function loadForEdit(){
      if (!EDIT_ID) return;
      // Ensure constraints first (so the picker shows nicely)
      if (!ALL.length) await loadConstraints();

      const res = await fetch(`/apotheoses/${EDIT_ID}`, { headers: { 'Accept':'application/json', ...authHeaders() }});
      const j = await res.json().catch(()=>({}));
      if (j.status !== 'success' || !j.apotheosis) return;

      const a = j.apotheosis;

      // Update header & save button
      const title = $('#page-title');
      if (title) title.textContent = `Edit an Apotheosis — ${a.name} [${a.id}]`;
      const saveBtn = $('#save');
      if (saveBtn) saveBtn.textContent = '💾 Save changes';

      // Fill fields
      setVal('#apo-name', a.name);
      setVal('#apo-desc', a.description || '');
      setVal('#apo-stage', a.stage);
      setVal('#apo-type', a.type || 'Personal');
      setVal('#apo-char', a.characteristic_value ?? 0);

      // Preselect constraints by id (use nice labels if we have them)
      const byId = new Map(ALL.map(c=>[c.id, c]));
      (a.constraints || []).forEach(id => {
        const c = byId.get(id);
        addSelectedConstraint(id, c ? `[${c.id}] ${c.name}` : `[${id}]`);
      });
      refreshAvailable();

      // Trades
      setVal('#trade-p2s', a.trades?.p2s ?? 0);
      setVal('#trade-p2a', a.trades?.p2a ?? 0);
      setVal('#trade-s2a', a.trades?.s2a ?? 0);
    }

    // ---- boot ----
    document.addEventListener("DOMContentLoaded", async ()=>{
      await loadConstraints();
      await loadForEdit();

      $("#save").addEventListener("click", save);

      $("#add-constraints").addEventListener("click", ()=>{
        const avail = $("#c-available");
        [...avail.selectedOptions].forEach(o=>{
          addSelectedConstraint(o.value, o.textContent);
        });
        refreshAvailable();
      });
      $("#remove-constraints").addEventListener("click", ()=>{
        const sel = $("#c-selected");
        [...sel.selectedOptions].forEach(o=>o.remove());
        refreshAvailable();
      });
    });
  </script>
</body>
</html>