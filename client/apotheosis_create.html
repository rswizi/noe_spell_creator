<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create an Apotheosis</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .scroll-pad { max-height: 56vh; overflow:auto; border:1px solid #222; border-radius:10px; padding:10px; }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:8px 12px; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #444; border-radius:999px; margin-left:6px; font-size:.85rem; }
    .small { font-size:.9rem } .muted { opacity:.8 }
    .row { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Create an Apotheosis</h1>

    <div class="home-card">
      <div class="grid">
        <div>
          <label>Name</label>
          <input id="apo-name" type="text" placeholder="e.g. Ascension of Thorns" />
        </div>
        <div>
          <label>Stage</label>
          <select id="apo-stage">
            <option>Immature Stage</option>
            <option>Stage I</option>
            <option>Stage II</option>
            <option>Stage III</option>
            <option>Stage IV</option>
            <option>Stage V</option>
          </select>
          <table id="stage-table" style="width:100%;margin-top:6px;border-collapse:collapse;font-size:.85rem;">
            <thead>
              <tr>
                <th style="padding:4px;border-bottom:1px solid #333;text-align:left;">Stage</th>
                <th style="padding:4px;border-bottom:1px solid #333;text-align:left;">Total Stability</th>
                <th style="padding:4px;border-bottom:1px solid #333;text-align:left;">Level Threshold</th>
              </tr>
            </thead>
            <tbody id="stage-table-body"></tbody>
          </table>
        </div>
        <div>
          <label>Type</label>
          <select id="apo-type">
            <option>Personal</option>
            <option>Environmental</option>
            <option>Ritual</option>
          </select>
        </div>
        <div>
          <label>Characteristic Value</label>
          <input id="apo-char" type="number" step="1" value="0" />
        </div>
      </div>

      <label style="margin-top:10px;">Description</label>
      <textarea id="apo-desc" rows="4" placeholder="Describe the Apotheosis..."></textarea>
    </div>

    <div class="home-card">
      <h3>Constraints</h3>

      <div class="row">
        <input id="c-filter" type="text" placeholder="Filter by name‚Ä¶" />
        <button id="c-clear" class="btn btn-secondary small">Reset</button>
        <span class="small muted" id="forbid-note" style="margin-left:auto;"></span>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div>
          <div class="small muted" style="margin-bottom:4px;">Available</div>
          <div class="scroll-pad">
            <select id="c-available" size="12" style="width:100%;"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="c-add" class="btn small">Add ‚Üí</button>
          </div>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:4px;">Selected</div>
          <div class="scroll-pad">
            <select id="c-selected" size="12" style="width:100%;"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="c-remove" class="btn btn-secondary small">‚Üê Remove</button>
          </div>
        </div>

        <div>
          <div class="small muted" style="margin-bottom:4px;">Constraint Info</div>
          <div id="c-info" class="scroll-pad small muted">Select a constraint to see details.</div>
        </div>
      </div>
    </div>

    <div class="home-card">
      <h3>Live Summary</h3>
      <div class="grid">
        <div>
          <div class="kv">
            <div><strong>Total Difficulty</strong></div><div id="diff-sum">‚Äî</div>
            <div><strong>Extra Stability Œî</strong></div><div id="stab-pen-sum">‚Äî</div>
            <div><strong>Amplitude Bonus</strong></div><div id="amp-bonus-sum">‚Äî</div>
          </div>
        </div>
        <div>
          <div class="kv">
            <div><strong>Power</strong></div><div id="out-power">‚Äî</div>
            <div><strong>Stability</strong></div><div id="out-stab">‚Äî</div>
            <div><strong>Amplitude</strong></div><div id="out-amp">‚Äî</div>
            <div><strong>Diameter</strong></div><div id="out-dia">‚Äî</div>
          </div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #222;margin:14px 0;">

      <h4>Trading</h4>
      <div class="small muted" style="margin-bottom:6px;">Allocate Power/Stability into Stability/Amplitude.</div>

      <div class="kv">
        <div>Power ‚Üí Stability</div>
        <div>
          <input id="trade-p2s" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-p2s">0</span>
        </div>

        <div>Power ‚Üí Amplitude</div>
        <div>
          <input id="trade-p2a" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-p2a">0</span>
        </div>

        <div>Stability ‚Üí Amplitude</div>
        <div>
          <input id="trade-s2a" type="number" min="0" step="1" value="0" />
          <span class="pill" id="pill-s2a">0</span>
        </div>
      </div>
    </div>

    <div class="home-card">
      <button id="save" class="btn">üíæ Save</button>
      <a class="btn btn-secondary" href="apotheosis_home.html">‚Üê Back</a>
      <div id="apo-status" class="muted small" style="margin-top:8px;">&nbsp;</div>
    </div>
  </div>

<script>
  const API_BASE = "";
  const $ = s => document.querySelector(s);

  // ---- Auth helpers (single source of truth)
  const getToken = () =>
    localStorage.getItem("auth_token") || localStorage.getItem("token") || "";
  const authHeaders = () =>
    getToken() ? { Authorization: "Bearer " + getToken() } : {};

  const STAGE_DATA = [
    { stage: "Immature Stage", stability: 5, threshold: "Stage I" },
    { stage: "Stage I",         stability: 7, threshold: "30" },
    { stage: "Stage II",        stability: 10, threshold: "45" },
    { stage: "Stage III",       stability: 14, threshold: "60" },
    { stage: "Stage IV",        stability: 19, threshold: "75" },
    { stage: "Stage V",         stability: 25, threshold: "90" },
  ];
  const TYPE_ALIASES = {
    environmental: "Terrain",
    terrain: "Terrain",
    ritual: "Ephemeral",
    ephemeral: "Ephemeral",
    personal: "Personal",
  };
  let constraintMap = new Map();
  let selectedConstraintIds = [];
  const stageTableBody = document.getElementById("stage-table-body");
  const selectedConstraintsEl = document.getElementById("c-selected");
  const availableConstraintsEl = document.getElementById("c-available");
  const constraintInfoEl = document.getElementById("c-info");
  const constraintFilterEl = document.getElementById("c-filter");
  const forbidNoteEl = document.getElementById("forbid-note");
  const statusEl = document.getElementById("apo-status");
  const tradeInputs = [
    { field: "trade-p2s", pill: "pill-p2s" },
    { field: "trade-p2a", pill: "pill-p2a" },
    { field: "trade-s2a", pill: "pill-s2a" },
  ];
  const summaryFields = {
    diff: document.getElementById("diff-sum"),
    stabDelta: document.getElementById("stab-pen-sum"),
    ampBonus: document.getElementById("amp-bonus-sum"),
    power: document.getElementById("out-power"),
    stability: document.getElementById("out-stab"),
    amplitude: document.getElementById("out-amp"),
    diameter: document.getElementById("out-dia"),
  };
  const editId = new URLSearchParams(window.location.search).get("edit") || "";

  let CACHE = [];
  let STARS = new Set(JSON.parse(localStorage.getItem("apoth_stars") || "[]"));
  let ME = null; // { username, role } or null

  async function loadMe() {
    if (!getToken()) { ME = null; return; }
    try {
      const r = await fetch(`/auth/me`, { headers: authHeaders() });
      const j = await r.json();
      ME = j.status === "success" ? { username: j.username, role: j.role } : null;
    } catch { ME = null; }
  }

  function starToggle(id){
    if (STARS.has(id)) STARS.delete(id); else STARS.add(id);
    localStorage.setItem("apoth_stars", JSON.stringify(Array.from(STARS)));
    render(CACHE);
  }

  function canEdit(a){
    if (!ME) return false;
    return (ME.username === a.creator) || ["moderator","admin"].includes(ME.role);
  }
  function canDelete(a){
    if (!ME) return false;
    return ["moderator","admin"].includes(ME.role);
  }

  function row(a){
    const s = a.stats || {};
    const starred = STARS.has(a.id);

    const editBtn = canEdit(a)
      ? `<button class="btn" onclick="editApotheosis('${a.id}')">Edit</button>`
      : "";
    const delBtn = canDelete(a)
      ? `<button class="btn btn-danger" onclick="deleteApotheosis('${a.id}')">Delete</button>`
      : "";
    const dupBtn = `<button class="btn" onclick="duplicateApotheosis('${a.id}')">Duplicate</button>`;

    return `
      <div class="effect-entry">
        <div style="flex:1;">
          <div style="font-weight:bold">${a.name} <span style="opacity:.7">[${a.id}]</span></div>
          <div class="small" style="opacity:.85">${a.description||""}</div>
          <div class="small" style="margin-top:6px;">
            <span class="pill">${a.stage}</span>
            <span class="pill">Power ${s.power ?? "‚Äî"}</span>
            <span class="pill">Stability ${s.stability ?? "‚Äî"}</span>
            <span class="pill">Amplitude ${s.amplitude ?? "‚Äî"}</span>
          </div>
          <div class="small" style="margin-top:4px;opacity:.7;">Creator: ${a.creator || "‚Äî"}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" onclick="openDetails('${a.id}')">Details</button>
          ${dupBtn}
          ${editBtn}
          ${delBtn}
          <button class="${starred?'btn btn-secondary':'btn'}" onclick="starToggle('${a.id}')">${starred?'Unstar':'Star'}</button>
        </div>
      </div>
    `;
  }

  function render(list){
    const fName = $("#f-name")?.value.trim().toLowerCase() || "";
    const fStage = $("#f-stage")?.value || "";
    const stageText = fStage ? `Stage ${["I","II","III","IV","V"][parseInt(fStage,10)-1]}` : "";
    const onlyStar = $("#f-star")?.checked || false;

    let out = list.slice();
    if (fName) out = out.filter(a => (a.name||"").toLowerCase().includes(fName));
    if (stageText) out = out.filter(a => String(a.stage) === stageText);
    if (onlyStar) out = out.filter(a => STARS.has(a.id));
    ($("#results")||{}).innerHTML = out.length ? out.map(row).join("") : `<p>No results.</p>`;
  }

  // Require auth for this list; admins will see all, others only theirs (backend enforces)
  async function load(){
    const r = await fetch(`/apotheoses`, { headers: authHeaders() });
    const j = await r.json().catch(()=>({}));
    CACHE = j.apotheoses || [];
    render(CACHE);
  }

  // ----- Constraints (Create page)
  async function loadConstraints() {
    const res = await fetch(`/apotheosis/constraints`, { headers: authHeaders() });
    const txt = await res.text();
    const j = (() => { try { return JSON.parse(txt); } catch { return {status:"error", message: txt}; } })();
    if (j.status !== "success") throw new Error(j.message || "Failed to load constraints");

    const list = j.constraints || [];
    constraintMap = new Map();
    list.forEach(c => {
      constraintMap.set(String(c.id), c);
    });
    renderAvailableConstraints();
  }

  function renderStageTable() {
    if (!stageTableBody) return;
    stageTableBody.innerHTML = STAGE_DATA.map(row => `
      <tr>
        <td style="padding:4px;border-bottom:1px solid #222;">${row.stage}</td>
        <td style="padding:4px;border-bottom:1px solid #222;">${row.stability}</td>
        <td style="padding:4px;border-bottom:1px solid #222;">${row.threshold}</td>
      </tr>
    `).join("");
  }

  function renderAvailableConstraints() {
    if (!availableConstraintsEl) return;
    const filter = (constraintFilterEl?.value || "").trim().toLowerCase();
    const options = Array.from(constraintMap.values())
      .filter(c => !selectedConstraintIds.includes(String(c.id)))
      .filter(c => !filter || (String(c.name || "").toLowerCase().includes(filter) || String(c.description || "").toLowerCase().includes(filter)))
      .map(c => `<option value="${c.id}">[${c.id}] ${c.name}</option>`)
      .join("");
    availableConstraintsEl.innerHTML = options || "<option disabled>No matches</option>";
    if (availableConstraintsEl.options.length) {
      availableConstraintsEl.selectedIndex = 0;
      updateConstraintInfo(availableConstraintsEl.value);
    } else {
      updateConstraintInfo(null);
    }
  }

  function renderSelectedConstraints() {
    if (!selectedConstraintsEl) return;
    selectedConstraintsEl.innerHTML = selectedConstraintIds.map(id => {
      const data = constraintMap.get(String(id));
      return `<option value="${id}">${data ? `[${data.id}] ${data.name}` : id}</option>`;
    }).join("") || "<option disabled>No constraints selected</option>";
    if (selectedConstraintIds.length) {
      const lastId = selectedConstraintIds[selectedConstraintIds.length - 1];
      updateConstraintInfo(lastId);
    } else {
      updateConstraintInfo(null);
    }
  }

  function updateConstraintInfo(id) {
    if (!constraintInfoEl) return;
    const data = constraintMap.get(String(id));
    if (data) {
      constraintInfoEl.innerHTML = `
        <div><strong>${data.name}</strong> [${data.id}]</div>
        <div class="small">Difficulty: ${data.difficulty ?? "‚Äî"} | Stability Œî: ${data.stability_delta ?? 0} | Amplitude: ${data.amplitude_bonus ?? 0}</div>
        <div style="margin-top:6px;">${data.description || "No description provided."}</div>
      `;
    } else {
      constraintInfoEl.textContent = "Select a constraint to see details.";
    }
  }

  function addConstraint() {
    if (!availableConstraintsEl) return;
    const id = availableConstraintsEl.value;
    if (!id || selectedConstraintIds.includes(id)) return;
    selectedConstraintIds.push(id);
    renderSelectedConstraints();
    renderAvailableConstraints();
    triggerCompute();
  }

  function removeConstraint() {
    if (!selectedConstraintsEl) return;
    const id = selectedConstraintsEl.value;
    if (!id) return;
    selectedConstraintIds = selectedConstraintIds.filter(x => x !== id);
    renderSelectedConstraints();
    renderAvailableConstraints();
    triggerCompute();
  }

  function normalizeType(value) {
    const key = String(value || "").trim().toLowerCase();
    return TYPE_ALIASES[key] || value || "Personal";
  }

  function updateTradePill(field, value) {
    const pillId = tradeInputs.find(t => t.field === field)?.pill;
    const pill = pillId ? document.getElementById(pillId) : null;
    if (pill) pill.textContent = Number.isFinite(Number(value)) ? Number(value).toString() : "0";
  }

  function tradeValues() {
    return {
      p2s: Number($("#trade-p2s")?.value || 0),
      p2a: Number($("#trade-p2a")?.value || 0),
      s2a: Number($("#trade-s2a")?.value || 0),
    };
  }

  async function computeSummary() {
    if (!$("#apo-char")) return;
    const payload = {
      characteristic_value: Number($("#apo-char").value || 0),
      stage: $("#apo-stage")?.value || "Stage I",
      type: normalizeType($("#apo-type")?.value),
      constraints: selectedConstraintIds.slice(),
      trade_p2s: tradeValues().p2s,
      trade_p2a: tradeValues().p2a,
      trade_s2a: tradeValues().s2a,
    };
    try {
      const resp = await fetch(`/apotheosis/compute`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (data.status !== "success") throw new Error(data.message || "Compute failed");
      if (summaryFields.diff) summaryFields.diff.textContent = String(data.total_difficulty);
      const stageRow = STAGE_DATA.find(row => row.stage === payload.stage) || {};
      if (summaryFields.stabDelta) summaryFields.stabDelta.textContent = String((data.stability || 0) - (stageRow.stability || 0));
      if (summaryFields.ampBonus) summaryFields.ampBonus.textContent = String(data.amplitude || 0);
      if (summaryFields.power) summaryFields.power.textContent = String(data.power || 0);
      if (summaryFields.stability) summaryFields.stability.textContent = String(data.stability || 0);
      if (summaryFields.amplitude) summaryFields.amplitude.textContent = String(data.amplitude || 0);
      if (summaryFields.diameter) summaryFields.diameter.textContent = String(data.diameter || 0);
      if (forbidNoteEl) {
        forbidNoteEl.textContent = data.flags?.forbid_p2s ? "Power ‚Üí Stability trades disabled." : "";
        const p2sInput = document.getElementById("trade-p2s");
        if (p2sInput) {
          p2sInput.disabled = !!data.flags?.forbid_p2s;
          if (p2sInput.disabled) p2sInput.value = "0";
        }
      }
      if (statusEl) statusEl.textContent = "Stats refreshed.";
    } catch (e) {
      if (statusEl) statusEl.textContent = `Compute failed: ${e.message || e}`;
    }
  }

  const triggerCompute = debounce(()=>computeSummary(), 250);

  async function populateFormForEdit() {
    if (!editId) return;
    try {
      const res = await fetch(`/apotheoses/${encodeURIComponent(editId)}`, { headers: authHeaders() });
      const j = await res.json();
      if (j.status !== "success" || !j.apotheosis) throw new Error(j.message || "Not found");
      const ap = j.apotheosis;
      $("#apo-name").value = ap.name || "";
      $("#apo-desc").value = ap.description || "";
      $("#apo-stage").value = ap.stage || "Stage I";
      $("#apo-type").value = ap.type || "Personal";
      $("#apo-char").value = ap.characteristic_value || 0;
      const trades = ap.trades || {};
      $("#trade-p2s").value = Number(trades.p2s || 0);
      $("#trade-p2a").value = Number(trades.p2a || 0);
      $("#trade-s2a").value = Number(trades.s2a || 0);
      selectedConstraintIds = (ap.constraints || []).map(String);
      renderSelectedConstraints();
      renderAvailableConstraints();
      tradeInputs.forEach(t => updateTradePill(t.field, $(`#${t.field}`)?.value || 0));
      triggerCompute();
    } catch (e) {
      if (statusEl) statusEl.textContent = `Load failed: ${e.message || e}`;
    }
  }

  async function saveApotheosis() {
    const payload = {
      name: $("#apo-name")?.value.trim() || "Untitled Apotheosis",
      description: $("#apo-desc")?.value.trim() || "",
      type: normalizeType($("#apo-type")?.value),
      stage: $("#apo-stage")?.value || "Stage I",
      characteristic_value: Number($("#apo-char")?.value || 0),
      constraints: selectedConstraintIds.slice(),
      trade_p2s: tradeValues().p2s,
      trade_p2a: tradeValues().p2a,
      trade_s2a: tradeValues().s2a,
    };
    const method = editId ? "PUT" : "POST";
    const endpoint = editId ? `/apotheoses/${encodeURIComponent(editId)}` : "/apotheoses";
    try {
      $("#save").disabled = true;
      if (statusEl) statusEl.textContent = editId ? "Updating..." : "Saving...";
      const res = await fetch(endpoint, {
        method,
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if (data.status !== "success") throw new Error(data.message || "Save failed");
      if (statusEl) statusEl.textContent = `Saved as ${data.apotheosis?.id || editId || "new"}.`;
      await load();
      triggerCompute();
    } catch (e) {
      if (statusEl) statusEl.textContent = `Save failed: ${e.message || e}`;
    } finally {
      $("#save").disabled = false;
    }
  }
  }

  // ----- Details modal -----
  function openDetails(id){
    const a = CACHE.find(x => String(x.id) === String(id));
    if (!a) return;
    const s = a.stats || {};
    $("#m-title").textContent = `${a.name} [${a.id}]`;
    $("#m-desc").textContent  = a.description || "‚Äî";
    $("#m-stage").textContent = a.stage;
    $("#m-char").textContent  = String(a.characteristic_value ?? "‚Äî");
    $("#m-power").textContent = String(s.power ?? "‚Äî");
    $("#m-stab").textContent  = String(s.stability ?? "‚Äî");
    $("#m-amp").textContent   = String(s.amplitude ?? "‚Äî");
    const cs = (a.constraints || []).map(cid => `<span class="pill">${cid}</span>`).join("");
    $("#m-constraints").innerHTML = cs || "‚Äî";
    $("#modal").classList.remove("hidden");
    $("#modal").setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    $("#modal").classList.add("hidden");
    $("#modal").setAttribute("aria-hidden", "true");
  }

  function editApotheosis(id){
    window.location.href = `apotheosis_create.html?edit=${encodeURIComponent(id)}`;
  }

  async function duplicateApotheosis(id){
    try{
      const r = await fetch(`/apotheoses/${id}/duplicate`, { method: "POST", headers: { ...authHeaders() }});
      const j = await r.json();
      if (j.status !== "success") throw new Error(j.message || "Duplicate failed");
      await load();
      alert(`Duplicated as ${j.apotheosis.id}`);
    }catch(e){
      alert(e.message || "Duplicate failed.");
    }
  }

  async function deleteApotheosis(id){
    if (!confirm(`Delete ${id}? This cannot be undone.`)) return;
    try{
      const r = await fetch(`/apotheoses/${id}`, { method: "DELETE", headers: { ...authHeaders() }});
      const j = await r.json();
      if (j.status !== "success") throw new Error(j.message || "Delete failed");
      CACHE = CACHE.filter(a => a.id !== id);
      render(CACHE);
    }catch(e){
      alert(e.message || "Delete failed.");
    }
  }

  function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }

  document.addEventListener("DOMContentLoaded", async ()=>{
    await loadMe();
    await Promise.allSettled([
      load(),           // browse list
      loadConstraints() // create page (no-op if list box not present)
    ]);

    renderStageTable();
    const run = debounce(()=>render(CACHE), 200);
    $("#f-name")?.addEventListener("input", run);
    $("#f-stage")?.addEventListener("change", run);
    $("#f-star")?.addEventListener("change", run);
    $("#f-reset")?.addEventListener("click", ()=>{
      if ($("#f-name")) $("#f-name").value="";
      if ($("#f-stage")) $("#f-stage").value="";
      if ($("#f-star")) $("#f-star").checked=false;
      render(CACHE);
    });

    constraintFilterEl?.addEventListener("input", renderAvailableConstraints);
    document.getElementById("c-add")?.addEventListener("click", addConstraint);
    document.getElementById("c-remove")?.addEventListener("click", removeConstraint);
    document.getElementById("c-clear")?.addEventListener("click", ()=>{
      if (constraintFilterEl) constraintFilterEl.value = "";
      renderAvailableConstraints();
    });
    availableConstraintsEl?.addEventListener("change", ()=> updateConstraintInfo(availableConstraintsEl.value));
    selectedConstraintsEl?.addEventListener("change", ()=> updateConstraintInfo(selectedConstraintsEl.value));

    $("#apo-char")?.addEventListener("input", () => triggerCompute());
    $("#apo-stage")?.addEventListener("change", () => triggerCompute());
    $("#apo-type")?.addEventListener("change", () => triggerCompute());
    tradeInputs.forEach(entry=>{
      const element = document.getElementById(entry.field);
      if (!element) return;
      element.addEventListener("input", ()=>{
        updateTradePill(entry.field, element.value);
        triggerCompute();
      });
      updateTradePill(entry.field, element.value);
    });
    $("#save")?.addEventListener("click", saveApotheosis);

    $("#modal-close")?.addEventListener("click", closeModal);
    $("#modal")?.addEventListener("click", e=>{ if(e.target.id==="modal") closeModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeModal(); });

    if (editId){
      await populateFormForEdit();
    }else{
      triggerCompute();
    }
  });
</script>
