<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spell Creator — Modify Database</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="container">
    <h1>Modify Database</h1>

    <div class="home-card" style="margin-bottom:18px;">
      <div class="filter-bar">
        <input id="filter-name" type="text" placeholder="Filter by name..." />
        <select id="filter-category">
          <option value="">All Categories</option>
          <option>Novice</option><option>Apprentice</option><option>Disciple</option>
          <option>Adept</option><option>Mage</option><option>Magister</option>
          <option>High Mage</option><option>Master</option><option>Grand Master</option>
          <option>Archmage</option><option>Supreme Archmage</option><option>Avant-garde</option>
        </select>
        <select id="filter-school">
          <option value="">All Schools</option>
        </select>
        <select id="filter-status" title="Filter by tag">
          <option value="">All Tags</option>
          <option value="green">Approved</option>
          <option value="yellow">Review</option>
          <option value="red">Flagged</option>
        </select>
        <button id="clear-filters">Reset</button>
        <button id="delete-flagged" class="btn btn-flag" style="margin-left:auto;">
          Delete All Flagged
        </button>
      </div>
    </div>

    <div class="home-card">
      <div id="results"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="home.html">← Back Home</a>
    </div>
  </div>
</body>
<script>
(() => {
  const API_BASE = "";
  const $  = (s) => document.querySelector(s);

  // Auth (from login flow)
  const token = localStorage.getItem("auth_token") || "";
  const role  = localStorage.getItem("auth_role") || "";

  // UI elements
  const resultsEl  = $("#results");
  const nameEl     = $("#filter-name");
  const categoryEl = $("#filter-category");
  const schoolEl   = $("#filter-school");
  const statusEl   = $("#filter-status");      // NEW
  const clearBtn   = $("#clear-filters");
  const delFlagBtn = $("#delete-flagged");     // NEW

  // Gate access
  document.addEventListener("DOMContentLoaded", () => {
    if (role !== "admin" && role !== "moderator") {
      alert("Forbidden: admin/moderator only.");
      window.location.href = "home.html";
      return;
    }
    init();
  });

  async function init() {
    await loadSchools();
    await fetchSpells();

    const run = debounce(fetchSpells, 300);
    nameEl.addEventListener("input", run);
    categoryEl.addEventListener("change", run);
    schoolEl.addEventListener("change", run);
    if (statusEl) statusEl.addEventListener("change", run);

    clearBtn.addEventListener("click", () => {
      nameEl.value = "";
      categoryEl.value = "";
      schoolEl.value = "";
      if (statusEl) statusEl.value = "";
      fetchSpells();
    });

    if (delFlagBtn) delFlagBtn.addEventListener("click", deleteFlagged);
  }

  function debounce(fn, ms = 300) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }

  // -------- Data --------

  async function loadSchools() {
    try {
      const res = await fetch(`${API_BASE}/schools`);
      const data = await res.json();
      if (!data || !Array.isArray(data.schools)) return;
      for (const s of data.schools) {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name} [${s.id}]`;
        schoolEl.appendChild(opt);
      }
    } catch (e) {
      console.error("loadSchools error:", e);
    }
  }

  function buildQuery() {
    const params = new URLSearchParams();
    const name = (nameEl.value || "").trim();
    const cat  = categoryEl.value || "";
    const sch  = schoolEl.value || "";
    const st   = statusEl ? (statusEl.value || "") : "";

    if (name) params.set("name", name);
    if (cat)  params.set("category", cat);
    if (sch)  params.set("school", sch);
    if (st)   params.set("status", st);   // NEW

    return params.toString();
  }

  async function fetchSpells() {
    try {
      const q = buildQuery();
      const url = q ? `${API_BASE}/spells?${q}` : `${API_BASE}/spells`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.error) {
        resultsEl.innerHTML = `<p style="color:#ff4a4a">Error: ${escapeHtml(data.error)}</p>`;
        return;
      }
      renderList(data.spells || []);
    } catch (e) {
      console.error("fetchSpells error:", e);
      resultsEl.innerHTML = `<p style="color:#ff4a4a">Failed to load spells.</p>`;
    }
  }

  // -------- Render --------

  function renderList(spells) {
    if (!spells.length) {
      resultsEl.innerHTML = `<p>No spells found.</p>`;
      return;
    }
    resultsEl.innerHTML = spells.map(spellRow).join("");
  }

  function spellRow(s) {
    const schoolNames = (s.schools || []).map(sc => sc.name).join(", ") || "—";
    const meta = [
      s.category || "—",
      s.activation ?? "—",
      s.range ?? "—",
      s.aoe ?? "—",
      `dur ${s.duration ?? "—"}`
    ].join(" · ");

    const status = (s.status || "yellow");
    const pillClass =
      status === "green" ? "pill pill-green" :
      status === "red"   ? "pill pill-red"   :
                           "pill pill-yellow";

    // Inline handlers call functions exposed on window below
    return `
      <div class="effect-entry" style="justify-content:space-between; align-items:flex-start;">
        <div style="flex:1; min-width:0;">
          <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${escapeHtml(s.name || "Untitled")} <span style="opacity:.7">[${s.id}]</span>
          </div>
          <div style="opacity:.8;font-size:.95rem">${escapeHtml(meta)}</div>
          <div style="opacity:.7;font-size:.9rem">Schools: ${escapeHtml(schoolNames)}</div>
          <div style="margin-top:6px;"><span class="${pillClass}">${status.toUpperCase()}</span></div>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end; flex-shrink:0;">
          <div class="action-row">
            <button class="btn btn-approve" onclick="setStatus('${s.id}','green')">Approve</button>
            <button class="btn btn-review"  onclick="setStatus('${s.id}','yellow')">Review</button>
            <button class="btn btn-flag"    onclick="setStatus('${s.id}','red')">Flag</button>
          </div>
          <div class="action-row">
            <button class="btn"               onclick="adminEditSpell('${s.id}')">Edit</button>
            <button class="btn btn-secondary" onclick="adminDeleteSpell('${s.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;").replace(/</g, "&lt;")
      .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // -------- Actions (exposed globally for inline onclick) --------

  window.adminEditSpell = function(id) {
    window.location.href = `index.html?edit_id=${encodeURIComponent(id)}`;
  };

  window.adminDeleteSpell = async function(id) {
    if (!token) { alert("You must be logged in."); return; }
    if (!confirm(`Delete spell ${id}? This cannot be undone.`)) return;

    try {
      const res = await fetch(`${API_BASE}/spells/${encodeURIComponent(id)}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.status === "success") {
        await fetchSpells();
      } else {
        alert(data.message || "Delete failed.");
      }
    } catch (e) {
      console.error("delete error:", e);
      alert("Delete request failed.");
    }
  };

  window.setStatus = async function(id, status) {
    if (!token) { alert("You must be logged in."); return; }
    try {
      const res = await fetch(`${API_BASE}/admin/spells/${encodeURIComponent(id)}/status`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ status })
      });
      const data = await res.json();
      if (data.status === "success") {
        await fetchSpells();
      } else {
        alert(data.message || "Failed to update status.");
      }
    } catch (e) {
      console.error("setStatus error:", e);
      alert("Request failed.");
    }
  };

  async function deleteFlagged() {
    if (!token)  { alert("You must be logged in."); return; }
    if (role !== "admin") { alert("Admin only."); return; }
    if (!confirm("Delete ALL flagged (red) spells? This cannot be undone.")) return;

    try {
      const res = await fetch(`${API_BASE}/admin/spells/flagged`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.status === "success") {
        alert(`Deleted ${data.deleted} flagged spell(s).`);
        await fetchSpells();
      } else {
        alert(data.message || "Failed to delete flagged spells.");
      }
    } catch (e) {
      console.error("deleteFlagged error:", e);
      alert("Request failed.");
    }
  }
})();
</script>
</html>