<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NoE — Spell List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    html.modal-open, body.modal-open { overflow: hidden; }
    #sl, #sl * { box-sizing: border-box; }
    #sl { color: #eee; }
    #sl a { color: inherit; }
    #sl .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; }
    #sl .hero{ font-size:2rem; margin:12px 0 4px; line-height:1.2; }
    #sl .sub{ opacity:.85; }
    #sl .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #sl .row > * { min-width:0; }
    #sl .spacer{ flex:1; }
    #sl .card{ border:1px solid #333; border-radius:14px; padding:16px; background:#0c0c0c; }
    #sl .grid{ display:grid; gap:16px; }
    #sl .grid.cols-2{ grid-template-columns:1fr 1fr; }
    @media (max-width:980px){ #sl .grid.cols-2{ grid-template-columns:1fr; } }
    #sl .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    #sl .pill{ border:1px solid #444; padding:2px 8px; border-radius:999px; }
    #sl .muted{ opacity:.8; }
    #sl .k{ font-weight:600; }
    #sl .hint{ font-size:.9rem; opacity:.85; }
    #sl .badge{ border:1px solid #555; border-radius:6px; padding:2px 6px; white-space:nowrap; }
    #sl .ok{ border-color:#2a6; }
    #sl .warn{ border-color:#a62; }
    #sl .err{ border-color:#a33; }
    #sl .empty{ opacity:.75; padding:10px; }

    #sl input[type="text"], #sl input[type="number"], #sl input[type="password"], #sl select, #sl textarea {
      width:auto; max-width:100%; padding:8px 10px; background:#0a0a0a; color:#eee; border:1px solid #333; border-radius:8px;
    }
    #sl .table-wrap{ overflow:auto; -webkit-overflow-scrolling: touch; border-radius:10px; }
    #sl .table{ width:100%; border-collapse:collapse; min-width:900px; }
    #sl .table th, #sl .table td{ border-bottom:1px solid #222; padding:10px; text-align:left; vertical-align:top; }
    #sl .table th{ opacity:.85; position:sticky; top:0; background:#0c0c0c; }
    #sl .table td, #sl .table th{ word-break: break-word; overflow-wrap: anywhere; }

    /* Modal */
    /* Modal (global, because modals are outside #sl) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:none; }
    .modal{ position:fixed; inset:0; display:none; z-index:3001; align-items:center; justify-content:center; padding:16px; }
    .modal.open, .modal-backdrop.open{ display:flex; }
    .modal-card{
      width:100%; max-width:960px; background:#0e0e0e; border:1px solid #2a2a2a;
      border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.6);
      max-height:90vh; overflow:auto;
    }
    .modal-card header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; gap:12px; }
    .modal-title{ font-weight:700; }
    .modal-close{ border:0; background:transparent; color:inherit; cursor:pointer; font-size:18px; }


    /* IV grid */
    #sl .grid-iv{ display:grid; gap:8px; grid-template-columns:repeat(4, minmax(120px,1fr)); }
    #sl .grid-iv label{ font-size:.9rem; opacity:.95 }
    #sl .grid-iv input{ width:100%; }
    @media (max-width:840px){ #sl .grid-iv{ grid-template-columns:repeat(2, minmax(120px,1fr)); } }

    /* Bonus manager bits kept */
    #bonus-list table{ min-width:760px; }
    #bonus-editor .section{ border:1px solid #2a2a2a; border-radius:10px; padding:10px; margin-top:10px; }
    #bonus-schools{ max-height:240px; overflow:auto; border:1px solid #2a2a2a; border-radius:10px; padding:8px; }

    /* Rich text editor area (export/meta flavour) */
    .rt-toolbar { display:flex; gap:8px; margin-bottom:6px; }
    .rt-area { min-height:140px; padding:12px; background:#101010; border:1px solid #c02d2d; border-radius:8px; }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <h1>NoE Manager</h1>
    <div class="auth-inline">
      <div id="user-chip" class="user-chip">
        <span class="chip-name" id="chip-name"></span>
        <button id="chip-logout" class="btn linklike">Log Out</button>
      </div>
      <button id="open-login" class="btn btn-secondary small">Log In</button>
      <a id="open-signup" class="btn btn-secondary small" href="signup.html">Sign Up</a>
    </div>
  </div>

  <div id="sl">
    <div class="wrap">
      <div class="hero" id="list-name">Spell List</div>
      <div class="sub" id="list-meta">Loading…</div>

      <div id="auth-gate" class="card" style="display:none;margin-top:12px;">
        <div style="margin-bottom:8px;">You must be logged in to view this spell list.</div>
        <button class="btn" id="gate-login">Log In</button>
      </div>

      <div id="content" class="grid" style="display:none;margin-top:16px;"></div>
    </div>

    <!-- Initial Values -->
    <div class="home-card">
      <div class="row">
        <h2 style="margin:0;">Initial Values</h2>
        <span class="spacer"></span>
        <button class="btn btn-secondary" id="edit-iv">Edit Initial Values</button>
        <button class="btn" id="open-bonuses">Consult Bonuses</button>
        <button class="btn btn-flag" id="delete-list" type="button">Delete List</button>
      </div>
      <div class="grid cols-2" style="margin-top:10px;">
        <div>
          <div class="muted" style="margin-bottom:6px;">Natures</div>
          <div id="iv-natures" class="chips"></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Skills</div>
          <div id="iv-skills" class="chips"></div>
          <div class="muted" style="margin-top:10px;">MAG: <span id="iv-mag" class="k">0</span></div>
        </div>
      </div>
      <div class="hint" style="margin-top:10px;">
        MS = MAG + linked skill + (best of: top two linked intensities) or (top one intensity +2).
      </div>
    </div>

    <!-- Schools table (unchanged core logic) -->
    <div class="home-card">
      <div class="row" style="margin-bottom:8px;">
        <h2 style="margin:0;">School Categories</h2>
        <span class="spacer"></span>
        <input id="filter-name"
       name="sl_filter_name"
       type="text"
       placeholder="Filter by school name…"
       autocomplete="off"
       autocapitalize="none"
       autocorrect="off"
       inputmode="search"
       style="min-width:220px;">
        <select id="filter-min-cat">
          <option value="">Min. Category: Any</option>
        </select>
        <label class="mini" style="display:flex; align-items:center; gap:6px; margin-right:8px;"><input type="checkbox" id="hide-unpinned"> Hide unpinned</label><select id="filter-type">
          <option value="">Type: Any</option>
          <option value="simple">Simple</option>
          <option value="complex">Complex</option>
        </select>
        <select id="sort-by">
          <option value="cat_desc">Sort: Category (high → low)</option>
          <option value="name_asc">Sort: Name (A → Z)</option>
        </select>
        <button class="btn" id="recalc">Recalculate</button>
      </div>

      <div class="home-card">
        <table class="table" id="schools-table">
          <thead>
            <tr>
              <th style="width:22%;">School</th>
              <th style="width:24%;">Linked</th>
              <th style="width:22%;">MS Breakdown</th>
              <th style="width:14%;">MS</th>
              <th style="width:18%;">Category</th>
            </tr>
          </thead>
          <tbody id="schools-body">
            <tr><td colspan="5" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:8px;">
        Learning Time (days): Novice 2 • Apprentice 8 • Disciple 10 • Adept 14 • Mage 16 • Magister 20 • High Mage 22 • Master 28 • Grand Master 32 • Archmage 36 • Supreme Archmage 46 • Avant-Garde 50
      </div>
    </div>

    <!-- My Spells -->
    <div class="card" id="my-spells-card" style="display:none;">
      <div class="row" style="margin-bottom:8px;">
        <h2 style="margin:0;">My Spells</h2>
        <span class="spacer"></span>
        <span id="count-simple-spells" class="badge">Simple Spells: 0</span>
        <span id="count-complex-spells" class="badge">Complex Spells: 0</span>
        <button class="btn" id="open-add-spells">Add Spells</button>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th style="width:22%;">Name</th>
              <th style="width:18%;">Alt. Name</th>
              <th>Schools</th>
              <th style="width:10%;">Category</th>
              <th style="width:12%;">Status</th>
              <th style="width:14%;">Eligibility</th>
              <th style="width:18%;">Actions</th>
            </tr>
          </thead>
          <tbody id="my-spells-body">
            <tr><td colspan="7" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title" aria-hidden="true">
    <div class="modal-card">
      <header>
        <div class="modal-title" id="login-title">Log In</div>
        <button class="modal-close" id="close-login" aria-label="Close">✕</button>
      </header>

      <label for="login-username">Username</label>
      <input type="text" id="login-username" placeholder="Enter username" />

      <label for="login-password" style="margin-top:10px;">Password</label>
      <input type="password" id="login-password" placeholder="Enter password" />

      <div id="login-status" style="opacity:.85; margin-top:8px;"></div>

      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancel-login">Cancel</button>
        <button class="btn" id="login-btn">Log In</button>
      </div>
    </div>
  </div>

  <!-- Add Spells Modal -->
  <div id="addspells-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="addspells-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:1000px;">
      <header>
        <div class="modal-title">Add Spells</div>
        <a class="btn btn-secondary" href="home.html" target="_blank" rel="noopener">Create Spell</a>
        <button class="btn btn-secondary" id="reload-spells">Reload Spells</button>
        <button class="modal-close" id="addspells-close" aria-label="Close">✕</button>
      </header>
      <div class="row" style="gap:10px; margin-bottom:8px;">
        <input id="as-q" type="text" placeholder="Search name…" style="min-width:220px;">
        <select id="as-school"><option value="">Any school</option></select>
        <select id="as-category">
          <option value="">Any category</option>
          <option>Novice</option><option>Apprentice</option><option>Disciple</option>
          <option>Adept</option><option>Mage</option><option>Magister</option>
          <option>High Mage</option><option>Master</option><option>Grand Master</option>
          <option>Archmage</option><option>Supreme Archmage</option><option>Avant-Garde</option>
        </select>
        <button class="btn" id="as-search">Search</button>
        <span class="spacer"></span>
        <button class="btn" id="as-add-selected">Add Selected</button>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th style="width:4%;"><input type="checkbox" id="as-check-all"></th>
              <th style="width:30%;">Name</th>
              <th>Schools</th>
              <th style="width:14%;">Category</th>
              <th style="width:18%;">Eligibility</th>
            </tr>
          </thead>
          <tbody id="as-results"><tr><td colspan="5" class="empty">Search to begin.</td></tr></tbody>
        </table>
        <div id="reload-summary" class="hint" style="margin-top:8px;"></div>
      </div>
      <div id="as-status" class="hint" style="margin-top:8px;"></div>
      <div class="modal-actions" style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button class="btn btn-secondary" id="addspells-cancel">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Initial Values Modal -->
  <div id="iv-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="iv-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:960px;">
      <header>
        <div class="modal-title" id="iv-title">Edit Initial Values</div>
        <button class="modal-close" id="iv-close" aria-label="Close">✕</button>
      </header>

      <label for="iv-mag-input" class="k">MAG</label>
      <input id="iv-mag-input" type="number" min="0" step="1" value="0" />

      <div style="margin:12px 0 6px;font-weight:600;">Natures</div>
      <div class="grid-iv">
        <div><label>Fire</label><input type="number" id="iv-fire" min="0" step="1"></div>
        <div><label>Water</label><input type="number" id="iv-water" min="0" step="1"></div>
        <div><label>Wind</label><input type="number" id="iv-wind" min="0" step="1"></div>
        <div><label>Earth</label><input type="number" id="iv-earth" min="0" step="1"></div>
        <div><label>Sun</label><input type="number" id="iv-sun" min="0" step="1"></div>
        <div><label>Moon</label><input type="number" id="iv-moon" min="0" step="1"></div>
        <div><label>Lightning</label><input type="number" id="iv-lightning" min="0" step="1"></div>
        <div><label>Ki</label><input type="number" id="iv-ki" min="0" step="1"></div>
      </div>

      <div style="margin:12px 0 6px;font-weight:600;">Skills</div>
      <div class="grid-iv">
        <div><label>Aura</label><input type="number" id="iv-aura" min="0" step="1"></div>
        <div><label>Incantation</label><input type="number" id="iv-incantation" min="0" step="1"></div>
        <div><label>Enchantement</label><input type="number" id="iv-enchantement" min="0" step="1"></div>
        <div><label>Potential</label><input type="number" id="iv-potential" min="0" step="1"></div>
        <div><label>Restoration</label><input type="number" id="iv-restoration" min="0" step="1"></div>
        <div><label>Stealth</label><input type="number" id="iv-stealth" min="0" step="1"></div>
        <div><label>Investigation</label><input type="number" id="iv-investigation" min="0" step="1"></div>
        <div><label>Charm</label><input type="number" id="iv-charm" min="0" step="1"></div>
        <div><label>Intimidation</label><input type="number" id="iv-intimidation" min="0" step="1"></div>
        <div><label>Absorption</label><input type="number" id="iv-absorption" min="0" step="1"></div>
        <div><label>Spirit</label><input type="number" id="iv-spirit" min="0" step="1"></div>
      </div>

      <div id="iv-status" class="hint" style="margin-top:8px;"></div>
      <div class="modal-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn btn-secondary" id="iv-cancel">Cancel</button>
        <button class="btn" id="iv-save">Save</button>
      </div>
    </div>
  </div>

  <!-- Variant Modal (kept) -->
  <div id="var-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="var-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:720px;">
      <header>
        <div class="modal-title">Add Variant</div>
        <button class="modal-close" id="var-close" aria-label="Close">✕</button>
      </header>
      <div class="sub" id="var-school-title"></div>
      <div class="hint" id="var-rule" style="margin:6px 0 10px;"></div>
      <div id="var-choices" class="chips" style="gap:10px;"></div>
      <div style="margin-top:10px;">
        <label for="var-name" class="k">Variant Name</label>
        <input id="var-name" type="text" placeholder="e.g. Storm Weaving" style="min-width:240px;">
      </div>
      <div id="var-status" class="hint" style="margin-top:8px;"></div>
      <div class="modal-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn btn-secondary" id="var-cancel">Cancel</button>
        <button class="btn" id="var-save">Save Variant</button>
      </div>
    </div>
  </div>

  <!-- Bonuses Manager (kept, omitted content here for brevity in this block) -->
  <div id="bon-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="bon-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:1000px;">
      <header>
        <div class="modal-title">Bonuses</div>
        <button class="modal-close" id="bon-close" aria-label="Close">✕</button>
      </header>
      <div id="bonus-list" class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th style="width:6%;">On</th>
              <th style="width:24%;">Name</th>
              <th style="width:14%;">Type</th>
              <th>Targets</th>
              <th style="width:14%;">Value</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody id="bon-body">
            <tr><td colspan="6" class="empty">No bonuses yet.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="bon-add">Add Bonus</button>
      </div>

      <!-- Inline editor area kept identical to your prior version -->
      <div id="bonus-editor" class="section" style="display:none;"></div>
    </div>
  </div>

  <!-- Meta Modal: Alternative Name + Flavor -->
  <div id="meta-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="meta-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:760px;">
      <header>
        <div class="modal-title">Spell Display & Flavor</div>
        <button class="modal-close" id="meta-close" aria-label="Close">✕</button>
      </header>

      <div class="k" id="meta-spell-title" style="margin-bottom:6px;">—</div>
      <div style="display:grid; gap:10px;">
        <div>
          <label class="k">Alternative Name (shown in list & export)</label>
          <input id="meta-altname" type="text" placeholder="Leave empty to use official name">
        </div>

        <div>
          <div class="k" style="margin-bottom:6px;">Flavor Text (rich)</div>
          <div class="rt-toolbar">
            <button class="btn btn-secondary small" data-rt="bold"><b>B</b></button>
            <button class="btn btn-secondary small" data-rt="italic"><i>I</i></button>
            <button class="btn btn-secondary small" data-rt="underline"><u>U</u></button>
            <button class="btn btn-secondary small" data-rt="insertUnorderedList">• List</button>
          </div>
          <div id="meta-flavor" class="rt-area" contenteditable="true"></div>
          <div class="hint">Supports basic formatting; this text is included in export.</div>
        </div>
      </div>

      <div class="modal-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn btn-secondary" id="meta-cancel">Cancel</button>
        <button class="btn" id="meta-save">Save</button>
      </div>
    </div>
  </div>

  <!-- Export Modal (flavour confirm like export.html) -->
  <div id="exp-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="exp-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:720px;">
      <header>
        <div class="modal-title" id="exp-modal-title">Export Spell — Add Flavour</div>
        <button class="modal-close" id="exp-close" aria-label="Close">✕</button>
      </header>

      <div style="margin-bottom:10px; opacity:.9;">
        Optional: review/add flavour. Your saved flavour (if any) is pre-filled. (Matches the export flow in <code>export.html</code>.)
      </div>

      <div class="rt-toolbar">
        <button class="btn btn-secondary small" data-exp-rt="bold"><b>B</b></button>
        <button class="btn btn-secondary small" data-exp-rt="italic"><i>I</i></button>
        <button class="btn btn-secondary small" data-exp-rt="underline"><u>U</u></button>
        <button class="btn btn-secondary small" data-exp-rt="insertUnorderedList">• List</button>
      </div>

      <div id="exp-flavour" class="rt-area" contenteditable="true"></div>

      <div class="modal-actions">
        <button class="btn btn-secondary" id="exp-cancel">Cancel</button>
        <button class="btn" id="exp-continue">Continue</button>
      </div>
    </div>
  </div>

  <!-- Export View (same structure as export.html result panel) -->
  <div class="container" id="export-view" style="display:none; margin-top:24px;">
    <div class="home-card">
      <h2 id="exp-title" style="margin-bottom:10px;"></h2>

      <div id="exp-fields" style="display:grid; gap:10px;"></div>

      <div style="margin-top:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Description</h3>
          <button class="btn btn-secondary" id="copy-description">Copy Description</button>
          <button class="btn" id="copy-foundry">Copy All (Foundry Chat)</button>
        </div>
        <div id="description-preview" style="margin-top:8px; padding:12px; background:#121212; border:1px solid #c02d2d; border-radius:10px;"></div>
      </div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'})">↑ Back to Top</a>
    </div>
  </div>

<script>
/* =========================
   Config / Globals
========================= */
const API_BASE = ""; // set if your backend is mounted at a prefix
let token = "";
let listId = "";

const modal    = document.getElementById("login-modal");
const backdrop = document.getElementById("login-backdrop");
const statusEl = document.getElementById("login-status");

function openLogin() {
  modal.classList.add("open");
  backdrop.classList.add("open");
  const u = document.getElementById("login-username");
  if (u) u.focus();
}
function closeLogin() {
  modal.classList.remove("open");
  backdrop.classList.remove("open");
  if (statusEl) statusEl.textContent = "";
}

async function login() {
  const username = document.getElementById("login-username").value.trim();
  const password = document.getElementById("login-password").value;
  statusEl.textContent = "";

  const res = await fetch(`${API_BASE}/auth/login`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if (data.status === "success") {
    localStorage.setItem("auth_token", data.token);
    localStorage.setItem("auth_username", data.username);
    localStorage.setItem("auth_role", data.role);
    setLoggedInUI(data.username, data.role);
    closeLogin();
  } else {
    statusEl.textContent = data.message || "Login failed";
  }
}

async function logout() {
  const token = localStorage.getItem("auth_token");
  if (token) {
    await fetch(`${API_BASE}/auth/logout`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` }
    });
  }
  localStorage.clear();
  setLoggedOutUI();

  closeLogin();
}

const CATS = [
  {name:"Avant-Garde", ms:92, days:50},
  {name:"Supreme Archmage", ms:82, days:46},
  {name:"Archmage", ms:72, days:36},
  {name:"Grand Master", ms:62, days:32},
  {name:"Master", ms:52, days:28},
  {name:"High Mage", ms:42, days:22},
  {name:"Magister", ms:37, days:20},
  {name:"Mage", ms:32, days:16},
  {name:"Adept", ms:27, days:14},
  {name:"Disciple", ms:22, days:10},
  {name:"Apprentice", ms:17, days:8},
  {name:"Novice", ms:12, days:2},
  {name:"Unqualified", ms:-Infinity, days:0},
];
const CAT_ORDER = Object.fromEntries(CATS.map((c,i)=>[c.name, CATS.length-1 - i]));
function catOrder(n){ return CAT_ORDER[n] ?? 0; }

let spellList = null, schools = [], computed = [];
let upgradeIds = new Set(), upgradeNames = new Set();
let mySpells = [];                     // spells belonging to this list
let ALL_SCHOOLS = [];                  // for export filters/lookup if needed
let ALL_EFFECTS = [];                  // for export effect descriptions

/* =========================
   Utils
========================= */
function lc(s){ return (s||"").toString().trim().toLowerCase(); }
function title(s){ return s? s.charAt(0).toUpperCase()+s.slice(1) : ""; }
function qs(name){ const p=new URLSearchParams(location.search); return p.get(name)||""; }
function openModal(m,b){ m.classList.add("open"); b.classList.add("open"); document.documentElement.classList.add("modal-open"); document.body.classList.add("modal-open"); }
function closeModal(m,b){ m.classList.remove("open"); b.classList.remove("open"); if(!document.querySelector('.modal.open')){ document.documentElement.classList.remove("modal-open"); document.body.classList.remove("modal-open"); } }
function execRTOn(el, cmd){ document.getSelection().removeAllRanges(); document.execCommand(cmd, false, null); el.focus(); }
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}


/* =========================
   Auth bits (minimal)
========================= */
async function apiMe(){
  if (!token) return {ok:false};
  try{ const r = await fetch(`${API_BASE}/auth/me`, { headers:{Authorization:`Bearer ${token}`}}); const j = await r.json(); return (j && j.status==="success")? {ok:true,user:j}:{ok:false}; }catch{ return {ok:false}; }
}

/* =========================
   API: lists / schools / spells
========================= */
async function fetchSpellList(id){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(id)}`, { headers:{Authorization:`Bearer ${token}`}} );
  if (r.status===401) throw new Error("Unauthorized");
  const j = await r.json(); return j.list || j;
}
async function updateSpellList(id, payload){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(id)}`, {
    method:"PUT", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body: JSON.stringify(payload)
  });
  if (r.status===401) throw new Error("Unauthorized");
  return await r.json();
}
async function fetchSchools(){
  const r = await fetch(`${API_BASE}/schools`, { headers:{Authorization:`Bearer ${token}`}} );
  const j = await r.json(); return j.schools || j.items || j || [];
}
async function fetchListSpells(){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(listId)}/spells`, { headers:{Authorization:`Bearer ${token}`}} );
  const j = await r.json(); return (j.spells || []);
}
async function addSpells(ids){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(listId)}/spells`, {
    method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body:JSON.stringify({ids})
  });
  return await r.json();
}
async function removeSpell(id){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(listId)}/spells/${encodeURIComponent(id)}`, {
    method:"DELETE", headers:{Authorization:`Bearer ${token}`}
  });
  return await r.json();
}
async function searchSpells(q="", school="", category=""){
  const params = new URLSearchParams();
  if (q) params.set("name", q);
  if (school) params.set("school", school);
  if (category) params.set("category", category);
  params.set("limit","100");
  const r = await fetch(`${API_BASE}/spells?${params.toString()}`);
  const j = await r.json(); return j.spells || [];
}
async function fetchSpellById(spellId){
  const r = await fetch(`${API_BASE}/spells/${encodeURIComponent(spellId)}`);
  const j = await r.json();
  if (j.error) throw new Error(j.error);
  return j.spell || j;
}

/* =========================
   Upgrades / school helpers
========================= */
function refreshUpgradeSets(){
  upgradeIds  = new Set((schools||[]).filter(s => s.upgrade).map(s => String(s.id||"").toLowerCase()));
  upgradeNames= new Set((schools||[]).filter(s => s.upgrade).map(s => String(s.name||"").toLowerCase()));
}
function isUpgradeSchoolRef(ref){
  const id   = (ref.id||"").toLowerCase();
  const name = (ref.name||"").toLowerCase();
  return upgradeIds.has(id) || upgradeNames.has(name);
}
const isComplexNeedsTwo = (sch)=> (lc(sch.school_type)==="complex") && (sch.linked_intensities||[]).length>1;

function findSchoolByRef(ref){
  const id = lc(ref.id||"");
  const name = lc(ref.name||"");
  return (schools||[]).find(s => lc(s.id||"")===id || lc(s.name||"")===name);
}
function spellPrimaryTypes(sp){
  const refs = sp.schools || [];
  const types = [];
  for (const ref of refs){
    const s = findSchoolByRef(ref);
    if (!s || s.upgrade) continue;               // ignore upgrades
    types.push(lc(s.school_type||""));
  }
  return types; // e.g. ["simple"] or ["simple","complex"]
}
function isSimpleOnlySpell(sp){
  const t = spellPrimaryTypes(sp);
  if (!t.length) return false;
  return t.every(x => x==="simple");
}
function isComplexSpell(sp){
  const t = spellPrimaryTypes(sp);
  return t.length > 0 && t.includes("complex");
}

/* =========================
   MS math (kept)
========================= */
function mapCategory(ms){ for (const c of CATS){ if (ms >= c.ms) return c; } return CATS[CATS.length-1]; }
function normalizeIV(iv){
  const defN = {fire:0,water:0,wind:0,earth:0,sun:0,moon:0,lightning:0,ki:0};
  const defS = {aura:0,incantation:0,enchantement:0,potential:0,restoration:0,stealth:0,investigation:0,charm:0,intimidation:0,absorption:0,spirit:0};
  const n = Object.assign({}, defN), s = Object.assign({}, defS);
  for (const k in (iv.natures||{})) n[lc(k)] = +(iv.natures[k]||0);
  for (const k in (iv.skills||{}))  s[lc(k)] = +(iv.skills[k]||0);
  return { mag: +(iv.mag||0), natures:n, skills:s };
}
function bestMSForSchool(iv, school, opts={}){
  const mag = +((iv.mag ?? 0) || 0);
  const skillKey = lc(school.linked_skill || "");
  const skillVal = +((iv.skills?.[skillKey]) ?? 0);
  const ints = (school.linked_intensities || []).map(lc);

  const arr = ints.map(k => ({ key:k, val:+((iv.natures?.[k]) ?? 0) }))
                  .sort((a,b)=> (b.val - a.val) || a.key.localeCompare(b.key));

  const top1 = arr[0] || {key:null, val:0};
  const top2 = arr[1] || {key:null, val:0};

  if (opts.forceTwo){
    const ms = mag + skillVal + top1.val + (top2.val || 0);
    return {
      ms, useOne:false, pick:[top1.val, top2.val||0],
      mag, skillVal, top1: top1.val, top2: top2.val,
      pickNames: [top1.key, top2.key].filter(Boolean)
    };
  }

  const msTwo = mag + skillVal + top1.val + top2.val;
  const msOne = mag + skillVal + top1.val + 2;
  const useOne = msOne > msTwo;
  const ms = useOne ? msOne : msTwo;
  const pickNames = useOne ? [top1.key].filter(Boolean) : [top1.key, top2.key].filter(Boolean);

  return {
    ms, useOne,
    pick: useOne? [top1.val, "+2 bonus"]:[top1.val, top2.val],
    mag, skillVal, top1: top1.val, top2: top2.val,
    pickNames
  };
}


/* =========================
   Eligibility
========================= */
function eligibleForSpell(spell){
  const need = spell.category || "Novice";
  const reqOrd = catOrder(need);
  const bestBySchool = {};
  for (const r of computed){
    const key = (r.school.id || r.school.name || "").toLowerCase();
    const ord = catOrder(r.cat.name);
    if (!(key in bestBySchool) || ord > bestBySchool[key]) bestBySchool[key] = ord;
  }
  return (spell.schools || []).every(s => {
    if (isUpgradeSchoolRef(s)) return true;
    const k = (s.id || s.name || "").toLowerCase();
    return (bestBySchool[k] ?? -999) >= reqOrd;
  });
}

/* =========================
   Variants & Bonuses (kept in localStorage)
========================= */
// --- Server-backed list meta (variants, bonuses, per-spell meta) ---
let variantsCache = [];
let bonusesCache = [];
let spellMetaCache = {};  // { [spellId]: { status: "known"|"learnt", alt_name: "", flavor: "" } }

async function fetchListMeta(){
  const r = await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(listId)}/meta`,
    { headers:{Authorization:`Bearer ${token}`}} );
  const j = await r.json();
  const m = j.meta || {};
  variantsCache  = Array.isArray(m.variants) ? m.variants : [];
  bonusesCache   = Array.isArray(m.bonuses) ? m.bonuses : [];

  // Normalize server spell_meta ({alt_name}) to UI shape ({altName})
  const raw = (m.spell_meta && typeof m.spell_meta==="object") ? m.spell_meta : {};
  spellMetaCache = {};
  for (const [id, meta] of Object.entries(raw)){
    spellMetaCache[id] = {
      status : meta.status || "learnt",
      altName: (meta.altName ?? meta.alt_name ?? ""),
      flavor : meta.flavor ?? ""
    };
  }
}

// Spell meta read: always return UI shape (camelCase)
function getSpellMeta(spId){
  const m = spellMetaCache[spId] || { status:"learnt", altName:"", flavor:"" };
  return { status: m.status || "learnt", altName: m.altName || "", flavor: m.flavor || "" };
}

// Spell meta write: keep UI cache in camelCase, but send snake_case to server
function setSpellMeta(spId, partial){
  const cur = getSpellMeta(spId);
  const next = { ...cur, ...partial };
  spellMetaCache = { ...spellMetaCache, [spId]: next };

  // Build server payload with alt_name
  const serverMeta = {};
  for (const [id, m] of Object.entries(spellMetaCache)){
    serverMeta[id] = { status: m.status || "learnt", alt_name: m.altName || "", flavor: m.flavor || "" };
  }
  saveListMeta({ spell_meta: serverMeta }).catch(()=>{});
}

async function saveListMeta(patch){
  // patch: {variants?, bonuses?, spell_meta?}
  await fetch(`${API_BASE}/spell_lists/${encodeURIComponent(listId)}/meta`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
    body: JSON.stringify(patch)
  });
}

// keep the same function names the rest of the file uses:
function loadVariants(){ return variantsCache; }
function saveVariants(v){
  variantsCache = Array.isArray(v) ? v : [];
  saveListMeta({variants: variantsCache}).catch(()=>{});
}
function addVariant(sid, name, natures){
  const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : `v_${Date.now().toString(36)}`;
  const v = { id, schoolId: sid, name: (name||"").trim(), natures: (natures||[]).map(lc) };
  variantsCache = [...variantsCache, v];
  saveListMeta({variants: variantsCache}).catch(()=>{});
}

function loadBonuses(){ return bonusesCache; }
function saveBonuses(list){
  bonusesCache = Array.isArray(list) ? list : [];
  saveListMeta({bonuses: bonusesCache}).catch(()=>{});
}


/* =========================
   Pin / Unpin schools (client-side, persisted per list in localStorage; synced to server meta)
========================= */
function pinsKey(){ return `pins_${listId}`; }
function loadPins(){
  try{ return new Set(JSON.parse(localStorage.getItem(pinsKey())||"[]").map(String)); }catch{ return new Set(); }
}
function savePins(set){
  try{ localStorage.setItem(pinsKey(), JSON.stringify(Array.from(set||[]))); }catch{}
}
let PINNED;
function isPinned(sid){ return PINNED.has(String(sid)); }
function togglePin(sid){
  const k = String(sid);
  if (PINNED.has(k)) PINNED.delete(k); else PINNED.add(k);
  savePins(PINNED);
  try{ saveListMeta({ pinned_schools: Array.from(PINNED) }); }catch(e){}
  renderSchools();
}

/* =========================
   Load / Compute / Render Schools
========================= */
function buildMinCatSelect(){
  const sel = document.getElementById("filter-min-cat");
  sel.innerHTML = `<option value="">Min. Category: Any</option>`;
  for (const c of [...CATS].reverse().filter(x=>x.name!=="Unqualified")) {
    const opt = document.createElement("option"); opt.value = c.name; opt.textContent = c.name; sel.appendChild(opt);
  }
}
function displayName(row){
  return row.variant ? `${row.school.name || "Unknown"} (${row.variant.name})`
                     : (row.school.name || "Unknown");
}
function renderIVChips(iv){
  const nWrap = document.getElementById("iv-natures");
  const sWrap = document.getElementById("iv-skills");
  nWrap.innerHTML = ""; sWrap.innerHTML = "";
  const n = iv.natures || {}; const s = iv.skills || {};
  for (const k of ["fire","water","wind","earth","sun","moon","lightning","ki"]) {
    const chip = document.createElement("span"); chip.className="pill"; chip.textContent = `${title(k)}: ${+n[k]||0}`; nWrap.appendChild(chip);
  }
  for (const k of ["aura","incantation","enchantement","potential","restoration","stealth","investigation","charm","intimidation","absorption","spirit"]) {
    const chip = document.createElement("span"); chip.className="pill"; chip.textContent = `${title(k)}: ${+s[k]||0}`; sWrap.appendChild(chip);
  }
  document.getElementById("iv-mag").textContent = +((iv.mag ?? 0) || 0);
}
function computeAll(){
  function msBonusForSchoolId(schoolId){
    const list = loadBonuses() || [];
    let sum = 0;
    for (const b of list){
      if (b.type !== "ms") continue;
      if (b.on === "all") { sum += +b.value || 0; continue; }
      if (b.on === "schools" && Array.isArray(b.targets) && b.targets.includes(String(schoolId))) {
        sum += +b.value || 0;
      }
    }
    return sum;
  }

function msWithChosenNatures(iv, school, chosen) {
  const mag = +((iv.mag ?? 0) || 0);
  const skillKey = lc(school.linked_skill || "");
  const skillVal = +((iv.skills?.[skillKey]) ?? 0);

  const ALL_NATURES = ["fire","water","wind","earth","sun","moon","lightning","ki"];
  const chosenKeys = (chosen || [])
    .map(lc)
    .filter(k => ALL_NATURES.includes(k));

  // Fallback: if variant somehow has no valid choice, just use bestMSForSchool
  if (!chosenKeys.length) {
    const b = bestMSForSchool(iv, school, { forceTwo: isComplexNeedsTwo(school) });
    return {
      ms: b.ms,
      useOne: b.useOne,
      pick: Array.isArray(b.pick) ? b.pick : [b.top1, b.top2],
      mag: b.mag,
      skillVal: b.skillVal,
      top1: b.top1,
      top2: b.top2,
      pickNames: b.pickNames || [],
      chosen: b.pickNames || []
    };
  }

  // Map to values, take up to 2 (since MS formula never uses more than 2)
  const vals = chosenKeys
    .map(k => ({ key: k, val: +((iv.natures?.[k]) ?? 0) }))
    .sort((a,b) => (b.val - a.val) || a.key.localeCompare(b.key));

  const top1 = vals[0] || { key: null, val: 0 };
  const top2 = vals[1] || { key: null, val: 0 };

  // For variants: sum the selected values (1 or 2), no “+2” substitution.
  const usedVals = vals.slice(0, 2);
  const natureSum = usedVals.reduce((acc, v) => acc + (+v.val || 0), 0);

  return {
    ms: mag + skillVal + natureSum,
    useOne: chosenKeys.length === 1,
    pick: usedVals.map(v => v.val),
    mag,
    skillVal,
    top1: top1.val,
    top2: top2.val,
    pickNames: usedVals.map(v => v.key),
    chosen: chosenKeys
  };
}

function msBonusForLinkedRules(school, variantUsedNatures) {
  const list = loadBonuses() || [];
  const linked = (school.linked_intensities || []).map(lc);
  const usedSet = new Set((variantUsedNatures || []).map(lc)); // for variant rows
  // how many natures are actually used in this row (1-nature option gate)
  const usedCount = (variantUsedNatures && variantUsedNatures.length) ? variantUsedNatures.length
                    : Math.min(2, linked.length); // for base school rows we’re using either 1+2 or 2

  let sum = 0;
  for (const b of list){
    if (b.type !== "ms") continue;

    // Gate by “apply only to 1 nature”
    if (b.onlySingleNature && usedCount !== 1) continue;

    const t = (b.targets || []).map(lc);

    // Linked to elements (base + optional variants)
    if (b.on === "linked_any" || b.on === "linked_all" || b.on === "linked_any_with_variants" || b.on === "linked_all_with_variants") {
      const baseHitAny = t.some(x => linked.includes(x));
      const baseHitAll = t.every(x => linked.includes(x));
      const wantAll    = (b.on === "linked_all" || b.on === "linked_all_with_variants");
      let hit = wantAll ? baseHitAll : baseHitAny;

      // If “with_variants” is chosen, also consider the chosen variant natures
      const includeVariants = (b.on === "linked_any_with_variants" || b.on === "linked_all_with_variants");
      if (includeVariants && usedSet.size){
        const usedHitAny = t.some(x => usedSet.has(x));
        const usedHitAll = t.every(x => usedSet.has(x));
        hit = wantAll ? (baseHitAll || usedHitAll) : (baseHitAny || usedHitAny);
      }

      if (hit) sum += +b.value || 0;
      continue;
    }

    // Legacy “natures” = apply once if ALL chosen natures are used in this row
    if (b.on === "natures"){
      const usedHitAll = t.length && t.every(x => usedSet.has(x));
      if (usedHitAll) sum += +b.value || 0;
    }
  }
  return sum;
}

  function msBonusForUsedNatures(usedNatures){
    const list = loadBonuses() || [];
    const usedSet = new Set((usedNatures||[]).map(lc));
    let sum = 0;
    for (const b of list){
      if (b.type !== "ms") continue;
      if (b.on === "natures"){
        const targets = (b.targets||[]).map(lc);
        // Apply once if ALL selected targets are present in the used natures
        if (targets.length && targets.every(t => usedSet.has(t))) {
          sum += +b.value || 0;
        }
      }
    }
    return sum;
  }

  if (!spellList || !schools.length) return [];
  const iv = normalizeIV(spellList.initial_values || {});
  const out = [];

  // base (non-upgrade) schools
  for (const sch of schools){
    if (sch.upgrade) continue;
    const b = bestMSForSchool(iv, sch, {forceTwo: isComplexNeedsTwo(sch)});
    const extra = msBonusForSchoolId(sch.id) + msBonusForUsedNatures(b.pickNames) + msBonusForLinkedRules(sch, b.pickNames);
    const ms = b.ms + extra;
    const cat = mapCategory(ms);
    out.push({ school: sch, ms, cat, breakdown: b, bonus: extra });
  }

  // variants
  for (const v of loadVariants()){
    const sch = schools.find(s => lc(s.id||"") === lc(v.schoolId||""));
    if (!sch || sch.upgrade) continue;
    const b = msWithChosenNatures(iv, sch, v.natures||[]);
    const extra = msBonusForSchoolId(sch.id) + msBonusForUsedNatures(b.chosen) + msBonusForLinkedRules(sch, b.chosen);
    const ms = b.ms + extra;
    const cat = mapCategory(ms);
    out.push({ school: sch, ms, cat, breakdown: b, variant: {name:v.name, natures:v.natures}, bonus: extra });
  }

  return out;
}
function renderSchools(){
  const tbody = document.getElementById("schools-body");
  tbody.innerHTML = "";

  const nameFilter = lc(document.getElementById("filter-name").value);
  const minCat = document.getElementById("filter-min-cat").value;
  const sortBy = document.getElementById("sort-by").value;
  const typeFilter = (document.getElementById("filter-type")?.value || "").toLowerCase(); // NEW

  let rows = [...computed];

  const hideUnpinned = !!document.getElementById("hide-unpinned")?.checked;

  if (nameFilter) rows = rows.filter(r => lc(displayName(r)).includes(nameFilter));
  if (minCat) rows = rows.filter(r => CAT_ORDER[r.cat.name] >= CAT_ORDER[minCat]);

  if (typeFilter) {
    rows = rows.filter(r => {
      const t = lc(r.school?.school_type || "");
      return typeFilter === "simple" ? t === "simple"
           : typeFilter === "complex" ? t === "complex"
           : true;
    });
  }

  if (hideUnpinned) rows = rows.filter(r => isPinned(r.school.id));

  if (sortBy === "name_asc") {
    rows.sort((a,b)=> displayName(a).localeCompare(displayName(b)));
  } else {
    rows.sort((a,b)=>{
      const d = CAT_ORDER[b.cat.name] - CAT_ORDER[a.cat.name];
      if (d!==0) return d;
      if (b.ms !== a.ms) return b.ms - a.ms;
      return displayName(a).localeCompare(displayName(b));
    });
  }

  if (!rows.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="empty">No schools match the current filters.</td>`;
    tbody.appendChild(tr); return;
  }

  for (const r of rows){
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    const pinStar = isPinned(r.school.id) ? "★" : "☆";
    tdName.innerHTML = `<div class="row" style="align-items:center; gap:8px;">
      <button class="btn small" data-pin="${r.school.id}" title="${isPinned(r.school.id)?'Unpin':'Pin'}">${pinStar}</button>
      <div class="k">${displayName(r)}</div>
    </div>`;
    tr.appendChild(tdName);

    const tdLinked = document.createElement("td");
    const ints = (r.school.linked_intensities||[]).join(", ");
    tdLinked.innerHTML = `
      <div>Skill: <span class="k">${r.school.linked_skill || "-"}</span></div>
      <div>Intensities: <span class="k">${ints || "-"}</span></div>
      ${r.variant ? "" : `<div style="margin-top:6px;"><button class="btn btn-secondary small" data-variant="${r.school.id}">Add Variant</button></div>`}
    `;
    tr.appendChild(tdLinked);

    const tdBreak = document.createElement("td");
    const bd = r.breakdown;
    const pickTxt = r.variant
      ? (r.variant.natures||[]).map(title).join(" + ")
      : (bd.useOne ? `${bd.top1} + 2` : `${bd.top1} + ${bd.top2}`);
    tdBreak.innerHTML = `MAG ${bd.mag} + Skill ${bd.skillVal} + ${pickTxt}`;
    tr.appendChild(tdBreak);

    const tdMS = document.createElement("td");
    tdMS.innerHTML = `<span class="badge ok">MS ${r.ms}</span>`;
    tr.appendChild(tdMS);

    const tdCat = document.createElement("td");
    tdCat.innerHTML = `<div class="k">${r.cat.name}</div><div class="muted">${r.cat.days} days</div>`;
    tr.appendChild(tdCat);

    tbody.appendChild(tr);
  }
  tbody.querySelectorAll("[data-variant]").forEach(btn=>{
    btn.addEventListener("click", ()=> openVariant(btn.getAttribute("data-variant")));
  });
}

/* =========================
   My Spells: render with Status, Meta, Export
========================= */
function updateCounts(){
  try{
    const knownSpells = (mySpells||[]).filter(sp => (getSpellMeta(sp.id).status || "known") === "known");

    const simpleOnly = knownSpells.filter(isSimpleOnlySpell).length;
    const complex    = knownSpells.filter(isComplexSpell).length;

    const a = document.getElementById("count-simple-spells");
    const b = document.getElementById("count-complex-spells");
    if (a) a.textContent = `Simple Spells: ${simpleOnly}`;
    if (b) b.textContent = `Complex Spells: ${complex}`;
  }catch{}
}

async function loadMySpells(){
  document.getElementById("my-spells-card").style.display = "block";
  const tbody = document.getElementById("my-spells-body");
  tbody.innerHTML = `<tr><td colspan="7" class="empty">Loading…</td></tr>`;
  mySpells = await fetchListSpells();

  if (!mySpells.length){
    tbody.innerHTML = `<tr><td colspan="7" class="empty">No spells yet. Click “Add Spells”.</td></tr>`;
    updateCounts();
    return;
  }
  tbody.innerHTML = "";

  for (const sp of mySpells){
    const tr = document.createElement("tr");
    const schTxt = (sp.schools||[]).map(s=>s.name).join(", ");
    const ok = eligibleForSpell(sp);

    const m = getSpellMeta(sp.id);
    const displayAlt = m.altName || "";

    // Row cells
    const nameHTML = `<div class="k">${sp.name}</div><div class="muted">id: ${sp.id}</div>`;
    const statusHTML = `
      <select class="sl-status" data-status="${sp.id}">
        <option value="learnt" ${m.status==="learnt"?"selected":""}>Learnt</option>
        <option value="known"  ${m.status==="known" ?"selected":""}>Known</option>
      </select>
    `;

    tr.innerHTML = `
      <td>${nameHTML}</td>
      <td>${displayAlt ? `<span class="k">${displayAlt}</span>` : `<span class="muted">—</span>`}</td>
      <td>${schTxt||"—"}</td>
      <td>${sp.category || "—"}</td>
      <td>${statusHTML}</td>
      <td><span class="badge ${ok?"ok":"warn"}">${ok?"Eligible":"Insufficient Level"}</span></td>
      <td>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-secondary small" data-meta="${sp.id}">Edit Meta</button>
          <button class="btn small" data-export="${sp.id}">Export</button>
          <button class="btn btn-flag small" data-remove="${sp.id}">Remove</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // Bind status changes
  tbody.querySelectorAll(".sl-status").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const id = sel.getAttribute("data-status");
      setSpellMeta(id, { status: sel.value });
      updateCounts();
    });
  });

  async function reloadSpellsAndSummarize(){
  const before = Array.isArray(mySpells) ? JSON.parse(JSON.stringify(mySpells)) : [];
  const beforeById = Object.fromEntries(before.map(s=>[String(s.id), s]));
  const summary = { changed:0, name:0, category:0, schools:0 };

  // re-fetch the list spells from server
  mySpells = await fetchListSpells();

  // diff
  for (const sp of mySpells){
    const old = beforeById[String(sp.id)];
    if (!old) continue;
    let changed = false;

    if ((old.name||"") !== (sp.name||"")) { summary.name++; changed = true; }
    if ((old.category||"") !== (sp.category||"")) { summary.category++; changed = true; }

    const oldSch = (old.schools||[]).map(s=>s.name||s.id).sort().join(",");
    const newSch = (sp.schools||[]).map(s=>s.name||s.id).sort().join(",");
    if (oldSch !== newSch) { summary.schools++; changed = true; }

    if (changed) summary.changed++;
  }

  // re-render the table and counts
  await loadMySpells();

  // print a short summary
  const el = document.getElementById("reload-summary");
  const parts = [];
  if (summary.changed===0) parts.push("No differences detected.");
  else {
    parts.push(`${summary.changed} spells changed`);
    if (summary.name) parts.push(`${summary.name} name`);
    if (summary.category) parts.push(`${summary.category} category`);
    if (summary.schools) parts.push(`${summary.schools} schools`);
  }
  el.textContent = `Reload complete — ${parts.join(", ")}.`;
}

document.getElementById("reload-spells").addEventListener("click", reloadSpellsAndSummarize);

  // Bind edit meta
  tbody.querySelectorAll("[data-meta]").forEach(btn=>{
    btn.addEventListener("click", ()=> openMetaEditor(btn.getAttribute("data-meta")));
  });

  // Bind export
  tbody.querySelectorAll("[data-export]").forEach(btn=>{
    btn.addEventListener("click", ()=> openExportFlow(btn.getAttribute("data-export")));
  });

  // Remove
  tbody.querySelectorAll("[data-remove]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-remove");
      await removeSpell(id);
      await loadMySpells();
    });
  });

  updateCounts();
}

/* =========================
   Variant Modal
========================= */
const varModal = document.getElementById("var-modal");
const varBackdrop = document.getElementById("var-backdrop");
const varChoices = document.getElementById("var-choices");
const varTitle = document.getElementById("var-school-title");
const varRule = document.getElementById("var-rule");
let varCurrentSchool = null;

function openVariant(schoolId){
  varCurrentSchool = schools.find(s => (s.id||"").toLowerCase() === String(schoolId||"").toLowerCase());
  if (!varCurrentSchool) return;

  varTitle.textContent = `For: ${varCurrentSchool.name}`;

  const ALL_NATURES = ["fire","water","wind","earth","sun","moon","lightning","ki"];
  varChoices.innerHTML = "";
  ALL_NATURES.forEach((k,i)=>{
    const id = `var-int-${i}`;
    const wrap = document.createElement("label");
    wrap.className = "pill"; wrap.style.cursor = "pointer";
    wrap.innerHTML = `<input type="checkbox" id="${id}" value="${k}" style="margin-right:6px;"> ${title(k)}`;
    varChoices.appendChild(wrap);
  });
  const complexTwo = isComplexNeedsTwo(varCurrentSchool); // complex schools must pick exactly 2
  varRule.textContent = complexTwo
    ? "Complex school: select exactly 2 natures."
    : "Simple school: select 1 or 2 natures.";

  document.getElementById("var-name").value = "";
  document.getElementById("var-status").textContent = "";
  openModal(varModal, varBackdrop);
}
function closeVariant(){ closeModal(varModal, varBackdrop); }

function saveVariant(){
  const checks = Array.from(varChoices.querySelectorAll("input[type=checkbox]:checked"));
  const chosen = checks.map(c=>c.value);
  const name = document.getElementById("var-name").value.trim();
  const statusEl = document.getElementById("var-status");
  const complexTwo = isComplexNeedsTwo(varCurrentSchool);

  if (!name){ statusEl.textContent = "Enter a variant name."; return; }
  if (complexTwo && chosen.length !== 2){
    statusEl.textContent = "Select exactly 2 natures for complex schools."; return;
  }
  if (!complexTwo && (chosen.length < 1 || chosen.length > 2)){
    statusEl.textContent = "Select 1 or 2 natures."; return;
  }

  addVariant(varCurrentSchool.id, name, chosen);
  computed = computeAll();
  renderSchools();
  closeVariant();
}
// ===== Bonuses UI =====
const bonModal = document.getElementById("bon-modal");
const bonBackdrop = document.getElementById("bon-backdrop");
const bonBody = document.getElementById("bon-body");
const bonEditor = document.getElementById("bonus-editor");

function openBonuses(){
  renderBonuses();
  bonEditor.style.display = "none";
  openModal(bonModal, bonBackdrop);
}
function closeBonuses(){ closeModal(bonModal, bonBackdrop); }

// RENDER TABLE
function renderBonuses(){
  const list = loadBonuses();
  bonBody.innerHTML = "";
  if (!Array.isArray(list) || !list.length){
    bonBody.innerHTML = `<tr><td colspan="6" class="empty">No bonuses yet.</td></tr>`;
    return;
  }
  const schoolById = Object.fromEntries((schools||[]).map(s=>[String(s.id||s.name), s]));

  list.forEach((b, idx)=>{
    const onScope   = b.on === "all" ? "All" : "Schools";
    const targetsTxt =
      (b.on === "all") ? "—"
      : (b.on === "natures")
          ? (Array.isArray(b.targets) && b.targets.length
              ? b.targets.map(t => title(t)).join(", ")
              : "—")
          : (Array.isArray(b.targets) && b.targets.length
              ? b.targets.map(t => (schoolById[t]?.name || t)).join(", ")
              : "—");
    const typeTxt   = b.type === "ms" ? "MS" : (b.type || "—");
    const valueTxt  = (b.value >= 0 ? "+" : "") + String(b.value ?? 0);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${onScope}</td>
      <td>${escapeHtml(b.name || "—")}</td>
      <td>${typeTxt}</td>
      <td>${targetsTxt}</td>
      <td>${valueTxt}</td>
      <td style="text-align:right;">
        <button class="btn btn-flag small" data-bon-del="${idx}">Delete</button>
      </td>
    `;
    bonBody.appendChild(tr);
  });

  bonBody.querySelectorAll("[data-bon-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = +btn.getAttribute("data-bon-del");
      const list = loadBonuses();
      list.splice(idx, 1);
      saveBonuses(list);
      renderBonuses();
      computed = computeAll();
      renderSchools();
    });
  });
}

// OPEN EDITOR
function openBonusEditor(){
  // Build editor UI
const schoolOptions = (schools||[])
  .filter(s => !s.upgrade)
  .map(s => `<label class="pill" style="cursor:pointer;"><input type="checkbox" value="${s.id}" style="margin-right:6px;"> ${escapeHtml(s.name||s.id)}</label>`)
  .join(" ");

const natureOptions = ['fire','water','wind','earth','sun','moon','lightning','ki']
  .map(n => `<label class="pill" style="cursor:pointer;"><input type="checkbox" value="${n}" style="margin-right:6px;"> ${title(n)}</label>`)
  .join(" ");

bonEditor.innerHTML = `
  <div class="row" style="margin-bottom:8px;">
    <div style="min-width:260px;">
      <label class="k">Target</label>
      <select id="be-on">
        <option value="all">All Schools of Magic</option>
        <option value="schools">Some Schools (checked)</option>
        <option value="linked_any">All schools originally linked to ≥1 of the elements checked</option>
        <option value="linked_all">All schools originally linked to all the elements checked</option>
        <option value="linked_any_with_variants">Schools originally linked (+ their Variants) to ≥1 of the elements checked</option>
        <option value="linked_all_with_variants">Schools originally linked (+ their Variants) to all the elements checked</option>
        <option value="natures">BONUS when ALL chosen natures are actually used</option>
      </select>
      <label class="mini" style="display:flex; align-items:center; gap:6px; margin-top:8px;">
        <input type="checkbox" id="be-only-one-nature"> Apply only to schools/variants that use 1 nature
      </label>
    </div>

    <!-- Shown when picking “Some Schools” -->
    <div id="be-schools-wrap" style="flex:1; display:none;">
      <div class="k" style="margin-bottom:6px;">Pick Schools</div>
      <div id="bonus-schools">
        <!-- inserted from JS: list of checkboxes for base schools -->
      </div>
    </div>

    <!-- Shown when picking linked/nature logic -->
    <div id="be-natures-wrap" style="flex:1; display:none;">
      <div class="k" style="margin-bottom:6px;">Pick Elements</div>
      <div id="bonus-natures">
        <!-- inserted from JS: fire/water/… -->
      </div>
    </div>
  </div>
`;
document.getElementById("bonus-schools").innerHTML = schoolOptions;
document.getElementById("bonus-natures").innerHTML = natureOptions;
bonEditor.style.display = "block";

// scope toggle
const beOn = document.getElementById("be-on");
const beSchoolsWrap = document.getElementById("be-schools-wrap");
const beNaturesWrap = document.getElementById("be-natures-wrap");
function syncTargetVisibility() {
  const v = beOn.value;
  beSchoolsWrap.style.display = (v === "schools") ? "block" : "none";
  beNaturesWrap.style.display = (v === "linked_any" || v === "linked_all" || v === "linked_any_with_variants" || v === "linked_all_with_variants" || v === "natures") ? "block" : "none";
}
beOn.addEventListener("change", syncTargetVisibility);
syncTargetVisibility();

// actions
document.getElementById("be-cancel").addEventListener("click", ()=> bonEditor.style.display="none");
document.getElementById("be-save").addEventListener("click", ()=>{
  const name  = (document.getElementById("be-name").value || "").trim();
  const type  = document.getElementById("be-type").value || "ms";
  const value = parseInt(document.getElementById("be-value").value || "0", 10);
  const on    = beOn.value;
  const onlySingleNature = !!document.getElementById("be-only-one-nature").checked;

  if (!name){ alert("Enter a name."); return; }
  if (Number.isNaN(value)){ alert("Enter a numeric value."); return; }

  let targets = [];
  if (on === "schools"){
    targets = Array.from(document.querySelectorAll("#bonus-schools input[type=checkbox]:checked")).map(c=>c.value);
    if (!targets.length){ alert("Pick at least one school."); return; }
  } else if (on === "linked_any" || on === "linked_all" || on === "linked_any_with_variants" || on === "linked_all_with_variants" || on === "natures"){
    targets = Array.from(document.querySelectorAll("#bonus-natures input[type=checkbox]:checked")).map(c=>c.value);
    if (!targets.length){ alert("Pick at least one element."); return; }
  }

  const list = loadBonuses() || [];
  list.push({
    id: `bon_${Date.now()}`,
    name, type, value,
    on,
    targets, 
    onlySingleNature
  });
  saveBonuses(list);
  bonEditor.style.display = "none";
  renderBonuses();
  computed = computeAll();
  renderSchools();
});
}

/* =========================
   Meta Editor (alt name + flavor)
========================= */
const metaModal = document.getElementById("meta-modal");
const metaBackdrop = document.getElementById("meta-backdrop");
let META_TARGET_ID = null;

function openMetaEditor(spellId){
  META_TARGET_ID = spellId;
  const sp = mySpells.find(s=>String(s.id)===String(spellId));
  const { altName, flavor } = getSpellMeta(spellId);
  document.getElementById("meta-spell-title").textContent = `${sp?.name || "Spell"} [${spellId}]`;
  document.getElementById("meta-altname").value = altName || "";
  document.getElementById("meta-flavor").innerHTML = flavor || "";
  openModal(metaModal, metaBackdrop);
}
function saveMetaEditor(){
  const altName = document.getElementById("meta-altname").value.trim();
  const flavor = document.getElementById("meta-flavor").innerHTML.trim();
  setSpellMeta(META_TARGET_ID, { altName, flavor });
  closeModal(metaModal, metaBackdrop);
  loadMySpells(); // refresh alt name column
}

/* Rich text buttons for meta */
document.addEventListener("click", (e)=>{
  if (e.target && e.target.getAttribute("data-rt")){
    e.preventDefault();
    execRTOn(document.getElementById("meta-flavor"), e.target.getAttribute("data-rt"));
  }
});

/* =========================
   Export Flow (mirrors export.html)
========================= */
// Preload effects for nice descriptions
async function loadAllSchools(){ // for export filters if needed
  const res = await fetch(`${API_BASE}/schools`);
  const data = await res.json();
  ALL_SCHOOLS = data.schools || [];
}
async function loadEffects(){
  const res = await fetch(`${API_BASE}/effects`);
  const data = await res.json();
  const lookup = {};
  // map school id → name where possible
  const byId = Object.fromEntries((ALL_SCHOOLS||[]).map(s => [String(s.id), s]));
  ALL_EFFECTS = (data.effects || []).map(e=>{
    const sid = String(e.school || "").trim();
    const sch = byId[sid] || { id: sid, name: sid };
    return { ...e, school: { id: sch.id, name: sch.name } };
  });
}
function countsByEffect(sp){
  const counts = {};
  (sp.effects || []).forEach(eid => {
    const k = String(eid);
    counts[k] = (counts[k] || 0) + 1;
  });
  return counts;
}
function buildExportFields(sp){
  return [
    ["MP Cost", sp.mp_cost ?? 0],
    ["EN Cost", sp.en_cost ?? 0],
    ["Activation", sp.activation ?? "—"],
    ["Range", sp.range ?? "—"],
    ["AoE", sp.aoe ?? "—"],
    ["Duration", sp.duration ?? "—"],
    ["Category", sp.category ?? "—"]
  ];
}
function copyTextById(spanId){
  const text = document.getElementById(spanId).innerText;
  navigator.clipboard.writeText(String(text)).then(()=>alert("Copied."), ()=>alert("Copy failed."));
}
async function copyRich(html){
  try{
    const blobHtml = new Blob([html], { type: "text/html" });
    const tmp = document.createElement("div"); tmp.innerHTML = html;
    const plain = tmp.innerText;
    await navigator.clipboard.write([new ClipboardItem({"text/html": blobHtml, "text/plain": new Blob([plain], { type: "text/plain" })})]);
    alert("Description copied (with formatting).");
  }catch(err){
    // Fallback
    const el = document.getElementById("description-preview");
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges(); sel.addRange(range);
    document.execCommand("copy");
    sel.removeAllRanges();
    alert("Description copied.");
  }
}

function buildFoundryHTML(titleText, fields, descHTML){
  // one self-contained table with inline styles (safe for Foundry chat)
  const fieldRows = fields.map(([label, val]) => `
    <tr>
      <td style="border:1px solid #666; padding:6px 8px; font-weight:600; white-space:nowrap;">${escapeHtml(label)}</td>
      <td style="border:1px solid #666; padding:6px 8px;">${escapeHtml(String(val ?? "—"))}</td>
    </tr>
  `).join("");

  return `
  <div class="noe-spell" style="font-family: sans-serif; line-height:1.4;">
    <table style="border-collapse:collapse; width:100%; margin:0;">
      <thead>
        <tr>
          <th colspan="2" style="text-align:left; border:1px solid #666; padding:8px 10px; background:#111; color:#fff;">
            ${escapeHtml(titleText)}
          </th>
        </tr>
      </thead>
      <tbody>
        ${fieldRows}
        <tr>
          <td style="border:1px solid #666; padding:6px 8px; font-weight:600; white-space:nowrap;">Description</td>
          <td style="border:1px solid #666; padding:6px 8px;">${descHTML}</td>
        </tr>
      </tbody>
    </table>
  </div>`;
}

const expModal = document.getElementById("exp-modal");
const expBackdrop = document.getElementById("exp-backdrop");
let EXPORT_TARGET_ID = null;

function openExportFlow(spellId){
  EXPORT_TARGET_ID = spellId;
  const m = getSpellMeta(spellId);
  document.getElementById("exp-flavour").innerHTML = (m.flavor || "");
  document.getElementById("exp-modal-title").textContent = `Export Spell — ${spellId}`;
  openModal(expModal, expBackdrop);
}
function closeExportModal(){ closeModal(expModal, expBackdrop); }

async function continueExport(){
  try{
    // fetch fresh details (includes effects array)
    const sp = await fetchSpellById(EXPORT_TARGET_ID);
    const m = getSpellMeta(EXPORT_TARGET_ID);
    const altName = (m.altName || "").trim();
    const flavourHTML = document.getElementById("exp-flavour").innerHTML.trim();

    // build description
    const counts = countsByEffect(sp);
    const byId = Object.fromEntries(ALL_EFFECTS.map(e => [String(e.id), e]));
    const effectLines = Object.entries(counts).map(([eid, count])=>{
      const e = byId[eid] || { name:`[${eid}]`, description:"" };
      const suffix = count > 1 ? ` [x${count}]` : "";
      const desc = (e.description || "").trim();
      return `<div><b>${e.name}${suffix}</b>: ${desc}</div>`;
    }).join("");

    const sep = `<hr style="border:0;border-top:1px solid #c02d2d;margin:10px 0;">`;
    const descHTML = (flavourHTML ? `${flavourHTML}${sep}` : "") + `<div style="font-style:italic">${effectLines}</div>`;

    // Title prefers alt name
    const displayName = `${altName || sp.name} [${sp.id}]`;
    document.getElementById("exp-title").textContent = displayName;

    // Fields with copy buttons
    const fields = buildExportFields(sp);
    const fieldsWrap = document.getElementById("exp-fields");
    fieldsWrap.innerHTML = "";
    fields.forEach(([label, val])=>{
      const id = `copy-${label.replace(/\s+/g,'-').toLowerCase()}`;
      fieldsWrap.insertAdjacentHTML("beforeend", `
        <div style="display:flex; justify-content:space-between; align-items:center; border:1px solid #c02d2d; padding:10px; border-radius:10px;">
          <div><strong>${label}:</strong> <span id="${id}-val">${val}</span></div>
          <button class="btn btn-secondary" onclick="copyTextById('${id}-val')">Copy</button>
        </div>
      `);
    });

    // Description block + copy
    document.getElementById("description-preview").innerHTML = descHTML;
    document.getElementById("copy-description").onclick = ()=>copyRich(descHTML);

    document.getElementById("copy-foundry").onclick = ()=>{
      const html = buildFoundryHTML(displayName, fields, descHTML);
      copyRich(html);
    };
    
    closeExportModal();
    document.getElementById("export-view").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }catch(e){
    alert("Export failed: " + e.message);
  }
}

/* =========================
   Boot
========================= */
function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

document.addEventListener("DOMContentLoaded", async ()=>{
  // token & list
  token = localStorage.getItem("auth_token") || "";
  listId = qs("id");
  PINNED = loadPins();

  // topbar auth chip minimal
  const me = await apiMe();
  const chip = document.getElementById("user-chip");
  const chipName = document.getElementById("chip-name");
  const openLogin = document.getElementById("open-login");
  if (me.ok){
    chip.style.display="flex"; chipName.textContent = me.user?.user?.username || "User";
    openLogin.style.display="none";
    document.getElementById("chip-logout").onclick = ()=>{ localStorage.removeItem("auth_token"); location.reload(); };
  }else{
    chip.style.display="none"; openLogin.style.display="inline-flex";
    openLogin.onclick = ()=> document.getElementById("gate-login").click();
  }

  // Auth gate for the list fetch
  try{
    spellList = await fetchSpellList(listId);
    document.getElementById("list-name").textContent = spellList.name || "Spell List";
    document.getElementById("list-meta").textContent = `Owner: ${spellList.owner || "-"} • ID: ${listId}`;
    document.getElementById("auth-gate").style.display = "none";
  }catch(e){
    document.getElementById("auth-gate").style.display = "block";
    document.getElementById("content").style.display = "none";
    document.getElementById("gate-login").onclick = ()=> document.getElementById("open-login").click();
    return;
  }

  // Load schools & compute
  schools = await fetchSchools();
  refreshUpgradeSets();
  computed = computeAll();
  buildMinCatSelect();
  document.getElementById("content").style.display = "grid";  
  renderSchools();

  await fetchListMeta();

  computed = computeAll();
  renderSchools();

  await loadMySpells();

  // Add modal — fill school select
  const sel = document.getElementById("as-school");
  sel.innerHTML = `<option value="">Any school</option>`;
  for (const s of schools){
    const opt = document.createElement("option"); opt.value = s.id || s.name; opt.textContent = s.name || s.id; sel.appendChild(opt);
  }

  // Export data helpers (effects)
  await loadAllSchools();
  await loadEffects();

  // Controls
  document.getElementById("recalc").addEventListener("click", ()=>{ computed = computeAll(); renderSchools(); });
  const run = debounce(()=>renderSchools(), 250);
  document.getElementById("filter-name").addEventListener("input", run);
  document.getElementById("filter-min-cat").addEventListener("change", run);
  document.getElementById("sort-by").addEventListener("change", run);
  document.getElementById("filter-type").addEventListener("change", run);
  document.getElementById("hide-unpinned").addEventListener("change", ()=>renderSchools());


  // Add Spells modal open/close
  const asModal = document.getElementById("addspells-modal");
  const asBackdrop = document.getElementById("addspells-backdrop");
  document.getElementById("open-add-spells").addEventListener("click", ()=>{
    openModal(asModal, asBackdrop);
    document.getElementById("as-q").focus();
  });
  function closeAdd(){ closeModal(asModal, asBackdrop); document.getElementById("as-status").textContent=""; }
  document.getElementById("addspells-close").addEventListener("click", closeAdd);
  document.getElementById("addspells-cancel").addEventListener("click", closeAdd);
  asBackdrop.addEventListener("click", (e)=>{ if(e.target===asBackdrop) closeAdd(); });

  // Add Spells search & add
  async function runSearch(){
    const q = document.getElementById("as-q").value.trim();
    const school = document.getElementById("as-school").value;
    const cat = document.getElementById("as-category").value;
    const list = await searchSpells(q, school, cat);
    const body = document.getElementById("as-results");
    if (!list.length){ body.innerHTML = `<tr><td colspan="5" class="empty">No results.</td></tr>`; return; }
    body.innerHTML = "";
    for (const sp of list){
      const ok = eligibleForSpell(sp);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="as-chk" value="${sp.id}"></td>
        <td><div class="k">${sp.name}</div><div class="muted">id: ${sp.id}</div></td>
        <td>${(sp.schools||[]).map(s=>s.name).join(", ") || "—"}</td>
        <td>${sp.category || "—"}</td>
        <td><span class="badge ${ok?"ok":"warn"}">${ok?"Eligible":"Insufficient Level"}</span></td>
      `;
      body.appendChild(tr);
    }
    // Check-all
    document.getElementById("as-check-all").checked = false;
  }
  document.getElementById("as-search").addEventListener("click", runSearch);
  document.getElementById("as-q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runSearch(); });
  document.getElementById("as-check-all").addEventListener("change", (e)=>{
    document.querySelectorAll(".as-chk").forEach(cb => cb.checked = e.target.checked);
  });
  document.getElementById("as-add-selected").addEventListener("click", async ()=>{
    const ids = Array.from(document.querySelectorAll(".as-chk:checked")).map(cb=>cb.value);
    if (!ids.length){ document.getElementById("as-status").textContent="Select at least one spell."; return; }
    await addSpells(ids);
    document.getElementById("as-status").textContent = `Added ${ids.length} spell(s).`;
    await loadMySpells();
  });

  // IV edit modal bindings (kept minimal)
  const ivModal = document.getElementById("iv-modal");
  const ivBackdrop = document.getElementById("iv-backdrop");
  document.getElementById("edit-iv").addEventListener("click", ()=>{
    // prefill current IV
    const iv = spellList.initial_values || {};
    document.getElementById("iv-mag-input").value = iv.mag ?? 0;
    const n = iv.natures || {}, s = iv.skills || {};
    (["fire","water","wind","earth","sun","moon","lightning","ki"]).forEach(k => document.getElementById(`iv-${k}`).value = n[k] ?? 0);
    (["aura","incantation","enchantement","potential","restoration","stealth","investigation","charm","intimidation","absorption","spirit"]).forEach(k => document.getElementById(`iv-${k}`).value = s[k] ?? 0);
    openModal(ivModal, ivBackdrop);
  });
  document.getElementById("iv-close").addEventListener("click", ()=>closeModal(ivModal, ivBackdrop));
  document.getElementById("iv-cancel").addEventListener("click", ()=>closeModal(ivModal, ivBackdrop));
  document.getElementById("iv-save").addEventListener("click", async ()=>{
    // collect and save
    const iv = {
      mag: +document.getElementById("iv-mag-input").value || 0,
      natures: Object.fromEntries(["fire","water","wind","earth","sun","moon","lightning","ki"].map(k => [k, +document.getElementById(`iv-${k}`).value || 0])),
      skills: Object.fromEntries(["aura","incantation","enchantement","potential","restoration","stealth","investigation","charm","intimidation","absorption","spirit"].map(k => [k, +document.getElementById(`iv-${k}`).value || 0])),
    };
    await updateSpellList(listId, { initial_values: iv });
    spellList = await fetchSpellList(listId);
    renderIVChips(normalizeIV(iv));
    computed = computeAll(); renderSchools();
    closeModal(ivModal, ivBackdrop);
  });

  // Variant modal save
  document.getElementById("var-close").addEventListener("click", ()=>closeVariant());
  document.getElementById("var-cancel").addEventListener("click", ()=>closeVariant());
  document.getElementById("var-save").addEventListener("click", saveVariant);

  // Bonuses open
  document.getElementById("open-bonuses").addEventListener("click", openBonuses);
  document.getElementById("bon-close").addEventListener("click", closeBonuses);
  bonBackdrop.addEventListener("click", (e)=>{ if(e.target===bonBackdrop) closeBonuses(); });
  document.getElementById("bon-add").addEventListener("click", openBonusEditor);

  // Meta modal
  document.getElementById("meta-close").addEventListener("click", ()=>closeModal(metaModal, metaBackdrop));
  document.getElementById("meta-cancel").addEventListener("click", ()=>closeModal(metaModal, metaBackdrop));
  document.getElementById("meta-save").addEventListener("click", saveMetaEditor);
  metaBackdrop.addEventListener("click", (e)=>{ if(e.target===metaBackdrop) closeModal(metaModal, metaBackdrop); });

  // Export modal
  document.getElementById("exp-close").addEventListener("click", closeExportModal);
  document.getElementById("exp-cancel").addEventListener("click", closeExportModal);
  document.getElementById("exp-continue").addEventListener("click", continueExport);
  expBackdrop.addEventListener("click", (e)=>{ if(e.target===expBackdrop) closeExportModal(); });

  // Rich text buttons for export flavour
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.getAttribute("data-exp-rt")){
      e.preventDefault();
      execRTOn(document.getElementById("exp-flavour"), e.target.getAttribute("data-exp-rt"));
    }
  });

  // Render IV chips initially
  renderIVChips(normalizeIV(spellList.initial_values || {}));
});

/* =========================
   Tiny helpers used by export fields
========================= */
window.copyTextById = copyTextById;


// Delegated clicks for dynamic [data-pin] buttons
document.addEventListener("click", (e)=>{
  const btn = e.target && (e.target.closest ? e.target.closest("[data-pin]") : null);
  if (btn){
    e.preventDefault();
    const sid = btn.getAttribute("data-pin");
    if (sid) togglePin(sid);
  }
});

</script>
</body>
</html>