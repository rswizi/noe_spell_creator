<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weapons — Edit</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .row{display:flex;gap:8px;align-items:center}
    .grid{display:grid;gap:8px;grid-template-columns:1fr 90px 70px 90px 110px 90px auto;align-items:center}
    .muted{opacity:.8}.pill{display:inline-block;padding:2px 8px;border:1px solid #444;border-radius:999px}
    .mod-row{display:grid;grid-template-columns:1fr 0.9fr 0.6fr 1fr auto;gap:6px;align-items:center}
  </style>
</head>
<body>
<div class="container">
  <h1>Edit Weapons</h1>

  <div class="home-card">
    <div class="row">
      <input id="q" type="text" placeholder="Filter by name..." />
      <button id="refresh" class="btn small">Refresh</button>
      <span id="info" class="muted" style="margin-left:auto;"></span>
    </div>
  </div>

  <div class="home-card" id="list">Loading…</div>

  <a class="btn btn-secondary" href="weapons_home.html" style="margin-top:12px;">← Back</a>
</div>

<!-- modal -->
<div id="modal" class="modal hidden" aria-hidden="true">
  <div class="modal-card" style="min-width:620px;">
    <button id="close" class="modal-close" aria-label="Close">&times;</button>
    <h3 id="m-title">Edit Weapon</h3>
    <div class="row" style="gap:12px;flex-wrap:wrap;">
      <label>Name <input id="m-name" style="min-width:260px"/></label>
      <label>Skill
        <select id="m-skill">
          <option>Technicity</option><option>Brutality</option>
          <option>Accuracy</option><option>Aura</option>
        </select>
      </label>
      <span class="pill" id="m-animarma">—</span>
    </div>
    <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:6px;">
      <label>Damage <input id="m-damage" style="min-width:260px"/></label>
      <label>Range <input id="m-range" style="width:90px"/></label>
      <label>Hands <input id="m-hands" type="number" style="width:90px"/></label>
      <label>Enc. <input id="m-enc" type="number" step="0.1" style="width:90px"/></label>
    </div>
    <div class="row" style="margin-top:6px;">
      <label style="flex:1">Effects (comma separated)<br/><input id="m-effects" style="width:100%"/></label>
    </div>
    <div class="row" style="margin-top:6px;">
      <label style="flex:1">Tags (comma separated)<br/><input id="m-tags" style="width:100%"/></label>
    </div>
    <div class="row" style="margin-top:6px;">
      <label style="flex:1">Description<br/><textarea id="m-desc" rows="3" style="width:100%"></textarea></label>
    </div>
    <div class="row" style="margin-top:6px;">
      <label style="flex:1">Preinstalled upgrades (ids, comma — use id|target for targeted ones)<br/><input id="m-upgrades" style="width:100%"></label>
    </div>
    <div class="row" style="margin-top:6px;flex-direction:column;align-items:stretch;gap:8px;">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <strong>Modifiers</strong>
        <button id="mod-add" class="btn small" type="button">+ Modifier</button>
      </div>
      <div id="mod-list"></div>
    </div>
    <div class="row" style="gap:12px;align-items:center;margin-top:6px;">
      <label>Base Price <input id="m-price" type="number" style="width:120px"/></label>
      <label>Quality
        <select id="m-quality">
          <option value="Mediocre">Mediocre</option>
          <option value="Adequate" selected>Adequate</option>
          <option value="Good">Good</option><option value="Very Good">Very Good</option>
          <option value="Excellent">Excellent</option><option value="Legendary">Legendary</option>
          <option value="Mythical">Mythical</option><option value="Epic">Epic</option>
          <option value="Divine">Divine</option><option value="Unreal">Unreal</option>
        </select>
      </label>
      <span class="pill">Price @Quality: <span id="m-qprice">—</span></span>
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end;">
      <button id="save" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "";
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization":"Bearer "+token } : {};
let CACHE=[], EDIT_ID=null;
const modListEl = document.getElementById("mod-list");
const MOD_TARGETS = [
    "char.reflex","char.dexterity","char.body","char.wisdom","char.presence","char.magic","char.willpower","char.tech",
    "skills.reflex.Technicity","skills.reflex.Dodge","skills.reflex.Counter","skills.reflex.Reactivity",
    "skills.dexterity.Accuracy","skills.dexterity.Evasion","skills.dexterity.Stealth","skills.dexterity.Acrobatics",
    "skills.body.Brutality","skills.body.Blocking","skills.body.Resistance","skills.body.Athletics",
    "skills.wisdom.Survival","skills.wisdom.Education","skills.wisdom.Perception","skills.wisdom.Psychology","skills.wisdom.Investigation",
    "skills.presence.Taming","skills.presence.Charm","skills.presence.Charisma","skills.presence.Deception","skills.presence.Persuasion",
    "skills.magic.Aura","skills.magic.Incantation","skills.magic.Enchantment","skills.magic.Restoration","skills.magic.Potential",
    "skills.willpower.Intimidation","skills.willpower.Spirit","skills.willpower.Instinct","skills.willpower.Absorption",
    "skills.tech.Crafting","skills.tech.Sleight of hand","skills.tech.Alchemy","skills.tech.Medicine","skills.tech.Engineering",
    "derived.hp","derived.en","derived.fo","derived.mo","derived.spcap","derived.enc","derived.et","derived.tx","derived.craftomancy_max",
    "spell_slots.simple","spell_slots.complex",
    "__custom__"
  ];

function addModRow(container, initial={}){
  const row = document.createElement("div");
  row.className = "mod-row";
  const sel = document.createElement("select");
  MOD_TARGETS.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t === "__custom__" ? "Custom..." : t;
    if (t === (initial.target||"")) opt.selected = true;
    sel.appendChild(opt);
  });
  const custom = document.createElement("input");
  custom.placeholder = "Custom target";
  custom.value = (!MOD_TARGETS.includes(initial.target) ? (initial.target||"") : "");
  custom.style.display = (sel.value === "__custom__") ? "" : "none";
  sel.addEventListener("change", ()=>{
    custom.style.display = sel.value === "__custom__" ? "" : "none";
    if (sel.value !== "__custom__") custom.value = "";
  });
  const mode = document.createElement("select");
  ["add","mul","set"].forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m;
    if ((initial.mode||"add") === m) opt.selected = true;
    mode.appendChild(opt);
  });
  const val = document.createElement("input"); val.type="number"; val.step="0.1"; val.value = initial.value ?? 0;
  const note = document.createElement("input"); note.placeholder="Note"; note.value = initial.note || "";
  const rm = document.createElement("button"); rm.className="btn btn-secondary small"; rm.type="button"; rm.textContent="Remove"; rm.onclick=()=>row.remove();
  row.appendChild(sel); row.appendChild(custom); row.appendChild(mode); row.appendChild(val); row.appendChild(note); row.appendChild(rm);
  container.appendChild(row);
}
function setModifiers(container, mods){
  container.innerHTML = "";
  if (mods && mods.length){
    mods.forEach(m=> addModRow(container, m));
  } else {
    addModRow(container, {});
  }
}
function collectModifiers(container){
  const mods = [];
  container.querySelectorAll(".mod-row").forEach(row=>{
    const sel = row.querySelector("select");
    const custom = row.querySelector("input[placeholder='Custom target']");
    const target = sel.value === "__custom__" ? (custom.value||"").trim() : sel.value;
    if (!target) return;
    const mode = row.querySelectorAll("select")[1]?.value || "add";
    const val = parseFloat(row.querySelector("input[type='number']").value||"0");
    const note = row.querySelector("input[placeholder='Note']").value || "";
    mods.push({ target, mode, value: val, note });
  });
  return mods;
}

const QDIFF = {
  "Mediocre":-100, "Adequate":0, "Good":167, "Very Good":1390, "Excellent":5280,
  "Legendary":15300, "Mythical":38760, "Epic":128000, "Divine":614400, "Unreal":921600
};

function qPrice(base, qual){ return Math.max(0, (Number(base)||0) + (QDIFF[qual]||0)); }

function row(w){
  return `
    <div class="grid" style="border-bottom:1px solid #222;padding:6px 0;">
      <div><strong>${w.name}</strong> <span class="muted">[${w.id}]</span>
        <div class="muted small">${w.description||""}</div></div>
      <div style="text-align:center;">${w.skill||"Technicity"}</div>
      <div style="text-align:center;">${w.range}</div>
      <div style="text-align:center;">${w.hands}</div>
      <div style="text-align:center;">${w.price}</div>
      <div style="display:flex;gap:6px;justify-content:flex-end;">
        <button class="btn" onclick="openEdit('${w.id}')">Edit</button>
        <button class="btn btn-danger" onclick="delOne('${w.id}')">Delete</button>
      </div>
    </div>`;
}

function render(){
  const q = document.getElementById("q").value.trim().toLowerCase();
  let list = CACHE.slice();
  if (q) list = list.filter(o => (o.name||"").toLowerCase().includes(q));
  document.getElementById("list").innerHTML = list.length ? list.map(row).join("") : "<p>No results.</p>";
  document.getElementById("info").textContent = `${list.length}/${CACHE.length}`;
}
async function load(){
  const r = await fetch(`${API_BASE}/weapons`, { headers: authHeaders() });
  const j = await r.json().catch(()=>({}));
  CACHE = j.weapons || [];
  render();
}

/* modal */
function syncQuality(){
  const base = document.getElementById("m-price").value;
  const qual = document.getElementById("m-quality").value;
  document.getElementById("m-qprice").textContent = qPrice(base, qual);
}

function openEdit(id){
  const w = CACHE.find(x=>x.id===id); if(!w) return;
  EDIT_ID=id;
  document.getElementById("m-title").textContent = `Edit Weapon — ${w.name} [${w.id}]`;
  document.getElementById("m-name").value = w.name||"";
  document.getElementById("m-skill").value = w.skill||"Technicity";
  document.getElementById("m-animarma").textContent = w.is_animarma ? "Animarma" : "Standard";
  document.getElementById("m-damage").value = w.damage||"";
  document.getElementById("m-range").value  = w.range||"";
  document.getElementById("m-hands").value  = w.hands ?? 1;
  document.getElementById("m-enc").value    = w.enc ?? 0;
  document.getElementById("m-effects").value = (w.effects||[]).join(", ");
  document.getElementById("m-tags").value = (w.tags || []).join(", ");
  document.getElementById("m-desc").value   = w.description||"";
  document.getElementById("m-upgrades").value = (w.upgrades||[]).join(", ");
  setModifiers(modListEl, w.modifiers || []);
  document.getElementById("m-price").value  = w.price ?? 0;
  syncQuality();
  document.getElementById("modal").classList.remove("hidden");
  document.getElementById("modal").setAttribute("aria-hidden","false");
}
function closeEdit(){
  document.getElementById("modal").classList.add("hidden");
  document.getElementById("modal").setAttribute("aria-hidden","true");
  EDIT_ID=null;
}
document.getElementById("close").addEventListener("click", closeEdit);
const MODAL = document.getElementById("modal");
MODAL.addEventListener("click", (e) => {
  if (e.target === MODAL) closeEdit();
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !MODAL.classList.contains("hidden")) {
    closeEdit();
  }
});
document.getElementById("mod-add").addEventListener("click", ()=> addModRow(modListEl, {}));

document.getElementById("save").addEventListener("click", async ()=>{
  if(!EDIT_ID) return;
  const body={
    name: document.getElementById("m-name").value.trim() || "Unnamed",
    skill: document.getElementById("m-skill").value,
    damage: document.getElementById("m-damage").value.trim(),
    range:  String(document.getElementById("m-range").value).trim(),
    hands:  Number(document.getElementById("m-hands").value||1),
    enc:    Number(document.getElementById("m-enc").value||0),
    effects: document.getElementById("m-effects").value.split(",").map(s=>s.trim()).filter(Boolean),
    tags: document.getElementById("m-tags").value.trim(),
    description: document.getElementById("m-desc").value.trim(),
    price:  Number(document.getElementById("m-price").value||0),
    upgrades: document.getElementById("m-upgrades").value.split(",").map(s=>s.trim()).filter(Boolean),
    modifiers: collectModifiers(modListEl),
  };
  const r=await fetch(`/weapons/${EDIT_ID}`,{method:"PUT",headers:{ "Content-Type":"application/json", ...authHeaders() },body:JSON.stringify(body)});
  const j=await r.json().catch(()=>({}));
  if(j.status!=="success"){ alert(j.message||"Update failed."); return; }
  await load(); closeEdit();
});

async function delOne(id){
  if(!confirm(`Delete weapon ${id}?`)) return;
  const r=await fetch(`/weapons/${id}`,{method:"DELETE",headers:{...authHeaders()}});
  const j=await r.json().catch(()=>({}));
  if(j.status!=="success"){ alert(j.message||"Delete failed."); return; }
  CACHE=CACHE.filter(o=>o.id!==id); render();
}

document.addEventListener("DOMContentLoaded", ()=>{ load(); document.getElementById("refresh").addEventListener("click", load); document.getElementById("q").addEventListener("input", render); });

</script>
</body>
</html>
