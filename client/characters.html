<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE — My Characters</title>
  
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
  .page { min-height: 100vh; display: grid; place-items: start center; }
  .wrap { width: 100%; max-width: 880px; padding: 28px 16px; }
  .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
  .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .card { border:1px solid #333; border-radius:16px; padding:14px; background:#0d0d0d; }
  .muted { opacity:.8; font-size:.9rem; }
  button, a.btn, input { padding:8px 12px; border-radius:10px; border:1px solid #444; background:#111; color:#eaeaea; }
  .primary { background:#1d1d1d; }
</style>

</head>
<body>
  <div class="page"><div class="wrap">
    <div class="topbar">
      <h1>My Characters</h1>
      <a class="btn" href="portal.html">Portal</a>
      <span id="login-chip" class="muted" style="margin-left:auto;"></span>
      <a class="btn" id="admin-link" href="character_admin.html" style="display:none">All Characters</a>
    </div>

    <div style="margin-bottom:12px;">
      <button type="button" id="new-btn" class="primary">+ New Character</button>
      <span class="muted">Click a card to edit.</span>
    </div>

    <div id="list" class="grid"></div>
    <p id="empty-msg" class="muted" style="display:none">No characters yet. Click “New Character”.</p>
  </div></div>

<script>
function authHeaders() {
  const tok = localStorage.getItem('auth_token');
  return tok ? { 'Authorization': 'Bearer ' + tok } : {};
}
async function api(path, opt={}) {
  const headers = Object.assign({}, opt.headers || {}, authHeaders());
  const r = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = r.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await r.json() : { status:'error', message: await r.text() };
  if (!r.ok || data.status === 'error') throw new Error(data.message || `HTTP ${r.status}`);
  return data;
}
async function checkMe() {
  try {
    const me = await api('/auth/me');
    document.getElementById('login-chip').textContent = me.username + ' (' + me.role + ')';
    if (me.role === 'admin') document.getElementById('admin-link').style.display = '';
    return me;
  } catch (e) {
    document.getElementById('login-chip').textContent = 'Not logged in';
    throw e;
  }
}
function el(tag, attrs={}, ...kids) {
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) (k==='class') ? (n.className=v) :
    (k==='onclick') ? n.addEventListener('click', v) : n.setAttribute(k,v);
  for (const k of kids) n.append(k);
  return n;
}
async function loadList() {
  const data = await api('/characters');
  const list = document.getElementById('list');
  list.innerHTML = '';
  const arr = data.characters || [];
  document.getElementById('empty-msg').style.display = arr.length ? 'none' : '';
  for (const c of arr) {
    list.append(el('div', {class:'card', onclick: ()=>location.href='character_edit.html?id='+encodeURIComponent(c.id)},
      el('div', {}, c.name || '(unnamed)'),
      el('div', {class:'muted'}, 'ID: '+c.id)
    ));
  }
}
async function createNew() {
  const nm = prompt('Character name?', '') ?? '';
  const name = nm.trim() || 'New Character';
  const res = await api('/characters', {
    method:'POST',
    headers:{ 'content-type':'application/json' },
    body: JSON.stringify({ name })
  });
  // immediately go edit it
  location.href = 'character_edit.html?id=' + encodeURIComponent(res.id);
}
document.getElementById('new-btn').addEventListener('click', createNew);

// boot
checkMe().then(loadList).catch(()=>{}); // if not logged in, the button will still show but calls will fail
</script>
</body>
</html>