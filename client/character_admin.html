<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE — All Characters (Admin)</title>
  
<style>
  :root {
    color-scheme: dark;
    --bg: #14090c;
    --bg-2: #0c0b12;
    --panel: #121219;
    --border: #252533;
    --accent: #c53535;
    --text: #f3f3f5;
  }
  body {
    margin: 0;
    padding: 24px;
    font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--text);
    background: linear-gradient(180deg, #1a0c0f 0%, #0b0b10 100%);
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: 100% 100%;
  }
  .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
  h1 { margin:0; font-size:24px; letter-spacing:0.5px; }
  .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
  .card {
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    background: linear-gradient(135deg, rgba(197,53,53,0.15), rgba(12,12,18,0.95));
    box-shadow: 0 10px 28px rgba(0,0,0,0.28);
    display:flex;
    gap:10px;
  }
  .card .avatar {
    width:78px; height:78px; border:1px solid #333; border-radius:12px; overflow:hidden; background:#0b0b10; flex-shrink:0;
    display:grid; place-items:center;
  }
  .card .avatar img { width:100%; height:100%; object-fit:cover; }
  .card .meta { display:grid; gap:4px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .muted { opacity:.82; font-size:.9rem; }
  input, button, a.btn {
    padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#181821; color:var(--text); text-decoration:none;
    transition: background .15s ease, border .15s ease, transform .1s ease;
  }
  button.primary, a.btn.primary { background: linear-gradient(135deg, rgba(197,53,53,0.35), rgba(20,20,29,0.9)); border-color: var(--accent); color:#fff; }
  button:hover, a.btn:hover { background:#1f1f2a; border-color:#2f2f42; }
  button:active, a.btn:active { transform: translateY(1px); }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid #2f2f3f; font-size:.82rem; }
  .right { margin-left:auto; }
  .danger { color:#ff7575; }
</style>

</head>
<body>
  <div class="topbar">
    <span id="login-chip" class="muted" style="display:none;margin-left:auto;"></span>
    <h1>All Characters</h1>
    <a class="btn" href="characters.html">My Characters</a>
  </div>

  <div class="row" style="margin-bottom:12px;">
    <button id="new-btn" class="primary">+ New Character</button>
    <input id="filter" placeholder="Filter by owner or name..." style="min-width:280px" />
  </div>

  <div id="list" class="grid"></div>


<script>
function authHeaders() {
  const tok = localStorage.getItem('auth_token');
  return tok ? { 'Authorization': 'Bearer ' + tok } : {};
}
async function api(path, opt={}) {
  const headers = Object.assign({}, opt.headers || {}, authHeaders());
  const resp = await fetch(path, { credentials: 'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  if (!ct.includes('application/json')) {
    const t = await resp.text();
    throw new Error(`HTTP ${resp.status}: ${t.slice(0,180)}`);
  }
  const data = await resp.json();
  if (data.status === 'error') throw new Error(data.message || 'Request failed');
  return data;
}
async function ensureLoginBadge() {
  try {
    const me = await api('/auth/me');
    if (me.status === 'success') {
      const chip = document.getElementById('login-chip');
      if (chip) { chip.textContent = me.username + ' (' + me.role + ')'; chip.style.display=''; }
      const adminLink = document.getElementById('admin-link');
      if (adminLink && me.role === 'admin') adminLink.style.display = '';
      return true;
    }
  } catch (e) {
    const chip = document.getElementById('login-chip');
    if (chip) { chip.textContent = 'Not logged in'; chip.style.display=''; }
    return false;
  }
}
ensureLoginBadge();
</script>

<script>
/* replaced by auth-aware api() */
function el(tag, attrs={}, ...children) {
  const x = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') x.className = v;
    else if (k === 'onclick') x.addEventListener('click', v);
    else x.setAttribute(k, v);
  }
  for (const c of children) x.append(c);
  return x;
}

let RAW = [];

async function loadAll() {
  const me = await api('/auth/me');
  if (me.status !== 'success' || me.role !== 'admin') {
    document.body.innerHTML = '<p class="danger">Admin access required.</p>';
    return;
  }
  const data = await api('/admin/characters');
  RAW = data.characters || [];
  render();
}

function render() {
  const q = (document.getElementById('filter').value || '').toLowerCase();
  const list = document.getElementById('list');
  list.innerHTML = '';
  for (const c of RAW) {
    if (q && !((c.name||'').toLowerCase().includes(q) || (c.owner||'').toLowerCase().includes(q))) continue;
    const avatarUrl = `/characters/${encodeURIComponent(c.id)}/avatar?ts=${Date.now()}`;
    const card = el('div', {class:'card'}, 
      el('div', {class:'avatar'},
        el('img', {src: avatarUrl, alt:'avatar', onerror:"this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9WUZPi8AAAAASUVORK5CYII=';"})
      ),
      el('div', {class:'meta'},
        el('strong', {}, c.name || '(unnamed)'),
        el('div', {class:'muted'}, 'ID: ' + c.id),
        el('div', {class:'pill'}, 'Owner: ' + (c.owner || '—')),
        el('button', {onclick: () => location.href = 'character_edit.html?id=' + encodeURIComponent(c.id)}, 'Edit')
      )
    );
    list.append(card);
  }
}

async function createNew() {
  const res = await api('/characters', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ name: 'New Character' })
  });
  if (res.status === 'success') location.href = 'character_edit.html?id=' + encodeURIComponent(res.id);
  else alert(res.message || 'Failed to create');
}

async function adminCreate() {
  const name = prompt('Character name?', '')?.trim() || 'New Character';
  const owner = prompt('Owner username? (leave empty for yourself)', '')?.trim();
  const body = owner ? { name, owner } : { name };
  const res = await api('/characters', {
    method:'POST',
    headers:{ 'content-type':'application/json' },
    body: JSON.stringify(body)
  });
  location.href = 'character_edit.html?id=' + encodeURIComponent(res.id);
}

document.getElementById('new-btn').addEventListener('click', createNew);
document.getElementById('filter').addEventListener('input', render);

loadAll();
ensureLoginBadge();
</script>
</body>
</html>
