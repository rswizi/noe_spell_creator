<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign Quest Hub</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0c10;
      --panel: #12161d;
      --border: #232a35;
      --muted: #b7b2a8;
      --accent: #c9a227;
      --accent-2: #4a8b8f;
      --text: #f6f2ea;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Source Sans 3", "Inter", sans-serif;
      background: radial-gradient(900px 500px at 0% -10%, rgba(201,162,39,0.18), transparent 55%),
        radial-gradient(700px 420px at 100% 0%, rgba(74,139,143,0.2), transparent 50%),
        linear-gradient(180deg, var(--bg) 0%, #07080c 70%);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 16px 70px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .hero {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hero h1 {
      margin: 0;
      font-family: "Cinzel", "Times New Roman", serif;
      font-size: 2rem;
    }
    .hero-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hero-search {
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .hero-search input {
      margin-top: 4px;
      width: 220px;
    }
    .filters-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }
    .filters-row select {
      width: 100%;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(0, 1.2fr);
      gap: 16px;
    }
    .panel {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      background: var(--panel);
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
    }
    .list-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 70vh;
    }
    .detail-panel {
      min-height: 70vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .quest-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .quest-card {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      background: #0d1016;
      cursor: pointer;
      transition: border 0.2s ease, transform 0.2s ease;
    }
    .quest-card.active {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .quest-card .titles {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .quest-card h3 {
      margin: 0;
      font-size: 1rem;
    }
    .status-pill {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      text-transform: capitalize;
    }
    .status-pill.pending { border-color: #c9a227; color: #c9a227; }
    .status-pill.active { border-color: #4ac68f; color: #4ac68f; }
    .status-pill.on_hold { border-color: #7795f6; color: #7795f6; }
    .status-pill.completed { border-color: #6cc991; color: #6cc991; }
    .status-pill.failed { border-color: #e06666; color: #e06666; }
    .status-pill.abandoned { border-color: #ad6fdc; color: #ad6fdc; }
    .status-pill.hidden { border-color: #6c6c6c; color: #6c6c6c; }
    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .badge {
      border-radius: 999px;
      padding: 2px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.75rem;
    }
    .detail-empty {
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
    }
    .detail-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .detail-header h2 {
      margin: 0;
      font-size: 1.7rem;
    }
    .detail-subtitle {
      font-size: 0.95rem;
      color: var(--muted);
    }
    .detail-section {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .objectives-grid {
      display: grid;
      gap: 12px;
    }
    .objective-card {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px;
      background: #0c0f15;
      display: grid;
      gap: 6px;
    }
    .objective-card strong {
      font-size: 0.95rem;
    }
    .objective-card .objective-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .objective-card select {
      width: 140px;
    }
    .notes-grid {
      display: grid;
      gap: 12px;
    }
    .note-card {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px;
      background: #0c0f15;
    }
    .muted {
      color: var(--muted);
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    body.modal-open {
      overflow: hidden;
    }
    textarea {
      width: 100%;
      min-height: 80px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 16px;
      background: #12161d;
      color: var(--text);
      cursor: pointer;
    }
    .btn.primary {
      background: linear-gradient(135deg, rgba(197,53,53,0.35), rgba(20,20,29,0.95));
      border-color: var(--accent);
    }
    .btn.secondary {
      background: transparent;
      border-color: rgba(255,255,255,0.3);
    }
    .btn.ghost {
      background: rgba(255,255,255,0.05);
    }
    .create-panel .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .create-panel label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .section-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .gm-only {
      display: none;
    }
    .gm-only.visible {
      display: inline-flex;
    }
    .overlay-layer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      z-index: 20;
    }
    .overlay-layer.visible {
      display: flex;
    }
    .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
    }
    .panel.create-panel {
      position: relative;
      width: min(680px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .hero-search input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div>
        <h1 id="page-title">Campaign Quest Hub</h1>
        <p id="page-subtitle" class="muted">Manage every quest, objective, and theory for this campaign.</p>
      </div>
      <div class="hero-actions">
        <label class="hero-search muted">
          <span>Search</span>
          <input id="search-input" type="search" placeholder="Title, tags, assigned, faction..." autocomplete="off" />
        </label>
        <button class="btn ghost" id="toggle-hidden">Show Hidden</button>
        <button class="btn primary gm-only" id="open-create-btn">New Quest</button>
      </div>
    </header>
    <section class="filters-row">
      <select id="filter-type">
        <option value="">Type</option>
      </select>
      <select id="filter-status">
        <option value="">Status</option>
      </select>
      <select id="filter-assigned">
        <option value="">Assigned</option>
      </select>
      <select id="filter-faction">
        <option value="">Faction</option>
      </select>
      <select id="filter-session">
        <option value="">Session</option>
      </select>
    </section>
    <div class="layout">
      <aside class="panel list-panel">
        <div class="list-header">
          <strong>Quest List</strong>
          <span class="muted" id="quest-count">0 quests</span>
        </div>
        <div id="quest-list" class="quest-list"></div>
      </aside>
      <main class="panel detail-panel">
        <div id="quest-detail" class="detail-empty">
          Select a quest from the list to inspect its objectives, notes, and theories.
        </div>
      </main>
    </div>
    <div id="create-layer" class="overlay-layer">
      <div class="overlay-backdrop" id="create-backdrop"></div>
      <section id="create-panel" class="panel create-panel create-modal-content">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <strong>Create Quest</strong>
          <button class="btn secondary" id="close-create">Close</button>
        </div>
      <form id="create-form">
        <div class="form-grid">
          <label>
            Title
            <input name="title" required />
          </label>
          <label>
            Subtitle
            <input name="subtitle" />
          </label>
          <label>
            Quest Kind
            <select name="questKind">
              <option value="main">Main Quest</option>
              <option value="side">Side Quest</option>
              <option value="personal">Personal Quest</option>
              <option value="faction">Faction Quest</option>
              <option value="secret">Secret Quest</option>
              <option value="time_limited">Time-Limited Quest</option>
              <option value="dynamic">Dynamic/Event Quest</option>
            </select>
          </label>
          <label>
            Scope
            <select name="scope">
              <option value="group">Group</option>
              <option value="personal">Personal</option>
            </select>
          </label>
          <label>
            Status
            <select name="status">
              <option value="pending">Pending</option>
              <option value="active">Active</option>
              <option value="on_hold">On Hold</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
              <option value="abandoned">Abandoned</option>
              <option value="hidden">Hidden</option>
            </select>
          </label>
          <label>
            Visibility
            <select name="visibility">
              <option value="gm_only">GM Only</option>
              <option value="party_visible">Party Visible</option>
              <option value="character_specific">Character Specific</option>
              <option value="role_restricted">Role Restricted</option>
            </select>
          </label>
          <label>
            Priority
            <select name="priority">
              <option value="main">Main</option>
              <option value="secondary">Secondary</option>
              <option value="tertiary">Tertiary</option>
            </select>
          </label>
          <label>
            Assigned Characters (comma-separated)
            <input name="assignedTo" placeholder="player1, player2" />
          </label>
          <label>
            Tags (comma separated)
            <input name="tags" placeholder="exploration, mystery" />
          </label>
          <label>
            Faction
            <input name="faction" />
          </label>
          <label>
            Session
            <input name="session" />
          </label>
        </div>
        <label>
          Description
          <textarea name="description"></textarea>
        </label>
        <label>
          Objectives (one per line)
          <textarea name="objectives" placeholder="Objective one\nObjective two"></textarea>
        </label>
        <div class="row">
          <label style="flex-direction:row;align-items:center;gap:6px;">
            <input type="checkbox" name="tracked" />
            Track for me
          </label>
          <label style="flex-direction:row;align-items:center;gap:6px;">
            <input type="checkbox" name="pinned" />
            Pin to HUD
          </label>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn primary" type="submit">Create Quest</button>
          <span id="create-feedback" class="muted"></span>
        </div>
      </form>
      </section>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(location.search);
    const CID = (params.get('cid') || '').trim();

    const searchInput = document.getElementById('search-input');
    const filterTypeEl = document.getElementById('filter-type');
    const filterStatusEl = document.getElementById('filter-status');
    const filterAssignedEl = document.getElementById('filter-assigned');
    const filterFactionEl = document.getElementById('filter-faction');
    const filterSessionEl = document.getElementById('filter-session');
    const toggleHiddenBtn = document.getElementById('toggle-hidden');
    const questListEl = document.getElementById('quest-list');
    const questDetailEl = document.getElementById('quest-detail');
    const questCountEl = document.getElementById('quest-count');
    const openCreateBtn = document.getElementById('open-create-btn');
    const createPanel = document.getElementById('create-panel');
    const createLayer = document.getElementById('create-layer');
    const createBackdrop = document.getElementById('create-backdrop');
    const closeCreateBtn = document.getElementById('close-create');
    const createForm = document.getElementById('create-form');
    const createFeedback = document.getElementById('create-feedback');
    const pageStatus = document.getElementById('page-subtitle');

    const OBJECTIVE_STATUS_OPTIONS = [
      { value: 'not_started', label: 'Not started' },
      { value: 'ongoing', label: 'Ongoing' },
      { value: 'succeeded', label: 'Succeeded' },
      { value: 'failed', label: 'Failed' },
    ];

    const QUEST_STATUS_LABELS = {
      pending: 'Pending',
      active: 'Active',
      on_hold: 'On Hold',
      completed: 'Completed',
      failed: 'Failed',
      abandoned: 'Abandoned',
      hidden: 'Hidden',
    };

    const QUEST_KIND_LABELS = {
      main: 'Main Quest',
      side: 'Side Quest',
      personal: 'Personal Quest',
      faction: 'Faction Quest',
      secret: 'Secret Quest',
      time_limited: 'Time-Limited Quest',
      dynamic: 'Dynamic/Event Quest',
    };

      const state = {
        user: null,
        campaign: null,
        quests: [],
        filters: {
          search: '',
          type: '',
          status: '',
          assigned: '',
          faction: '',
          session: '',
          showHidden: false,
        },
        activeQuest: null,
        isGm: false,
      };

    function escapeHtml(val) {
      if (!val) return '';
      return String(val)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br>');
    }

    function refreshGmVisibility() {
      const campaignRole = ((state.campaign || {}).user_role || '').toLowerCase();
      const isOwner = Boolean(state.campaign?.is_owner);
      const isAssistant = Boolean(state.campaign?.is_assistant_gm);
      const userRole = (state.user?.role || '').toLowerCase();
      state.isGm =
        isOwner ||
        isAssistant ||
        ['gm', 'assistant'].includes(campaignRole) ||
        userRole === 'admin';
      if (openCreateBtn) {
        openCreateBtn.classList.toggle('visible', state.isGm);
        openCreateBtn.style.display = state.isGm ? 'inline-flex' : 'none';
      }
    }

    function setCreateModalVisible(visible) {
      if (!createLayer) return;
      createLayer.classList.toggle('visible', visible);
      document.body.classList.toggle('modal-open', visible);
    }

    function canUpdateObjectives(quest) {
      if (state.isGm) return true;
      const visibility = (quest.visibility || '').toLowerCase();
      if (visibility === 'gm_only') return false;
      const userLower = (state.user?.username || '').toLowerCase();
      const assigned = (quest.assignedTo || []).map((name) => (name || '').toLowerCase());
      const creator = (quest.createdBy || '').toLowerCase();
      return assigned.includes(userLower) || creator === userLower;
    }

    function getFilteredQuests() {
      const list = [];
      (state.quests || []).forEach((quest) => {
        if (!state.filters.showHidden && (quest.status || '').toLowerCase() === 'hidden') {
          return;
        }
        if (state.filters.type && quest.quest_kind !== state.filters.type) {
          return;
        }
        if (state.filters.status && quest.status !== state.filters.status) {
          return;
        }
        if (state.filters.assigned) {
          const assigned = (quest.assignedTo || []).map((value) => (value || '').toLowerCase());
          if (!assigned.includes(state.filters.assigned.toLowerCase())) return;
        }
        if (state.filters.faction) {
          if ((quest.faction || '').toLowerCase() !== state.filters.faction.toLowerCase()) return;
        }
        if (state.filters.session) {
          if ((quest.session || '').toLowerCase() !== state.filters.session.toLowerCase()) return;
        }
        const search = (state.filters.search || '').toLowerCase();
        if (search) {
          const haystack = [
            quest.title,
            quest.subtitle,
            quest.description,
            ...(quest.tags || []),
            ...(quest.assignedTo || []),
            quest.faction,
            quest.session,
          ]
            .filter(Boolean)
            .map((value) => value.toLowerCase())
            .join(' ');
          if (!haystack.includes(search)) return;
        }
        list.push(quest);
      });
      return list;
    }

    function renderFilters() {
      const types = new Set(['main']);
      const statuses = new Set(['pending']);
      const assigned = new Set();
      const factions = new Set();
      const sessions = new Set();
      state.quests.forEach((quest) => {
        if (quest.quest_kind) types.add(quest.quest_kind);
        if (quest.status) statuses.add(quest.status);
        (quest.assignedTo || []).forEach((name) => {
          if (name) assigned.add(name);
        });
        if (quest.faction) factions.add(quest.faction);
        if (quest.session) sessions.add(quest.session);
      });
      function pushOptions(el, values) {
        const current = el.value;
        el.innerHTML = `<option value="">${el === filterTypeEl ? 'Type' : el === filterStatusEl ? 'Status' : el === filterAssignedEl ? 'Assigned' : el === filterFactionEl ? 'Faction' : 'Session'}</option>`;
        Array.from(values)
          .sort()
          .forEach((value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = el === filterStatusEl ? QUEST_STATUS_LABELS[value] || value : value;
            el.appendChild(option);
          });
        if (current) el.value = current;
      }
      pushOptions(filterTypeEl, types);
      pushOptions(filterStatusEl, statuses);
      pushOptions(filterAssignedEl, assigned);
      pushOptions(filterFactionEl, factions);
      pushOptions(filterSessionEl, sessions);
    }

    function renderQuestList() {
      questListEl.innerHTML = '';
      const filtered = getFilteredQuests();
      questCountEl.textContent = `${filtered.length} quest${filtered.length === 1 ? '' : 's'}`;
      filtered.forEach((quest) => {
        const card = document.createElement('div');
        card.className = 'quest-card';
        if (state.activeQuest && state.activeQuest.id === quest.id) {
          card.classList.add('active');
        }
        card.innerHTML = `
          <div class="titles">
            <h3>${escapeHtml(quest.title || 'Untitled Quest')}</h3>
            <span class="status-pill ${quest.status || 'pending'}">${QUEST_STATUS_LABELS[quest.status] || quest.status || 'Pending'}</span>
          </div>
          <div class="badges">
            <span class="badge">${QUEST_KIND_LABELS[quest.quest_kind] || 'Main Quest'}</span>
            <span class="badge">${(quest.priority || 'Main').replace('_', ' ')}</span>
          </div>
          <div class="muted">${(quest.assignedTo || []).join(', ') || 'Unassigned'}</div>
        `;
        card.addEventListener('click', () => {
          state.activeQuest = quest;
          renderQuestDetail();
          document.querySelectorAll('.quest-card').forEach((el) => el.classList.remove('active'));
          card.classList.add('active');
        });
        questListEl.appendChild(card);
      });
      if (!filtered.length) {
        questListEl.innerHTML = '<div class="muted">No quests match the current filters.</div>';
      }
    }

    function renderQuestDetail() {
      const quest = state.activeQuest;
      if (!quest) {
        questDetailEl.innerHTML = '<div class="detail-empty">Select a quest to inspect its objectives, notes, and theories.</div>';
        return;
      }
      const header = `
        <div class="detail-header">
          <div>
            <h2>${escapeHtml(quest.title || 'Untitled Quest')}</h2>
            ${quest.subtitle ? `<div class="detail-subtitle">${escapeHtml(quest.subtitle)}</div>` : ''}
          </div>
          <div class="badges">
            <span class="badge">${QUEST_KIND_LABELS[quest.quest_kind] || 'Main Quest'}</span>
            <span class="badge">${(quest.priority || 'Main').replace('_', ' ')}</span>
            <span class="badge">${quest.faction || 'No faction'}</span>
          </div>
        </div>
      `;
      const meta = `
        <div class="row">
          <span class="muted">Status: ${QUEST_STATUS_LABELS[quest.status] || quest.status || 'Pending'}</span>
          <span class="muted">Visibility: ${(quest.visibility || 'party_visible').replace('_', ' ')}</span>
          <span class="muted">Assigned: ${(quest.assignedTo || []).join(', ') || 'Unassigned'}</span>
          <span class="muted">Session: ${quest.session || 'N/A'}</span>
          <span class="muted">Tracked by you: ${isTracked(quest) ? 'Yes' : 'No'}</span>
        </div>
      `;
      const description = `
        <div class="detail-section">
          <strong>Description</strong>
          <div>${escapeHtml(quest.description)}</div>
        </div>
      `;
      const objectives = (quest.objectives || []).sort((a, b) => (a.order || 0) - (b.order || 0));
      const objectivesHtml = objectives.length
        ? objectives.map((obj) => {
            const typeLabel = obj.type ? obj.type.replace('_', ' ') : 'mandatory';
            const priorityLabel = (obj.priority || 'secondary').replace('_', ' ');
            const select = canUpdateObjectives(quest) ? `<select data-objective-id="${obj.id}" class="objective-select">
              ${OBJECTIVE_STATUS_OPTIONS.map((option) => `<option value="${option.value}" ${option.value === obj.status ? 'selected' : ''}>${option.label}</option>`).join('')}
            </select>` : `<span class="muted">${OBJECTIVE_STATUS_OPTIONS.find((option) => option.value === obj.status)?.label || 'Not started'}</span>`;
            return `
              <div class="objective-card">
                <div class="row">
                  <strong>${escapeHtml(obj.title)}</strong>
                  ${select}
                </div>
                <div class="objective-meta muted">
                  <span>Type: ${typeLabel}</span>
                  <span>Priority: ${priorityLabel}</span>
                  <span>Status: ${obj.status}</span>
                </div>
                <div>${escapeHtml(obj.description)}</div>
              </div>
            `;
          }).join('')
        : '<div class="muted">No objectives yet.</div>';
      const notesHtml = `
        <div class="detail-section">
          <div class="row" style="justify-content:space-between;">
            <strong>Personal Notes</strong>
            <button class="btn secondary" id="note-add-btn">Add Note</button>
          </div>
          <div id="notes-list" class="notes-grid">
            ${(quest.personalNotes || []).map((note) => `
              <div class="note-card">
                <div class="row" style="justify-content:space-between;">
                  <span><strong>${note.author}</strong></span>
                  <span class="muted" style="font-size:0.8rem;">${note.createdAt}</span>
                </div>
                <div>${escapeHtml(note.text)}</div>
              </div>`).join('') || '<div class="muted">No notes yet.</div>'}
          </div>
          <div id="note-form-container" class="hidden">
            <textarea id="note-text" placeholder="Add a note..."></textarea>
            <div class="section-actions">
              <button class="btn primary" id="note-submit">Save note</button>
              <button class="btn secondary" id="note-cancel">Cancel</button>
            </div>
          </div>
        </div>
      `;
      const theoriesHtml = `
        <div class="detail-section">
          <div class="row" style="justify-content:space-between;">
            <strong>Theories</strong>
            <button class="btn secondary" id="theory-add-btn">Add Theory</button>
          </div>
          <div id="theories-list" class="notes-grid">
            ${(quest.theories || []).map((entry) => `
              <div class="note-card">
                <div class="row" style="justify-content:space-between;">
                  <span><strong>${entry.author}</strong></span>
                  <span class="muted" style="font-size:0.8rem;">${entry.createdAt}</span>
                </div>
                <div>${escapeHtml(entry.text)}</div>
              </div>`).join('') || '<div class="muted">No theories yet.</div>'}
          </div>
          <div id="theory-form-container" class="hidden">
            <textarea id="theory-text" placeholder="Draft a theory..."></textarea>
            <div class="section-actions">
              <button class="btn primary" id="theory-submit">Save theory</button>
              <button class="btn secondary" id="theory-cancel">Cancel</button>
            </div>
          </div>
        </div>
      `;
      const trackingControls = `
        <div class="detail-section">
          <div class="section-actions">
            <button class="btn ghost" id="track-btn">${isTracked(quest) ? 'Untrack' : 'Track'} Quest</button>
            <button class="btn ghost" id="pin-btn">${isPinned(quest) ? 'Unpin' : 'Pin'} to HUD</button>
            ${state.isGm ? `<select id="status-update">
              ${Object.entries(QUEST_STATUS_LABELS).map(([value, label]) => `<option value="${value}" ${value === quest.status ? 'selected' : ''}>${label}</option>`).join('')}
            </select>` : ''}
          </div>
        </div>
      `;
      questDetailEl.innerHTML = header + meta + description + `
        <div class="detail-section">
          <strong>Objectives</strong>
          <div class="objectives-grid">${objectivesHtml}</div>
        </div>` + notesHtml + theoriesHtml + trackingControls;
      attachObjectiveListeners();
      attachNoteButtons();
      attachTheoryButtons();
      attachTrackingButtons();
      attachStatusUpdate();
    }

    function isTracked(quest) {
      const user = (state.user?.username || '').toLowerCase();
      return (quest.tracked_by || []).map((name) => (name || '').toLowerCase()).includes(user);
    }

    function isPinned(quest) {
      const user = (state.user?.username || '').toLowerCase();
      return (quest.pinned_by || []).map((name) => (name || '').toLowerCase()).includes(user);
    }

    function attachObjectiveListeners() {
      document.querySelectorAll('.objective-card select').forEach((select) => {
        select.addEventListener('change', () => {
          const objectiveId = select.dataset.objectiveId;
          const questId = state.activeQuest?.id;
          if (questId && objectiveId) {
            updateObjectiveStatus(questId, objectiveId, select.value);
          }
        });
      });
    }

    function attachNoteButtons() {
      const noteAdd = document.getElementById('note-add-btn');
      const noteForm = document.getElementById('note-form-container');
      const noteCancel = document.getElementById('note-cancel');
      const noteSubmit = document.getElementById('note-submit');
      const noteText = document.getElementById('note-text');
      if (!noteAdd || !noteForm) return;
      noteAdd.addEventListener('click', () => {
        noteForm.classList.remove('hidden');
        noteText.value = '';
        noteText.focus();
      });
      noteCancel.addEventListener('click', () => noteForm.classList.add('hidden'));
      noteSubmit.addEventListener('click', async () => {
        const text = noteText.value.trim();
        if (!text) return;
        await postNote(text);
      });
    }

    function attachTheoryButtons() {
      const theoryAdd = document.getElementById('theory-add-btn');
      const theoryForm = document.getElementById('theory-form-container');
      const theoryCancel = document.getElementById('theory-cancel');
      const theorySubmit = document.getElementById('theory-submit');
      const theoryText = document.getElementById('theory-text');
      if (!theoryAdd || !theoryForm) return;
      theoryAdd.addEventListener('click', () => {
        theoryForm.classList.remove('hidden');
        theoryText.value = '';
        theoryText.focus();
      });
      theoryCancel.addEventListener('click', () => theoryForm.classList.add('hidden'));
      theorySubmit.addEventListener('click', async () => {
        const text = theoryText.value.trim();
        if (!text) return;
        await postTheory(text);
      });
    }

    function attachTrackingButtons() {
      const trackBtn = document.getElementById('track-btn');
      const pinBtn = document.getElementById('pin-btn');
      if (trackBtn) {
        trackBtn.addEventListener('click', async () => {
          await toggleTracking('tracked', isTracked(state.activeQuest) ? 'untrack' : 'track');
        });
      }
      if (pinBtn) {
        pinBtn.addEventListener('click', async () => {
          await toggleTracking('pinned', isPinned(state.activeQuest) ? 'untrack' : 'track');
        });
      }
    }

    function attachStatusUpdate() {
      const statusSelect = document.getElementById('status-update');
      if (!statusSelect) return;
      statusSelect.addEventListener('change', async () => {
        await patchQuest(state.activeQuest.id, { status: statusSelect.value });
      });
    }

    async function updateObjectiveStatus(questId, objectiveId, status) {
      try {
        await api(`/campaigns/${encodeURIComponent(CID)}/quests/${encodeURIComponent(questId)}/objectives/${encodeURIComponent(objectiveId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        await loadQuestData();
      } catch (error) {
        console.error('Objective update failed', error);
      }
    }

    async function postNote(text) {
      if (!state.activeQuest) return;
      await api(`/campaigns/${encodeURIComponent(CID)}/quests/${encodeURIComponent(state.activeQuest.id)}/notes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      await loadQuestData();
    }

    async function postTheory(text) {
      if (!state.activeQuest) return;
      await api(`/campaigns/${encodeURIComponent(CID)}/quests/${encodeURIComponent(state.activeQuest.id)}/theories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      await loadQuestData();
    }

    async function toggleTracking(type, action) {
      if (!state.activeQuest) return;
      await api(`/campaigns/${encodeURIComponent(CID)}/quests/${encodeURIComponent(state.activeQuest.id)}/tracking`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, action }),
      });
      await loadQuestData();
    }

    async function patchQuest(questId, payload) {
      await api(`/campaigns/${encodeURIComponent(CID)}/quests/${encodeURIComponent(questId)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      await loadQuestData();
    }

    async function loadQuestData() {
      if (!CID) {
        pageStatus.textContent = 'Campaign ID missing.';
        return;
      }
      try {
        const res = await api(`/campaigns/${encodeURIComponent(CID)}/quests`);
        const payload = res.quests || {};
        const previousId = state.activeQuest?.id;
        state.quests = [
          ...(payload.group || []),
          ...(payload.personal || []),
          ...(payload.archive || []),
        ];
        if (previousId) {
          state.activeQuest = state.quests.find((entry) => entry.id === previousId) || null;
        } else if (!state.activeQuest && state.quests.length) {
          state.activeQuest = state.quests[0];
        }
        renderFilters();
        renderQuestList();
        if (state.activeQuest) {
          renderQuestDetail();
        }
      } catch (error) {
        pageStatus.textContent = `Unable to load quests: ${error.message}`;
      }
    }

    async function loadUser() {
      try {
        const user = await api('/auth/me');
        state.user = user;
      } catch {
        state.user = null;
      }
      refreshGmVisibility();
    }

    async function loadCampaign() {
      if (!CID) return;
      try {
        const res = await api(`/campaigns/${encodeURIComponent(CID)}`);
        state.campaign = res.campaign || {};
        refreshGmVisibility();
      } catch (error) {
        console.warn('Failed to load campaign', error);
      }
    }

    function updateFiltersFromInputs() {
      state.filters.search = searchInput.value.trim().toLowerCase();
      state.filters.type = filterTypeEl.value;
      state.filters.status = filterStatusEl.value;
      state.filters.assigned = filterAssignedEl.value;
      state.filters.faction = filterFactionEl.value;
      state.filters.session = filterSessionEl.value;
      renderQuestList();
    }

    searchInput.addEventListener('input', () => {
      state.filters.search = searchInput.value.trim().toLowerCase();
      renderQuestList();
    });
    [filterTypeEl, filterStatusEl, filterAssignedEl, filterFactionEl, filterSessionEl].forEach((el) => {
      el.addEventListener('change', () => {
        updateFiltersFromInputs();
      });
    });

    toggleHiddenBtn.addEventListener('click', () => {
      state.filters.showHidden = !state.filters.showHidden;
      toggleHiddenBtn.textContent = state.filters.showHidden ? 'Hide Hidden' : 'Show Hidden';
      renderQuestList();
    });

    openCreateBtn?.addEventListener('click', () => setCreateModalVisible(true));
    closeCreateBtn?.addEventListener('click', () => setCreateModalVisible(false));
    createBackdrop?.addEventListener('click', () => setCreateModalVisible(false));

    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(createForm);
      const payload = {};
      formData.forEach((value, key) => {
        payload[key] = value;
      });
      if (payload.tags) {
        payload.tags = payload.tags.split(',').map((value) => value.trim()).filter(Boolean);
      }
      if (payload.assignedTo) {
        payload.assignedTo = payload.assignedTo.split(',').map((value) => value.trim()).filter(Boolean);
      }
      if (payload.objectives) {
        payload.objectives = payload.objectives
          .split('\n')
          .map((line) => line.trim())
          .filter(Boolean)
          .map((label) => ({ title: label }));
      }
      payload.tracked = formData.get('tracked') === 'on';
      payload.pinned = formData.get('pinned') === 'on';
      try {
        createFeedback.textContent = 'Creating quest...';
        await api(`/campaigns/${encodeURIComponent(CID)}/quests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        createFeedback.textContent = 'Quest created.';
        createForm.reset();
        setCreateModalVisible(false);
        await loadQuestData();
      } catch (error) {
        createFeedback.textContent = error.message || 'Creation failed';
      }
    });

    async function api(path, options = {}) {
      const headers = options.headers || {};
      const resp = await fetch(path, {
        credentials: 'include',
        ...options,
        headers,
      });
      const contentType = resp.headers.get('content-type') || '';
      const data = contentType.includes('application/json') ? await resp.json() : { status: 'error', message: await resp.text() };
      if (!resp.ok || data.status === 'error') {
        throw new Error(data.message || `HTTP ${resp.status}`);
      }
      return data;
    }

    async function init() {
      if (!CID) {
        pageStatus.textContent = 'This hub must be opened with a campaign id.';
        return;
      }
      await loadUser();
      await loadCampaign();
      await loadQuestData();
    }

    init().catch((error) => {
      if (pageStatus) pageStatus.textContent = error.message;
    });
</body>
</html>
