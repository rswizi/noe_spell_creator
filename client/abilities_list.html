<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE â€” Abilities Browser</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#050507; color:#f5f5f5; }
    .page { min-height:100vh; display:grid; place-items:start center; }
    .wrap { width:100%; max-width:1180px; padding:24px 16px 40px; }

    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
    .topbar h1 { margin:0; font-size:20px; }
    .topbar .right { margin-left:auto; }
    .muted { opacity:.8; font-size:.9rem; }

    a.btn, button.btn, input, select, textarea {
      border-radius:10px; border:1px solid #333; background:#111; color:#f0f0f0;
      padding:8px 10px; font:inherit;
    }
    a.btn:hover, button.btn:hover { background:#181818; }
    textarea { resize:vertical; min-height:80px; }

    .grid { display:grid; gap:16px; grid-template-columns: 1fr; align-items:start; }

    .panel { border:1px solid #262626; border-radius:14px; background:#101010; padding:14px 14px 16px; }
    .panel h2 { margin:0 0 8px; font-size:1rem; }
    .panel h3 { margin:10px 0 6px; font-size:.95rem; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row label { font-size:.88rem; opacity:.85; min-width:90px; }
    .row .grow { flex:1 1 auto; }

    .ability-list { max-height:430px; overflow:auto; margin-top:6px; font-size:.9rem; border-top:1px solid #222; padding-top:6px; }
    .ability-item { padding:5px 6px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; gap:6px; }
    .ability-item:hover { background:#181818; }
    .ability-item.active { background:#222; border:1px solid #3f3f3f; }

    .badge { border-radius:999px; border:1px solid #333; padding:2px 8px; font-size:.8rem; }

    .pill { font-size:.75rem; opacity:.85; border:1px solid #343434; border-radius:999px; padding:2px 7px; }

    .subgrid-2 { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }
    @media (max-width:700px) { .subgrid-2 { grid-template-columns:1fr; } }

    .cost-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:6px; margin-top:6px; }
    .cost-grid label { font-size:.8rem; opacity:.85; }
    .cost-grid input { width:100%; text-align:right; }

    .mod-list { display:grid; gap:8px; margin-top:6px; }
    .mod-row { display:grid; grid-template-columns: 1.2fr 0.7fr 0.6fr 0.8fr 0.6fr; gap:8px; align-items:center; }
    .mod-row input, .mod-row select { width:100%; }
    .mod-row button { padding:4px 8px; font-size:.8rem; }
    .mod-row .mod-target-custom { grid-column:1 / span 3; }
    .mod-row .choice-wrap { grid-column:1 / -1; display:none; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; align-items:start; padding:10px 12px; border:1px solid #222; border-radius:10px; background:#0c0c0f; }
    .mod-row .choice-wrap .muted { grid-column:1 / -1; }
    .mod-row .choice-actions { grid-column:1 / -1; display:flex; gap:8px; align-items:center; }
    .chip-list { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { border:1px solid #333; padding:4px 8px; border-radius:999px; font-size:.85rem; display:flex; gap:6px; align-items:center; }
    .chip input { width:auto; }

    .status-line { margin-top:10px; font-size:.85rem; opacity:.9; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1>Browse & Edit Abilities</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="abilities_home.html">Back</a>
    </div>

    <div class="grid">
      <!-- LEFT: list / filters -->
      <div>
        <div class="panel">
          <h2>Search</h2>
          <div class="row">
            <label for="filter-name">Name</label>
            <input id="filter-name" class="grow" placeholder="Search by nameâ€¦" />
          </div>
          <div class="row">
            <label for="filter-type">Type</label>
            <select id="filter-type" class="grow">
              <option value="">Any</option>
              <option value="active">Active</option>
              <option value="passive">Passive</option>
              <option value="mixed">Mixed</option>
            </select>
          </div>
          <div class="row">
            <label for="filter-source">Source</label>
            <select id="filter-source" class="grow">
              <option value="">Any</option>
              <option value="Specie">Specie</option>
              <option value="Talent">Talent</option>
              <option value="Archetype">Archetype</option>
              <option value="Expertise">Expertise</option>
              <option value="Awakening">Awakening</option>
              <option value="Apotheosis">Apotheosis</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <h2>Abilities</h2>
          <div id="ability-list" class="ability-list">
            <div class="muted">No abilities loaded yet.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: editor -->
      <div>
        <div class="panel">
          <h2>Selected Ability</h2>

          <div class="row">
            <label>ID</label>
            <span id="ab-id" class="muted">None selected</span>
          </div>

          <div class="row">
            <label for="ab-name">Name</label>
            <input id="ab-name" class="grow" />
          </div>

          <div class="row">
            <label for="ab-type">Type</label>
            <select id="ab-type">
              <option value="active">Active</option>
              <option value="passive">Passive</option>
              <option value="mixed">Mixed</option>
            </select>
          </div>

          <div class="row">
            <label for="ab-source-cat">Source</label>
            <select id="ab-source-cat" class="grow">
              <option value="Specie">Specie</option>
              <option value="Talent">Talent</option>
              <option value="Archetype">Archetype</option>
              <option value="Expertise">Expertise</option>
              <option value="Awakening">Awakening</option>
              <option value="Apotheosis">Apotheosis</option>
              <option value="Other">Other</option>
            </select>
          </div>

        <div class="row">
          <label for="ab-source-ref">Source Detail</label>
          <input id="ab-source-ref" class="grow" />
        </div>

        <div id="arc-meta" class="row" style="flex-direction:column; align-items:flex-start; display:none; gap:8px; margin-top:4px;">
          <div class="row" style="width:100%; gap:8px; align-items:center; flex-wrap:wrap;">
            <label style="min-width:140px;">Archetype Version</label>
            <input id="ab-arc-version" type="number" min="1" value="1" style="width:120px;">
            <label style="min-width:140px;">Original Rank</label>
            <input id="ab-arc-orig-rank" type="number" min="1" max="12" value="1" style="width:120px;">
          </div>
          <div class="row" style="width:100%; gap:8px; align-items:center; flex-wrap:wrap;">
            <label style="min-width:140px;">Replaces Ability</label>
            <div style="display:flex; gap:6px; align-items:center; flex:1; min-width:260px;">
              <input id="ab-arc-repl-search" class="grow" placeholder="Search ability by name...">
              <select id="ab-arc-repl" style="flex:1; min-width:200px;">
                <option value="">-- none --</option>
              </select>
            </div>
          </div>
        </div>

          <div class="row">
            <label for="ab-tags">Tags</label>
            <input id="ab-tags" class="grow" />
          </div>

          <h3>Description</h3>
          <textarea id="ab-description"></textarea>

          <button class="btn" id="btn-save" type="button" style="margin-top:14px;">ðŸ’¾ Save Changes</button>
          <div class="status-line" id="status-line">Select an ability to begin.</div>
        </div>

        <div class="panel" id="panel-passive">
          <h2>Passive Part <span class="pill">always on</span></h2>
          <h3>Passive Description</h3>
          <textarea id="passive-desc"></textarea>

          <h3 style="margin-top:10px;">Modifiers</h3>
          <div class="muted" style="margin-bottom:4px;">
            Pick from the dropdown (skills, characteristics, derived resources) or use a custom path if you need something special.
          </div>

          <div id="mod-list" class="mod-list"></div>
          <button class="btn" id="btn-add-mod" type="button">+ Add Modifier</button>
        </div>

        <div class="panel" id="panel-active">
          <h2>Active Part <span class="pill">needs activation</span></h2>

          <div class="row">
            <label for="act-activation">Activation</label>
            <select id="act-activation" class="grow">
              <option value="Action">Action</option>
              <option value="Free Action">Free Action</option>
              <option value="Special Action">Special Action</option>
              <option value="Ritual">Ritual</option>
            </select>
          </div>

          <div class="subgrid-2">
            <div>
              <label>Range</label>
              <input id="act-range" type="number" min="0" step="1" />
            </div>
            <div>
              <label>AoE</label>
              <input id="act-aoe" />
            </div>
          </div>

          <h3 style="margin-top:10px;">Costs</h3>
          <div class="cost-grid">
            <div><label>HP</label><input id="cost-hp" type="number" step="1" /></div>
            <div><label>EN</label><input id="cost-en" type="number" step="1" /></div>
            <div><label>MP</label><input id="cost-mp" type="number" step="1" /></div>
            <div><label>FO</label><input id="cost-fo" type="number" step="1" /></div>
            <div><label>MO</label><input id="cost-mo" type="number" step="1" /></div>
            <div><label>TX</label><input id="cost-tx" type="number" step="1" /></div>
            <div><label>Other label</label><input id="cost-other-label" /></div>
            <div><label>Other value</label><input id="cost-other-value" type="number" step="1" /></div>
          </div>
        </div>
      </div>
    </div>

  </div></div>

<script>
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){
  const t=getToken(); if(t) setCookieToken(t);
  return t ? {'Authorization':'Bearer '+t, 'X-Auth-Token':t} : {};
}
async function api(path,opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
  if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status));
  return data;
}

const loginChip      = document.getElementById('login-chip');
const abilityListEl  = document.getElementById('ability-list');
const filterNameEl   = document.getElementById('filter-name');
const filterTypeEl   = document.getElementById('filter-type');
const filterSourceEl = document.getElementById('filter-source');

const abIdEl       = document.getElementById('ab-id');
const nameEl       = document.getElementById('ab-name');
const typeEl       = document.getElementById('ab-type');
const sourceCatEl  = document.getElementById('ab-source-cat');
const sourceRefEl  = document.getElementById('ab-source-ref');
const tagsEl       = document.getElementById('ab-tags');
const descEl       = document.getElementById('ab-description');
const statusLine   = document.getElementById('status-line');

const panelActive  = document.getElementById('panel-active');
const panelPassive = document.getElementById('panel-passive');
const passiveDescEl= document.getElementById('passive-desc');
const modListEl    = document.getElementById('mod-list');
const btnAddMod    = document.getElementById('btn-add-mod');

const actActivationEl = document.getElementById('act-activation');
const actRangeEl      = document.getElementById('act-range');
const actAoeEl        = document.getElementById('act-aoe');

const costHpEl    = document.getElementById('cost-hp');
const costEnEl    = document.getElementById('cost-en');
const costMpEl    = document.getElementById('cost-mp');
const costFoEl    = document.getElementById('cost-fo');
const costMoEl    = document.getElementById('cost-mo');
const costTxEl    = document.getElementById('cost-tx');
const costOLabelEl= document.getElementById('cost-other-label');
const costOValEl  = document.getElementById('cost-other-value');

const btnSave     = document.getElementById('btn-save');

const arcMetaEl    = document.getElementById('arc-meta');
const arcVersionEl = document.getElementById('ab-arc-version');
const arcOrigRankEl= document.getElementById('ab-arc-orig-rank');
const arcReplSel   = document.getElementById('ab-arc-repl');
const arcReplSearch= document.getElementById('ab-arc-repl-search');

const CUSTOM_TARGET_VALUE = '__custom__';
const CHOICE_OPTIONS = [
  { value:'choice:skill_ms',     label:'[Choice] Skill-based MS' },
  { value:'choice:nature_ms',    label:'[Choice] Nature-based MS' },
  { value:'choice:school_ms',    label:'[Choice] MS' },
  { value:'choice:magic_weapon', label:'[Choice] Magic damage on weapons (nature pick)' },
  { value:'choice:magic_spell',  label:'[Choice] Magic damage on spells/animarma (nature pick)' },
  { value:'choice:char_skill',   label:'[Choice] Skill linked to a characteristic' },
];
const PASSIVE_TARGET_GROUPS = (()=>{
  const characteristics = [
    { key:'reflex',    label:'Reflex' },
    { key:'dexterity', label:'Dexterity' },
    { key:'body',      label:'Body' },
    { key:'wisdom',    label:'Wisdom' },
    { key:'presence',  label:'Presence' },
    { key:'magic',     label:'Magic' },
    { key:'willpower', label:'Willpower' },
    { key:'tech',      label:'Tech' },
  ];
  const skills = [
    { key:'reflex',    label:'Reflex',    skills:['Technicity','Dodge','Counter','Reactivity'] },
    { key:'dexterity', label:'Dexterity', skills:['Accuracy','Evasion','Stealth','Acrobatics'] },
    { key:'body',      label:'Body',      skills:['Brutality','Blocking','Resistance','Athletics'] },
    { key:'wisdom',    label:'Wisdom',    skills:['Survival','Education','Perception','Psychology','Investigation'] },
    { key:'presence',  label:'Presence',  skills:['Taming','Charm','Charisma','Deception','Persuasion'] },
    { key:'magic',     label:'Magic',     skills:['Aura','Incantation','Enchantment','Restoration','Potential'] },
    { key:'willpower', label:'Willpower', skills:['Intimidation','Spirit','Instinct','Absorption'] },
    { key:'tech',      label:'Tech',      skills:['Crafting','Sleight of hand','Alchemy','Medicine','Engineering'] },
  ];
  const derived = [
    { key:'hp', label:'HP' },
    { key:'en', label:'EN' },
    { key:'fo', label:'FO' },
    { key:'mo', label:'MO' },
    { key:'spcap', label:'SP cap (10% HP)' },
    { key:'enc', label:'Encumbrance' },
    { key:'et', label:'Eclipse Threshold (ET)' },
    { key:'tx', label:'Max Toxicity (TX)' },
  ];
  return [
    { label:'Characteristics', options: characteristics.map(c=>({ value:`char.${c.key}`, label:`${c.label} (modifier)` })) },
    { label:'Skills', options: skills.flatMap(c=> c.skills.map(s=>({ value:`skills.${c.key}.${s}`, label:`${s} (${c.label})` }))) },
    { label:'Derived / Resources', options: derived.map(d=>({ value:`derived.${d.key}`, label:d.label })) },
    { label:'User choice (configurable)', options: CHOICE_OPTIONS },
    { label:'Custom', options:[{ value:CUSTOM_TARGET_VALUE, label:'Custom path...' }]},
  ];
})();

const DEFAULT_NATURES = ['Fire','Water','Earth','Lightning','Wind','Sun','Moon','Ki'];
const DEFAULT_CHARACTERISTICS = ['Reflex','Dexterity','Body','Wisdom','Presence','Magic','Willpower','Tech'];
let SCHOOLS_CACHE = null;

async function loadSchoolsCached(){
  if (SCHOOLS_CACHE) return SCHOOLS_CACHE;
  try{
    const res = await api('/schools');
    SCHOOLS_CACHE = res.schools || [];
  }catch(e){
    SCHOOLS_CACHE = [];
  }
  return SCHOOLS_CACHE;
}

function skillsFromSchools(schools){
  const set = new Set();
  (schools || []).forEach(s=>{ if (s.linked_skill) set.add(s.linked_skill); });
  if (set.size === 0){
    const grp = PASSIVE_TARGET_GROUPS.find(g=>g.label==='Skills');
    (grp?.options||[]).forEach(o=>{
      const name = (o.label || '').split(' (')[0];
      if (name) set.add(name);
    });
  }
  return Array.from(set).sort();
}

function naturesFromSchools(schools){
  const set = new Set(DEFAULT_NATURES);
  (schools || []).forEach(s=>{
    (s.linked_intensities || []).forEach(n=> set.add(n));
  });
  return Array.from(set).sort();
}

function skillChoiceKeys(){
  const skillsGroup = PASSIVE_TARGET_GROUPS.find(g=> g.label === 'Skills');
  if (!skillsGroup) return [];
  return (skillsGroup.options || []).map(o=> o.value).filter(Boolean);
}
function skillChoiceItems(){
  const skillsGroup = PASSIVE_TARGET_GROUPS.find(g=> g.label === 'Skills');
  if (!skillsGroup) return [];
  return (skillsGroup.options || []).map(o=>({ key:o.value, label:o.label }));
}
function parseCsvList(txt){
  if (!txt || typeof txt !== 'string') return [];
  return txt.split(',').map(s=>s.trim()).filter(Boolean);
}

async function choiceKeysForKind(kind){
  const schools = await loadSchoolsCached();
  const skills = skillsFromSchools(schools);
  const natures = naturesFromSchools(schools);
  if (kind === 'skill_ms') return skillChoiceKeys();
  if (kind === 'nature_ms') return natures.map(n=> `intensities.${n}`);
  if (kind === 'magic_weapon' || kind === 'magic_spell') return DEFAULT_NATURES.map(n=> `intensities.${n}`);
  if (kind === 'school_ms') return (schools || []).map(sc=> `schools.${String(sc.id || '').trim()}`).filter(Boolean);
  if (kind === 'char_skill') return skillChoiceKeys();
  return [];
}

let currentAbilityId = null;
let ALL_ABILITIES = [];

async function checkMe(){
  try{
    const me = await api('/auth/me');
    loginChip.textContent = me.username + ' (' + me.role + ')';
  }catch(e){
    loginChip.textContent = 'Not logged in.';
  }
}

function addModifierRow(initial){
  const row = document.createElement('div');
  row.className = 'mod-row';

  const target = document.createElement('select');
  target.className = 'mod-target';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select target...';
  placeholder.disabled = true;
  target.appendChild(placeholder);

  let matchedPreset = false;
  PASSIVE_TARGET_GROUPS.forEach(group=>{
    const og = document.createElement('optgroup');
    og.label = group.label;
    group.options.forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o.value;
      opt.textContent = o.label;
      if (initial?.target === o.value){ opt.selected = true; matchedPreset = true; }
      og.appendChild(opt);
    });
    target.appendChild(og);
  });
  if (!matchedPreset){
    target.value = initial?.target ? CUSTOM_TARGET_VALUE : '';
  }

  const customTarget = document.createElement('input');
  customTarget.className = 'mod-target-custom';
  customTarget.placeholder = 'Custom path (ex: derived.hp)';
  customTarget.value = matchedPreset ? '' : (initial?.target || '');
  customTarget.style.display = (target.value === CUSTOM_TARGET_VALUE) ? '' : 'none';

  const mode = document.createElement('select');
  mode.className = 'mod-mode';
  ['add','mul','set'].forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    if ((initial?.mode || 'add') === m) opt.selected = true;
    mode.appendChild(opt);
  });

  const value = document.createElement('input');
  value.className = 'mod-value';
  value.type = 'number';
  value.step = '0.1';
  value.value = initial?.value ?? 0;

  const configBtn = document.createElement('button');
  configBtn.type = 'button';
  configBtn.textContent = 'Configure';
  configBtn.className = 'btn mod-config-btn';
  configBtn.style.display = 'none';

  const rm = document.createElement('button');
  rm.type = 'button';
  rm.textContent = 'Remove';
  rm.className = 'btn';
  rm.addEventListener('click', ()=> row.remove());

  // Choice configuration
  const choiceWrap = document.createElement('div');
  choiceWrap.className = 'choice-wrap';
  const choiceMax = document.createElement('input');
  choiceMax.type = 'number';
  choiceMax.min = '0';
  choiceMax.placeholder = 'Max choices (0 = unlimited)';
  choiceMax.className = 'choice-max';
  choiceMax.value = initial?.choice?.max_choices ?? 0;
  const choiceRestrict = document.createElement('input');
  choiceRestrict.type = 'text';
  choiceRestrict.placeholder = 'Restrict list (comma-separated)';
  choiceRestrict.className = 'choice-restrict';
  choiceRestrict.value =
    Array.isArray(initial?.choice?.restrict) ? initial.choice.restrict.join(', ') :
    Array.isArray(initial?.choice?.restrict_list) ? initial.choice.restrict_list.join(', ') :
    Array.isArray(initial?.choice_restrict) ? initial.choice_restrict.join(', ') :
    (initial?.choice?.restrict_text || initial?.choice?.restrict_list || initial?.choice_restrict || initial?.restrict || '');
  choiceWrap.appendChild(choiceMax);
  choiceWrap.appendChild(choiceRestrict);
  choiceWrap.style.display = 'none';

  async function ensureDefaultRestrict(){ /* no-op to preserve creator input */ }

  async function renderChoiceConfigurator(kind, wrap, restrictInput){
    wrap.innerHTML = '';

    const header = document.createElement('div');
    header.innerHTML = `<strong>Configure: ${kind.replace('_',' ')}</strong>`;
    wrap.appendChild(header);

    const maxBox = document.createElement('div');
    maxBox.style.display = 'flex';
    maxBox.style.flexDirection = 'column';
    maxBox.innerHTML = `<label class="muted">Max choices (0 = unlimited)</label>`;
    maxBox.appendChild(choiceMax);
    wrap.appendChild(maxBox);

    const listBox = document.createElement('div');
    listBox.className = 'chip-list';

    const schools = await loadSchoolsCached();
    const skills = skillsFromSchools(schools);
    const natures = naturesFromSchools(schools);

    let items = [];
    if (kind === 'skill_ms'){
      items = skills.map(s=>{
        const linked = schools.filter(sc=> (sc.linked_skill||'').toLowerCase() === s.toLowerCase()).map(sc=>sc.name||sc.id);
        const label = linked.length ? `${s} (${linked.join(', ')})` : s;
        return { key: s, label };
      });
    }else if (kind === 'nature_ms'){
      items = natures.map(n=>{
        const linked = schools.filter(sc=> (sc.linked_intensities||[]).map(x=>x.toLowerCase()).includes(n.toLowerCase())).map(sc=>sc.name||sc.id);
        const label = linked.length ? `${n} (${linked.join(', ')})` : n;
        return { key:n, label };
      });
    }else if (kind === 'magic_weapon' || kind === 'magic_spell'){
      items = DEFAULT_NATURES.map(n=>({ key:n.toLowerCase(), label:n }));
    }else if (kind === 'school_ms'){
      items = (schools || []).map(sc=>({ key: sc.id, label: `${sc.name} (${sc.school_type||'simple'})` }));
    }else if (kind === 'char_skill'){
      items = skillChoiceItems();
    }

    const allKeys = items.map(it=> String(it.key||'').trim()).filter(Boolean);
    choiceRestrict.dataset.allKeys = JSON.stringify(allKeys);

    const savedAllowed = (()=> {
      if (choiceRestrict.dataset.allowed){
        try{ return JSON.parse(choiceRestrict.dataset.allowed) || []; }catch(e){}
      }
      if (Array.isArray(initial?.choice?.choices)) return initial.choice.choices;
      if (typeof initial?.choice?.choices_text === 'string' && initial.choice.choices_text.trim()){
        return parseCsvList(initial.choice.choices_text);
      }
      return [];
    })().map(x=> String(x).trim()).filter(Boolean);

    let allowedSet = new Set(savedAllowed.map(x=> x.toLowerCase()));

    if (!allowedSet.size){
      const restrictSetInit = new Set((restrictInput.value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));
      if (restrictSetInit.size){
        allowedSet = new Set(allKeys.filter(k=> !restrictSetInit.has(k.toLowerCase())).map(k=> k.toLowerCase()));
      }
    }

    const syncRestrictInput = ()=>{
      const restrictKeys = allKeys.filter(k=> !allowedSet.has(k.toLowerCase()));
      restrictInput.value = restrictKeys.join(', ');
      choiceRestrict.dataset.allowed = JSON.stringify(Array.from(allowedSet));
    };
    syncRestrictInput();

    items.forEach(item=>{
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      const keyLower = String(item.key||'').toLowerCase();
      const allowed = allowedSet.has(keyLower);
      chip.style.opacity = allowed ? 1 : 0.5;
      chip.textContent = allowed ? item.label : `Excluded: ${item.label}`;
      chip.addEventListener('click', ()=>{
        if (allowedSet.has(keyLower)) allowedSet.delete(keyLower);
        else allowedSet.add(keyLower);
        const isAllowed = allowedSet.has(keyLower);
        chip.style.opacity = isAllowed ? 1 : 0.5;
        chip.textContent = isAllowed ? item.label : `Excluded: ${item.label}`;
        syncRestrictInput();
      });
      listBox.appendChild(chip);
    });

    if (!items.length){
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'No data found to configure.';
      wrap.appendChild(empty);
    }else{
      wrap.appendChild(listBox);
    }

    const hint = document.createElement('div');
    hint.className = 'muted';
    hint.textContent = 'Click to toggle exclusions. Users will only see non-excluded entries.';
    wrap.appendChild(hint);
  }

  function syncChoiceUI(){
    const isChoice = (target.value || '').startsWith('choice:');
    configBtn.style.display = isChoice ? '' : 'none';
    if (!isChoice){
      choiceWrap.style.display = 'none';
    }
    if (isChoice){
      ensureDefaultRestrict();
    }
  }
  target.addEventListener('change', ()=>{
    const useCustom = target.value === CUSTOM_TARGET_VALUE;
    customTarget.style.display = useCustom ? '' : 'none';
    if (!useCustom) customTarget.value = '';
    syncChoiceUI();
  });
  configBtn.addEventListener('click', async ()=>{
    const kind = (target.value || '').replace('choice:','');
    await ensureDefaultRestrict();
    await renderChoiceConfigurator(kind, choiceWrap, choiceRestrict);
    choiceWrap.style.display = choiceWrap.style.display === 'none' ? 'grid' : 'none';
  });
  syncChoiceUI();

  row.appendChild(target);
  row.appendChild(mode);
  row.appendChild(value);
  row.appendChild(configBtn);
  row.appendChild(rm);
  row.appendChild(customTarget);
  row.appendChild(choiceWrap);
  modListEl.appendChild(row);
}
btnAddMod.addEventListener('click', ()=> addModifierRow());

function updateTypeVisibility(){
  const t = typeEl.value;
  panelActive.style.display  = (t === 'active' || t === 'mixed')  ? '' : 'none';
  panelPassive.style.display = (t === 'passive' || t === 'mixed') ? '' : 'none';
}
typeEl.addEventListener('change', updateTypeVisibility);

function updateArchetypeMeta(){
  const isArc = (sourceCatEl.value || '').toLowerCase() === 'archetype';
  arcMetaEl.style.display = isArc ? '' : 'none';
}
sourceCatEl.addEventListener('change', updateArchetypeMeta);

async function loadAbilitiesForReplace(){
  try{
    const res = await api('/abilities');
    ALL_ABILITIES = res.abilities || [];
    renderReplaceOptions();
  }catch(e){
    console.error('Failed to load abilities list', e);
  }
}

function renderReplaceOptions(filter="", selected=arcReplSel.value){
  const term = (filter||"").toLowerCase();
  const opts = ALL_ABILITIES.filter(a => !term || (a.name||"").toLowerCase().includes(term));
  arcReplSel.innerHTML = `<option value="">-- none --</option>` + opts.map(a=>`<option value="${a.id}">${a.name} (${a.id})</option>`).join("");
  if (selected && !opts.find(a=>a.id===selected)){
    arcReplSel.insertAdjacentHTML('beforeend', `<option value="${selected}" selected>${selected}</option>`);
  }else{
    arcReplSel.value = selected || "";
  }
}
arcReplSearch.addEventListener('input', ()=>{
  clearTimeout(arcReplSearch._t);
  arcReplSearch._t = setTimeout(()=> renderReplaceOptions(arcReplSearch.value, arcReplSel.value), 200);
});

async function buildPayloadFromForm(){
  const tags = (tagsEl.value || '').split(',')
    .map(t=>t.trim()).filter(Boolean);

  const base = {
    name: nameEl.value || '',
    type: typeEl.value,
    source_category: sourceCatEl.value,
    source_ref: sourceRefEl.value || '',
    tags,
    description: descEl.value || '',
  };

  let active = null;
  if (typeEl.value === 'active' || typeEl.value === 'mixed') {
    active = {
      activation: actActivationEl.value,
      range: Number(actRangeEl.value || 0),
      aoe: actAoeEl.value || '',
      costs: {
        HP: Number(costHpEl.value || 0),
        EN: Number(costEnEl.value || 0),
        MP: Number(costMpEl.value || 0),
        FO: Number(costFoEl.value || 0),
        MO: Number(costMoEl.value || 0),
        TX: Number(costTxEl.value || 0),
        other_label: costOLabelEl.value || '',
        other_value: Number(costOValEl.value || 0),
      }
    };
  }

  let passive = null;
  if (typeEl.value === 'passive' || typeEl.value === 'mixed') {
    const mods = [];
    for (const row of modListEl.querySelectorAll('.mod-row')){
      const targetSel = row.querySelector('.mod-target');
      const customTarget = row.querySelector('.mod-target-custom');
      const modeEl   = row.querySelector('.mod-mode');
      const valueEl  = row.querySelector('.mod-value');
      const choiceMax    = row.querySelector('.choice-max');
      const choiceRestrict = row.querySelector('.choice-restrict');

      const isChoice = (targetSel.value || '').startsWith('choice:');
      let choice = null;
      if (isChoice){
        const kind = (targetSel.value || '').replace('choice:','') || 'custom';
        const allKeys = (()=> {
          try{ return JSON.parse(choiceRestrict?.dataset?.allKeys || '[]'); }catch(e){ return []; }
        })();
        const allowedList = (()=>{
          try{
            const raw = choiceRestrict?.dataset?.allowed ? JSON.parse(choiceRestrict.dataset.allowed) : [];
            return Array.isArray(raw) ? raw : [];
          }catch(e){ return []; }
        })().map(x=> String(x).trim()).filter(Boolean);
        const allowedLower = new Set(allowedList.map(x=> x.toLowerCase()));
        const restrictList = allKeys.filter(k=> !allowedLower.has(String(k).trim().toLowerCase()));
        choice = {
          kind,
          max_choices: Math.max(0, Number(choiceMax?.value || 0)),
          restrict: restrictList,
          restrict_text: restrictList.join(', '),
          choices: allowedList
        };
      }

      const resolvedTarget = targetSel.value === CUSTOM_TARGET_VALUE ? (customTarget.value || '').trim() : targetSel.value.trim();
      const parsedValue = parseFloat(valueEl.value || '0');
      const finalTarget = choice ? `choice:${choice.kind}` : resolvedTarget;
      if (!finalTarget) return;
      const modPayload = { target: finalTarget, mode: modeEl.value, value: parsedValue, note:'' };
      if (choice) modPayload.choice = choice;
      mods.push(modPayload);
    }
    passive = {
      description: passiveDescEl.value || '',
      modifiers: mods,
    };
  }

  const out = base;
  if (active) out.active = active;
  if (passive) out.passive = passive;
  if ((sourceCatEl.value || '').toLowerCase() === 'archetype'){
    out.archetype_original_rank = Number(arcOrigRankEl.value || 0);
    out.archetype_version = Number(arcVersionEl.value || 1);
    out.archetype_replaces = (arcReplSel.value || '').trim();
  }
  return out;
}

function populateForm(a){
  currentAbilityId = a.id;
  abIdEl.textContent = a.id || '(no id)';
  nameEl.value       = a.name || '';
  typeEl.value       = a.type || 'passive';
  sourceCatEl.value  = a.source_category || 'Other';
  sourceRefEl.value  = a.source_ref || '';
  tagsEl.value       = (a.tags || []).join(', ');
  descEl.value       = a.description || '';
  arcVersionEl.value = a.archetype_version || 1;
  arcOrigRankEl.value= a.archetype_original_rank || 1;
  arcReplSel.value   = a.archetype_replaces || '';

  // passive
  const passive = a.passive || {};
  passiveDescEl.value = passive.description || '';
  modListEl.innerHTML = '';
  (passive.modifiers || []).forEach(m=> addModifierRow(m));

  // active
  const active = a.active || {};
  actActivationEl.value = active.activation || 'Action';
  actRangeEl.value      = active.range ?? 0;
  actAoeEl.value        = active.aoe || '';

  const costs = active.costs || {};
  costHpEl.value     = costs.HP ?? 0;
  costEnEl.value     = costs.EN ?? 0;
  costMpEl.value     = costs.MP ?? 0;
  costFoEl.value     = costs.FO ?? 0;
  costMoEl.value     = costs.MO ?? 0;
  costTxEl.value     = costs.TX ?? 0;
  costOLabelEl.value = costs.other_label || '';
  costOValEl.value   = costs.other_value ?? 0;

  updateTypeVisibility();
  updateArchetypeMeta();
  renderReplaceOptions(arcReplSearch.value || "", a.archetype_replaces || arcReplSel.value);
}

async function loadAbilities(){
  try{
    const params = [];
    if (filterNameEl.value) params.push('name='+encodeURIComponent(filterNameEl.value));
    if (filterTypeEl.value) params.push('typ='+encodeURIComponent(filterTypeEl.value));
    if (filterSourceEl.value) params.push('source='+encodeURIComponent(filterSourceEl.value));
    const qs = params.length ? '?'+params.join('&') : '';
    const res = await api('/abilities'+qs);
    const arr = res.abilities || [];
    abilityListEl.innerHTML = '';
    if (!arr.length){
      abilityListEl.innerHTML = '<div class="muted">No abilities found.</div>';
      return;
    }
    arr.forEach(a=>{
      const div = document.createElement('div');
      div.className = 'ability-item';
      if (a.id === currentAbilityId) div.classList.add('active');
      const left = document.createElement('span');
      left.textContent = a.name;
      const right = document.createElement('span');
      right.className = 'badge';
      right.textContent = a.type || '';
      div.appendChild(left);
      div.appendChild(right);
      div.addEventListener('click', async ()=>{
        try{
          const full = await api('/abilities/'+encodeURIComponent(a.id));
          populateForm(full.ability);
          document.querySelectorAll('.ability-item').forEach(x=>x.classList.remove('active'));
          div.classList.add('active');
          statusLine.textContent = 'Loaded '+a.id;
        }catch(e){
          statusLine.textContent = 'Error loading ability: '+e.message;
        }
      });
      abilityListEl.appendChild(div);
    });
  }catch(err){
    abilityListEl.innerHTML = '<div class="muted">Error: '+err.message+'</div>';
  }
}

filterNameEl.addEventListener('input', ()=>{
  clearTimeout(filterNameEl._t);
  filterNameEl._t = setTimeout(loadAbilities, 250);
});
filterTypeEl.addEventListener('change', loadAbilities);
filterNameEl.addEventListener('input', ()=>{
  clearTimeout(filterNameEl._t);
  filterNameEl._t = setTimeout(loadAbilities, 250);
});
filterTypeEl.addEventListener('change', loadAbilities);
filterSourceEl.addEventListener('change', loadAbilities);

btnSave.addEventListener('click', async ()=>{
  if (!currentAbilityId){
    statusLine.textContent = 'No ability selected.';
    return;
  }
  try{
    statusLine.textContent = 'Saving…';
    const payload = await buildPayloadFromForm();
    console.log('[AbilityEdit] Outgoing payload (choices)', JSON.stringify(payload.passive?.modifiers?.filter(m=>String(m.target||'').startsWith('choice:')), null, 2));
    const res = await api('/abilities/'+encodeURIComponent(currentAbilityId), {
      method:'PUT',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload),
    });
    try{
      const check = await api('/abilities/'+encodeURIComponent(res.ability.id));
      console.log('[AbilityEdit] Stored ability (choices)', JSON.stringify(check.ability?.passive?.modifiers?.filter(m=>String(m.target||'').startsWith('choice:')), null, 2));
      const same = JSON.stringify(payload.passive?.modifiers||[]) === JSON.stringify(check.ability?.passive?.modifiers||[]);
      console.log('[AbilityEdit] Choice payload match DB:', same ? 'OK' : 'MISMATCH');
      statusLine.textContent = same ? 'Saved '+res.ability.id+' (choices OK)' : 'Saved '+res.ability.id+' (choices mismatch, see console)';
    }catch(e){
      console.warn('[AbilityEdit] Could not refetch ability for verification', e);
      statusLine.textContent = 'Saved '+res.ability.id+' (verify console)';
    }
    loadAbilities();
  }catch(err){
    statusLine.textContent = 'Error: '+err.message;
  }
});

checkMe().then(()=> Promise.all([loadAbilities(), loadAbilitiesForReplace()]));
</script>
</body>
</html>
