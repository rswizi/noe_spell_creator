<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Apotheoses</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .hidden{display:none!important}
    .scroll-pad { max-height: 64vh; overflow:auto; }
    .effect-entry{ display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #222; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid #444; border-radius:999px; margin-right:6px; }
    .modal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000; padding:16px; }
    .modal-card{ width:min(820px,96vw); max-height:90vh; overflow:auto; background:#111; color:#eee; border-radius:16px; padding:20px 22px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .modal-close{ float:right; font-size:28px; line-height:1; background:transparent; border:0; color:#aaa; cursor:pointer; }
    .modal-close:hover{ color:#fff; }
    .effect-entry{ align-items:flex-start; }        /* top-align left text with the buttons */
    .actions-col{ display:flex; flex-direction:column; gap:8px; align-items:stretch; }
    .actions-col .btn{ width:160px; text-align:center; }  /* consistent width */
    @media (max-width:700px){
    .actions-col .btn{ width:100%; }
    }
      </style>
</head>
<body>
  <div class="container">
    <h1>Apotheoses</h1>
    <div id="loginInfo" class="small" style="opacity:.8;margin-top:-8px;margin-bottom:12px;"></div>

    <div class="home-card">
      <div class="filter-bar">
        <input id="f-name" type="text" placeholder="Filter by name…" />
        <select id="f-stage">
          <option value="">All Stages</option>
          <option value="Stage I">Stage I</option>
          <option value="Stage II">Stage II</option>
          <option value="Stage III">Stage III</option>
          <option value="Stage IV">Stage IV</option>
          <option value="Stage V">Stage V</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="f-star" />
          <span>Only starred</span>
        </label>
        <button id="f-reset">Reset</button>
      </div>
    </div>

    <div class="home-card">
      <div id="results" class="scroll-pad"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="apotheosis_home.html">← Back</a>
    </div>
  </div>

  <!-- Details modal -->
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <button id="modal-close" class="modal-close" aria-label="Close">×</button>
      <h2 id="m-title"></h2>
      <p id="m-desc" style="opacity:.9"></p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;">
        <div>
          <div><strong>Stage:</strong> <span id="m-stage"></span></div>
          <div><strong>Characteristic:</strong> <span id="m-char"></span></div>
        </div>
        <div>
          <div><strong>Power:</strong> <span id="m-power"></span></div>
          <div><strong>Stability:</strong> <span id="m-stab"></span></div>
          <div><strong>Amplitude:</strong> <span id="m-amp"></span></div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <strong>Constraints:</strong>
        <div id="m-constraints" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    // ---- state ----
    let CACHE = [];
    let STARS = new Set(JSON.parse(localStorage.getItem("apoth_stars") || "[]"));
    let ME = null; // { username, role } or null

    // ---- auth helpers ----
    const token = () => localStorage.getItem("auth_token") || "";
    const authHeaders = () => (token() ? { "Authorization": "Bearer " + token() } : {});
    const updateLoginInfo = () => {
      const el = document.getElementById("loginInfo");
      if (!el) return;
      el.textContent = ME ? `Logged in as ${ME.username} (${ME.role})` : "Not logged in";
    };
    async function readJson(res){
      const txt = await res.text();
      try { return JSON.parse(txt); } catch {
        return { status: res.ok ? "success":"error", message: txt };
      }
    }
    async function loadMe(){
      if (!token()) { ME = null; updateLoginInfo(); return; }
      try {
        const r = await fetch(`/auth/me`, { headers: authHeaders() });
        const j = await readJson(r);
        ME = j.status === "success" ? { username: j.username, role: j.role } : null;
      } catch { ME = null; }
      updateLoginInfo();
    }

    // ---- UI helpers ----
    function starToggle(id){
      if (STARS.has(id)) STARS.delete(id); else STARS.add(id);
      localStorage.setItem("apoth_stars", JSON.stringify([...STARS]));
      render(CACHE);
    }
    const canEdit   = a => ME && (ME.username === a.creator || ["moderator","admin"].includes(ME.role));
    const canDelete = a => ME && ["moderator","admin"].includes(ME.role);

    function row(a){
      const s = a.stats || {};
      const starred = STARS.has(a.id);
      const editBtn = canEdit(a)   ? `<button class="btn"            onclick="editApotheosis('${a.id}')">Edit</button>` : "";
      const delBtn  = canDelete(a) ? `<button class="btn btn-danger"  onclick="deleteApotheosis('${a.id}')">Delete</button>` : "";
      const dupBtn  = `<button class="btn" onclick="duplicateApotheosis('${a.id}')">Duplicate</button>`;
      return `
        <div class="effect-entry">
          <div style="flex:1;">
            <div style="font-weight:bold">${a.name} <span style="opacity:.7">[${a.id}]</span></div>
            <div class="small" style="opacity:.85">${a.description||""}</div>
            <div class="small" style="margin-top:6px;">
              <span class="pill">${a.stage}</span>
              <span class="pill">Power ${s.power ?? "—"}</span>
              <span class="pill">Stability ${s.stability ?? "—"}</span>
              <span class="pill">Amplitude ${s.amplitude ?? "—"}</span>
            </div>
            <div class="small" style="margin-top:4px;opacity:.7;">Creator: ${a.creator || "—"}</div>
          </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
              <button class="btn" onclick="openDetails('${a.id}')">Details</button>
              ${dupBtn}
              ${editBtn}
              ${delBtn}
              <button class="${starred?'btn btn-secondary':'btn'}" onclick="starToggle('${a.id}')">${starred?'Unstar':'Star'}</button>
            </div>
        </div>`;
    }

    function render(list){
      const fName = $("#f-name").value.trim().toLowerCase();
      const fStage = $("#f-stage").value;
      const onlyStar = $("#f-star").checked;

      let out = list.slice();
      if (fName)  out = out.filter(a => (a.name||"").toLowerCase().includes(fName));
      if (fStage) out = out.filter(a => (a.stage||"") === fStage);
      if (onlyStar) out = out.filter(a => STARS.has(a.id));

      $("#results").innerHTML = out.length ? out.map(row).join("") : `<p>No results.</p>`;
    }

    async function load(){
      const r = await fetch(`/apotheoses`);
      const j = await readJson(r);
      CACHE = j.apotheoses || [];
      render(CACHE);
    }

    // ---- modal ----
    function openDetails(id){
      const a = CACHE.find(x=>String(x.id)===String(id));
      if (!a) return;
      $("#m-title").textContent = `${a.name} [${a.id}]`;
      $("#m-desc").textContent  = a.description || "—";
      $("#m-stage").textContent = a.stage || "—";
      $("#m-char").textContent  = a.characteristic_value ?? "—";
      const s = a.stats || {};
      $("#m-power").textContent = s.power ?? "—";
      $("#m-stab").textContent  = s.stability ?? "—";
      $("#m-amp").textContent   = s.amplitude ?? "—";
      const cs = (a.constraints||[]).map(c => `<span class="pill">${c}</span>`).join("");
      $("#m-constraints").innerHTML = cs || "—";
      $("#modal").classList.remove("hidden");
      $("#modal").setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      $("#modal").classList.add("hidden");
      $("#modal").setAttribute("aria-hidden", "true");
    }

    // ---- actions ----
    function editApotheosis(id){
      // reuse creator page as an editor
      window.location.href = `apotheosis_create.html?edit=${encodeURIComponent(id)}`;
    }
    async function duplicateApotheosis(id){
      try{
        const r = await fetch(`/apotheoses/${id}/duplicate`, { method: "POST", headers: { ...authHeaders() }});
        const j = await readJson(r);
        if (j.status !== "success") throw new Error(j.message || `Duplicate failed (${r.status})`);
        await load();
        alert(`Duplicated as ${j.apotheosis.id}`);
      }catch(e){ alert(e.message || "Duplicate failed."); }
    }
    async function deleteApotheosis(id){
      if (!confirm(`Delete ${id}? This cannot be undone.`)) return;
      try{
        const r = await fetch(`/apotheoses/${id}`, { method: "DELETE", headers: { ...authHeaders() }});
        const j = await readJson(r);
        if (j.status !== "success") throw new Error(j.message || `Delete failed (${r.status})`);
        CACHE = CACHE.filter(a => a.id !== id);
        render(CACHE);
      }catch(e){ alert(e.message || "Delete failed."); }
    }

    // util
    function debounce(fn, ms=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    // boot
    document.addEventListener("DOMContentLoaded", async ()=>{
      await loadMe();
      await load();

      const run = debounce(()=>render(CACHE), 200);
      $("#f-name").addEventListener("input", run);
      $("#f-stage").addEventListener("change", run);
      $("#f-star").addEventListener("change", run);
      $("#f-reset").addEventListener("click", ()=>{
        $("#f-name").value=""; $("#f-stage").value=""; $("#f-star").checked=false; render(CACHE);
      });

      $("#modal-close").addEventListener("click", closeModal);
      $("#modal").addEventListener("click", e=>{ if(e.target.id==="modal") closeModal(); });
      document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeModal(); });
    });
  </script>
</body>
</html>