<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign Manager</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #14090c;
      --bg-2: #0c0b12;
      --panel: #121219;
      --border: #252533;
      --accent: #c53535;
      --text: #f3f3f5;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #1a0c0f 0%, #0b0b10 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: 100% 100%;
    }
    .page { min-height: 100vh; display: grid; place-items: start center; }
    .wrap { width: 100%; max-width: 1100px; padding: 28px 16px 60px; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:24px; letter-spacing:0.5px; }
    button, input { padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#181821; color:var(--text); }
    button:hover { background:#1f1f2a; border-color:#2f2f42; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { border:1px solid var(--border); border-radius:16px; padding:12px; background: linear-gradient(135deg, rgba(197,53,53,0.15), rgba(12,12,18,0.95)); box-shadow: 0 10px 28px rgba(0,0,0,0.28); display:grid; gap:8px; }
    .muted { opacity:.8; font-size:.9rem; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid #2f2f3f; font-size:.82rem; }
    .avatar { width:52px; height:52px; border:1px solid #333; border-radius:12px; overflow:hidden; background:#0b0b10; flex-shrink:0; display:grid; place-items:center; }
    .avatar img { width:100%; height:100%; object-fit:cover; }
    .char-row { display:flex; gap:10px; align-items:center; padding:6px 8px; border:1px solid #252533; border-radius:12px; background:#11111a; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .section { border:1px solid var(--border); border-radius:14px; padding:12px; background: var(--panel); box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .labelled { display:grid; gap:4px; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">
    <div class="topbar">
      <h1>Campaign Manager</h1>
      <a href="portal.html" class="btn">Portal</a>
      <span id="login-chip" class="muted" style="margin-left:auto;"></span>
      <span id="status" class="muted"></span>
    </div>

    <div class="section" style="margin-bottom:16px;">
      <div class="row" style="gap:12px;">
        <div class="labelled">
          <span class="muted">Create</span>
          <div class="row">
            <input id="camp-name" placeholder="Campaign name">
            <button id="camp-create">Create</button>
          </div>
        </div>
        <div class="labelled">
          <span class="muted">Join by code</span>
          <div class="row">
            <input id="camp-code" placeholder="ABC123" style="width:140px;">
            <button id="camp-join">Join</button>
          </div>
        </div>
      </div>
    </div>

    <div id="camp-list" class="grid"></div>
    <p id="empty" class="muted" style="display:none;">No campaigns yet. Create or join one.</p>
  </div></div>

<script>
const loginChip = document.getElementById("login-chip");
const statusEl = document.getElementById("status");
const listEl = document.getElementById("camp-list");
const emptyEl = document.getElementById("empty");

function authHeaders(){
  const tok = localStorage.getItem("auth_token") || "";
  return tok ? { "Authorization": "Bearer " + tok, "X-Auth-Token": tok } : {};
}
async function api(path, opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get("content-type") || "";
  const data = ct.includes("application/json") ? await resp.json() : { status:"error", message: await resp.text() };
  if (!resp.ok || data.status === "error") throw new Error(data.message || `HTTP ${resp.status}`);
  return data;
}

async function checkMe(){
  loginChip.textContent = "Checking login...";
  try{
    const me = await api("/auth/me");
    loginChip.textContent = `${me.username} (${me.role})`;
    return me;
  }catch(e){
    loginChip.textContent = "Not logged in";
    throw e;
  }
}

let CAMPAIGNS = [];
let MY_CHARACTERS = [];

function fallbackAvatar(ev){
  ev.target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9WUZPi8AAAAASUVORK5CYII=';
}

function render(){
  listEl.innerHTML = "";
  if (!CAMPAIGNS.length){
    emptyEl.style.display = "";
    return;
  }
  emptyEl.style.display = "none";
  CAMPAIGNS.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    const members = (c.members || []).join(", ");
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div>
          <strong>${c.name}</strong>
          <div class="muted">Owner: ${c.owner}</div>
        </div>
        ${c.is_owner ? `<span class="pill">Join code: ${c.join_code}</span>` : ""}
        <a class="btn small" href="campaign_view.html?cid=${encodeURIComponent(c.id)}" target="_blank">Open</a>
      </div>
      <div class="muted">Members: ${members || "None"}</div>
      <div class="section">
        <div class="row" style="gap:8px; align-items:flex-end;">
          <div class="labelled">
            <span class="muted">Character</span>
            <select class="char-id">
              ${(window.MY_CHARACTERS||[]).map(ch=>`<option value="${ch.id}">${ch.name||ch.id}</option>`).join('')}
            </select>
          </div>
          <div class="labelled">
            <span class="muted">Assign to (user)</span>
            <select class="assign-to">
              <option value="">Unassigned</option>
              <option value="${c.owner}">${c.owner} (GM)</option>
              ${(c.members||[]).map(m=>`<option value="${m}">${m}</option>`).join('')}
            </select>
          </div>
          <div class="labelled">
            <span class="muted">Folder (path)</span>
            <input class="folder" placeholder="e.g. Party/Tank">
          </div>
          <label class="row muted" style="gap:6px;">
            <input type="checkbox" class="editable"> GM can edit
          </label>
          <button class="btn small assign-btn"${c.is_owner ? "" : " disabled title='GM only'"}>Assign</button>
        </div>
      </div>
      <div class="muted">Characters</div>
      <div class="list chars"></div>
    `;
    const charsEl = card.querySelector(".chars");
    const chars = (c.characters || []).slice().sort((a,b)=> (a.folder||'').localeCompare(b.folder||''));
    if (!chars.length){
      charsEl.innerHTML = `<div class="muted">No characters yet.</div>`;
    }else{
      chars.forEach(ch=>{
        const row = document.createElement("div");
        row.className = "char-row";
        const assigned = ch.assigned_to || "Unassigned";
        const folder = ch.folder || "(root)";
        const editable = ch.editable_by_gm ? "Editable by GM" : "View only";
        const requests = (ch.edit_requests || []).join(", ");
        row.innerHTML = `
          <div class="avatar"><img src="/characters/${encodeURIComponent(ch.character_id)}/avatar" alt="avatar" onerror="this.onerror=null; this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9WUZPi8AAAAASUVORK5CYII=';"></div>
          <div class="grow">
            <div><strong>${ch.character_id}</strong></div>
            <div class="muted">Folder: ${folder} • Assigned: ${assigned} • ${editable}</div>
            ${requests ? `<div class="muted">Edit requests: ${requests}</div>` : ""}
          </div>
          ${c.is_owner ? "" : `<button class="btn small req-edit">Request edit</button>`}
        `;
        if (!c.is_owner){
          row.querySelector(".req-edit").addEventListener("click", async ()=>{
            try{
              statusEl.textContent = "Requesting edit...";
              await api(`/campaigns/${encodeURIComponent(c.id)}/request_edit`, {
                method:"POST",
                headers:{ "content-type":"application/json" },
                body: JSON.stringify({ character_id: ch.character_id })
              });
              await loadCampaigns();
              statusEl.textContent = "Request sent.";
            }catch(e){
              statusEl.textContent = "Request failed: "+e.message;
              alert(e.message);
            }
          });
        }
        charsEl.appendChild(row);
      });
    }
    const assignBtn = card.querySelector(".assign-btn");
    if (assignBtn){
      assignBtn.addEventListener("click", async ()=>{
        const charId = (card.querySelector(".char-id").value || "").trim();
        if (!charId){ alert("Character id required"); return; }
        const assigned_to = (card.querySelector(".assign-to").value || "").trim();
        const folder = (card.querySelector(".folder").value || "").trim();
        const editable = !!card.querySelector(".editable").checked;
        try{
          statusEl.textContent = "Assigning...";
          await api(`/campaigns/${encodeURIComponent(c.id)}/assign_character`, {
            method:"POST",
            headers:{ "content-type":"application/json" },
            body: JSON.stringify({ character_id: charId, assigned_to, folder, editable_by_gm: editable })
          });
          await loadCampaigns();
          statusEl.textContent = "Assigned.";
        }catch(e){
          statusEl.textContent = "Assign failed: "+e.message;
          alert(e.message);
        }
      });
    }
    listEl.appendChild(card);
  });
}

async function loadCampaigns(){
  try{
    const chars = await api('/characters');
    MY_CHARACTERS = chars.characters || [];
  }catch{}
  const res = await api("/campaigns");
  CAMPAIGNS = res.campaigns || [];
  render();
}

document.getElementById("camp-create").addEventListener("click", async ()=>{
  const name = (document.getElementById("camp-name").value || "").trim() || "New Campaign";
  try{
    statusEl.textContent = "Creating...";
    await api("/campaigns", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ name }) });
    document.getElementById("camp-name").value = "";
    await loadCampaigns();
    statusEl.textContent = "Created.";
  }catch(e){
    statusEl.textContent = "Create failed: "+e.message;
    alert(e.message);
  }
});

document.getElementById("camp-join").addEventListener("click", async ()=>{
  const code = (document.getElementById("camp-code").value || "").trim();
  if (!code){ alert("Enter code"); return; }
  try{
    statusEl.textContent = "Joining...";
    await api("/campaigns/join", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ code }) });
    document.getElementById("camp-code").value = "";
    await loadCampaigns();
    statusEl.textContent = "Joined.";
  }catch(e){
    statusEl.textContent = "Join failed: "+e.message;
    alert(e.message);
  }
});

checkMe().then(loadCampaigns).catch(()=>{ statusEl.textContent = "Login required."; });
</script>
</body>
</html>
