<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign Manager</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #14090c;
      --bg-2: #0c0b12;
      --panel: #121219;
      --border: #252533;
      --accent: #c53535;
      --text: #f3f3f5;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #1a0c0f 0%, #0b0b10 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: 100% 100%;
    }
    .page { min-height: 100vh; display: grid; place-items: start center; }
    .wrap { width: 100%; max-width: 1100px; padding: 28px 16px 60px; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:24px; letter-spacing:0.5px; }
    button, input { padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#181821; color:var(--text); }
    button:hover { background:#1f1f2a; border-color:#2f2f42; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { border:1px solid var(--border); border-radius:16px; padding:12px; background: linear-gradient(135deg, rgba(197,53,53,0.15), rgba(12,12,18,0.95)); box-shadow: 0 10px 28px rgba(0,0,0,0.28); display:grid; gap:8px; }
    .muted { opacity:.8; font-size:.9rem; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid #2f2f3f; font-size:.82rem; }
    .avatar { width:52px; height:52px; border:1px solid #333; border-radius:12px; overflow:hidden; background:#0b0b10; flex-shrink:0; display:grid; place-items:center; }
    .avatar img { width:100%; height:100%; object-fit:cover; }
    .char-row { display:flex; gap:10px; align-items:center; padding:6px 8px; border:1px solid #252533; border-radius:12px; background:#11111a; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .section { border:1px solid var(--border); border-radius:14px; padding:12px; background: var(--panel); box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .labelled { display:grid; gap:4px; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">
    <div class="topbar">
      <h1>Campaign Manager</h1>
      <a href="portal.html" class="btn">Portal</a>
      <span id="login-chip" class="muted" style="margin-left:auto;"></span>
      <span id="status" class="muted"></span>
    </div>

    <div class="section" style="margin-bottom:16px;">
      <div class="row" style="gap:12px; flex-wrap:wrap;">
        <div class="labelled" style="min-width:280px;">
          <span class="muted">Create</span>
          <div class="row">
            <input id="camp-name" placeholder="Campaign name">
            <button id="camp-create">Create</button>
          </div>
          <textarea id="camp-desc" rows="2" placeholder="Description (optional)" style="width:100%; margin-top:6px;"></textarea>
          <div class="muted" style="font-size:.85rem;">You can set an avatar after creating.</div>
        </div>
        <div class="labelled" style="min-width:320px;">
          <span class="muted">Join by code</span>
          <div class="row">
            <input id="camp-code" placeholder="ABC123" style="width:140px;">
            <select id="join-char" style="min-width:180px;"></select>
            <button id="camp-join">Join</button>
          </div>
          <div class="muted" style="font-size:.85rem;">Pick one of your characters or create a new one when joining.</div>
        </div>
      </div>
    </div>

    <div id="camp-list" class="grid"></div>
    <p id="empty" class="muted" style="display:none;">No campaigns yet. Create or join one.</p>
  </div></div>

<script>
const loginChip = document.getElementById("login-chip");
const statusEl = document.getElementById("status");
const listEl = document.getElementById("camp-list");
const emptyEl = document.getElementById("empty");
const joinCharSelect = document.getElementById("join-char");
const createDescEl = document.getElementById("camp-desc");

function authHeaders(){
  const tok = localStorage.getItem("auth_token") || "";
  return tok ? { "Authorization": "Bearer " + tok, "X-Auth-Token": tok } : {};
}
async function api(path, opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get("content-type") || "";
  const data = ct.includes("application/json") ? await resp.json() : { status:"error", message: await resp.text() };
  if (!resp.ok || data.status === "error") throw new Error(data.message || `HTTP ${resp.status}`);
  return data;
}

async function checkMe(){
  loginChip.textContent = "Checking login...";
  try{
    const me = await api("/auth/me");
    loginChip.textContent = `${me.username} (${me.role})`;
    return me;
  }catch(e){
    loginChip.textContent = "Not logged in";
    throw e;
  }
}

let CAMPAIGNS = [];
let MY_CHARACTERS = [];

function fallbackAvatar(ev){
  ev.target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9WUZPi8AAAAASUVORK5CYII=';
}

async function uploadAvatar(cid, file){
  const headers = authHeaders();
  const fd = new FormData();
  fd.append("file", file);
  const resp = await fetch(`/campaigns/${encodeURIComponent(cid)}/avatar`, { method:"POST", body: fd, credentials:"include", headers });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
}

function render(){
  listEl.innerHTML = "";
  if (!CAMPAIGNS.length){
    emptyEl.style.display = "";
    return;
  }
  emptyEl.style.display = "none";
  CAMPAIGNS.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    const members = (c.members || []).join(", ");
    const avatarUrl = c.avatar_url ? `${c.avatar_url}?ts=${Date.now()}` : `/campaigns/${encodeURIComponent(c.id)}/avatar?ts=${Date.now()}`;
    card.innerHTML = `
      <div class="row" style="justify-content:space-between; gap:8px;">
        <div class="row" style="gap:10px;">
          <div class="avatar"><img src="${avatarUrl}" onerror="fallbackAvatar(event)"></div>
          <div>
            <strong>${c.name}</strong>
            <div class="muted">Owner: ${c.owner}</div>
            <div class="muted">Members: ${members || "None"}</div>
          </div>
        </div>
        <div class="row" style="gap:8px; align-items:center;">
          <span class="pill">${c.is_owner ? "Join code:" : "Code:"} ${c.join_code || "--"}</span>
          <a class="btn small" href="campaign_view.html?cid=${encodeURIComponent(c.id)}">Open</a>
        </div>
      </div>
      <div class="muted">${c.description || "No description."}</div>
      ${c.is_owner ? `
      <div class="row" style="gap:8px; align-items:flex-end;">
        <div class="labelled" style="flex:1;">
          <span class="muted">Edit description</span>
          <textarea class="desc" rows="2" style="width:100%;">${c.description || ""}</textarea>
        </div>
        <div class="labelled">
          <span class="muted">Avatar</span>
          <input type="file" class="avatar-file" accept="image/png,image/jpeg">
        </div>
        <button class="btn small save-desc">Save</button>
        <button class="btn small upload-avatar">Upload avatar</button>
      </div>
      ` : ""}
      ${c.is_owner ? `
      <div class="section" style="margin-top:8px;">
        <div class="row" style="gap:8px; align-items:flex-end;">
          <div class="labelled">
            <span class="muted">Add / Assign character</span>
            <select class="char-id">
              ${(MY_CHARACTERS||[]).map(ch=>`<option value="${ch.id}">${ch.name||ch.id}</option>`).join('')}
            </select>
          </div>
          <div class="labelled">
            <span class="muted">Assign to (member)</span>
            <select class="assign-to">
              <option value="">Unassigned</option>
              <option value="${c.owner}">${c.owner} (GM)</option>
              ${(c.members||[]).map(m=>`<option value="${m}">${m}</option>`).join('')}
            </select>
          </div>
          <div class="labelled">
            <span class="muted">Folder</span>
            <input class="folder" placeholder="e.g. Party/Tank">
          </div>
          <label class="row muted" style="gap:6px;">
            <input type="checkbox" class="editable"> GM can edit
          </label>
          <button class="btn small assign-btn">Add & Assign</button>
        </div>
      </div>
      ` : ""}
    `;

    if (c.is_owner){
      const saveDescBtn = card.querySelector(".save-desc");
      const descEl = card.querySelector(".desc");
      saveDescBtn?.addEventListener("click", async ()=>{
        try{
          statusEl.textContent = "Saving description...";
          await api(`/campaigns/${encodeURIComponent(c.id)}`, {
            method:"PATCH",
            headers:{ "content-type":"application/json" },
            body: JSON.stringify({ description: descEl.value || "" })
          });
          statusEl.textContent = "Saved.";
          await loadCampaigns();
        }catch(e){
          statusEl.textContent = "Save failed: "+e.message;
          alert(e.message);
        }
      });
      const uploadBtn = card.querySelector(".upload-avatar");
      const avatarFile = card.querySelector(".avatar-file");
      uploadBtn?.addEventListener("click", async ()=>{
        const file = avatarFile?.files?.[0];
        if (!file){ alert("Choose an image first."); return; }
        try{
          statusEl.textContent = "Uploading avatar...";
          await uploadAvatar(c.id, file);
          statusEl.textContent = "Uploaded.";
          await loadCampaigns();
        }catch(e){
          statusEl.textContent = "Upload failed: "+e.message;
          alert(e.message);
        }
      });

      const assignBtn = card.querySelector(".assign-btn");
      assignBtn.addEventListener("click", async ()=>{
        const charId = (card.querySelector(".char-id").value || "").trim();
        if (!charId){ alert("Character required"); return; }
        const assigned_to = (card.querySelector(".assign-to").value || "").trim();
        const folder = (card.querySelector(".folder").value || "").trim();
        const editable = !!card.querySelector(".editable").checked;
        try{
          statusEl.textContent = "Assigning...";
          await api(`/campaigns/${encodeURIComponent(c.id)}/assign_character`, {
            method:"POST",
            headers:{ "content-type":"application/json" },
            body: JSON.stringify({ character_id: charId, assigned_to, folder, editable_by_gm: editable })
          });
          statusEl.textContent = "Assigned.";
        }catch(e){
          statusEl.textContent = "Assign failed: "+e.message;
          alert(e.message);
        }
      });
    }

    listEl.appendChild(card);
  });
}

async function loadCampaigns(){
  const res = await api("/campaigns");
  CAMPAIGNS = res.campaigns || [];
  render();
}

async function loadMyCharacters(){
  try{
    const res = await api("/characters");
    MY_CHARACTERS = res.characters || [];
  }catch(e){
    MY_CHARACTERS = [];
  }
  renderJoinCharOptions();
}

function renderJoinCharOptions(){
  if (!joinCharSelect) return;
  const opts = ['<option value=\"\">No character</option>'];
  opts.push('<option value=\"__new__\">+ Create new character</option>');
  (MY_CHARACTERS||[]).forEach(ch=>{
    opts.push(`<option value=\"${ch.id}\">${ch.name || ch.id}</option>`);
  });
  joinCharSelect.innerHTML = opts.join(\"\\n\");
}

document.getElementById("camp-create").addEventListener("click", async ()=>{
  const name = (document.getElementById("camp-name").value || "").trim() || "New Campaign";
  const description = (createDescEl?.value || "").trim();
  try{
    statusEl.textContent = "Creating...";
    await api("/campaigns", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ name, description }) });
    document.getElementById("camp-name").value = "";
    if (createDescEl) createDescEl.value = "";
    await loadCampaigns();
    statusEl.textContent = "Created.";
  }catch(e){
    statusEl.textContent = "Create failed: "+e.message;
    alert(e.message);
  }
});

document.getElementById("camp-join").addEventListener("click", async ()=>{
  const code = (document.getElementById("camp-code").value || "").trim();
  let charId = joinCharSelect ? (joinCharSelect.value || "") : "";
  if (!code){ alert("Enter code"); return; }
  if (charId === "__new__"){
    const name = prompt("Name for new character?") || "";
    if (name){
      try{
        const res = await api("/characters", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ name }) });
        charId = res.id || res.character?.id || "";
        await loadMyCharacters();
      }catch(e){
        alert("Failed to create character: "+e.message);
        return;
      }
    }
  }
  try{
    statusEl.textContent = "Joining...";
    await api("/campaigns/join", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ code, character_id: charId }) });
    document.getElementById("camp-code").value = "";
    await loadCampaigns();
    statusEl.textContent = "Joined.";
  }catch(e){
    statusEl.textContent = "Join failed: "+e.message;
    alert(e.message);
  }
});

checkMe().then(loadMyCharacters).then(loadCampaigns).catch(()=>{ statusEl.textContent = "Login required."; });
</script>
</body>
</html>
