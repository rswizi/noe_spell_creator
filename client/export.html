<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Export Spells</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .hidden { display: none !important; }
    .effect-entry { display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px solid #222; }
    .effect-entry:last-child { border-bottom:0; }
    .btn-outline { background: transparent; border:1px solid #444; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .btn-outline:hover { border-color:#777; color:#fff; }
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.5); z-index: 1000; padding: 16px; }
    .modal-card { width: min(720px, 96vw); background:#111; color:#eee; border-radius: 14px; padding: 18px 20px; border:1px solid #252525; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .small { font-size:.92rem; opacity:.9; }
    textarea.export-area { width:100%; min-height:240px; background:#0f0f0f; color:#eee; border:1px solid #333; border-radius:8px; padding:10px; }
    .filter-bar label { display:flex; align-items:center; gap:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Export Spells</h1>

    <div class="home-card" style="margin-bottom:18px;">
      <div class="filter-bar">
        <input id="filter-name" type="text" placeholder="Filter by name..." />
        <select id="filter-category">
          <option value="">All Categories</option>
          <option>Novice</option><option>Apprentice</option><option>Disciple</option>
          <option>Adept</option><option>Mage</option><option>Magister</option>
          <option>High Mage</option><option>Master</option><option>Grand Master</option>
          <option>Archmage</option><option>Supreme Archmage</option><option>Avant-Garde</option>
        </select>
        <select id="filter-school">
          <option value="">All Schools</option>
        </select>

        <label style="margin-left:auto;">
          <input type="checkbox" id="filter-fav" />
          <span>Only favorites</span>
        </label>

        <button id="clear-filters">Reset</button>
      </div>
      <p class="small">Only approved (green) spells are shown.</p>
    </div>

    <div class="home-card">
      <div id="results"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="home.html">← Back Home</a>
    </div>
  </div>

  <!-- Foundry Template chooser -->
  <div id="tmpl-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <h3 style="margin-top:0;">Export to Foundry</h3>
      <p>Choose a template type for <span id="tmpl-spell-name" style="font-weight:600;"></span>.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="tmpl-cancel">Cancel</button>
        <button class="btn" id="tmpl-passive">Passive</button>
        <button class="btn" id="tmpl-active">Active</button>
      </div>
    </div>
  </div>

  <!-- Classic Copy modal -->
  <div id="copy-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <h3 style="margin-top:0;">Classic Export</h3>
      <div style="display:flex; gap:12px; align-items:center; margin:6px 0 12px;">
        <div>Format:</div>
        <label><input type="radio" name="copyfmt" value="passive" checked> Passive</label>
        <label><input type="radio" name="copyfmt" value="active"> Active</label>
        <div style="margin-left:auto; opacity:.8" id="copy-spell-name"></div>
      </div>
      <textarea id="copy-text" class="export-area" readonly></textarea>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="copy-cancel">Close</button>
        <button class="btn" id="copy-btn">Copy</button>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   Setup / Data caches
---------------------------- */
const API_BASE = "";
const $  = (s)=>document.querySelector(s);
const resultsEl   = $("#results");
const nameEl      = $("#filter-name");
const categoryEl  = $("#filter-category");
const schoolEl    = $("#filter-school");
const favOnlyEl   = $("#filter-fav");

const token = localStorage.getItem("auth_token") || "";

let ALL_SCHOOLS = [];          // [{id,name,school_type,...}]
let SCHOOL_BY_ID = {};         // id -> school
let ALL_EFFECTS = [];          // [{id,name,description,school,mp_cost,en_cost}]
let EFFECT_BY_ID = {};         // id -> effect
let CACHE_SPELL_BY_ID = new Map();
let FAV_IDS = new Set();

let CHOOSE_FOR_ID = null;      // for foundry modal
let COPY_FOR_ID = null;        // for classic copy modal

/* ---------------------------
   Foundry helpers / templates
---------------------------- */
function catOptions(){
  return [
    {key:"Novice",value:"Novice"},{key:"Apprentice",value:"Apprentice"},{key:"Disciple",value:"Disciple"},
    {key:"Adept",value:"Adept"},{key:"Mage",value:"Mage"},{key:"Magister",value:"Magister"},
    {key:"High Mage",value:"High Mage"},{key:"Master",value:"Master"},{key:"Grand Master",value:"Grand Master"},
    {key:"Archmage",value:"Archmage"},{key:"Supreme Archmage",value:"Supreme Archmage"},{key:"Avant-Garde",value:"Avant-Garde"}
  ];
}
function randId(){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; let out=''; for(let i=0;i<16;i++) out+=chars[Math.floor(Math.random()*chars.length)]; return out; }
function labelCell(value, vis=null){ return {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":vis??"","type":"label","size":"full-size","icon":"","value":value,"prefix":"","suffix":"","rollMessage":"","altRollMessage":"","rollMessageToChat":true,"altRollMessageToChat":true,"style":"bold"}; }
function textCell(key, def="", vis=null){ return {"key":key,"cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":vis??"","type":"textField","label":"","defaultValue":def,"size":"full-size","charList":"","autocomplete":""}; }
function numberCell(key, def="", vis=null){ return {"key":key,"cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":vis??"","type":"numberField","label":"","defaultValue":def,"size":"small","allowDecimal":false,"minVal":"","maxVal":"","allowRelative":false,"showControls":false,"controlsStyle":"hover","inputStyle":"text"}; }
function selectCell(key, def, opts, vis=null){ return {"key":key,"cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":vis??"","type":"select","label":"","defaultValue":def,"size":"full-size","selectedOptionType":"custom","options": opts.map(x=>({key:x,value:x}))}; }
function panelDescription(){ return {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"panel","contents":[labelCell("Description"),{"key":"desc","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":null,"type":"textArea","label":"","defaultValue":"","size":"full-size","style":"sheet"}],"flow":"vertical","align":"left","collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"}; }
function optionPanel(label, key){ return {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"panel","contents":[labelCell(label),{"key":key,"cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"checkbox","label":"","size":"full-size","defaultChecked":false}],"flow":"grid-2","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"}; }
function categoryPanel(){ return {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"panel","contents":[labelCell("Category"),selectCell("spell_category","Novice",catOptions().map(o=>o.key)),labelCell("Status"),selectCell("learned","1",["0","1"])],"flow":"grid-2","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"}; }

const BASE_ACTIVE = (() => ({
  "name": "Spell (Active)",
  "type": "equippableItem",
  "_id": randId(),
  "img": "icons/svg/item-bag.svg",
  "system": {
    "hidden": [
      {"name":"pv","value":"${0+sum(lookup('cout_table','valeur','ressource','pvb'))}$"},
      {"name":"en","value":"${0+sum(lookup('cout_table','valeur','ressource','enb'))}$"},
      {"name":"verr","value":"${equalText(type,'Archetype') ? 1 : 0}$"},
      {"name":"dv","value":"${0+sum(lookup('cout_table','valeur','ressource','dvb'))}$"},
      {"name":"is_spell","value":"${equalText(type,'Spell') ? 1 : 0}$"},
      {"name":"simple_spell","value":"${is_spell == 1 and complexx == 0 and craftomancy == 0 ? 1 : 0}$"},
      {"name":"complex_spell","value":"${is_spell == 1 and complexx == 1 and craftomancy == 0 ? 1 : 0}$"},
      {"name":"craftomancy_spell","value":"${is_spell == 1 and complexx == 0 and craftomancy == 1 ? 1 : is_spell == 1 and complexx == 1 and craftomancy == 1 ? 3 : 0}$"},
      {"name":"cn","value":"${0+sum(lookup('cout_table','valeur','ressource','cnb'))}$"}
    ],
    "header": {"contents":[],"key":"custom_header","cssClass":null,"role":0,"permission":0,"tooltip":null,"visibilityFormula":null,"flow":"vertical","align":"","type":"panel","collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"},
    "body": {
      "contents": [
        {
          "key": "", "cssClass": "", "role": "0", "permission": "0", "tooltip": "", "visibilityFormula": "",
          "type": "panel", "contents": [
            {
              "key": "", "cssClass":"", "role":"0", "permission":"0", "tooltip":"", "visibilityFormula":"", "type":"panel",
              "contents":[
                {"key":"","cssClass":"subtitle-text","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"label","size":"full-size","icon":"","value":"Cost","prefix":"","suffix":"","rollMessage":"","altRollMessage":"","rollMessageToChat":true,"altRollMessageToChat":true,"style":"bold"},
                {
                  "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"panel","contents":[
                    {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"label","size":"full-size","icon":"","value":"Active","prefix":"","suffix":"","rollMessage":"","altRollMessage":"","rollMessageToChat":true,"altRollMessageToChat":true,"style":"bold"},
                    {"key":"actif","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"checkbox","label":"","size":"small","defaultChecked":false},
                    {"key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"actif == 1","type":"label","size":"full-size","icon":"","value":"Active Now?","prefix":"","suffix":"","rollMessage":"","altRollMessage":"","rollMessageToChat":true,"altRollMessageToChat":true,"style":"bold"},
                    {"key":"active_rn","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"actif == 1","type":"checkbox","label":"","size":"full-size","defaultChecked":false}
                  ],
                  "flow":"grid-2","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"
                }
              ],
              "flow":"horizontal","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"
            },
            {
              "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"is_spell == 1","type":"panel","contents":[
                optionPanel("Complex","complexx"),
                optionPanel("Craftomancy","craftomancy"),
                {
                  "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"panel","contents":[
                    labelCell("Category"),
                    selectCell("spell_category","Novice",catOptions().map(o=>o.key)),
                    labelCell("Status"),
                    selectCell("learned","1",["0","1"])
                  ],"flow":"grid-2","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"
                }
              ],"flow":"grid-3","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"
            }
          ],
          "flow":"grid-2","align":"center","collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"
        },
        {
          "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"table","contents":[
            [
              labelCell("<p><strong>Range</strong></p>"),
              labelCell("<p><strong>AoE</strong></p>"),
              labelCell("<p><strong>Activation</strong></p>"),
              labelCell("Note"),
              null, null
            ],
            [
              textCell("portee","Self"),
              textCell("zone","Square"),
              selectCell("act","Action",["Action","Special Action","Free Action","Ritual"]),
              textCell("effet","N/A"),
              null, null
            ]
          ],
          "cols":4,"rows":2,"layout":"ccccccc","type":"table"
        },
        panelDescription()
      ],
      "key":"custom_body","cssClass":null,"role":0,"permission":0,"tooltip":null,"flow":"vertical","align":"","type":"panel","visibilityFormula":null,"collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"
    },
    "display":{"width":"850","height":"500","fix_size":false,"pp_width":"64","pp_height":"64"},
    "template":"J9o2iAz51pJFqc7q",
    "props":{
      "name":"Spell (Active)","spell_category":"Novice","learned":"1","type":"Spell","ver":"1",
      "portee":"Self","zone":"Square","act":"Action","effet":"N/A",
      "uuid":"Item."+randId(),"id":randId(),"img":"icons/svg/item-bag.svg",
      "pv":0,"en":0,"verr":0,"dv":0,"is_spell":1,"cn":0,
      "actif":false,"active_rn":false,"complexx":false,"craftomancy":false,
      "cout_table":{"0":{"$deleted":false,"valeur":"","ressource":"enb"}},
      "simple_spell":1,"complex_spell":0,"craftomancy_spell":0,
      "source":"", "desc":""
    },
    "modifiers":[],"unique":false,"container":null,"uniqueId":randId(),"templateSystemUniqueVersion":3997128925
  },
  "effects": [], "folder": null,
  "flags": {"custom-system-builder":{"version":"4.6.6"}},
  "_stats": {"coreVersion":"12.343","systemId":"custom-system-builder","systemVersion":"4.6.6","createdTime":Date.now(),"modifiedTime":Date.now(),"lastModifiedBy":"system"},
  "items":[]
}))();

const BASE_PASSIVE = (() => ({
  "name": "Spell (Passive)",
  "type": "equippableItem",
  "_id": randId(),
  "img": "icons/svg/item-bag.svg",
  "system": {
    "hidden": [
      {"name":"verr","value":"${equalText(type,'Archetype') ? 1 : 0}$"},
      {"name":"is_passive","value":"1"},{"name":"is_spell","value":"${equalText(type,'Spell') ? 1 : 0}$"},
      {"name":"craftomancy_spell","value":"${is_spell == 1 and complex == 0 and craftomancy == 1 ? 1 : is_spell == 1 and complex == 1 and craftomancy == 1 ? 3 : 0}$"},
      {"name":"complex_spell","value":"${is_spell == 1 and complex == 1 and craftomancy == 0 ? 1 : 0}$"},
      {"name":"simple_spell","value":"${is_spell == 1 and complex == 0 and craftomancy == 0 ? 1 : 0}$"},
      {"name":"pv","value":"0"},{"name":"en","value":"0"},{"name":"cn","value":"0"},{"name":"actif","value":"0"}
    ],
    "header":{"contents":[],"key":"custom_header","cssClass":null,"role":0,"permission":0,"tooltip":null,"visibilityFormula":null,"flow":"vertical","align":"","type":"panel","collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"},
    "body": {
      "contents":[
        {
          "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"","type":"table",
          "contents":[
            [
              labelCell("Type"),
              selectCell("type","Spell",["Archetype","Talent","Specie","Expertise","Spell","Other"]),
              labelCell("Version","verr==1"),
              numberCell("ver","1","verr==1"),
              labelCell("Source","is_spell == 1"),
              textCell("source","", "is_spell == 1")
            ],
            [null,null,null,null]
          ],
          "cols":6,"rows":1,"layout":""
        },
        {
          "key":"","cssClass":"","role":"0","permission":"0","tooltip":"","visibilityFormula":"is_spell == 1","type":"panel","contents":[
            optionPanel("Complex","complexx"),
            optionPanel("Craftomancy","craftomancy"),
            categoryPanel()
          ],"flow":"grid-3","align":"center","collapsible":false,"defaultCollapsed":false,"title":"","titleStyle":"default"
        },
        panelDescription()
      ],
      "key":"custom_body","cssClass":null,"role":0,"permission":0,"tooltip":null,"flow":"vertical","align":"","type":"panel","visibilityFormula":null,"collapsible":false,"defaultCollapsed":true,"title":"","titleStyle":"default"
    },
    "display":{"width":"700","height":"400","fix_size":false,"pp_width":"64","pp_height":"64"},
    "template":"dxdMJNjsednQvPw2",
    "props":{"name":"Spell (Passive)","type":"Spell","ver":"1","learned":"1","source":"","complexx":false,"craftomancy":false,"spell_category":"Novice","desc":""},
    "modifiers":[],"unique":false,"container":null,"uniqueId":randId(),"templateSystemUniqueVersion":3814201775
  },
  "effects": [], "folder": null, "flags":{"custom-system-builder":{"version":"4.6.6"}},
  "_stats":{"coreVersion":"12.343","systemId":"custom-system-builder","systemVersion":"4.6.6","createdTime":Date.now(),"modifiedTime":Date.now(),"lastModifiedBy":"system"},
  "items":[]
}))();

/* ---------------------------
   Loaders & filters
---------------------------- */
function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
async function loadSchools(){
  const r = await fetch(`${API_BASE}/schools`); const j = await r.json();
  ALL_SCHOOLS = j.schools || [];
  SCHOOL_BY_ID = Object.fromEntries(ALL_SCHOOLS.map(s => [String(s.id), s]));
  const sel = $("#filter-school");
  ALL_SCHOOLS.forEach(s => { const o = document.createElement("option"); o.value = s.id; o.textContent = `${s.name} [${s.id}]`; sel.appendChild(o); });
}
async function loadEffects(){
  const r = await fetch(`${API_BASE}/effects`); const j = await r.json();
  ALL_EFFECTS = j.effects || [];
  EFFECT_BY_ID = Object.fromEntries(ALL_EFFECTS.map(e => [String(e.id), e]));
}
async function loadFavIds(){
  if (!token) { FAV_IDS = new Set(); return; }
  try {
    const r = await fetch(`${API_BASE}/favorites/ids`, { headers: { "Authorization": `Bearer ${token}` }});
    const j = await r.json();
    FAV_IDS = new Set((j.ids || []).map(String));
  } catch { FAV_IDS = new Set(); }
}

function buildQuery(){
  const p = new URLSearchParams();
  const n = nameEl.value.trim();
  const c = categoryEl.value;
  const sch = schoolEl.value;
  if(n) p.set("name", n);
  if(c) p.set("category", c);
  if(sch) p.set("school", sch);
  p.set("status","green"); // approved only
  if (favOnlyEl.checked) p.set("favorite","1");
  return p.toString();
}

async function fetchSpells(){
  const q = buildQuery();
  const url = q ? `${API_BASE}/spells?${q}` : `${API_BASE}/spells?status=green`;
  const headers = favOnlyEl.checked ? { "Authorization": `Bearer ${token}` } : {};
  const r = await fetch(url, { headers });
  const j = await r.json();
  let list = j.spells || [];
  if (favOnlyEl.checked && FAV_IDS.size) {
    // server already filters by favorite=1, but if it didn't, keep a client-side guard:
    list = list.filter(s => FAV_IDS.has(String(s.id)));
  }
  CACHE_SPELL_BY_ID.clear();
  list.forEach(s => CACHE_SPELL_BY_ID.set(String(s.id), s));
  renderList(list);
}

/* ---------------------------
   Rendering
---------------------------- */
function spellRow(s){
  const schools = (s.schools||[]).map(sc=>sc.name).join(", ") || "—";
  const isFav = FAV_IDS.has(String(s.id));
  const star = isFav ? "⭐" : "☆";
  return `
    <div class="effect-entry">
      <div style="flex:1;">
        <div style="font-weight:bold">${s.name} <span style="opacity:.7">[${s.id}]</span> <span title="Favorite">${star}</span></div>
        <div style="opacity:.85">${s.category || "—"} · ${s.activation || "—"} · ${s.range ?? "—"} · ${s.aoe || "—"} · dur ${s.duration ?? "—"}</div>
        <div style="opacity:.75;font-size:.92rem">Schools: ${schools}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn-outline" onclick="openCopy('${String(s.id)}')">Copy (classic)</button>
        <button class="btn-outline" onclick="openTemplateChooser('${String(s.id)}')">Export to Foundry</button>
      </div>
    </div>
  `;
}
function renderList(list){
  resultsEl.innerHTML = list.length ? list.map(spellRow).join("") : "<p>No spells found.</p>";
}

/* ---------------------------
   Shared derivations
---------------------------- */
function isComplexFromSchools(spell){
  // if list_spells attached schools, use them; else fallback via effects
  const ids = (spell.schools || []).map(s=>String(s.id));
  for (const sid of ids) {
    const sch = SCHOOL_BY_ID[sid];
    if (sch && String(sch.school_type || "").toLowerCase() === "complex") return true;
  }
  return false;
}
function computeEN(spell){
  if (typeof spell.en_cost === 'number') return spell.en_cost;
  let sum = 0;
  if (Array.isArray(spell.effects)) {
    for (const ef of spell.effects) sum += Number(ef.en_cost||0);
  }
  return sum;
}
function buildDescription(spell){
  const effectIds = (spell.effects || []).map(String);
  const lines = [];
  for (const eid of effectIds) {
    const ef = EFFECT_BY_ID[eid];
    if (!ef) continue;
    const n = ef.name || `Effect ${eid}`;
    const d = (ef.description || "").trim();
    lines.push(`• ${n}: ${d || "(no description)"}`);
  }
  return lines.join("\n");
}
function hasActiveTag(spell){
  const effectIds = (spell.effects || []).map(String);
  for (const eid of effectIds) {
    const ef = EFFECT_BY_ID[eid];
    if (!ef) continue;
    if (/\[active\]|\(active\)/i.test(ef.description||"")) return true;
  }
  return false;
}
function sourceFor(spell){ return `${spell.name} [${spell.id}]`; }

/* ---------------------------
   Foundry export
---------------------------- */
function openTemplateChooser(spellId){
  CHOOSE_FOR_ID = String(spellId);
  const sp = CACHE_SPELL_BY_ID.get(CHOOSE_FOR_ID);
  $("#tmpl-spell-name").textContent = sp ? sp.name : `#${CHOOSE_FOR_ID}`;
  $("#tmpl-modal").classList.remove("hidden");
  $("#tmpl-modal").setAttribute("aria-hidden","false");
}
function closeTemplateChooser(){
  $("#tmpl-modal").classList.add("hidden");
  $("#tmpl-modal").setAttribute("aria-hidden","true");
}

async function exportFoundry(type){
  const id = CHOOSE_FOR_ID;
  if (!id) return closeTemplateChooser();

  const r = await fetch(`${API_BASE}/spells/${encodeURIComponent(id)}`);
  const j = await r.json();
  const spell = j.spell || CACHE_SPELL_BY_ID.get(String(id));
  if (!spell) { alert("Spell not found"); return closeTemplateChooser(); }

  const out = (type === "active") ? structuredClone(BASE_ACTIVE) : structuredClone(BASE_PASSIVE);
  const complex = isComplexFromSchools(spell);
  const desc = buildDescription(spell);
  const src = sourceFor(spell);

  out.name = spell.name;
  out.system.props.name = spell.name;
  out.system.props.spell_category = spell.category || "Novice";
  out.system.props.source = src;
  out.system.props.complexx = !!complex;
  out.system.props.desc = desc;

  if (type === "active") {
    out.system.props.act = spell.activation || "Action";
    out.system.props.portee = (Number(spell.range) === 0 ? "Self" : String(spell.range));
    out.system.props.zone = spell.aoe || "Square";
    const en = Number(computeEN(spell));
    if (!out.system.props.cout_table) out.system.props.cout_table = {"0":{"$deleted":false,"valeur":"","ressource":"enb"}};
    if (!out.system.props.cout_table["0"]) out.system.props.cout_table["0"] = {"$deleted":false,"valeur":"","ressource":"enb"};
    out.system.props.cout_table["0"].valeur = String(isFinite(en) ? en : 0);
    out.system.props.actif = hasActiveTag(spell);
  }

  // refresh ids
  const newId = randId();
  out._id = newId;
  if (out.system?.props) { out.system.props.id = newId; out.system.props.uuid = "Item."+newId; }
  if (out.uniqueId) out.uniqueId = newId;

  const kind = (type === "active") ? "active" : "passive";
  const filename = `fvtt-spell-${sanitize(spell.name)}-${spell.id}-${kind}.json`;
  const blob = new Blob([JSON.stringify(out, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
  closeTemplateChooser();
}
function sanitize(s){ return String(s||"spell").replace(/[^\w\-]+/g,"_"); }

/* ---------------------------
   Classic copy
---------------------------- */
function openCopy(spellId){
  COPY_FOR_ID = String(spellId);
  const sp = CACHE_SPELL_BY_ID.get(COPY_FOR_ID);
  $("#copy-spell-name").textContent = sp ? `${sp.name} [${sp.id}]` : "";
  // default to passive content
  buildCopyText("passive");
  $("#copy-modal").classList.remove("hidden");
  $("#copy-modal").setAttribute("aria-hidden","false");
}
function closeCopy(){
  $("#copy-modal").classList.add("hidden");
  $("#copy-modal").setAttribute("aria-hidden","true");
}
async function buildCopyText(kind){
  const id = COPY_FOR_ID; if (!id) return;
  const r = await fetch(`${API_BASE}/spells/${encodeURIComponent(id)}`);
  const j = await r.json();
  const s = j.spell || CACHE_SPELL_BY_ID.get(String(id));
  if (!s) { $("#copy-text").value = "Spell not found."; return; }

  const complex = isComplexFromSchools(s);
  const desc = buildDescription(s);
  const src = sourceFor(s);

  if (kind === "passive") {
    const txt =
`Name: ${s.name} [${s.id}]
Category: ${s.category || "Novice"}
Complex: ${complex ? "Yes" : "No"}
Source: ${src}

Description:
${desc}`;
    $("#copy-text").value = txt;
  } else {
    const en = computeEN(s);
    const actif = hasActiveTag(s) ? 1 : 0;
    const txt =
`Name: ${s.name} [${s.id}]
Category: ${s.category || "Novice"}
Complex: ${complex ? "Yes" : "No"}
Source: ${src}

EN Cost: ${en}
Activation: ${s.activation || "Action"}
Range: ${Number(s.range) === 0 ? "Self" : s.range}
AoE: ${s.aoe || "Square"}
Actif: ${actif}

Description:
${desc}`;
    $("#copy-text").value = txt;
  }
}

/* ---------------------------
   Events & boot
---------------------------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  // Load data & favorites
  await loadSchools();
  await loadEffects();
  await loadFavIds();
  await fetchSpells();

  const run = debounce(fetchSpells, 250);
  nameEl.addEventListener("input", run);
  categoryEl.addEventListener("change", run);
  schoolEl.addEventListener("change", run);
  favOnlyEl.addEventListener("change", async ()=>{ await loadFavIds(); fetchSpells(); });
  $("#clear-filters").addEventListener("click", async () => {
    nameEl.value = ""; categoryEl.value = ""; schoolEl.value = ""; favOnlyEl.checked = false;
    await loadFavIds(); fetchSpells();
  });

  // Foundry modal buttons
  $("#tmpl-cancel").addEventListener("click", (e)=>{ e.preventDefault(); closeTemplateChooser(); });
  $("#tmpl-active").addEventListener("click", (e)=>{ e.preventDefault(); exportFoundry("active"); });
  $("#tmpl-passive").addEventListener("click", (e)=>{ e.preventDefault(); exportFoundry("passive"); });
  $("#tmpl-modal").addEventListener("click", (e)=>{ if (e.target.id === "tmpl-modal") closeTemplateChooser(); });

  // Classic copy modal buttons
  $("#copy-cancel").addEventListener("click", (e)=>{ e.preventDefault(); closeCopy(); });
  $("#copy-btn").addEventListener("click", async (e)=> {
    e.preventDefault();
    const ta = $("#copy-text");
    ta.select();
    try {
      await navigator.clipboard.writeText(ta.value);
      alert("Copied!");
    } catch {
      document.execCommand("copy");
      alert("Copied!");
    }
  });
  document.getElementsByName("copyfmt").forEach(r => {
    r.addEventListener("change", (e)=> buildCopyText(e.target.value));
  });
});
</script>
</body>
</html>