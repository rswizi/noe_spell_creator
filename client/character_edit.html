<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE â€” Edit Character (with Abilities)</title>

  <style>
    :root { color-scheme: dark; }
    html,body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .page { min-height: 100vh; display: grid; place-items: start center; background: #0b0b0b; }
    .wrap { width: 100%; max-width: 980px; padding: 28px 16px; }

    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .topbar h1 { font-size: 20px; margin: 0; }
    a.btn, button, input, select, textarea { padding:8px 12px; border-radius:10px; border:1px solid #333; background:#121212; color:#f0f0f0; text-decoration:none; }
    a.btn:hover, button:hover { background:#171717; }
    .muted { opacity:.8; font-size:.9rem; }
    .grow { flex: 1 1 auto; }
    .right { margin-left:auto; }

    .tabs { display:flex; gap:8px; border-bottom:1px solid #222; margin:16px 0 12px; }
    .tab { padding:10px 14px; border:1px solid #222; border-bottom:none; border-radius:12px 12px 0 0; background:#111; cursor:pointer; }
    .tab.active { background:#191919; font-weight:600; }
    .tabpanes { border:1px solid #222; border-radius:0 14px 14px 14px; background:#141414; padding:16px; }

    .stats-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); align-items:start; }
    .panel { border:1px solid #2a2a2a; border-radius:14px; overflow:hidden; background:#101010; }
    details.panel > summary { list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; }
    details.panel > summary::-webkit-details-marker { display:none; }
    .pill { font-size:.85rem; opacity:.85; border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; }
    .panel-body { padding:0 14px 14px; }

    .row { display:flex; align-items:center; gap:8px; }
    .row > .grow { flex:1 1 auto; }
    .k { opacity:.85; font-size:.9rem; }
    .num { width:90px; }
    .total { font-weight:600; }
    .hdr { display:flex; align-items:center; gap:10px; }
    .skills { display:grid; gap:8px; margin-top:10px; }
    .skill-line { display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; }
    .skill-total { min-width:48px; text-align:right; font-variant-numeric: tabular-nums; }
    .charac-badge { font-variant-numeric: tabular-nums; }
    .num { width:90px; }
    .badge { border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; font-variant-numeric: tabular-nums; }
    .smallmuted { opacity:.75; font-size:.85rem; }

    .skill-line { display:grid; grid-template-columns: 140px 80px 80px 70px 70px 50px; gap:8px; align-items:center; }
    .skill-line.smallmuted { font-size:.85rem; opacity:.75; }
    .skill-line input.num { width:70px; text-align:right; }
    .skill-line .badge, .skill-line .skill-total { text-align:center; font-variant-numeric: tabular-nums; min-width:50px; }
    .skill-line .k { font-size:.9rem; opacity:.85; }

    .status { margin-top:10px; opacity:.8; }
    .derived-grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:6px 8px; align-items:center; }
    .kv .val { justify-self:end; font-variant-numeric: tabular-nums; }

    /* Abilities tab */
    .abi-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .abi-bucket h3 { margin:6px 0 8px; font-size:1rem; }
    .abi-list { display:grid; gap:6px; }
    .abi-item { display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #2b2b2b; border-radius:10px; background:#0f0f0f; }
    .abi-item .tag { border:1px solid #3b3b3b; border-radius:999px; padding:2px 6px; font-size:.75rem; opacity:.85; }
    .abi-item button { padding:4px 8px; font-size:.85rem; }
    .abi-add { display:flex; gap:8px; align-items:center; }
    .abi-add input, .abi-add select { flex:1 1 auto; }
    .abi-hint { opacity:.75; font-size:.85rem; margin-top:6px; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1 id="title">Edit Character</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="characters.html">Back to My Characters</a>
      <a class="btn" href="character_admin.html" id="admin-link" style="display:none">All Characters</a>
    </div>

    <!-- Name card -->
    <div class="panel" style="margin-bottom:12px;">
      <details open class="panel">
        <summary class="hdr">
          <strong>Name</strong>
          <span class="muted">(autosaves)</span>
          <span class="muted status" id="status">Loaded.</span>
        </summary>
        <div class="panel-body">
          <input id="name" placeholder="Enter a name..." class="grow" />
        </div>
      </details>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="tab-stat">Statistic</div>
      <div class="tab" data-tab="tab-inv">Inventory</div>
      <div class="tab" data-tab="tab-abi">Abilities</div>
      <div class="tab" data-tab="tab-com">Combat</div>
      <div class="tab" data-tab="tab-per">Personal</div>
    </div>

    <div class="tabpanes">
      <!-- STATISTICS TAB -->
      <div id="tab-stat" class="tabpane">
        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Derived Stats</strong>
              <span class="muted">(auto from Level, Milestones & skills)</span>
              <span class="grow"></span>
              <span class="k">Level</span>
              <input id="level" type="number" class="num" min="1" value="1" />
            </summary>
            <div class="panel-body">
              <div class="derived-grid">
                <div class="kv"><div class="k">HP</div> <div class="val badge" id="hp-val" title="">â€”</div></div>
                <div class="kv"><div class="k">EN</div> <div class="val badge" id="en-val" title="">â€”</div></div>
                <div class="kv"><div class="k">FO</div> <div class="val badge" id="fo-val" title="">â€”</div></div>
                <div class="kv"><div class="k">MO</div> <div class="val badge" id="mo-val" title="">â€”</div></div>
                <div class="kv"><div class="k">SP cap (10% HP)</div> <div class="val badge" id="spcap-val" title="">â€”</div></div>
                <div class="kv"><div class="k">Encumbrance</div> <div class="val badge" id="enc-val" title="">â€”</div></div>
                <div class="kv"><div class="k">Eclipse Threshold (ET)</div> <div class="val badge" id="et-val" title="">â€”</div></div>
                <div class="kv"><div class="k">Max Toxicity (TX)</div> <div class="val badge" id="tx-val" title="">â€”</div></div>
              </div>
            </div>
          </details>
        </div>

        <div class="stats-grid" id="stats-grid"><!-- injected --></div>

        <!-- Intensities (MAG) -->
        <div class="panel" style="margin-top:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Intensities</strong>
              <span class="pill">Linked to MAG</span>
              <span class="muted">(behaves like skills)</span>
              <span class="grow"></span>
              <span class="k">MAG Mod:</span>
              <span id="int-mag-mod" class="pill">+0</span>
            </summary>
            <div class="panel-body">
              <div id="intensities-list" class="skills" style="margin-top:8px"></div>

              <div style="margin-top:14px; border-top:1px solid #222; padding-top:12px;">
                <div class="hdr"><strong>Defense Summary</strong><span class="muted"> (from known natures & IV)</span></div>
                <div id="defense-summary" class="skills" style="margin-top:8px"></div>
                <p class="muted" style="margin-top:8px">
                  N = Neutral, R = âˆ’2 per hit, VR = âˆ’4 per hit, V = +2 per hit, VV = +4 per hit.
                </p>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- INVENTORY placeholder -->
      <div id="tab-inv" class="tabpane" style="display:none;"><p class="muted">Inventory â€” coming next.</p></div>

      <!-- ABILITIES TAB -->
      <div id="tab-abi" class="tabpane" style="display:none;">
        <div class="panel">
          <details open class="panel">
            <summary class="hdr">
              <strong>Abilities on this Character</strong>
              <span class="muted">(Archetype / Passive / Active)</span>
              <span class="grow"></span>
              <span class="muted">Autosaves</span>
            </summary>
            <div class="panel-body">
              <!-- Add / search row -->
              <div class="abi-add" style="margin-bottom:10px;">
                <input id="abi-search" placeholder="Search ability by nameâ€¦" />
                <select id="abi-filter-type">
                  <option value="">Any type</option>
                  <option value="active">Active</option>
                  <option value="passive">Passive</option>
                  <option value="mixed">Mixed</option>
                </select>
                <select id="abi-filter-source">
                  <option value="">Any source</option>
                  <option value="Specie">Specie</option>
                  <option value="Talent">Talent</option>
                  <option value="Archetype">Archetype</option>
                  <option value="Expertise">Expertise</option>
                  <option value="Awakening">Awakening</option>
                  <option value="Apotheosis">Apotheosis</option>
                  <option value="Other">Other</option>
                </select>
                <button id="abi-search-btn">Find</button>
              </div>
              <div id="abi-results" class="abi-list" style="margin-bottom:12px;"></div>
              <div class="abi-hint">Tip: click a result to add it; click the ðŸ—‘ on an assigned ability to remove it.</div>

              <div class="abi-grid" style="margin-top:16px;">
                <div class="abi-bucket">
                  <h3>Archetype</h3>
                  <div id="abi-list-archetype" class="abi-list"></div>
                </div>
                <div class="abi-bucket">
                  <h3>Passive (non-Archetype)</h3>
                  <div id="abi-list-passive" class="abi-list"></div>
                </div>
                <div class="abi-bucket">
                  <h3>Active (non-Archetype)</h3>
                  <div id="abi-list-active" class="abi-list"></div>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- COMBAT / PERSONAL placeholders -->
      <div id="tab-com" class="tabpane" style="display:none;"><p class="muted">Combat â€” coming next.</p></div>
      <div id="tab-per" class="tabpane" style="display:none;"><p class="muted">Personal â€” coming next.</p></div>
    </div>

  </div></div>

<script>
/* --- auth helper --- */
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){ const t=getToken(); if(t) setCookieToken(t); return t? {'Authorization':'Bearer '+t, 'X-Auth-Token':t} : {}; }
async function api(path,opt={}){ const headers = Object.assign({}, opt.headers||{}, authHeaders()); const resp = await fetch(path, { credentials:'include', ...opt, headers }); const ct = resp.headers.get('content-type') || ''; const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() }; if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status)); return data; }

/* Constants replicated from your sheet */
const CHARACS = [
  { key:'body',      code:'BOD', name:'Body',      skills:['Athletics','Resistance','Melee','Brawl'] },
  { key:'willpower', code:'WIL', name:'Willpower', skills:['Spirit','Courage','Discipline','Insight'] },
  { key:'magic',     code:'MAG', name:'Magic',     skills:['Arcana','Spellwork','Alchemy','Ritual'] },
  { key:'presence',  code:'PRE', name:'Presence',  skills:['Charm','Intimidation','Deception','Performance'] },
  { key:'reflex',    code:'REF', name:'Reflex',    skills:['Stealth','Acrobatics','Aim','Perception'] },
  { key:'dexterity', code:'DEX', name:'Dexterity', skills:['Craft','Lockpicking','Tinkering','Drive'] },
];

const NATURES = ['Fire','Lightning','Water','Earth','Wind','Sun','Moon','Ki'];
const INT_TABLE = [
  {min:1,max:1, id:'1d4', iv:2},{min:2,max:3, id:'1d6', iv:3},{min:4,max:7, id:'1d8', iv:4},
  {min:8,max:15, id:'1d10', iv:5},{min:16,max:99, id:'1d12', iv:6}
];
const DEF_TABLE = {
  Fire:{Fire:"N",Lightning:"N",Water:"R",Earth:"VR",Wind:"V",Sun:"N",Moon:"VR",Ki:"N"},
  Lightning:{Fire:"N",Lightning:"N",Water:"N",Earth:"V",Wind:"VR",Sun:"VR",Moon:"VV",Ki:"N"},
  Water:{Fire:"V",Lightning:"N",Water:"N",Earth:"N",Wind:"VV",Sun:"R",Moon:"R",Ki:"N"},
  Earth:{Fire:"VV",Lightning:"V",Water:"N",Earth:"N",Wind:"R",Sun:"VR",Moon:"N",Ki:"N"},
  Wind:{Fire:"R",Lightning:"VR",Water:"VV",Earth:"V",Wind:"N",Sun:"N",Moon:"N",Ki:"N"},
  Sun:{Fire:"N",Lightning:"R",Water:"VR",Earth:"VV",Wind:"N",Sun:"N",Moon:"V",Ki:"N"},
  Moon:{Fire:"VR",Lightning:"VV",Water:"V",Earth:"N",Wind:"N",Sun:"R",Moon:"N",Ki:"N"},
  Ki:{Fire:"N",Lightning:"N",Water:"N",Earth:"N",Wind:"N",Sun:"N",Moon:"N",Ki:"N"},
};
const SYM_PTS = { N:0, R:-2, VR:-4, V:+2, VV:+4 };
function ivFactor(iv){ return Math.max(1, Math.min(3, 0.5 * iv)); }
function totalFromInvest(v){ const total = (parseInt(v||0,10) || 0) + 4; return total; }
function modFromTotal(total){ return Math.floor((Number(total)-10)/2); }
function charMod(key){ const invest = CHAR.stats?.[key]?.invest ?? 0; return modFromTotal(totalFromInvest(invest)); }
function milestone(key){ return Math.max(0, charMod(key)); }
function skillTotal(key, skill){ const invest = CHAR.stats?.[key]?.skills?.[skill] ?? 0; return invest + charMod(key); }

/* state + refs */
const params = new URLSearchParams(location.search);
const CID = params.get('id');
let ROLE = 'user';
let SAVE_TIMER = null;
let CHAR = null;
let ASSIGNED = []; // full documents of assigned abilities (resolved by id)

/* DOM refs */
const loginChip = document.getElementById('login-chip');
const adminLink = document.getElementById('admin-link');
const titleEl   = document.getElementById('title');
const statusEl  = document.getElementById('status');
const nameEl    = document.getElementById('name');
const gridEl    = document.getElementById('stats-grid');

/* derived refs */
const levelEl = document.getElementById('level');
const hpEl = document.getElementById('hp-val');
const enEl = document.getElementById('en-val');
const foEl = document.getElementById('fo-val');
const moEl = document.getElementById('mo-val');
const spcapEl = document.getElementById('spcap-val');
const encEl = document.getElementById('enc-val');
const etEl = document.getElementById('et-val');
const txEl = document.getElementById('tx-val');

/* Abilities tab refs */
const abiSearchEl = document.getElementById('abi-search');
const abiFilterTypeEl = document.getElementById('abi-filter-type');
const abiFilterSrcEl  = document.getElementById('abi-filter-source');
const abiSearchBtn = document.getElementById('abi-search-btn');
const abiResultsEl = document.getElementById('abi-results');
const listArchetypeEl = document.getElementById('abi-list-archetype');
const listPassiveEl   = document.getElementById('abi-list-passive');
const listActiveEl    = document.getElementById('abi-list-active');

/* tabs switching */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
    tab.classList.add('active');
    const id = tab.getAttribute('data-tab');
    document.getElementById(id).style.display='';
  });
});

/* auth */
async function checkMe() {
  loginChip.textContent = 'Checking login...';
  try{
    const me = await api('/auth/me');
    loginChip.textContent = `${me.username} (${me.role})`;
    if ((me.role||'').toLowerCase()==='admin') adminLink.style.display='';
    ROLE = me.role||'user';
    return me;
  } catch(e){
    loginChip.textContent = 'Not logged in';
    adminLink.style.display='none';
    throw e;
  }
}

/* defaults */
function makeDefaultStats(){
  const stats = {};
  for (const c of CHARACS){
    const sk = {};
    for (const s of c.skills) sk[s] = 0;
    stats[c.key] = { invest: 0, skills: sk };
  }
  const ints = {};
  for (const n of NATURES){ ints[n] = {knows:false, invest:0}; }
  stats.intensities = ints;
  return stats;
}

/* render stats/skills */
function renderStatistics(){
  gridEl.innerHTML = '';
  for (const c of CHARACS){
    const rec = (CHAR.stats && CHAR.stats[c.key]) || { invest:0, skills:{} };
    const total = totalFromInvest(rec.invest);
    const mod = modFromTotal(total);

    const details = document.createElement('details'); details.className='panel'; details.open = true;
    const sum = document.createElement('summary'); sum.className='hdr';
    sum.innerHTML = `
      <strong>${c.name}</strong>
      <span class="pill">${c.code}</span>
      <span class="charac-badge">[ <span class="total" id="${c.key}-total">${total}</span> | <span id="${c.key}-mod">${mod>=0? '+'+mod : mod}</span> ]</span>
      <span class="grow"></span>
      <span class="k">Invested</span>
      <input type="number" class="num" min="0" id="${c.key}-invest" value="${Number(rec.invest)||0}">
    `;
    details.appendChild(sum);

    const body = document.createElement('div'); body.className='panel-body';
    const skills = document.createElement('div'); skills.className='skills';

    for (const s of c.skills){
      const invested = Number((rec.skills||{})[s] || 0);
      const totalSkill = invested + mod;
      const line = document.createElement('div'); line.className='skill-line';
      line.innerHTML = `
        <div class="k">${s}</div>
        <input type="number" class="num" min="0" id="${c.key}__${s}__invest" value="${invested}">
        <div class="skill-total" id="${c.key}__${s}__total">${totalSkill>=0? '+'+totalSkill : totalSkill}</div>
      `;
      skills.appendChild(line);
    }

    body.appendChild(skills);
    details.appendChild(body);
    gridEl.appendChild(details);
  }

  // Wire listeners
  for (const c of CHARACS){
    const input = document.getElementById(`${c.key}-invest`);
    input.addEventListener('input', ()=>{
      const v = parseInt(input.value||'0', 10) || 0;
      CHAR.stats[c.key].invest = v;
      const total = totalFromInvest(v);
      const mod = modFromTotal(total);
      document.getElementById(`${c.key}-total`).textContent = total;
      document.getElementById(`${c.key}-mod`).textContent = (mod>=0? '+'+mod : mod);
      for (const s of c.skills){
        const invested = Number(CHAR.stats[c.key].skills[s] || 0);
        const t = invested + mod;
        document.getElementById(`${c.key}__${s}__total`).textContent = (t>=0? '+'+t : t);
      }
      if (c.key === 'magic') {
        renderIntensities();
        renderDefenseSummary();
      }
      updateDerived();
      queueSave();
    });
    for (const s of c.skills){
      const sid = `${c.key}__${s}__invest`;
      const inp = document.getElementById(sid);
      inp.addEventListener('input', ()=>{
        const v = parseInt(inp.value||'0', 10) || 0;
        CHAR.stats[c.key].skills[s] = v;
        const total = totalFromInvest(CHAR.stats[c.key].invest);
        const mod = modFromTotal(total);
        const t = v + mod;
        document.getElementById(`${c.key}__${s}__total`).textContent = (t>=0? '+'+t : t);
        updateDerived();
        queueSave();
      });
    }
  }
}

/* Intensities & defense (unchanged) */
function magMod(){ const mag = CHAR.stats?.magic?.invest ?? 0; const total = totalFromInvest(mag); return modFromTotal(total); }
function idIvFromTotal(t){ const v = Math.max(0, Math.min(99, Number(t)||0)); if (v <= 0) return { id:"â€”", iv:0 }; for (const row of INT_TABLE){ if (v >= row.min && v <= row.max) return { id: row.id, iv: row.iv }; } return { id:"1d12", iv:6 }; }
function defenseFromKnown(){
  const ints = CHAR.stats?.intensities || {};
  const entries = NATURES.map(n=>{ const rec = ints[n] || {knows:false, invest:0}; const total = (rec.invest||0) + magMod(); const {iv} = idIvFromTotal(total); return { nature:n, knows:!!rec.knows, iv, total }; });
  const summary = {};
  for (const incoming of NATURES){
    let score = 0;
    for (const m of entries){
      if (!m.knows || m.iv<=0) continue;
      const sym = DEF_TABLE[incoming][m.nature];
      score += (SYM_PTS[sym] || 0) * ivFactor(m.iv);
    }
    summary[incoming] = score;
  }
  return summary;
}
function scoreToLabel(score){ if (score <= -6) return "VR"; if (score <= -2) return "R"; if (score >= +6) return "VV"; if (score >= +2) return "V"; return "N"; }
function renderIntensities(){
  const list = document.getElementById('intensities-list');
  const im = magMod();
  document.getElementById('int-mag-mod').textContent = (im>=0? '+'+im : im);
  list.innerHTML = '';
  for (const n of NATURES){
    const rec = CHAR.stats.intensities[n];
    const total = (rec.invest||0) + im;
    const info = idIvFromTotal(total);
    const row = document.createElement('div');
    row.className = 'skill-line';
    row.innerHTML = `
      <div class="k">${n}</div>
      <input type="checkbox" id="int_${n}_knows" ${rec.knows?'checked':''} />
      <input type="number" class="num" id="int_${n}_invest" min="0" value="${rec.invest||0}" />
      <div class="badge" id="int_${n}_total">${total>=0? '+'+total:total}</div>
      <div class="badge" id="int_${n}_id">${info.id}</div>
      <div class="badge" id="int_${n}_iv">${info.iv || 'â€”'}</div>
    `;
    list.appendChild(row);
  }
  // Hooks
  for (const n of NATURES){
    const k = document.getElementById(`int_${n}_knows`);
    const i = document.getElementById(`int_${n}_invest`);
    k.addEventListener('change', ()=>{ CHAR.stats.intensities[n].knows = !!k.checked; renderDefenseSummary(); queueSave(); });
    i.addEventListener('input', ()=>{ const v = parseInt(i.value||'0',10) || 0; CHAR.stats.intensities[n].invest = v; const mm2 = magMod(); const total = v + mm2; const info = idIvFromTotal(total); document.getElementById(`int_${n}_total`).textContent = (total>=0? '+'+total:total); document.getElementById(`int_${n}_id`).textContent = info.id; document.getElementById(`int_${n}_iv`).textContent = info.iv || 'â€”'; renderDefenseSummary(); queueSave(); });
  }
}
function renderDefenseSummary(){
  const box = document.getElementById('defense-summary');
  const scores = defenseFromKnown();
  box.innerHTML = '';
  const hdr = document.createElement('div'); hdr.className='skill-line smallmuted'; hdr.innerHTML = `<div>Incoming</div><div></div><div></div><div>Score</div><div>Level</div><div></div>`; box.appendChild(hdr);
  for (const n of NATURES){
    const s = scores[n] || 0;
    const lab = scoreToLabel(s);
    const row = document.createElement('div'); row.className='skill-line';
    row.innerHTML = `<div class="k">${n}</div><div></div><div></div><div class="badge">${s.toFixed(1)}</div><div class="badge">${lab}</div><div></div>`;
    box.appendChild(row);
  }
}

/* PASSIVE MODIFIERS APPLICATION
   We support targets like:
   - derived.hp / derived.en / derived.fo / derived.mo / derived.et / derived.tx / derived.enc
   Modes: add / mul / set (order: set â†’ mul â†’ add)
*/
function applyPassiveModifiersToDerived(base){
  const out = { ...base };
  const notes = {
    hp: [`Base = ${base.hp}`],
    en: [`Base = ${base.en}`],
    fo: [`Base = ${base.fo}`],
    mo: [`Base = ${base.mo}`],
    et: [`Base = ${base.et}`],
    tx: [`Base = ${base.tx}`],
    enc:[`Base = ${base.enc}`],
    spcap:[`Base = ${base.spcap}`],
  };

  const ops = { set:[], mul:[], add:[] };

  const passiveAbilities = (ASSIGNED||[]).filter(a=>{
    const t = (a.type||'').toLowerCase();
    return t==='passive' || t==='mixed';
  });

  for (const ab of passiveAbilities){
    const mods = (ab.passive && ab.passive.modifiers) || [];
    for (const m of mods){
      const target = (m.target||'').toLowerCase().trim();
      const mode = (m.mode||'add').toLowerCase();
      const val = Number(m.value||0);
      const note = m.note ? ` (${m.note})` : '';
      const origin = `${ab.name}${note}`;
      const map = {
        'derived.hp':'hp','derived.en':'en','derived.fo':'fo','derived.mo':'mo',
        'derived.et':'et','derived.tx':'tx','derived.enc':'enc','derived.spcap':'spcap'
      };
      if (map[target]){
        ops[mode]?.push({ k: map[target], v: val, origin });
      }
    }
  }

  // Apply in order: set, mul, add
  for (const item of ops.set){ out[item.k] = item.v; notes[item.k].push(`Set to ${item.v} â† ${item.origin}`); }
  for (const item of ops.mul){ out[item.k] = Math.round(out[item.k] * item.v); notes[item.k].push(`Ã—${item.v} â† ${item.origin}`); }
  for (const item of ops.add){ out[item.k] = out[item.k] + item.v; const s = item.v>=0? `+${item.v}`: `${item.v}`; notes[item.k].push(`${s} â† ${item.origin}`); }

  // Titles
  hpEl.title = notes.hp.join('\n');
  enEl.title = notes.en.join('\n');
  foEl.title = notes.fo.join('\n');
  moEl.title = notes.mo.join('\n');
  etEl.title = notes.et.join('\n');
  txEl.title = notes.tx.join('\n');
  encEl.title = notes.enc.join('\n');
  spcapEl.title = notes.spcap.join('\n');

  return out;
}

/* Derived computations */
function clampInt(x){ return Math.max(0, Math.floor(Number(x)||0)); }
function updateDerived(){
  const lvl = Math.max(1, Math.floor(Number(levelEl.value)||1));
  const msBOD = milestone('body'); const msWIL = milestone('willpower'); const msMAG = milestone('magic'); const msPRE = milestone('presence'); const msREF = milestone('reflex'); const msDEX = milestone('dexterity');

  // Base
  const base = {};
  base.hp = 100 + lvl + 12*msBOD + 6*msWIL;
  base.en = 5 + Math.floor(lvl/5) + msWIL + 2*msMAG;
  base.fo = 2 + Math.floor(lvl/5) + msWIL + msPRE;
  base.mo = 4 + msDEX + msREF;
  base.spcap = Math.floor(base.hp * 0.10);
  const athletics = skillTotal('body','Athletics');
  const spirit = skillTotal('willpower','Spirit');
  base.enc = 10 + (athletics*5) + (spirit*2);
  base.et = 1 + Math.floor(lvl/9) + msMAG;
  const resistance = skillTotal('body','Resistance');
  const alchemy = skillTotal('tech','Alchemy');
  base.tx = resistance + alchemy;

  // Apply passive modifiers
  const final = applyPassiveModifiersToDerived(base);

  // Display
  hpEl.textContent = final.hp;
  enEl.textContent = final.en;
  foEl.textContent = final.fo;
  moEl.textContent = final.mo;
  spcapEl.textContent = final.spcap;
  encEl.textContent = final.enc;
  etEl.textContent = final.et;
  txEl.textContent = final.tx;
}

/* LOAD & SAVE */
async function loadCharacter(){
  if (!CID){ statusEl.textContent = 'Missing id'; return; }
  const res = await api('/characters/' + encodeURIComponent(CID));
  CHAR = res.character || {};
  if (!CHAR.stats) CHAR.stats = makeDefaultStats();
  if (!CHAR.stats.intensities) CHAR.stats.intensities = makeDefaultStats().intensities;
  if (!('level' in CHAR)) CHAR.level = 1;
  if (!Array.isArray(CHAR.abilities)) CHAR.abilities = [];

  // Name
  titleEl.textContent = 'Edit: ' + (CHAR.name || '(unnamed)');
  nameEl.value = CHAR.name || '';
  nameEl.addEventListener('input', ()=> queueSave());

  // Level
  levelEl.value = Math.max(1, Number(CHAR.level)||1);
  levelEl.addEventListener('input', ()=>{ CHAR.level = Math.max(1, Math.floor(Number(levelEl.value)||1)); updateDerived(); queueSave(); });

  // Render stuff
  renderStatistics();
  renderIntensities();
  renderDefenseSummary();

  // Load assigned abilities (docs)
  await resolveAssignedAbilities();
  renderAbilitiesTab();

  updateDerived();
}

function queueSave(){
  statusEl.textContent = 'Saving...';
  if (SAVE_TIMER) clearTimeout(SAVE_TIMER);
  SAVE_TIMER = setTimeout(saveNow, 350);
}

async function saveNow(){
  try{
    const payload = { name: nameEl.value || '', level: CHAR.level || 1, stats: CHAR.stats, abilities: CHAR.abilities || [] };
    const res = await api('/characters/' + encodeURIComponent(CID), {
      method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
    });
    titleEl.textContent = 'Edit: ' + (res.character?.name || '(unnamed)');
    statusEl.textContent = 'Saved at ' + new Date().toLocaleTimeString();
  }catch(err){
    statusEl.textContent = 'Save failed: ' + err.message;
  }
}

/* ------- Abilities: search/add/remove/render ------- */
async function searchAbilities(){
  try{
    const params = [];
    if (abiSearchEl.value) params.push('name='+encodeURIComponent(abiSearchEl.value));
    if (abiFilterTypeEl.value) params.push('typ='+encodeURIComponent(abiFilterTypeEl.value));
    if (abiFilterSrcEl.value) params.push('source='+encodeURIComponent(abiFilterSrcEl.value));
    const qs = params.length ? '?'+params.join('&') : '';
    const res = await api('/abilities'+qs); // list endpoint (:contentReference[oaicite:6]{index=6})
    const arr = res.abilities || [];
    renderSearchResults(arr);
  }catch(e){
    abiResultsEl.innerHTML = `<div class="muted">Error: ${e.message}</div>`;
  }
}
abiSearchBtn.addEventListener('click', searchAbilities);
abiSearchEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') searchAbilities(); });

function renderSearchResults(arr){
  abiResultsEl.innerHTML = '';
  if (!arr.length){ abiResultsEl.innerHTML = '<div class="muted">No results.</div>'; return; }
  for (const a of arr){
    const div = document.createElement('div');
    div.className = 'abi-item';
    div.innerHTML = `
      <div class="grow">
        <div><strong>${a.name}</strong></div>
        <div class="muted" style="font-size:.85rem">${a.description||''}</div>
      </div>
      <span class="tag">${a.type||''}</span>
      <span class="tag">${a.source_category||''}</span>
      <button>Add</button>
    `;
    div.querySelector('button').addEventListener('click', ()=> addAbilityToChar(a.id));
    abiResultsEl.appendChild(div);
  }
}

async function addAbilityToChar(aid){
  if (!Array.isArray(CHAR.abilities)) CHAR.abilities = [];
  if (CHAR.abilities.includes(aid)) return; // already there
  CHAR.abilities.push(aid);
  queueSave();
  await resolveAssignedAbilities();
  renderAbilitiesTab();
  updateDerived();
}

async function removeAbilityFromChar(aid){
  CHAR.abilities = (CHAR.abilities||[]).filter(x=>x!==aid);
  queueSave();
  await resolveAssignedAbilities();
  renderAbilitiesTab();
  updateDerived();
}

async function resolveAssignedAbilities(){
  const ids = (CHAR.abilities||[]);
  if (!ids.length){ ASSIGNED = []; return; }
  // Try bulk API first; if not present, fetch one by one.
  try{
    const qs = '?ids=' + encodeURIComponent(ids.join(','));
    const bulk = await api('/abilities/bulk'+qs);
    ASSIGNED = (bulk.abilities||[]);
    // Fill any missing via per-id (in case)
    const gotIds = new Set(ASSIGNED.map(a=>a.id));
    const missing = ids.filter(i=>!gotIds.has(i));
    for (const mid of missing){
      const one = await api('/abilities/'+encodeURIComponent(mid));
      if (one && one.ability) ASSIGNED.push(one.ability);
    }
  }catch(_e){
    // Fallback: per-id
    const arr = [];
    for (const id of ids){
      try{
        const one = await api('/abilities/'+encodeURIComponent(id));
        if (one && one.ability) arr.push(one.ability);
      }catch(e){}
    }
    ASSIGNED = arr;
  }
}

function renderAbilitiesBucket(el, list){
  el.innerHTML = '';
  if (!list.length){ el.innerHTML = '<div class="muted">â€”</div>'; return; }
  for (const a of list){
    const div = document.createElement('div');
    div.className = 'abi-item';
    const isPassive = (a.type||'').toLowerCase()!=='active';
    div.innerHTML = `
      <div class="grow">
        <div><strong>${a.name}</strong></div>
        <div class="muted" style="font-size:.85rem">${isPassive ? (a.passive?.description||a.description||'') : (a.description||'')}</div>
      </div>
      <span class="tag">${a.type||''}</span>
      <span class="tag">${a.source_category||''}</span>
      <button title="Remove">ðŸ—‘</button>
    `;
    div.querySelector('button').addEventListener('click', ()=> removeAbilityFromChar(a.id));
    el.appendChild(div);
  }
}

function renderAbilitiesTab(){
  const docs = ASSIGNED.slice();

  // Buckets:
  const isArchetype = (a)=> (a.source_category||'').toLowerCase()==='archetype';
  const isPassiveLike = (a)=> ['passive','mixed'].includes((a.type||'').toLowerCase());
  const isActiveLike  = (a)=> ['active','mixed'].includes((a.type||'').toLowerCase());

  const bucketArchetype = docs.filter(isArchetype);
  const bucketPassive   = docs.filter(a=>!isArchetype(a) && isPassiveLike(a));
  const bucketActive    = docs.filter(a=>!isArchetype(a) && isActiveLike(a));

  renderAbilitiesBucket(listArchetypeEl, bucketArchetype);
  renderAbilitiesBucket(listPassiveEl,   bucketPassive);
  renderAbilitiesBucket(listActiveEl,    bucketActive);
}

/* boot */
checkMe().then(loadCharacter).catch(()=>{});
</script>
</body>
</html>
