<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoE â€” Character Editor</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0b0b0b; color:#f5f5f5; }
    .page { min-height:100vh; display:grid; place-items:start center; }
    .wrap { width:100%; max-width:1280px; padding:24px 16px 44px; }

    a.btn, button.btn, input, select, textarea {
      border-radius:10px; border:1px solid #333; background:#111; color:#f0f0f0; padding:8px 10px; font:inherit;
    }
    a.btn:hover, button.btn:hover { background:#181818; }
    textarea { resize:vertical; min-height:80px; }
    .muted { opacity:.82; }

    /* Topbar */
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    .topbar h1 { margin:0; font-size:20px; }
    .topbar .right { margin-left:auto; }

    /* Panels / rows */
    .panel { border:1px solid #262626; border-radius:14px; background:#101010; padding:14px 14px 16px; margin-top:12px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row .grow { flex:1 1 auto; }

    /* Tabs */
    .tabs { display:flex; gap:8px; border-bottom:1px solid #222; margin:14px 0 10px; }
    .tab-link { padding:8px 10px; border-radius:10px 10px 0 0; cursor:pointer; }
    .tab-link.active { background:#111; border:1px solid #222; border-bottom:none; }
    .tab-panel { display:none; }

    /* Stats */
    .stats-grid { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px; }
    @media (max-width:1100px){ .stats-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .stats-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .stat-card { border:1px solid #222; border-radius:12px; padding:10px 12px; background:#0f0f0f; }
    .stat-name { font-size:.86rem; opacity:.8; }
    .stat-val { font-size:1.2rem; font-weight:600; }
    .stat-hover { text-decoration: dotted underline; cursor:help; }

    /* Chips */
    .chip-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border:1px solid #333; border-radius:999px; background:#111; font-size:.9rem;
    }
    .chip .badges { display:inline-flex; gap:6px; margin-left:6px; }
    .chip .rm { cursor:pointer; border:none; background:#181818; border-radius:6px; padding:2px 6px; color:#f5f5f5; }
    .pill { border:1px solid #333; border-radius:999px; padding:1px 6px; font-size:.75rem; opacity:.9; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9998; }
    .modal { width:min(980px, calc(100vw - 24px)); max-height:80vh; overflow:auto; border:1px solid #333; border-radius:14px; background:#0f0f0f; box-shadow:0 24px 60px rgba(0,0,0,.6); }
    .modal-head { display:flex; gap:10px; align-items:center; padding:12px; border-bottom:1px solid #222; position:sticky; top:0; background:inherit; }
    .modal-body { display:grid; grid-template-columns: minmax(0,1.2fr) minmax(0,0.8fr); gap:12px; padding:12px; }
    @media (max-width:900px){ .modal-body{ grid-template-columns:1fr; } }
    .table { width:100%; border-collapse:collapse; font-size:.92rem; }
    .table th, .table td { padding:7px 8px; border-bottom:1px solid #1c1c1c; vertical-align:top; }
    .table tr:hover { background:#151515; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .tag { border:1px solid #2b2b2b; border-radius:999px; padding:1px 6px; font-size:.72rem; opacity:.9; }

    /* Tooltip */
    .tooltip {
      position:absolute; z-index:9999; max-width:380px; border:1px solid #333; background:#0d0d0d; color:#f5f5f5;
      border-radius:10px; padding:8px 10px; font-size:.86rem; display:none; box-shadow:0 8px 24px rgba(0,0,0,.4);
    }

    /* Breakdown drawer */
    .drawer { position:fixed; top:0; right:0; width:min(420px, 100vw); height:100vh; background:#0b0b0b; border-left:1px solid #222; box-shadow:-18px 0 40px rgba(0,0,0,.5); transform:translateX(100%); transition:transform .25s ease; z-index:9997; }
    .drawer.open { transform:translateX(0); }
    .drawer-head { display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid #222; }
    .drawer-body { padding:12px; overflow:auto; height:calc(100vh - 56px); }
    .kv { display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px dashed #222; }
    .sum { font-weight:700; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1>Character Editor</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="portal.html">Back to Portal</a>
    </div>

    <!-- Character loader -->
    <div class="panel">
      <div class="row">
        <label for="char-id">Character ID</label>
        <input id="char-id" class="grow" placeholder="e.g., C001 or use ?id=C001" />
        <button id="btn-load" class="btn" type="button">Load</button>
      </div>
      <div class="muted" id="char-name-line"></div>
    </div>

    <!-- Stats -->
    <div class="panel">
      <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
        <h2 style="margin:0;">Stats</h2>
        <div>
          <button class="btn" id="btn-open-drawer" type="button">ðŸ“Š Open Breakdown</button>
        </div>
      </div>
      <div id="stats-grid" class="stats-grid"><!-- stat cards populate below --></div>
      <div class="muted" style="margin-top:6px;">Hover any value to see modifier breakdown (origin + ability + mode/value, in <b>set â†’ mul â†’ add</b> order).</div>
      <div id="tooltip" class="tooltip"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <a class="tab-link active" data-tab="tab-abilities">Abilities</a>
    </div>

    <!-- Abilities Tab -->
    <div id="tab-abilities" class="tab-panel" style="display:block;">

      <!-- Archetype -->
      <div class="panel">
        <h2 style="margin:0 0 8px;">Archetype Abilities</h2>
        <div class="row" style="align-items:flex-start;">
          <input id="arch-search" class="grow" placeholder="Search catalog by nameâ€¦" />
          <button id="arch-open" class="btn" type="button">Browse</button>
        </div>
        <div id="arch-list" class="chip-list"></div>
      </div>

      <!-- Passive -->
      <div class="panel">
        <h2 style="margin:0 0 8px;">Passive Abilities (non-Archetype)</h2>
        <div class="row" style="align-items:flex-start;">
          <input id="passive-search" class="grow" placeholder="Search catalog by nameâ€¦" />
          <button id="passive-open" class="btn" type="button">Browse</button>
        </div>
        <div id="passive-list" class="chip-list"></div>
      </div>

      <!-- Active -->
      <div class="panel">
        <h2 style="margin:0 0 8px;">Active Abilities (non-Archetype)</h2>
        <div class="row" style="align-items:flex-start;">
          <input id="active-search" class="grow" placeholder="Search catalog by nameâ€¦" />
          <button id="active-open" class="btn" type="button">Browse</button>
        </div>
        <div id="active-list" class="chip-list"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btn-save-abilities" class="btn" type="button">ðŸ’¾ Save Abilities to Character</button>
        <span id="abilities-status" class="muted" style="margin-left:10px;"></span>
      </div>
    </div>

    <!-- Ability Picker Modal -->
    <div class="modal-backdrop" id="picker-bd">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Ability Picker">
        <div class="modal-head">
          <strong id="picker-title">Add Ability</strong>
          <input id="picker-q" class="grow" placeholder="Search by name or tagâ€¦" />
          <select id="picker-type">
            <option value="">Type: Any</option>
            <option value="active">Active</option>
            <option value="passive">Passive</option>
            <option value="mixed">Mixed</option>
          </select>
          <select id="picker-source">
            <option value="">Source: Any</option>
            <option>Specie</option><option>Talent</option><option>Archetype</option>
            <option>Expertise</option><option>Awakening</option><option>Apotheosis</option><option>Other</option>
          </select>
          <button id="picker-close" class="btn" type="button">Close</button>
        </div>
        <div class="modal-body">
          <div>
            <table class="table" id="picker-table">
              <thead>
                <tr><th style="width:34%;">Name</th><th style="width:18%;">Type</th><th style="width:20%;">Source</th><th>Tags</th></tr>
              </thead>
              <tbody id="picker-tbody"><tr><td colspan="4" class="muted">Type to searchâ€¦</td></tr></tbody>
            </table>
          </div>
          <div id="picker-preview" style="border:1px solid #222; border-radius:12px; padding:10px;">
            <div class="muted">Select an ability to preview.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Breakdown Drawer -->
    <div class="drawer" id="drawer">
      <div class="drawer-head">
        <strong>Stats Breakdown</strong>
        <button id="btn-close-drawer" class="btn" type="button" style="margin-left:auto;">Close</button>
      </div>
      <div class="drawer-body" id="drawer-body">
        <!-- Filled programmatically -->
      </div>
    </div>

  </div></div>

<script>
/* -------------------- basic auth & api helpers -------------------- */
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){ const t=getToken(); if(t) setCookieToken(t); return t ? {'Authorization':'Bearer '+t,'X-Auth-Token':t} : {}; }
async function api(path,opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
  if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status));
  return data;
}
(async function(){
  try{ const me = await api('/auth/me'); document.getElementById('login-chip').textContent = me.username+' ('+me.role+')'; }
  catch(e){ document.getElementById('login-chip').textContent = 'Not logged in.'; }
})();

/* -------------------- URL & character load helpers -------------------- */
function qp(name){ const u=new URL(location.href); return u.searchParams.get(name); }
const charIdEl = document.getElementById('char-id');
const btnLoad  = document.getElementById('btn-load');
const charNameLine = document.getElementById('char-name-line');

let currentCharacterId = null;
let currentCharacter   = null;

btnLoad.addEventListener('click', ()=> {
  const id = (charIdEl.value || '').trim();
  if (!id) return alert('Enter a Character ID.');
  loadCharacterIntoForm(id);
});
const qpId = qp('id'); if (qpId) charIdEl.value = qpId;

/* -------------------- stats & tooltips -------------------- */
const tipEl = document.getElementById('tooltip');
let _computed_cache = null;

function positionTooltip(ev, tip){ const pad=14; tip.style.left=(ev.pageX+pad)+'px'; tip.style.top=(ev.pageY+pad)+'px'; }
function htmlesc(x){ return (x+'').replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":"&#39;",'"':'&quot;' }[c])); }

function renderTooltipHtml(key, list){
  let html = `<div style="font-weight:600;margin-bottom:6px;">${htmlesc(key)}</div>`;
  html += `<div style="opacity:.8;margin-bottom:6px;">Order: set â†’ mul â†’ add</div>`;
  list.forEach(it=>{
    const v = (it.mode==='mul') ? ('Ã— '+it.value) : ((it.mode==='set') ? ('= '+it.value) : ((it.value>=0?'+':'')+it.value));
    html += `<div style="display:flex;gap:6px;align-items:baseline;margin-bottom:2px;">
      <span class="pill">${htmlesc(it.origin||'')}</span>
      <span style="flex:1 1 auto;">${htmlesc(it.source||'')}</span>
      <span style="opacity:.95;">${htmlesc(v)}</span>
    </div>`;
    if (it.note){
      html += `<div style="opacity:.7;margin-left:62px;margin-top:-2px;">${htmlesc(it.note)}</div>`;
    }
  });
  return html;
}

function wireStatTooltips(){
  document.querySelectorAll('.stat-hover').forEach(el=>{
    el.addEventListener('mouseenter', (ev)=>{
      const key = el.getAttribute('data-target');
      const list = (_computed_cache?.breakdown || {})[key] || [];
      if (!list.length) { tipEl.style.display='none'; return; }
      tipEl.innerHTML = renderTooltipHtml(key, list);
      positionTooltip(ev, tipEl);
      tipEl.style.display='block';
    });
    el.addEventListener('mousemove', (ev)=> positionTooltip(ev, tipEl));
    el.addEventListener('mouseleave', ()=> { tipEl.style.display='none'; });
  });
}

function writeStatCard(grid, key, label, value){
  const id = 'stat-'+key.replace(/\./g,'-');
  let card = document.getElementById(id);
  if (!card){
    card = document.createElement('div');
    card.className = 'stat-card';
    card.id = id;
    card.innerHTML = `<div class="stat-name">${htmlesc(label)}</div>
      <div class="stat-val stat-hover" data-target="${htmlesc(key)}">--</div>`;
    grid.appendChild(card);
  }
  const v = card.querySelector('.stat-val');
  v.textContent = (value ?? '--');
}

async function refreshComputedAndRender(){
  if (!currentCharacterId) return;
  const res = await api('/characters/'+encodeURIComponent(currentCharacterId)+'/computed');
  _computed_cache = res;
  const f = res.final || {};
  const fs = f.stats || {};
  // Which stats to show, and labels
  const statOrder = [
    ['stats.hp_max','HP Max'], ['stats.en_max','EN Max'], ['stats.mp_max','MP Max'], ['stats.speed','Speed'],
    // expand common combat stats by default; add more keys if you want
    ['stats.attack','Attack'], ['stats.defense','Defense'],
    ['stats.init','Initiative'], ['stats.accuracy','Accuracy'],
  ];
  const grid = document.getElementById('stats-grid');
  grid.innerHTML = '';
  for (const [k, label] of statOrder){
    const parts = k.split('.'); let cur = f; for (const p of parts){ cur = (cur||{})[p]; }
    writeStatCard(grid, k, label, cur);
  }
  // Also auto-add any other numeric stats not listed above
  for (const [k,v] of Object.entries(fs)){
    if (statOrder.find(x=>x[0]==='stats.'+k)) continue;
    if (typeof v === 'number') writeStatCard(grid, 'stats.'+k, k, v);
  }
  wireStatTooltips();
}

/* -------------------- Abilities: 3 buckets + picker modal -------------------- */
let archSel = [];
let passiveSel = [];
let activeSel = [];
let _catalog_cache = []; // for chip names

async function loadCatalogCache(){ const res = await api('/abilities'); _catalog_cache = res.abilities || []; }
async function searchCatalog({q, typ, src}){
  let url = '/abilities';
  const qs=[]; if (q) qs.push('name='+encodeURIComponent(q));
  if (typ) qs.push('typ='+encodeURIComponent(typ));
  if (src) qs.push('source='+encodeURIComponent(src));
  if (qs.length) url += '?'+qs.join('&');
  return (await api(url)).abilities || [];
}

function renderChipList(el, arr){
  el.innerHTML = '';
  arr.forEach(id=>{
    const ab = _catalog_cache.find(x=>x.id===id);
    const name = ab ? ab.name : id;
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `${htmlesc(name)} <span class="badges"></span>`;
    const badges = chip.querySelector('.badges');
    if (ab?.type) badges.innerHTML += `<span class="pill">${htmlesc(ab.type)}</span>`;
    if (ab?.source_category) badges.innerHTML += `<span class="pill">${htmlesc(ab.source_category)}</span>`;
    const rm = document.createElement('button'); rm.className = 'rm'; rm.textContent = 'âœ•';
    rm.addEventListener('click', ()=> { const i=arr.indexOf(id); if(i>=0){ arr.splice(i,1); renderAllChipLists(); refreshComputedAndRender(); }});
    chip.appendChild(rm);
    // quick preview
    chip.title = 'Click for preview';
    chip.addEventListener('click', async (e)=>{
      if (e.target === rm) return;
      try { const full = await api('/abilities/'+encodeURIComponent(id)); showPreview(full.ability); openPicker(true); } catch(e) {}
    });
    el.appendChild(chip);
  });
}

function renderAllChipLists(){
  renderChipList(document.getElementById('arch-list'),    archSel);
  renderChipList(document.getElementById('passive-list'), passiveSel);
  renderChipList(document.getElementById('active-list'),  activeSel);
}

/* ---- Picker Modal ---- */
const pickerBd = document.getElementById('picker-bd');
const pickerTitle = document.getElementById('picker-title');
const pickerQ = document.getElementById('picker-q');
const pickerType = document.getElementById('picker-type');
const pickerSource = document.getElementById('picker-source');
const pickerTbody = document.getElementById('picker-tbody');
const pickerPrev = document.getElementById('picker-preview');
document.getElementById('picker-close').addEventListener('click', ()=> openPicker(false));

function openPicker(open){
  pickerBd.style.display = open ? 'flex' : 'none';
  if (open) pickerQ.focus();
}
function showPreview(a){
  const tags = (a.tags||[]).map(t=>`<span class="tag">${htmlesc(t)}</span>`).join(' ');
  const passive = a.passive||{};
  const active = a.active||{};
  const costs = active.costs || {};
  pickerPrev.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
      <h3 style="margin:0;">${htmlesc(a.name)}</h3>
      <div style="display:flex;gap:6px;">
        <span class="pill">${htmlesc(a.type)}</span>
        <span class="pill">${htmlesc(a.source_category||'Other')}</span>
      </div>
    </div>
    <div class="muted" style="margin-top:4px;">${htmlesc(a.description||'')}</div>
    ${tags ? `<div class="tags" style="margin-top:6px;">${tags}</div>` : ''}

    ${a.type!=='passive' ? `
    <div style="margin-top:10px;">
      <strong>Active</strong>
      <div>Activation: ${htmlesc(active.activation||'Action')} â€¢ Range: ${htmlesc(active.range??0)} â€¢ AoE: ${htmlesc(active.aoe||'â€”')}</div>
      <div class="tags" style="margin-top:4px;">
        ${Object.entries({HP:costs.HP,EN:costs.EN,MP:costs.MP,FO:costs.FO,MO:costs.MO,TX:costs.TX})
          .filter(([,v])=> (v??0)!==0).map(([k,v])=>`<span class="tag">${k}: ${v}</span>`).join('')}
        ${costs.other_label && costs.other_value ? `<span class="tag">${htmlesc(costs.other_label)}: ${htmlesc(costs.other_value)}</span>`:''}
      </div>
    </div>` : ''}

    ${(a.type!=='active') ? `
    <div style="margin-top:10px;">
      <strong>Passive</strong>
      ${passive.description ? `<div style="margin-top:2px;">${htmlesc(passive.description)}</div>` : ''}
      ${(passive.modifiers||[]).length ? `
        <div style="margin-top:6px;">
          <div class="muted">Modifiers:</div>
          ${(passive.modifiers||[]).map(m=>`
            <div style="display:flex;gap:6px;">
              <span class="pill">${htmlesc(m.mode||'add')}</span>
              <span>${htmlesc(m.target||'')}</span>
              <span style="opacity:.95;">${htmlesc(m.value)}</span>
              ${m.note ? `<span class="muted">(${htmlesc(m.note)})</span>`:''}
            </div>`).join('')}
        </div>` : ''}
    </div>` : ''}
  `;
}

async function refreshPickerTable(){
  const q = pickerQ.value.trim(); const typ = pickerType.value; const src = pickerSource.value;
  const list = await searchCatalog({ q, typ, src });
  pickerTbody.innerHTML = '';
  if (!list.length){ pickerTbody.innerHTML = `<tr><td colspan="4" class="muted">No results.</td></tr>`; return; }
  list.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${htmlesc(a.name)}</td>
      <td>${htmlesc(a.type||'')}</td>
      <td>${htmlesc(a.source_category||'')}</td>
      <td>${(a.tags||[]).map(t=>`<span class="tag">${htmlesc(t)}</span>`).join(' ')}</td>`;
    tr.addEventListener('click', async ()=>{
      showPreview(a);
      _pickerCurrent = a;
    });
    tr.addEventListener('dblclick', ()=> _pickerAcceptCurrent());
    pickerTbody.appendChild(tr);
  });
}

let _pickerBucket = 'passive'; // which bucket weâ€™re adding into
let _pickerCurrent = null;

function openPickerFor(bucket, title){
  _pickerBucket = bucket; _pickerCurrent = null;
  pickerTitle.textContent = title || 'Add Ability';
  openPicker(true);
  refreshPickerTable();
}

function _pickerAcceptCurrent(){
  if (!_pickerCurrent) return;
  const id = _pickerCurrent.id;
  if (_pickerBucket==='archetype'){ archSel = Array.from(new Set([...archSel, id])); }
  else if (_pickerBucket==='passive'){ passiveSel = Array.from(new Set([...passiveSel, id])); }
  else { activeSel = Array.from(new Set([...activeSel, id])); }
  renderAllChipLists();
  refreshComputedAndRender();
}

/* open buttons */
document.getElementById('arch-open').addEventListener('click', ()=> openPickerFor('archetype','Add Archetype Ability'));
document.getElementById('passive-open').addEventListener('click', ()=> openPickerFor('passive','Add Passive Ability'));
document.getElementById('active-open').addEventListener('click', ()=> openPickerFor('active','Add Active Ability'));
pickerQ.addEventListener('input', ()=> { clearTimeout(pickerQ._t); pickerQ._t=setTimeout(refreshPickerTable, 200); });
pickerType.addEventListener('change', refreshPickerTable);
pickerSource.addEventListener('change', refreshPickerTable);
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && pickerBd.style.display==='flex') _pickerAcceptCurrent(); });

/* Save abilities to character */
document.getElementById('btn-save-abilities').addEventListener('click', async ()=>{
  const st = document.getElementById('abilities-status');
  if (!currentCharacterId){ st.textContent='No character loaded.'; return; }
  try{
    st.textContent = 'Savingâ€¦';
    await api('/characters/'+encodeURIComponent(currentCharacterId)+'/abilities', {
      method:'PUT',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ archetype: archSel, passive: passiveSel, active: activeSel })
    });
    st.textContent = 'Saved.';
    await refreshComputedAndRender();
  }catch(e){
    st.textContent = 'Error: '+e.message;
  }
});

/* -------------------- Breakdown drawer -------------------- */
const drawer = document.getElementById('drawer');
const drawerBody = document.getElementById('drawer-body');
document.getElementById('btn-open-drawer').addEventListener('click', ()=> { fillDrawer(); drawer.classList.add('open'); });
document.getElementById('btn-close-drawer').addEventListener('click', ()=> drawer.classList.remove('open'));

function fillDrawer(){
  const br = _computed_cache?.breakdown || {};
  const final = _computed_cache?.final || {};
  const fs = final.stats || {};
  const keys = Object.keys(br).sort();
  drawerBody.innerHTML = '';
  if (!keys.length){ drawerBody.innerHTML = '<div class="muted">No modifiers are affecting stats.</div>'; return; }

  // Group by top-level stat (e.g., stats.hp_max)
  keys.forEach(k=>{
    const list = br[k] || [];
    let total = 0, mul = 1, set = null;
    list.forEach(m=>{
      const mode = (m.mode||'add');
      const val = Number(m.value||0);
      if (mode==='set') set = val;
      else if (mode==='mul') mul *= val;
      else total += val;
    });
    let finalVal = fs?.[k.split('.').slice(1).join('.')] ?? null; // try to pick from final.stats
    const sec = document.createElement('div');
    sec.className='panel';
    sec.innerHTML = `<div class="kv sum"><span>${htmlesc(k)}</span><span>${finalVal ?? ''}</span></div>`;
    list.forEach(m=>{
      const v = (m.mode==='mul') ? ('Ã— '+m.value) : ((m.mode==='set') ? ('= '+m.value) : ((m.value>=0?'+':'')+m.value));
      const row = document.createElement('div');
      row.className = 'kv';
      row.innerHTML = `<span><span class="pill">${htmlesc(m.origin||'')}</span> ${htmlesc(m.source||'')}</span>
                       <span>${htmlesc(v)}</span>`;
      sec.appendChild(row);
      if (m.note){
        const note = document.createElement('div');
        note.className = 'muted';
        note.style.margin = '2px 0 0 6px';
        note.textContent = m.note;
        sec.appendChild(note);
      }
    });
    drawerBody.appendChild(sec);
  });
}

/* -------------------- load character -------------------- */
async function loadCharacterIntoForm(charId){
  currentCharacterId = charId;
  const res = await api('/characters/'+encodeURIComponent(charId));
  currentCharacter = res.character;

  charNameLine.textContent = (currentCharacter.name ? ('Name: '+currentCharacter.name) : '') + '  â€¢  ID: '+currentCharacterId;

  const abil = currentCharacter.abilities || {};
  archSel    = (abil.archetype || []).map(x=>x.id);
  passiveSel = (abil.passive   || []).map(x=>x.id);
  activeSel  = (abil.active    || []).map(x=>x.id);

  if (!_catalog_cache.length) await loadCatalogCache();
  renderAllChipLists();

  await refreshComputedAndRender();
}

/* -------------------- boot -------------------- */
(async function boot(){
  if (qpId) await loadCharacterIntoForm(qpId);
})();
</script>
</body>
</html>