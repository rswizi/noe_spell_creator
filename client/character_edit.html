<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE -- Edit Character (with Abilities)</title>

  <style>
    :root { color-scheme: dark; }
    html,body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .page { min-height: 100vh; display: grid; place-items: start center; background: #0b0b0b; }
    .wrap { width: 100%; max-width: 980px; padding: 28px 16px; }

    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .topbar h1 { font-size: 20px; margin: 0; }
    a.btn, button, input, select, textarea { padding:8px 12px; border-radius:10px; border:1px solid #333; background:#121212; color:#f0f0f0; text-decoration:none; }
    a.btn:hover, button:hover { background:#171717; }
    .muted { opacity:.8; font-size:.9rem; }
    .grow { flex: 1 1 auto; }
    .right { margin-left:auto; }

    .tabs { display:flex; gap:8px; border-bottom:1px solid #222; margin:16px 0 12px; }
    .tab { padding:10px 14px; border:1px solid #222; border-bottom:none; border-radius:12px 12px 0 0; background:#111; cursor:pointer; }
    .tab.active { background:#191919; font-weight:600; }
    .tabpanes { border:1px solid #222; border-radius:0 14px 14px 14px; background:#141414; padding:16px; }

    .stats-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); align-items:start; }
    .panel { border:1px solid #2a2a2a; border-radius:14px; overflow:hidden; background:#101010; }
    details.panel > summary { list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; }
    details.panel > summary::-webkit-details-marker { display:none; }
    .pill { font-size:.85rem; opacity:.85; border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; }
    .panel-body { padding:0 14px 14px; }

    .row { display:flex; align-items:center; gap:8px; }
    .row > .grow { flex:1 1 auto; }
    .k { opacity:.85; font-size:.9rem; }
    .num { width:90px; }
    .total { font-weight:600; }
    .hdr { display:flex; align-items:center; gap:10px; }
    .skills { display:grid; gap:8px; margin-top:10px; }
    .skill-line { display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; }
    .skill-total { min-width:48px; text-align:right; font-variant-numeric: tabular-nums; }
    .charac-badge { font-variant-numeric: tabular-nums; }
    .badge { border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; font-variant-numeric: tabular-nums; }

    .derived-grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:6px 8px; align-items:center; }
    .kv .val { justify-self:end; font-variant-numeric: tabular-nums; }

    /* Abilities tab */
    .abi-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .abi-bucket h3 { margin:6px 0 8px; font-size:1rem; }
    .abi-list { display:grid; gap:6px; }
    .abi-item { display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #2b2b2b; border-radius:10px; background:#0f0f0f; }
    .abi-item .tag { border:1px solid #3b3b3b; border-radius:999px; padding:2px 6px; font-size:.75rem; opacity:.85; }
    .abi-item button { padding:4px 8px; font-size:.85rem; }
    .abi-add { display:flex; gap:8px; align-items:center; }
    .abi-add input, .abi-add select { flex:1 1 auto; }
    .abi-hint { opacity:.75; font-size:.85rem; margin-top:6px; }
    /* Modifiers breakdown */
    .mod-list { margin:6px 0 4px 16px; padding:0; list-style:disc; display:none; opacity:0.9; }
    .mod-list li { margin:0 0 3px 0; font-size:0.9rem; }
    .mod-toggle { cursor:pointer; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1 id="title">Edit Character</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="characters.html">Back to My Characters</a>
      <a class="btn" href="character_admin.html" id="admin-link" style="display:none">All Characters</a>
    </div>

    <!-- Name card -->
    <div class="panel" style="margin-bottom:12px;">
      <details open class="panel">
        <summary class="hdr">
          <strong>Name</strong>
          <span class="muted">(autosaves)</span>
          <span class="muted status" id="status">Loaded.</span>
        </summary>
        <div class="panel-body">
          <input id="name" placeholder="Enter a name..." class="grow" />
        </div>
      </details>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="tab-stat">Statistic</div>
      <div class="tab" data-tab="tab-inv">Inventory</div>
      <div class="tab" data-tab="tab-abi">Abilities</div>
      <div class="tab" data-tab="tab-com">Combat</div>
      <div class="tab" data-tab="tab-per">Personal</div>
    </div>

    <div class="tabpanes">
      <!-- STATISTICS TAB -->
      <div id="tab-stat" class="tabpane">
        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Derived Stats</strong>
              <span class="muted">(auto from Level, Milestones & skills)</span>
              <span class="grow"></span>
              <span class="k">Level</span>
              <input id="level" type="number" class="num" min="1" value="1" />
            </summary>
            <div class="panel-body">
              <div class="derived-grid">
                <div class="kv"><div class="k">HP</div> <div class="val badge mod-toggle" id="hp-val" data-target="mods-derived-hp" title="">--</div>
                <ul class="mod-list" id="mods-derived-hp" style="display:none"></ul></div>
                <div class="kv"><div class="k">EN</div> <div class="val badge mod-toggle" id="en-val" data-target="mods-derived-en" title="">--</div>
                <ul class="mod-list" id="mods-derived-en" style="display:none"></ul></div>
                <div class="kv"><div class="k">FO</div> <div class="val badge mod-toggle" id="fo-val" data-target="mods-derived-fo" title="">--</div>
                <ul class="mod-list" id="mods-derived-fo" style="display:none"></ul></div>
                <div class="kv"><div class="k">MO</div> <div class="val badge mod-toggle" id="mo-val" data-target="mods-derived-mo" title="">--</div>
                <ul class="mod-list" id="mods-derived-mo" style="display:none"></ul></div>
                <div class="kv"><div class="k">SP cap (10% HP)</div> <div class="val badge mod-toggle" id="spcap-val" data-target="mods-derived-spcap" title="">--</div>
                <ul class="mod-list" id="mods-derived-spcap" style="display:none"></ul></div>
                <div class="kv"><div class="k">Encumbrance</div> <div class="val badge mod-toggle" id="enc-val" data-target="mods-derived-enc" title="">--</div>
                <ul class="mod-list" id="mods-derived-enc" style="display:none"></ul></div>
                <div class="kv"><div class="k">Eclipse Threshold (ET)</div> <div class="val badge mod-toggle" id="et-val" data-target="mods-derived-et" title="">--</div>
                <ul class="mod-list" id="mods-derived-et" style="display:none"></ul></div>
                <div class="kv"><div class="k">Max Toxicity (TX)</div> <div class="val badge mod-toggle" id="tx-val" data-target="mods-derived-tx" title="">--</div>
                <ul class="mod-list" id="mods-derived-tx" style="display:none"></ul></div>
              </div>
            </div>
          </details>
        </div>

        <!-- Sublimations -->
        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Sublimations</strong>
              <span class="pill" id="sub-slot-pill"></span>
              <span class="muted" id="sub-warning"></span>
            </summary>
            <div class="panel-body">
              <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                <label class="muted">Type</label>
                <select id="sub-type">
                  <option value="">-- choose --</option>
                  <option value="lethality">Lethality</option>
                  <option value="blessing">Blessing</option>
                  <option value="excellence">Excellence</option>
                  <option value="defense">Defense</option>
                  <option value="speed">Speed</option>
                  <option value="devastation">Devastation</option>
                  <option value="clarity">Clarity</option>
                  <option value="endurance">Endurance</option>
                </select>
                <label class="muted">Tier</label>
                <select id="sub-tier">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
                <label class="muted" id="sub-skill-label" style="display:none;">Skill (Excellence)</label>
                <select id="sub-skill" style="display:none; min-width:180px;"></select>
                <label class="muted" id="sub-nature-label" style="display:none;">Nature (Blessing)</label>
                <select id="sub-nature" style="display:none; min-width:120px;">
                  <option value="">-- choose --</option>
                </select>
                <button id="sub-add-btn">Add</button>
              </div>
              <div id="sub-list" class="abi-list"></div>
              <div class="muted" id="sub-hidden"></div>
            </div>
          </details>
        </div>

        <div class="stats-grid" id="stats-grid"><!-- injected --></div>

        <!-- (optional Defense summary panel kept minimal) -->
        <div class="panel" style="margin-top:12px;">
          <details open class="panel">
            <summary class="hdr"><strong>Defense Summary</strong></summary>
            <div class="panel-body" id="defense-summary"></div>
          </details>
        </div>
      </div>

      <!-- INVENTORY -->
      <div id="tab-inv" class="tabpane" style="display:none;">
        <div class="panel">
          <details open class="panel">
            <summary class="hdr">
              <strong>Inventory</strong>
              <span class="muted">(link + manage inline)</span>
            </summary>
            <div class="panel-body">
              <div class="row" style="margin-bottom:10px; flex-wrap:wrap; gap:8px;">
                <select id="inv-select" class="grow"></select>
                <button id="inv-load-btn">Load</button>
                <a class="btn" id="inv-open-btn" target="_blank" rel="noopener">Open manager</a>
                <a class="btn" href="inventory_create.html" target="_blank" rel="noopener">Create inventory</a>
                <span id="inv-status" class="muted"></span>
              </div>

              <div id="inv-summary" class="muted" style="margin-bottom:8px;"></div>
              <div id="inv-embed-wrap" style="display:none; margin-top:10px;">
                <iframe id="inv-embed" title="Inventory manager" style="width:100%; height:760px; border:1px solid #222; border-radius:12px;"></iframe>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- ABILITIES TAB -->
      <div id="tab-abi" class="tabpane" style="display:none;">
        <div class="panel">
          <details open class="panel">
            <summary class="hdr">
              <strong>Abilities on this Character</strong>
              <span class="muted">(Archetype / Passive / Active)</span>
              <span class="grow"></span>
              <span class="muted">Autosaves</span>
            </summary>
            <div class="panel-body">
              <!-- Add / search row -->
              <div class="abi-add" style="margin-bottom:10px;">
                <input id="abi-search" placeholder="Search ability by nameâ€¦" />
                <select id="abi-filter-type">
                  <option value="">Any type</option>
                  <option value="active">Active</option>
                  <option value="passive">Passive</option>
                  <option value="mixed">Mixed</option>
                </select>
                <select id="abi-filter-source">
                  <option value="">Any source</option>
                  <option value="Specie">Specie</option>
                  <option value="Talent">Talent</option>
                  <option value="Archetype">Archetype</option>
                  <option value="Expertise">Expertise</option>
                  <option value="Awakening">Awakening</option>
                  <option value="Apotheosis">Apotheosis</option>
                  <option value="Other">Other</option>
                </select>
                <button id="abi-search-btn">Find</button>
              </div>
              <div id="abi-results" class="abi-list" style="margin-bottom:12px;"></div>
              <div class="abi-hint">Tip: click a result to add it; click the ðŸ—‘ on an assigned ability to remove it.</div>

              <div class="abi-grid" style="margin-top:16px;">
                <div class="abi-bucket">
                  <h3>Archetype</h3>
                  <div id="abi-list-archetype" class="abi-list"></div>
                </div>
                <div class="abi-bucket">
                  <h3>Passive (non-Archetype)</h3>
                  <div id="abi-list-passive" class="abi-list"></div>
                </div>
                <div class="abi-bucket">
                  <h3>Active (non-Archetype)</h3>
                  <div id="abi-list-active" class="abi-list"></div>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- COMBAT / PERSONAL placeholders -->
      <div id="tab-com" class="tabpane" style="display:none;"><p class="muted">Combat -- coming next.</p></div>
      <div id="tab-per" class="tabpane" style="display:none;"><p class="muted">Bio -- coming next.</p></div>
    </div>

  </div></div>

<script>
/* --- auth helper --- */
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){ const t=getToken(); if(t) setCookieToken(t); return t ? {'Authorization':'Bearer '+t, 'X-Auth-Token':t} : {}; }
async function api(path,opt={}){ const headers = Object.assign({}, opt.headers||{}, authHeaders()); const resp = await fetch(path, { credentials:'include', ...opt, headers }); const ct = resp.headers.get('content-type') || ''; const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() }; if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status)); return data; }

/* Constants */
const CHARACS = [
  { key:'reflex',    code:'REF', name:'Reflex',    skills:['Technicity','Dodge','Counter','Reactivity'] },
  { key:'dexterity', code:'DEX', name:'Dexterity', skills:['Accuracy','Evasion','Stealth','Acrobatics'] },
  { key:'body',      code:'BOD', name:'Body',      skills:['Brutality','Blocking','Resistance','Athletics'] },
  { key:'wisdom',    code:'WIS', name:'Wisdom',    skills:['Survival','Education','Perception','Psychology','Investigation'] },
  { key:'presence',  code:'PRE', name:'Presence',  skills:['Taming','Charm','Charisma','Deception','Persuasion'] },
  { key:'magic',     code:'MAG', name:'Magic',     skills:['Aura','Incantation','Enchantment','Restoration','Potential'] },
  { key:'willpower', code:'WIL', name:'Willpower', skills:['Intimidation','Spirit','Instinct','Absorption'] },
  { key:'tech',      code:'TECH',name:'Tech',      skills:['Crafting','Sleight of hand','Alchemy','Medicine','Engineering'] },
];

const NATURES = ['Fire','Lightning','Water','Earth','Wind','Sun','Moon','Ki'];
const SUB_TIER_SLOTS = {1:1, 2:3, 3:5, 4:7};
const SUB_TYPES = [
  { key:'lethality', label:'Lethality' },
  { key:'blessing', label:'Blessing' },
  { key:'excellence', label:'Excellence' },
  { key:'defense', label:'Defense' },
  { key:'speed', label:'Speed' },
  { key:'devastation', label:'Devastation' },
  { key:'clarity', label:'Clarity' },
  { key:'endurance', label:'Endurance' },
];
const TARGET_GROUPS = [
  { label:'Characteristics', options:[
    { value:'char.reflex', label:'Reflex (modifier)' },
    { value:'char.dexterity', label:'Dexterity (modifier)' },
    { value:'char.body', label:'Body (modifier)' },
    { value:'char.wisdom', label:'Wisdom (modifier)' },
    { value:'char.presence', label:'Presence (modifier)' },
    { value:'char.magic', label:'Magic (modifier)' },
    { value:'char.willpower', label:'Willpower (modifier)' },
    { value:'char.tech', label:'Tech (modifier)' },
  ]},
  { label:'Skills', options:[
    { value:'skills.reflex.Technicity', label:'Technicity (Reflex)' },
    { value:'skills.reflex.Dodge', label:'Dodge (Reflex)' },
    { value:'skills.reflex.Counter', label:'Counter (Reflex)' },
    { value:'skills.reflex.Reactivity', label:'Reactivity (Reflex)' },
    { value:'skills.dexterity.Accuracy', label:'Accuracy (Dexterity)' },
    { value:'skills.dexterity.Evasion', label:'Evasion (Dexterity)' },
    { value:'skills.dexterity.Stealth', label:'Stealth (Dexterity)' },
    { value:'skills.dexterity.Acrobatics', label:'Acrobatics (Dexterity)' },
    { value:'skills.body.Brutality', label:'Brutality (Body)' },
    { value:'skills.body.Blocking', label:'Blocking (Body)' },
    { value:'skills.body.Resistance', label:'Resistance (Body)' },
    { value:'skills.body.Athletics', label:'Athletics (Body)' },
    { value:'skills.wisdom.Survival', label:'Survival (Wisdom)' },
    { value:'skills.wisdom.Education', label:'Education (Wisdom)' },
    { value:'skills.wisdom.Perception', label:'Perception (Wisdom)' },
    { value:'skills.wisdom.Psychology', label:'Psychology (Wisdom)' },
    { value:'skills.wisdom.Investigation', label:'Investigation (Wisdom)' },
    { value:'skills.presence.Taming', label:'Taming (Presence)' },
    { value:'skills.presence.Charm', label:'Charm (Presence)' },
    { value:'skills.presence.Charisma', label:'Charisma (Presence)' },
    { value:'skills.presence.Deception', label:'Deception (Presence)' },
    { value:'skills.presence.Persuasion', label:'Persuasion (Presence)' },
    { value:'skills.magic.Aura', label:'Aura (Magic)' },
    { value:'skills.magic.Incantation', label:'Incantation (Magic)' },
    { value:'skills.magic.Enchantment', label:'Enchantment (Magic)' },
    { value:'skills.magic.Restoration', label:'Restoration (Magic)' },
    { value:'skills.magic.Potential', label:'Potential (Magic)' },
    { value:'skills.willpower.Intimidation', label:'Intimidation (Willpower)' },
    { value:'skills.willpower.Spirit', label:'Spirit (Willpower)' },
    { value:'skills.willpower.Instinct', label:'Instinct (Willpower)' },
    { value:'skills.willpower.Absorption', label:'Absorption (Willpower)' },
    { value:'skills.tech.Crafting', label:'Crafting (Tech)' },
    { value:'skills.tech.Sleight of hand', label:'Sleight of hand (Tech)' },
    { value:'skills.tech.Alchemy', label:'Alchemy (Tech)' },
    { value:'skills.tech.Medicine', label:'Medicine (Tech)' },
    { value:'skills.tech.Engineering', label:'Engineering (Tech)' },
  ]},
  { label:'Derived / Resources', options:[
    { value:'derived.hp', label:'HP' },
    { value:'derived.en', label:'EN' },
    { value:'derived.fo', label:'FO' },
    { value:'derived.mo', label:'MO' },
    { value:'derived.spcap', label:'SP cap' },
    { value:'derived.enc', label:'Encumbrance' },
    { value:'derived.et', label:'Eclipse Threshold (ET)' },
    { value:'derived.tx', label:'Max Toxicity (TX)' },
  ]},
  { label:'Custom', options:[{ value:'__custom__', label:'Custom path...' }]}
];
function totalFromInvest(v){ return (parseInt(v||0,10) || 0) + 4; }
function modFromTotal(total){ return Math.floor((Number(total)-10)/2); }

/* State */
const params = new URLSearchParams(location.search);
const CID = params.get('id');
let ROLE = 'user';
let SAVE_TIMER = null;
let CHAR = null;
let ASSIGNED = []; // full documents of assigned abilities (resolved by id)
let INVENTORIES = [];
let LINKED_INV = null;
let SELECTED_INV_ID = '';
let SUBLIMATIONS = [];
let SUB_HIDDEN = {};

/* Passive bonus aggregations (recomputed whenever ASSIGNED changes) */
let PASSIVE = {
  char: {},     // key -> { set:[], mul:[], add:[], notes:[] }  (applied to characteristic MOD)
  skill: {},    // "key|skill" -> { set:[], mul:[], add:[], notes:[] } (applied to skill TOTAL)
};

/* DOM refs */
const loginChip = document.getElementById('login-chip');
const adminLink = document.getElementById('admin-link');
const titleEl   = document.getElementById('title');
const statusEl  = document.getElementById('status');
const nameEl    = document.getElementById('name');
const gridEl    = document.getElementById('stats-grid');

/* derived refs */
const levelEl = document.getElementById('level');
const hpEl = document.getElementById('hp-val');
const enEl = document.getElementById('en-val');
const foEl = document.getElementById('fo-val');
const moEl = document.getElementById('mo-val');
const spcapEl = document.getElementById('spcap-val');
const encEl = document.getElementById('enc-val');
const etEl = document.getElementById('et-val');
const txEl = document.getElementById('tx-val');

/* Abilities tab refs */
const abiSearchEl = document.getElementById('abi-search');
const abiFilterTypeEl = document.getElementById('abi-filter-type');
const abiFilterSrcEl  = document.getElementById('abi-filter-source');
const abiSearchBtn = document.getElementById('abi-search-btn');
const abiResultsEl = document.getElementById('abi-results');
const listArchetypeEl = document.getElementById('abi-list-archetype');
const listPassiveEl   = document.getElementById('abi-list-passive');
const listActiveEl    = document.getElementById('abi-list-active');
/* Inventory tab refs */
const invSelectEl = document.getElementById('inv-select');
const invLoadBtn = document.getElementById('inv-load-btn');
const invOpenBtn = document.getElementById('inv-open-btn');
const invStatusEl = document.getElementById('inv-status');
const invSummaryEl = document.getElementById('inv-summary');
const invEmbedWrap = document.getElementById('inv-embed-wrap');
const invEmbed = document.getElementById('inv-embed');
/* Sublimations refs */
const subTypeEl = document.getElementById('sub-type');
const subTierEl = document.getElementById('sub-tier');
const subSkillEl = document.getElementById('sub-skill');
const subSkillLabel = document.getElementById('sub-skill-label');
const subNatureEl = document.getElementById('sub-nature');
const subNatureLabel = document.getElementById('sub-nature-label');
const subAddBtn = document.getElementById('sub-add-btn');
const subListEl = document.getElementById('sub-list');
const subSlotPill = document.getElementById('sub-slot-pill');
const subWarningEl = document.getElementById('sub-warning');
const subHiddenEl = document.getElementById('sub-hidden');

// Sublimations form wiring
(() => {
  const skillOpts = buildSkillOptions();
  subSkillEl.innerHTML = '';
  skillOpts.forEach(opt=>{
    const o = document.createElement('option');
    o.value = opt.value; o.textContent = opt.label;
    subSkillEl.appendChild(o);
  });
  subNatureEl.innerHTML = '<option value=\"\">-- choose --</option>';
  NATURES.forEach(n=>{
    const o = document.createElement('option');
    o.value = n; o.textContent = n;
    subNatureEl.appendChild(o);
  });
  subTypeEl.addEventListener('change', updateSubSpecialFields);
  subAddBtn.addEventListener('click', addSublimationFromForm);
  updateSubSpecialFields();
})();

// Listen for inventory iframe updates to refresh mods live
window.addEventListener('message', (event)=>{
  if (event.origin !== location.origin) return;
  const data = event.data || {};
  if (data.type === 'inventory-updated' && data.inventory){
    const inv = data.inventory;
    const match = LINKED_INV && (LINKED_INV.id === inv.id || SELECTED_INV_ID === inv.id);
    if (match){
      LINKED_INV = inv;
      SELECTED_INV_ID = inv.id || SELECTED_INV_ID;
      if (CHAR) CHAR.inventory_id = SELECTED_INV_ID;
      renderInventorySummary();
      recomputePassiveAgg();
      renderStatistics();
      updateDerived();
    }
  }
});

/* tabs switching */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
    tab.classList.add('active');
    const id = tab.getAttribute('data-tab');
    document.getElementById(id).style.display='';
  });
});

/* auth */
async function checkMe() {
  loginChip.textContent = 'Checking login...';
  try{
    const me = await api('/auth/me');
    loginChip.textContent = `${me.username} (${me.role})`;
    if ((me.role||'').toLowerCase()==='admin') adminLink.style.display='';
    ROLE = me.role||'user';
    return me;
  } catch(e){
    loginChip.textContent = 'Not logged in';
    adminLink.style.display='none';
    throw e;
  }
}

/* defaults */
function makeDefaultStats(){
  const stats = {};
  for (const c of CHARACS){
    const sk = {};
    for (const s of c.skills) sk[s] = 0;
    stats[c.key] = { invest: 0, skills: sk };
  }
  const ints = {};
  for (const n of NATURES){ ints[n] = {knows:false, invest:0}; }
  stats.intensities = ints;
  return stats;
}

/* ---------- Sublimations helpers ---------- */
function normalizeSublimations(arr){
  const out = [];
  (arr || []).forEach(s=>{
    if (!s || !s.type) return;
    const tier = Math.min(4, Math.max(1, Number(s.tier)||1));
    out.push({
      id: s.id || `sub_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      type: String(s.type||'').toLowerCase(),
      tier,
      skill: s.skill || '',
      nature: s.nature || ''
    });
  });
  return out;
}
function slotsForLevel(lvl){
  const base = 2; // unlocked immediately, +2 every 10 levels
  return base + (Math.floor(Math.max(1, lvl-1) / 10) * 2);
}
function slotsUsed(subs){
  return (subs||[]).reduce((acc,s)=> acc + (SUB_TIER_SLOTS[s.tier] || 0), 0);
}
function buildSkillOptions(){
  const opts = [];
  for (const c of CHARACS){
    for (const s of c.skills){
      opts.push({ value:`${c.key}|${s}`, label:`${s} (${c.name})` });
    }
  }
  return opts;
}

function updateSubSpecialFields(){
  const t = (subTypeEl.value || '').toLowerCase();
  const isEx = t === 'excellence';
  const isBless = t === 'blessing';
  subSkillEl.style.display = subSkillLabel.style.display = isEx ? '' : 'none';
  subNatureEl.style.display = subNatureLabel.style.display = isBless ? '' : 'none';
}

function renderSublimations(){
  const lvl = Math.max(1, Math.floor(Number(levelEl.value)||1));
  const cap = slotsForLevel(lvl);
  const used = slotsUsed(SUBLIMATIONS);
  subSlotPill.textContent = `Slots: ${used} / ${cap}`;
  subWarningEl.textContent = used > cap ? 'Over capacity' : '';

  subListEl.innerHTML = '';
  if (!SUBLIMATIONS.length){
    subListEl.innerHTML = '<div class="muted">No sublimations set.</div>';
  }else{
    const skillOpts = buildSkillOptions();
    SUBLIMATIONS.forEach(sub=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.style.alignItems = 'center';
      row.style.gap = '6px';

      const label = document.createElement('div');
      label.style.minWidth = '120px';
      label.innerHTML = `<b>${sub.type}</b>`;
      row.appendChild(label);

      const tierSel = document.createElement('select');
      [1,2,3,4].forEach(n=>{
        const o = document.createElement('option');
        o.value = n; o.textContent = `Tier ${n}`;
        if (n === Number(sub.tier)) o.selected = true;
        tierSel.appendChild(o);
      });
      tierSel.addEventListener('change', ()=>{
        sub.tier = Math.min(4, Math.max(1, Number(tierSel.value)||1));
        onSublimationChanged();
      });
      row.appendChild(tierSel);

      if (sub.type === 'excellence'){
        const skSel = document.createElement('select');
        skillOpts.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt.value; o.textContent = opt.label;
          if (opt.value === sub.skill) o.selected = true;
          skSel.appendChild(o);
        });
        skSel.addEventListener('change', ()=>{
          sub.skill = skSel.value;
          onSublimationChanged();
        });
        row.appendChild(skSel);
      }else if (sub.type === 'blessing'){
        const natSel = document.createElement('select');
        natSel.innerHTML = '<option value=\"\">-- nature --</option>';
        NATURES.forEach(n=>{
          const o = document.createElement('option');
          o.value = n; o.textContent = n;
          if ((sub.nature||'') === n) o.selected = true;
          natSel.appendChild(o);
        });
        natSel.addEventListener('change', ()=>{
          sub.nature = natSel.value;
          onSublimationChanged();
        });
        row.appendChild(natSel);
      }

      const rem = document.createElement('button');
      rem.className = 'btn btn-secondary small';
      rem.textContent = 'Remove';
      rem.addEventListener('click', ()=>{
        SUBLIMATIONS = SUBLIMATIONS.filter(s=>s.id !== sub.id);
        onSublimationChanged();
      });
      row.appendChild(rem);

      subListEl.appendChild(row);
    });
  }

  const { hidden } = getSublimationEffects();
  const parts = [];
  if (hidden.weaponNeutral) parts.push(`+${hidden.weaponNeutral} neutral weapon dmg (not animarmas)`);
  if (hidden.magicBonus) parts.push(`+${hidden.magicBonus} ${hidden.magicNature || 'magic'} dmg to space actions`);
  if (hidden.conditionDC) parts.push(`+${hidden.conditionDC} Condition DC`);
  subHiddenEl.textContent = parts.length ? `Hidden effects: ${parts.join(' | ')}` : '';
}

function onSublimationChanged(){
  renderSublimations();
  recomputePassiveAgg();
  renderStatistics();
  updateDerived();
  queueSave();
}

function addSublimationFromForm(){
  const type = (subTypeEl.value || '').toLowerCase();
  const tier = Math.min(4, Math.max(1, Number(subTierEl.value)||1));
  const skill = subSkillEl.value || '';
  const nature = subNatureEl.value || '';
  if (!type){ subWarningEl.textContent = 'Pick a type'; return; }
  if (type === 'excellence' && !skill){ subWarningEl.textContent = 'Choose a skill for Excellence'; return; }
  if (type === 'blessing' && !nature){ subWarningEl.textContent = 'Choose a nature for Blessing'; return; }
  if (type !== 'excellence' && SUBLIMATIONS.some(s=>s.type===type)){
    subWarningEl.textContent = 'This sublimation type is already slotted';
    return;
  }
  if (type === 'excellence' && SUBLIMATIONS.some(s=>s.type==='excellence' && s.skill === skill)){
    subWarningEl.textContent = 'That skill already has an Excellence';
    return;
  }
  const lvl = Math.max(1, Math.floor(Number(levelEl.value)||1));
  const cap = slotsForLevel(lvl);
  const newUsed = slotsUsed(SUBLIMATIONS) + (SUB_TIER_SLOTS[tier] || 0);
  if (newUsed > cap){
    subWarningEl.textContent = 'Not enough slots';
    return;
  }
  subWarningEl.textContent = '';
  SUBLIMATIONS = SUBLIMATIONS.concat([{ id:`sub_${Date.now()}_${Math.random().toString(16).slice(2)}`, type, tier, skill, nature }]);
  onSublimationChanged();
}

/* ---------- PASSIVE AGGREGATION (char & skills) ---------- */
function resetPassiveAgg(){
  PASSIVE = { char:{}, skill:{} };
}
function ensureAgg(obj, key){
  if (!obj[key]) obj[key] = { set:[], mul:[], add:[], notes:[] };
  return obj[key];
}
function recomputePassiveAgg(){
  resetPassiveAgg();
  const passiveAbilities = (ASSIGNED||[]).filter(a=>{
    const t = (a.type||'').toLowerCase();
    return t==='passive' || t==='mixed';
  });
  for (const ab of passiveAbilities){
    const mods = (ab.passive && ab.passive.modifiers) || [];
    for (const m of mods){
      const t = (m.target || m.key || '').trim();
      const mode = ((m.mode||'add')+'').toLowerCase();
      const val = Number(m.value||0);
      const note = m.note ? ` (${m.note})` : '';
      const origin = `${ab.name}${note}`;
      if (!t) continue;

      const cm = t.match(/^char\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)$/i);
      if (cm){
        const key = cm[1].toLowerCase();
        const agg = ensureAgg(PASSIVE.char, key);
        (agg[mode]||agg.add).push({v:val, origin});
        agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
        continue;
      }

      const sm = t.match(/^skills\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)\.(.+)$/i);
      if (sm){
        const ckey = sm[1].toLowerCase();
        const skName = sm[2];
        const k = `${ckey}|${skName}`;
        const agg = ensureAgg(PASSIVE.skill, k);
        (agg[mode]||agg.add).push({v:val, origin});
        agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
        continue;
      }
    }
  }
  for (const m of getEquippedInventoryModifiers()){
    const t = (m.target||'').trim();
    const mode = (m.mode||'add').toLowerCase();
    const val = Number(m.value||0);
    const origin = m.origin || 'Inventory';
    if (!t) continue;
    const cm = t.match(/^char\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)$/i);
    if (cm){
      const key = cm[1].toLowerCase();
      const agg = ensureAgg(PASSIVE.char, key);
      (agg[mode]||agg.add).push({v:val, origin});
      agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
      continue;
    }
    const sm = t.match(/^skills\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)\.(.+)$/i);
    if (sm){
      const ckey = sm[1].toLowerCase();
      const skName = sm[2];
      const k = `${ckey}|${skName}`;
      const agg = ensureAgg(PASSIVE.skill, k);
      (agg[mode]||agg.add).push({v:val, origin});
      agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
      continue;
    }
  }
  const { mods: subMods } = getSublimationEffects();
  for (const m of subMods){
    const t = (m.target||'').trim();
    const mode = (m.mode||'add').toLowerCase();
    const val = Number(m.value||0);
    const origin = m.origin || 'Sublimation';
    if (!t) continue;
    const cm = t.match(/^char\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)$/i);
    if (cm){
      const key = cm[1].toLowerCase();
      const agg = ensureAgg(PASSIVE.char, key);
      (agg[mode]||agg.add).push({v:val, origin});
      agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
      continue;
    }
    const sm = t.match(/^skills\.(body|willpower|magic|presence|reflex|dexterity|tech|wisdom)\.(.+)$/i);
    if (sm){
      const ckey = sm[1].toLowerCase();
      const skName = sm[2];
      const k = `${ckey}|${skName}`;
      const agg = ensureAgg(PASSIVE.skill, k);
      (agg[mode]||agg.add).push({v:val, origin});
      agg.notes.push(`${mode} ${val>=0?'+':''}${val} -> ${origin}`);
      continue;
    }
  }
}
function applyOps(base, agg){
  if (!agg) return { value: base, notes: [`Base = ${base}`] };
  const notes = [`Base = ${base}`];
  let v = base;
  // set -> mul -> add
  for (const x of (agg.set||[])){ v = x.v; notes.push(`Set to ${x.v} -> ${x.origin}`); }
  for (const x of (agg.mul||[])){ const before = v; v = Math.round(v * x.v); notes.push(`*${x.v} (from ${before}) -> ${x.origin}`); }
  for (const x of (agg.add||[])){ v = v + x.v; notes.push(`${x.v>=0?'+':''}${x.v} -> ${x.origin}`); }
  return { value: v, notes };
}

/* ---------- Rendering: Statistics & Skills ---------- */
function skillId(key, skill, suffix){
  const slug = (skill || '').toLowerCase().replace(/[^a-z0-9]+/g, '_');
  return `${key}__${slug}__${suffix}`;
}

function setNotesList(id, notes){
  let el = document.getElementById(id);
  if (!el){
    el = document.createElement('ul');
    el.className = 'mod-list';
    el.id = id;
    el.style.display = 'none';
  }else{
    el.innerHTML = '';
  }
  (notes || []).forEach(n=>{
    const li = document.createElement('li');
    li.textContent = n;
    el.appendChild(li);
  });
  return el;
}

function toggleModList(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = (el.style.display === 'none' || !el.style.display) ? '' : 'none';
}

document.addEventListener('click', (e)=>{
  const t = e.target.closest('.mod-toggle');
  if (!t) return;
  const id = t.getAttribute('data-target');
  if (id) toggleModList(id);
});

function getEquippedInventoryModifiers(){
  if (!LINKED_INV) return [];
  const items = LINKED_INV.items || [];
  const mods = [];
  for (const it of items){
    if (it.equipped === false) continue;
    for (const m of (it.modifiers || [])){
      const target = (m.target || m.key || '').trim();
      if (!target) continue;
      const mode = (m.mode || 'add').toLowerCase();
      const value = Number(m.value || 0);
      const note = m.note ? ` (${m.note})` : '';
      mods.push({ target, mode, value, origin: `[Item] ${it.name || 'Item'}${note}` });
    }
  }
  return mods;
}

function getSublimationEffects(){
  const mods = [];
  const hidden = { weaponNeutral:0, magicBonus:0, magicNature:'', conditionDC:0 };
  for (const s of SUBLIMATIONS || []){
    const t = (s.type||'').toLowerCase();
    const tier = Math.min(4, Math.max(1, Number(s.tier)||1));
    const origin = `Sublimation - ${t.charAt(0).toUpperCase()+t.slice(1)}`;
    if (t === 'lethality'){
      hidden.weaponNeutral += 2 * tier;
      continue;
    }
    if (t === 'blessing'){
      hidden.magicBonus += 2 * tier;
      hidden.magicNature = s.nature || hidden.magicNature || '';
      continue;
    }
    if (t === 'excellence'){
      if (!s.skill) continue;
      const [ckey, sk] = s.skill.split('|');
      if (!ckey || !sk) continue;
      mods.push({ target:`skills.${ckey}.${sk}`, mode:'add', value:tier, origin:`${origin} (${sk})` });
      continue;
    }
    if (t === 'defense'){
      mods.push({ target:'derived.hp', mode:'add', value:12 * tier, origin });
      continue;
    }
    if (t === 'speed'){
      mods.push({ target:'derived.mo', mode:'add', value: tier, origin });
      continue;
    }
    if (t === 'devastation'){
      hidden.conditionDC += tier;
      continue;
    }
    if (t === 'clarity'){
      mods.push({ target:'derived.en', mode:'add', value: 2 * tier, origin });
      continue;
    }
    if (t === 'endurance'){
      mods.push({ target:'derived.fo', mode:'add', value: 2 * tier, origin });
      continue;
    }
  }
  SUB_HIDDEN = hidden;
  return { mods, hidden };
}

async function loadInventoriesList(){
  invStatusEl.textContent = 'Loading inventories...';
  try{
    const res = await api('/inventories');
    INVENTORIES = res.inventories || [];
    invSelectEl.innerHTML = '<option value="">-- Select inventory --</option>';
    INVENTORIES.forEach(inv=>{
      const opt = document.createElement('option');
      opt.value = inv.id;
      opt.textContent = inv.name || inv.id;
      if (inv.id === SELECTED_INV_ID) opt.selected = true;
      invSelectEl.appendChild(opt);
    });
    invStatusEl.textContent = '';
  }catch(e){
    invStatusEl.textContent = 'Load failed: ' + e.message;
  }
}

function renderInventorySummary(){
  if (!LINKED_INV){
    invSummaryEl.textContent = 'No inventory linked.';
    invOpenBtn.style.display = 'none';
    if (invEmbedWrap) invEmbedWrap.style.display = 'none';
    return;
  }
  const enc = Number(LINKED_INV.enc_total || 0);
  const cur = LINKED_INV.currencies || {};
  const curText = Object.keys(cur).length ? Object.entries(cur).map(([k,v])=>`${k}: ${v}`).join(' | ') : 'no currencies';
  invSummaryEl.textContent = `${LINKED_INV.name || 'Inventory'} - Current encumbrance: ${enc.toFixed(1)} | ${curText}`;
  invOpenBtn.style.display = '';
  invOpenBtn.href = `inventory_view.html?inv=${encodeURIComponent(LINKED_INV.id || '')}`;
  if (invEmbedWrap && invEmbed){
    invEmbedWrap.style.display = '';
    const targetSrc = new URL(`inventory_view.html?inv=${encodeURIComponent(LINKED_INV.id || '')}&embed=1`, location.href).toString();
    const currentSrc = invEmbed.src;
    if (currentSrc !== targetSrc) invEmbed.src = targetSrc;
  }
  updateDerived();
}

async function loadInventoryById(id){
  if (!id){ LINKED_INV=null; SELECTED_INV_ID=''; CHAR.inventory_id=''; renderInventorySummary(); recomputePassiveAgg(); renderStatistics(); updateDerived(); queueSave(); return; }
  invStatusEl.textContent = 'Loading inventory...';
  try{
    const res = await api('/inventories/' + encodeURIComponent(id));
    if (res.inventory){
      LINKED_INV = res.inventory;
      SELECTED_INV_ID = LINKED_INV.id || id;
      CHAR.inventory_id = SELECTED_INV_ID;
      renderInventorySummary();
      recomputePassiveAgg();
      renderStatistics();
      updateDerived();
      invStatusEl.textContent = 'Inventory loaded';
      queueSave();
    }else{
      throw new Error('Not found');
    }
  }catch(e){
    invStatusEl.textContent = 'Load failed: ' + e.message;
  }
}

function charBaseMod(key){
  const invest = CHAR.stats?.[key]?.invest ?? 0;
  return modFromTotal(totalFromInvest(invest));
}
function charAdjMod(key){
  const base = charBaseMod(key);
  const { value, notes } = applyOps(base, PASSIVE.char[key]);
  return { mod:value, notes };
}
function skillBaseTotal(key, skill){
  const inv = CHAR.stats?.[key]?.skills?.[skill] ?? 0;
  return inv + charBaseMod(key);
}
function skillAdjTotal(key, skill){
  const base = skillBaseTotal(key, skill);
  const agg = PASSIVE.skill[`${key}|${skill}`];
  const { value, notes } = applyOps(base, agg);
  return { total:value, notes };
}

function renderStatistics(){
  gridEl.innerHTML = '';
  for (const c of CHARACS){
    const rec = (CHAR.stats && CHAR.stats[c.key]) || { invest:0, skills:{} };
    const total = totalFromInvest(rec.invest);
    const modInfo = charAdjMod(c.key);

    const details = document.createElement('details'); details.className='panel'; details.open = true;
    const sum = document.createElement('summary'); sum.className='hdr';
    sum.innerHTML = `
      <strong>${c.name}</strong>
      <span class="pill">${c.code}</span>
      <span class="charac-badge mod-toggle" data-target="mods-char-${c.key}" title="${modInfo.notes.join('\n')}">[ <span class="total" id="${c.key}-total">${total}</span> | <span id="${c.key}-mod">${modInfo.mod>=0? '+'+modInfo.mod : modInfo.mod}</span> ]</span>
      <span class="grow"></span>
      <span class="k">Invested</span>
      <input type="number" class="num" min="0" id="${c.key}-invest" value="${Number(rec.invest)||0}">
    `;
    details.appendChild(sum);

    const body = document.createElement('div'); body.className='panel-body';
    const skills = document.createElement('div'); skills.className='skills';

    for (const s of c.skills){
      const invested = Number((rec.skills||{})[s] || 0);
      const adj = skillAdjTotal(c.key, s);
      const investId = skillId(c.key, s, 'invest');
      const totalId = skillId(c.key, s, 'total');
      const line = document.createElement('div'); line.className='skill-line';
      line.innerHTML = `
        <div class="k">${s}</div>
        <input type="number" class="num" min="0" id="${investId}" value="${invested}">
        <div class="skill-total badge mod-toggle" data-target="mods-${totalId}" id="${totalId}" title="${adj.notes.join('\n')}">${adj.total>=0? '+'+adj.total : adj.total}</div>
      `;
      const noteList = setNotesList(`mods-${totalId}`, adj.notes);
      line.appendChild(noteList);
      skills.appendChild(line);
    }

    const charNotesList = setNotesList(`mods-char-${c.key}`, modInfo.notes);
    body.appendChild(charNotesList);
    body.appendChild(skills);
    details.appendChild(body);
    gridEl.appendChild(details);
  }

  // Wire listeners
  for (const c of CHARACS){
    const input = document.getElementById(`${c.key}-invest`);
    input.addEventListener('input', ()=>{
      const val = Math.max(0, Math.floor(Number(input.value)||0));
      CHAR.stats[c.key].invest = val;

      // update characteristic header
      const total = totalFromInvest(val);
      const modInfo = charAdjMod(c.key);
      document.getElementById(`${c.key}-total`).textContent = total;
      document.getElementById(`${c.key}-mod`).textContent = (modInfo.mod>=0? '+'+modInfo.mod : modInfo.mod);
      document.querySelector(`#${c.key}-mod`).parentElement.title = modInfo.notes.join('\\n');
      setNotesList(`mods-char-${c.key}`, modInfo.notes);

      // update skill rows
      for (const s of c.skills){
        const adj = skillAdjTotal(c.key, s);
        const el = document.getElementById(skillId(c.key, s, 'total'));
        el.textContent = (adj.total>=0? '+'+adj.total : adj.total);
        el.title = adj.notes.join('\\n');
        setNotesList(`mods-${skillId(c.key, s, 'total')}`, adj.notes);
      }
      updateDerived();
      queueSave();
    });

    for (const s of c.skills){
      const si = document.getElementById(skillId(c.key, s, 'invest'));
      si.addEventListener('input', ()=>{
        const val = Math.max(0, Math.floor(Number(si.value)||0));
        CHAR.stats[c.key].skills[s] = val;
        const adj = skillAdjTotal(c.key, s);
        const el = document.getElementById(skillId(c.key, s, 'total'));
        el.textContent = (adj.total>=0? '+'+adj.total : adj.total);
        el.title = adj.notes.join('\\n');
        setNotesList(`mods-${skillId(c.key, s, 'total')}`, adj.notes);
        updateDerived();
        queueSave();
      });
    }
  }
}
/* simple defense placeholder */
function renderDefenseSummary(){
  const box = document.getElementById('defense-summary');
  box.innerHTML = '<div class="muted">--</div>';
}

/* --------- PASSIVE on DERIVED (existing behavior) ---------- */
function applyPassiveModifiersToDerived(base, currentEnc = 0){
  const out = { ...base };
  const notes = {
    hp: [`Base = ${base.hp}`],
    en: [`Base = ${base.en}`],
    fo: [`Base = ${base.fo}`],
    mo: [`Base = ${base.mo}`],
    et: [`Base = ${base.et}`],
    tx: [`Base = ${base.tx}`],
    enc:[`Base = ${base.enc}`],
    spcap:[`Base = ${base.spcap}`],
  };
  notes.enc.unshift(`Current enc = ${Number(currentEnc||0).toFixed(1)}`);
  if (base._notes){
    Object.entries(base._notes).forEach(([k, arr])=>{
      if (notes[k]) notes[k].push(...arr);
    });
  }

  const ops = { set:[], mul:[], add:[] };
  const passiveAbilities = (ASSIGNED||[]).filter(a=>{
    const t = (a.type||'').toLowerCase();
    return t==='passive' || t==='mixed';
  });

  const allMods = [];
  for (const ab of passiveAbilities){
    const mods = (ab.passive && ab.passive.modifiers) || [];
    for (const m of mods){
      allMods.push({
        target:(m.target || m.key || '').toLowerCase().trim(),
        mode:(m.mode||'add').toLowerCase(),
        val:Number(m.value||0),
        origin:`${ab.name}${m.note?` (${m.note})`:''}`
      });
    }
  }
  for (const m of getEquippedInventoryModifiers()){
    allMods.push({
      target:(m.target||'').toLowerCase(),
      mode:(m.mode||'add').toLowerCase(),
      val:Number(m.value||0),
      origin:m.origin
    });
  }
  const { mods: subMods } = getSublimationEffects();
  for (const m of subMods){
    allMods.push({
      target:(m.target||'').toLowerCase(),
      mode:(m.mode||'add').toLowerCase(),
      val:Number(m.value||0),
      origin:m.origin
    });
  }

  const map = {
    'derived.hp':'hp','derived.en':'en','derived.fo':'fo','derived.mo':'mo',
    'derived.et':'et','derived.tx':'tx','derived.enc':'enc','derived.spcap':'spcap'
  };
  for (const m of allMods){
    if (map[m.target]){
      ops[m.mode]?.push({ k: map[m.target], v: m.val, origin: m.origin });
    }
  }

  // set -> mul -> add
  for (const op of ops.set){ out[op.k] = op.v; notes[op.k].push(`Set to ${op.v} -> ${op.origin}`); }
  for (const op of ops.mul){ const before = out[op.k]; out[op.k] = Math.round(before * op.v); notes[op.k].push(`*${op.v} (from ${before}) -> ${op.origin}`); }
  for (const op of ops.add){ out[op.k] = out[op.k] + op.v; notes[op.k].push(`${op.v>=0?'+':''}${op.v} -> ${op.origin}`); }

  // Tooltips with breakdown
  hpEl.title = notes.hp.join('\n');   setNotesList('mods-derived-hp', notes.hp);
  enEl.title = notes.en.join('\n');   setNotesList('mods-derived-en', notes.en);
  foEl.title = notes.fo.join('\n');   setNotesList('mods-derived-fo', notes.fo);
  moEl.title = notes.mo.join('\n');   setNotesList('mods-derived-mo', notes.mo);
  spcapEl.title = notes.spcap.join('\n'); setNotesList('mods-derived-spcap', notes.spcap);
  encEl.title = notes.enc.join('\n'); setNotesList('mods-derived-enc', notes.enc);
  etEl.title = notes.et.join('\n');   setNotesList('mods-derived-et', notes.et);
  txEl.title = notes.tx.join('\n');   setNotesList('mods-derived-tx', notes.tx);

  out.current_enc = Number(currentEnc || 0);
  out.enc_max = out.enc;
  return out;
}

/* Derived computations (use characteristic mods & skills that may be adjusted) */
function milestone(key){
  // milestone uses the **adjusted** characteristic mod (>=0)
  return Math.max(0, charAdjMod(key).mod);
}
function skillTotalAdjustedFor(key, name){
  return skillAdjTotal(key, name).total;
}

function updateDerived(){
  const lvl = Math.max(1, Math.floor(Number(levelEl.value)||1));
  const msBOD = milestone('body');
  const msWIL = milestone('willpower');
  const msMAG = milestone('magic');
  const msPRE = milestone('presence');
  const msREF = milestone('reflex');
  const msDEX = milestone('dexterity');
  const msWIS = milestone('wisdom');

  // Base
  const base = {};
  base.hp = 100 + lvl + 12*msBOD + 6*msWIL;
  base.en = 5 + Math.floor(lvl/5) + msWIL + 2*msMAG;
  base.fo = 2 + Math.floor(lvl/5) + msWIL + (2*msPRE) + msWIS;
  base.mo = 4 + msDEX + msREF;
  base.spcap = Math.floor(base.hp * 0.10);
  const athletics = skillTotalAdjustedFor('body','Athletics');
  const spirit = skillTotalAdjustedFor('willpower','Spirit');
  base.enc = 10 + (athletics*5) + (spirit*2);
  const invEnc = LINKED_INV?.enc_total || 0;
  base.et = 1 + Math.floor(lvl/9) + msMAG;
  const resistance = skillTotalAdjustedFor('body','Resistance');
  const alchemy = skillTotalAdjustedFor('tech','Alchemy') || 0;
  base.tx = resistance + alchemy;

  // Apply passive modifiers to derived
  const final = applyPassiveModifiersToDerived(base, invEnc);

  // Display
  hpEl.textContent = final.hp;
  enEl.textContent = final.en;
  foEl.textContent = final.fo;
  moEl.textContent = final.mo;
  spcapEl.textContent = final.spcap;
  encEl.textContent = `${Number(final.current_enc || 0).toFixed(1)} / ${final.enc}`;
  etEl.textContent = final.et;
  txEl.textContent = final.tx;
}

/* LOAD & SAVE */
async function loadCharacter(){
  if (!CID){ statusEl.textContent = 'Missing id'; return; }
  const res = await api('/characters/' + encodeURIComponent(CID));
  CHAR = res.character || {};
  if (!CHAR.stats) CHAR.stats = makeDefaultStats();
  if (!CHAR.stats.intensities) CHAR.stats.intensities = makeDefaultStats().intensities;
  if (!('level' in CHAR)) CHAR.level = 1;
  if (!Array.isArray(CHAR.abilities)) CHAR.abilities = [];
  SUBLIMATIONS = normalizeSublimations(CHAR.sublimations || []);
  SELECTED_INV_ID = CHAR.inventory_id || '';

  // Name
  titleEl.textContent = 'Edit: ' + (CHAR.name || '(unnamed)');
  nameEl.value = CHAR.name || '';
  nameEl.addEventListener('input', ()=> queueSave());

  // Level
  levelEl.value = Math.max(1, Number(CHAR.level)||1);
  levelEl.addEventListener('input', ()=>{ CHAR.level = Math.max(1, Math.floor(Number(levelEl.value)||1)); renderSublimations(); updateDerived(); queueSave(); });

  renderSublimations();

  // Render stats/skills
  renderStatistics();

  // Resolve abilities â†’ recalc passive agg â†’ render abilities â†’ derived
  await resolveAssignedAbilities();
  recomputePassiveAgg();
  renderAbilitiesTab();
  // refresh visuals that depend on passive agg
  renderStatistics();
  updateDerived();
  await loadInventoriesList();
  if (SELECTED_INV_ID) loadInventoryById(SELECTED_INV_ID);
}

function queueSave(){
  statusEl.textContent = 'Saving...';
  if (SAVE_TIMER) clearTimeout(SAVE_TIMER);
  SAVE_TIMER = setTimeout(saveNow, 350);
}

async function saveNow(){
  try{
    const payload = { name: nameEl.value || '', level: CHAR.level || 1, stats: CHAR.stats, abilities: CHAR.abilities || [], inventory_id: SELECTED_INV_ID || '', sublimations: SUBLIMATIONS };
    const res = await api('/characters/' + encodeURIComponent(CID), {
      method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
    });
    titleEl.textContent = 'Edit: ' + (res.character?.name || '(unnamed)');
    statusEl.textContent = 'Saved at ' + new Date().toLocaleTimeString();
  }catch(err){
    statusEl.textContent = 'Save failed: ' + err.message;
  }
}

/* ------- Abilities: search/add/remove/render ------- */
async function searchAbilities(){
  try{
    const params = [];
    if (abiSearchEl.value) params.push('name='+encodeURIComponent(abiSearchEl.value));
    if (abiFilterTypeEl.value) params.push('typ='+encodeURIComponent(abiFilterTypeEl.value));
    if (abiFilterSrcEl.value) params.push('source='+encodeURIComponent(abiFilterSrcEl.value));
    const qs = params.length ? '?'+params.join('&') : '';
    const res = await api('/abilities'+qs);
    const arr = res.abilities || [];
    renderSearchResults(arr);
  }catch(e){
    abiResultsEl.innerHTML = `<div class="muted">Error: ${e.message}</div>`;
  }
}
abiSearchBtn.addEventListener('click', searchAbilities);
abiSearchEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter') searchAbilities(); });

invLoadBtn.addEventListener('click', ()=> loadInventoryById(invSelectEl.value));
invSelectEl.addEventListener('change', ()=> loadInventoryById(invSelectEl.value));

function renderSearchResults(arr){
  abiResultsEl.innerHTML = '';
  if (!arr.length){ abiResultsEl.innerHTML = '<div class="muted">No results.</div>'; return; }
  for (const a of arr){
    const div = document.createElement('div');
    div.className = 'abi-item';
    div.innerHTML = `
      <div class="grow">
        <div><strong>${a.name}</strong></div>
        <div class="muted" style="font-size:.85rem">${a.description||''}</div>
      </div>
      <span class="tag">${a.type||''}</span>
      <span class="tag">${a.source_category||''}</span>
      <button>Add</button>
    `;
    div.querySelector('button').addEventListener('click', ()=> addAbilityToChar(a.id));
    abiResultsEl.appendChild(div);
  }
}

async function resolveAssignedAbilities(){
  const ids = (CHAR.abilities||[]);
  if (!ids.length){ ASSIGNED = []; return; }
  const uniqueIds = Array.from(new Set(ids));
  const qs = '?ids=' + encodeURIComponent(uniqueIds.join(','));
  const bulk = await api('/abilities/bulk'+qs);
  const byId = {};
  (bulk.abilities||[]).forEach(a=>{ if (a && a.id) byId[a.id] = a; });
  ASSIGNED = ids.map(id=> byId[id]).filter(Boolean); // preserve order and duplicates
}

async function addAbilityToChar(aid){
  if (!Array.isArray(CHAR.abilities)) CHAR.abilities = [];
  CHAR.abilities.push(aid);
  queueSave();
  await resolveAssignedAbilities();
  recomputePassiveAgg();
  renderAbilitiesTab();
  renderStatistics();
  updateDerived();
}

async function removeAbilityFromChar(aid){
  const arr = CHAR.abilities || [];
  const idx = arr.indexOf(aid);
  if (idx >= 0) arr.splice(idx, 1);
  CHAR.abilities = arr;
  queueSave();
  await resolveAssignedAbilities();
  recomputePassiveAgg();
  renderAbilitiesTab();
  renderStatistics();
  updateDerived();
}

function renderAbilitiesBucket(el, list){
  el.innerHTML = '';
  if (!list.length){ el.innerHTML = '<div class="muted">--</div>'; return; }
  for (const a of list){
    const div = document.createElement('div');
    div.className = 'abi-item';
    const isPassive = (a.type||'').toLowerCase()!=='active';
    div.innerHTML = `
      <div class="grow">
        <div><strong>${a.name}</strong></div>
        <div class="muted" style="font-size:.85rem">${isPassive ? (a.passive?.description||a.description||'') : (a.description||'')}</div>
      </div>
      <span class="tag">${a.type||''}</span>
      <span class="tag">${a.source_category||''}</span>
      <button title="Remove">ðŸ—‘</button>
    `;
    div.querySelector('button').addEventListener('click', ()=> removeAbilityFromChar(a.id));
    el.appendChild(div);
  }
}

function renderAbilitiesTab(){
  const docs = ASSIGNED.slice();
  const archetype = docs.filter(a=>(a.source_category||'').toLowerCase()==='archetype');
  const passive   = docs.filter(a=> (a.source_category||'').toLowerCase()!=='archetype' && ((a.type||'').toLowerCase()!=='active'));
  const active    = docs.filter(a=> (a.source_category||'').toLowerCase()!=='archetype' && ((a.type||'').toLowerCase()==='active'));

  renderAbilitiesBucket(listArchetypeEl, archetype);
  renderAbilitiesBucket(listPassiveEl,   passive);
  renderAbilitiesBucket(listActiveEl,    active);
}

/* boot */
checkMe().then(loadCharacter).catch(()=>{ statusEl.textContent='Please log in.'; });
</script>

</body>
</html>

