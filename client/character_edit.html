<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE â€” Edit Character (with Derived)</title>

  <style>
    :root { color-scheme: dark; }
    html,body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    /* centered page like the rest */
    .page { min-height: 100vh; display: grid; place-items: start center; background: #0b0b0b; }
    .wrap { width: 100%; max-width: 980px; padding: 28px 16px; }

    /* chrome */
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .topbar h1 { font-size: 20px; margin: 0; }
    a.btn, button, input { padding:8px 12px; border-radius:10px; border:1px solid #333; background:#121212; color:#f0f0f0; text-decoration:none; }
    a.btn:hover, button:hover { background:#171717; }
    .muted { opacity:.8; font-size:.9rem; }
    .grow { flex: 1 1 auto; }
    .right { margin-left:auto; }

    /* tabs */
    .tabs { display:flex; gap:8px; border-bottom:1px solid #222; margin:16px 0 12px; }
    .tab { padding:10px 14px; border:1px solid #222; border-bottom:none; border-radius:12px 12px 0 0; background:#111; cursor:pointer; }
    .tab.active { background:#191919; font-weight:600; }
    .tabpanes { border:1px solid #222; border-radius:0 14px 14px 14px; background:#141414; padding:16px; }

    /* statistics layout */
    .stats-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); align-items:start; }
    .panel { border:1px solid #2a2a2a; border-radius:14px; overflow:hidden; background:#101010; }
    details.panel > summary { list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; }
    details.panel > summary::-webkit-details-marker { display:none; }
    .pill { font-size:.85rem; opacity:.85; border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; }
    .panel-body { padding:0 14px 14px; }

    .row { display:flex; align-items:center; gap:8px; }
    .row > .grow { flex:1 1 auto; }
    .k { opacity:.85; font-size:.9rem; }
    .num { width:90px; }
    .total { font-weight:600; }
    .hdr { display:flex; align-items:center; gap:10px; }
    .skills { display:grid; gap:8px; margin-top:10px; }
    .skill-line { display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; }
    .skill-total { min-width:48px; text-align:right; font-variant-numeric: tabular-nums; }
    .charac-badge { font-variant-numeric: tabular-nums; }
    .skill-line { display:grid; grid-template-columns: auto 1fr auto auto auto auto; gap:8px; align-items:center; }
    .num { width:90px; }
    .badge { border:1px solid #2f2f2f; border-radius:999px; padding:2px 8px; font-variant-numeric: tabular-nums; }
    .smallmuted { opacity:.75; font-size:.85rem; }

    /* --- alignment fixes for all skill-line blocks --- */
    .skill-line { display:grid; grid-template-columns: 140px 80px 80px 70px 70px 50px; gap:8px; align-items:center; }
    .skill-line.smallmuted { font-size:.85rem; opacity:.75; }
    .skill-line input.num { width:70px; text-align:right; }
    .skill-line .badge, .skill-line .skill-total { text-align:center; font-variant-numeric: tabular-nums; min-width:50px; }
    .skill-line .k { font-size:.9rem; opacity:.85; }

    /* status line */
    .status { margin-top:10px; opacity:.8; }

    /* Derived stats table */
    .derived-grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:6px 8px; align-items:center; }
    .kv .val { justify-self:end; font-variant-numeric: tabular-nums; }

    /* --- Abilities chips + tooltips (added) --- */
    .chip-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #333; border-radius:999px; background:#111; font-size:.9rem; }
    .chip .rm { cursor:pointer; border:none; background:#181818; border-radius:6px; padding:2px 6px; }
    .stat-hover { text-decoration: dotted underline; cursor:help; }
    .tooltip { position:absolute; z-index:9999; max-width:320px; border:1px solid #333; background:#0d0d0d; color:#f5f5f5; border-radius:10px; padding:8px 10px; font-size:.85rem; display:none; box-shadow:0 8px 24px rgba(0,0,0,.4); }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1 id="title">Edit Character</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="characters.html">Back to My Characters</a>
      <a class="btn" href="character_admin.html" id="admin-link" style="display:none">All Characters</a>
    </div>

    <!-- Name card -->
    <div class="panel" style="margin-bottom:12px;">
      <details open class="panel">
        <summary class="hdr">
          <strong>Name</strong>
          <span class="muted">(autosaves)</span>
          <span class="muted status" id="status">Loaded.</span>
        </summary>
        <div class="panel-body">
          <input id="name" placeholder="Enter a name..." class="grow" />
        </div>
      </details>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="tab-stat">Statistic</div>
      <div class="tab" data-tab="tab-inv">Inventory</div>
      <div class="tab" data-tab="tab-abi">Abilities</div>
      <div class="tab" data-tab="tab-com">Combat</div>
      <div class="tab" data-tab="tab-per">Personal</div>
    </div>

    <div class="tabpanes">
      <!-- STATISTICS TAB -->
      <div id="tab-stat" class="tabpane">

        <!-- Level + Derived Stats -->
        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Derived Stats</strong>
              <span class="muted">(auto from Level, Milestones & skills)</span>
              <span class="grow"></span>
              <span class="k">Level</span>
              <input id="level" type="number" class="num" min="1" value="1" />
            </summary>
            <div class="panel-body">
              <div class="derived-grid">
                <div class="kv"><div class="k">HP</div> <div class="val badge stat-hover" id="hp-val" data-target="stats.hp_max">â€”</div></div>
                <div class="kv"><div class="k">EN</div> <div class="val badge stat-hover" id="en-val" data-target="stats.en_max">â€”</div></div>
                <div class="kv"><div class="k">FO</div> <div class="val badge" id="fo-val">â€”</div></div>
                <div class="kv"><div class="k">MO</div> <div class="val badge" id="mo-val">â€”</div></div>
                <div class="kv"><div class="k">SP cap (10% HP)</div> <div class="val badge" id="spcap-val">â€”</div></div>
                <div class="kv"><div class="k">Encumbrance</div> <div class="val badge" id="enc-val">â€”</div></div>
                <div class="kv"><div class="k">Eclipse Threshold (ET)</div> <div class="val badge" id="et-val">â€”</div></div>
                <div class="kv"><div class="k">Max Toxicity (TX)</div> <div class="val badge" id="tx-val">â€”</div></div>
              </div>
            </div>
          </details>
        </div>

        <div class="stats-grid" id="stats-grid"><!-- injected --></div>

        <!-- Intensities (MAG) -->
        <div class="panel" style="margin-top:12px;">
          <details open class="panel">
            <summary class="hdr">
              <strong>Intensities</strong>
              <span class="pill">Linked to MAG</span>
              <span class="muted">(behaves like skills)</span>
              <span class="grow"></span>
              <span class="k">MAG Mod:</span>
              <span id="int-mag-mod" class="pill">+0</span>
            </summary>
            <div class="panel-body">
              <div id="intensities-list" class="skills" style="margin-top:8px"></div>

              <div style="margin-top:14px; border-top:1px solid #222; padding-top:12px;">
                <div class="hdr"><strong>Defense Summary</strong><span class="muted"> (from known natures & IV)</span></div>
                <div id="defense-summary" class="skills" style="margin-top:8px"></div>
                <p class="muted" style="margin-top:8px">
                  N = Neutral, R = âˆ’2 per hit, VR = âˆ’4 per hit, V = +2 per hit, VV = +4 per hit.
                </p>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- Inventory tab placeholder -->
      <div id="tab-inv" class="tabpane" style="display:none;"><p class="muted">Inventory â€” coming next.</p></div>

      <!-- ABILITIES TAB (patched) -->
      <div id="tab-abi" class="tabpane" style="display:none;">
        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr"><strong>Archetype Abilities</strong></summary>
            <div class="panel-body">
              <div class="row" style="gap:6px; align-items:flex-start;">
                <input id="arch-search" class="grow" placeholder="Search catalog (name)â€¦" />
                <button id="arch-add" class="btn" type="button">Add</button>
              </div>
              <div id="arch-list" class="chip-list"></div>
            </div>
          </details>
        </div>

        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr"><strong>Passive Abilities (non-Archetype)</strong></summary>
            <div class="panel-body">
              <div class="row" style="gap:6px; align-items:flex-start;">
                <input id="passive-search" class="grow" placeholder="Search catalog (name)â€¦" />
                <button id="passive-add" class="btn" type="button">Add</button>
              </div>
              <div id="passive-list" class="chip-list"></div>
            </div>
          </details>
        </div>

        <div class="panel" style="margin-bottom:12px;">
          <details open class="panel">
            <summary class="hdr"><strong>Active Abilities (non-Archetype)</strong></summary>
            <div class="panel-body">
              <div class="row" style="gap:6px; align-items:flex-start;">
                <input id="active-search" class="grow" placeholder="Search catalog (name)â€¦" />
                <button id="active-add" class="btn" type="button">Add</button>
              </div>
              <div id="active-list" class="chip-list"></div>
            </div>
          </details>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btn-save-abilities" class="btn" type="button">ðŸ’¾ Save Abilities to Character</button>
          <span id="abilities-status" class="muted" style="margin-left:10px;"></span>
        </div>

        <div id="tooltip" class="tooltip"></div>
      </div>

      <!-- other placeholders -->
      <div id="tab-com" class="tabpane" style="display:none;"><p class="muted">Combat â€” coming next.</p></div>
      <div id="tab-per" class="tabpane" style="display:none;"><p class="muted">Personal â€” coming next.</p></div>
    </div>

  </div></div>

<script>
/* --- auth helper (sends header + keeps cookie) --- */
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){ const t=getToken(); if(t) setCookieToken(t); return t?{'Authorization':'Bearer '+t,'X-Auth-Token':t}:{ }; }
async function api(path,opt={}) {
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
  if(!resp.ok || data.status==='error') throw new Error(data.message || `HTTP ${resp.status}`);
  return data;
}

/* --- tabs --- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target = t.getAttribute('data-tab');
    document.querySelectorAll('.tabpane').forEach(p=>p.style.display = (p.id===target ? '' : 'none'));
  });
});

/* --- constants & helpers for Statistics (unchanged content trimmed for brevity) --- */
const CHARACS = [
  { key:'reflex',     code:'REF', name:'Reflex',     skills:['Technicity','Dodge','Tempo','Reactivity'] },
  { key:'dexterity',  code:'DEX', name:'Dexterity',  skills:['Accuracy','Evasion','Stealth','Acrobatics'] },
  { key:'body',       code:'BOD', name:'Body',       skills:['Brutality','Blocking','Resistance','Athletics'] },
  { key:'willpower',  code:'WIL', name:'Willpower',  skills:['Intimidation','Spirit','Instinct','Absorption'] },
  { key:'magic',      code:'MAG', name:'Magic',      skills:['Aura','Incantation','Enchantment','Restoration','Potential'] },
  { key:'presence',   code:'PRE', name:'Presence',   skills:['Taming','Charm','Charisma','Deception','Persuasion'] },
  { key:'wisdom',     code:'WIS', name:'Wisdom',     skills:['Survival','Education','Perception','Psychology','Investigation'] },
  { key:'tech',       code:'TEC', name:'Tech',       skills:['Crafting','Sleight of hand','Alchemy','Medicine','Engineering'] },
];

const NATURES = ["Fire","Water","Earth","Wind","Lightning","Moon","Sun","Ki"];
const INT_TABLE = [
  { min:1,  max:7,  id:"1d4",  iv:2 },
  { min:8,  max:11, id:"1d6",  iv:3 },
  { min:12, max:15, id:"1d8",  iv:4 },
  { min:16, max:17, id:"1d10", iv:5 },
  { min:18, max:99, id:"1d12", iv:6 },
];

/* --- Abilities integration (added) --- */
let currentCharacterId = null;
let currentCharacter = null;

let archSel = [];
let passiveSel = [];
let activeSel = [];

let _catalog_cache = [];

function getParam(name){
  const url = new URL(location.href);
  return url.searchParams.get(name);
}

async function searchAbilitiesByName(q) {
  const res = await api('/abilities?name=' + encodeURIComponent(q || ''));
  return res.abilities || [];
}

async function loadCatalogCache() {
  const res = await api('/abilities');
  _catalog_cache = res.abilities || [];
}

function renderChipList(el, arr, catalog) {
  el.innerHTML = '';
  arr.forEach(id => {
    const ab = catalog.find(x=>x.id===id);
    const name = ab ? ab.name : id;
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.textContent = name;
    const rm = document.createElement('button');
    rm.className = 'rm';
    rm.textContent = 'âœ•';
    rm.addEventListener('click', ()=> {
      const i = arr.indexOf(id);
      if (i>=0) { arr.splice(i,1); renderAllChipLists(); }
    });
    chip.appendChild(rm);
    el.appendChild(chip);
  });
}

function renderAllChipLists() {
  renderChipList(document.getElementById('arch-list'),    archSel,    _catalog_cache);
  renderChipList(document.getElementById('passive-list'), passiveSel, _catalog_cache);
  renderChipList(document.getElementById('active-list'),  activeSel,  _catalog_cache);
}

document.getElementById('arch-add').addEventListener('click', async ()=>{
  const q = document.getElementById('arch-search').value.trim();
  const arr = await searchAbilitiesByName(q);
  if (!arr.length) return alert('No ability found');
  archSel.push(arr[0].id);
  archSel = [...new Set(archSel)];
  renderAllChipLists();
});
document.getElementById('passive-add').addEventListener('click', async ()=>{
  const q = document.getElementById('passive-search').value.trim();
  const arr = await searchAbilitiesByName(q);
  if (!arr.length) return alert('No ability found');
  passiveSel.push(arr[0].id);
  passiveSel = [...new Set(passiveSel)];
  renderAllChipLists();
});
document.getElementById('active-add').addEventListener('click', async ()=>{
  const q = document.getElementById('active-search').value.trim();
  const arr = await searchAbilitiesByName(q);
  if (!arr.length) return alert('No ability found');
  activeSel.push(arr[0].id);
  activeSel = [...new Set(activeSel)];
  renderAllChipLists();
});

document.getElementById('btn-save-abilities').addEventListener('click', async ()=>{
  const st = document.getElementById('abilities-status');
  if (!currentCharacterId) { st.textContent = 'No character selected.'; return; }
  try {
    st.textContent = 'Savingâ€¦';
    await api('/characters/'+encodeURIComponent(currentCharacterId)+'/abilities', {
      method:'PUT',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ archetype: archSel, passive: passiveSel, active: activeSel })
    });
    st.textContent = 'Saved.';
    await refreshComputedAndApplyTooltips();
  } catch(e){
    st.textContent = 'Error: '+e.message;
  }
});

/* --- tooltips from /characters/{cid}/computed --- */
let _computed_cache = null;

async function refreshComputedAndApplyTooltips(){
  if (!currentCharacterId) return;
  const res = await api('/characters/'+encodeURIComponent(currentCharacterId)+'/computed');
  _computed_cache = res;

  // optional numeric updates if you wish
  const final = res.final || {};
  const hpMax = (((final.stats || {}).hp_max) ?? undefined);
  const enMax = (((final.stats || {}).en_max) ?? undefined);
  const elHp  = document.getElementById('hp-val'); if(elHp && hpMax!==undefined)  elHp.textContent  = hpMax;
  const elEn  = document.getElementById('en-val'); if(elEn && enMax!==undefined)  elEn.textContent  = enMax;

  const tip = document.getElementById('tooltip');
  document.querySelectorAll('.stat-hover').forEach(el=>{
    // remove old listeners (avoid stacking)
    el.onmouseenter = null; el.onmousemove = null; el.onmouseleave = null;

    el.addEventListener('mouseenter', (ev)=>{
      const key = el.getAttribute('data-target');
      const list = (res.breakdown || {})[key] || [];
      if (!list.length) { tip.style.display='none'; return; }
      tip.innerHTML = renderTooltipHtml(key, list);
      positionTooltip(ev, tip);
      tip.style.display='block';
    });
    el.addEventListener('mousemove', (ev)=> positionTooltip(ev, tip));
    el.addEventListener('mouseleave', ()=> { tip.style.display='none'; });
  });
}

function renderTooltipHtml(key, list){
  let html = `<div style="font-weight:600;margin-bottom:6px;">${key}</div>`;
  html += `<div style="opacity:.8;margin-bottom:6px;">Order: set â†’ mul â†’ add</div>`;
  list.forEach(it=>{
    const mode = (it.mode||'add').toLowerCase();
    const v = mode==='mul' ? ('Ã— '+it.value) : (mode==='set' ? ('= '+it.value) : ((it.value>=0?'+':'')+it.value));
    html += `<div style="display:flex;gap:6px;align-items:baseline;">
      <span class="pill" style="border:1px solid #333;padding:1px 6px;border-radius:10px;">${it.origin||''}</span>
      <span style="flex:1 1 auto;">${it.source||'Ability'}</span>
      <span style="opacity:.9;">${v}</span>
    </div>`;
    if (it.note){
      html += `<div style="opacity:.7;margin-left:60px;">${it.note}</div>`;
    }
  });
  return html;
}
function positionTooltip(ev, tip){
  const pad = 14;
  tip.style.left = (ev.pageX + pad) + 'px';
  tip.style.top  = (ev.pageY + pad) + 'px';
}

/* --- initialization for abilities on load --- */
async function loadCharacterAbilities(charId){
  const res = await api('/characters/'+encodeURIComponent(charId));
  currentCharacter = res.character || {};
  const abil = currentCharacter.abilities || {};
  archSel    = (abil.archetype || []).map(x=>x.id);
  passiveSel = (abil.passive   || []).map(x=>x.id);
  activeSel  = (abil.active    || []).map(x=>x.id);

  if (!_catalog_cache.length) await loadCatalogCache();
  renderAllChipLists();
  await refreshComputedAndApplyTooltips();
}

/* --- boot: infer character id from URL so we don't touch your other logic --- */
(async function bootAbilities(){
  try {
    const cid = getParam('id');
    if (!cid) return; // no-op if page wasn't opened with ?id=
    currentCharacterId = cid;
    await loadCharacterAbilities(cid);
  } catch (e) {
    console.warn('Abilities init skipped:', e);
  }
})();
</script>
</body>
</html>