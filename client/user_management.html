<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Management</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="portal.html">← Back Home</a>
    </div>
    <section id="user-mgmt" style="margin-top:1rem; display:none;">
    <h2>User Management</h2>
    <div id="umg-msg" style="color:crimson;"></div>
    <table id="umg-table" border="1" cellspacing="0" cellpadding="6" style="width:100%; margin-top:0.5rem;">
        <thead>
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    </section>
</body>
<script>
(function () {
  const $ = (s) => document.querySelector(s);
  const token =
    localStorage.getItem("auth_token") ||
    localStorage.getItem("noe_token") ||
    localStorage.getItem("token");

  function authHeaders() {
    return token ? { Authorization: "Bearer " + token } : {};
  }

  function requireAdminOrShowMessage(role) {
    if (!token) {
      $("#umg-msg").textContent = "Please log in as an admin.";
      return false;
    }
    // We can trust /admin/users 401/403 too, but this gives instant feedback
    const storedRole =
      localStorage.getItem("auth_role") ||
      localStorage.getItem("role") ||
      role;
    if (storedRole !== "admin") {
      // (Optionally allow moderators if your backend does)
      $("#umg-msg").textContent = "Admin access required.";
      return false;
    }
    return true;
  }

  async function loadUsers() {
    const tbody = $("#umg-table tbody");
    $("#umg-msg").textContent = "";
    tbody.innerHTML = "<tr><td colspan='4'>Loading…</td></tr>";

    try {
      const r = await fetch("/admin/users", { headers: authHeaders() });
      if (r.status === 401 || r.status === 403) {
        $("#umg-msg").textContent = "Not authorized. Please log in as admin.";
        tbody.innerHTML = "";
        return;
      }
      const j = await r.json();
      if (j.status !== "success") {
        $("#umg-msg").textContent = j.message || "Failed to fetch users.";
        tbody.innerHTML = "";
        return;
      }
      const rows = (j.users || []).map(u => {
        const role = u.role || "user";
        const userEsc = (u.username || "").replace(/"/g, '&quot;');
        return `
          <tr data-username="${userEsc}">
            <td>${u.username || ""}</td>
            <td>${u.email || ""}</td>
            <td>${role}</td>
            <td>
              <button class="btn small" data-role="moderator">Make Moderator</button>
              <button class="btn small" data-role="user">Demote to User</button>
              <button class="btn small danger" data-delete="1">Delete</button>
              <button class="btn small" data-reset="1">Reset Password</button>
            </td>
          </tr>`;
      }).join("");
      tbody.innerHTML = rows || "<tr><td colspan='4'>No users.</td></tr>";
    } catch (e) {
      $("#umg-msg").textContent = "Network error.";
      tbody.innerHTML = "";
    }
  }

  async function setRole(username, role) {
    try {
      const r = await fetch(`/admin/users/${encodeURIComponent(username)}/role`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ role })
      });
      if (r.status === 401 || r.status === 403) {
        alert("Not authorized.");
        return;
      }
      const j = await r.json();
      if (j.status !== "success") {
        alert(j.message || "Failed to update role.");
      } else {
        await loadUsers();
      }
    } catch {
      alert("Network error.");
    }
  }

  async function deleteUser(username){
    if (!confirm(`Delete user ${username}? This cannot be undone.`)) return;
    try{
      const r = await fetch(`/admin/users/${encodeURIComponent(username)}`, {
        method:"DELETE",
        headers: { ...authHeaders() }
      });
      const j = await r.json();
      if (j.status !== "success"){ alert(j.message || "Delete failed."); return; }
      await loadUsers();
    }catch{
      alert("Network error.");
    }
  }

  async function resetUserPassword(username){
    try {
      const r = await fetch(`/admin/users/${encodeURIComponent(username)}/reset-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({})
      });
      if (r.status === 401 || r.status === 403) {
        $("#umg-msg").textContent = "Not authorized.";
        return;
      }
      const j = await r.json();
      if (j.status !== "success") {
        $("#umg-msg").textContent = j.message || "Reset failed.";
        return;
      }
      $("#umg-msg").textContent = `Temporary password for ${username}: ${j.temporary_password} (share securely and remind the user to pick a new password).`;
    } catch {
      $("#umg-msg").textContent = "Network error.";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Make the section visible on page load
    const sec = $("#user-mgmt");
    if (sec) sec.style.display = "block";

    // If not admin, show message; still try the request to let backend decide
    requireAdminOrShowMessage();

    // Load users now
    loadUsers();

    // Delegate role button clicks
    $("#user-mgmt").addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-role]");
      const del = ev.target.closest("button[data-delete]");
      const reset = ev.target.closest("button[data-reset]");
      const row = ev.target.closest("tr[data-username]");
      if (!row) return;
      const username = row.getAttribute("data-username");
      if (btn){
        const role = btn.getAttribute("data-role");
        setRole(username, role);
      } else if (del){
        deleteUser(username);
      } else if (reset){
        resetUserPassword(username);
      }
    });
  });
})();
</script>
