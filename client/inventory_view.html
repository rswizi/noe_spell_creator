<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Vertical, comfy layout */
    .stack { display: grid; gap: 18px; grid-template-columns: 1fr; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill{ display:inline-block; border:1px solid #444; border-radius:999px; padding:2px 8px; margin-right:6px }
    .muted{ opacity:.8 }
    .items { display:block; margin-top:8px; }
    .item-row { display:flex; align-items:center; gap:10px; padding:6px 8px; border:1px solid #222; border-radius:10px; margin:6px 0; }
    .item-row .grow { flex:1; min-width:200px; }
    .container-card { padding:10px; border:1px solid #222; border-radius:12px; margin:10px 0; }
    .container-head { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .container-head input[type="text"]{ min-width:180px; }
    .list { border:1px solid #222; border-radius:10px; padding:8px; }
    .searchbar { display:grid; gap:8px; grid-template-columns: 1fr; }
    .search-controls { display:grid; gap:8px; grid-template-columns: 1fr 1fr 1fr 1fr; }
    .purchase-controls { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
    .modal { position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000; padding:16px; }
    .modal.hidden{ display:none; }
    .modal-card { width:min(760px, 96vw); background:#0b0b0b; border:1px solid #222; border-radius:14px; padding:16px; }
    .modal-close { float:right; font-size:22px; border:none; background:transparent; color:#ccc; cursor:pointer; }
    .info-grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); margin:10px 0; }
    .info-grid .cell { border:1px solid #1c2637; border-radius:10px; padding:8px; background:#0c111a; }
    .info-grid .label { font-size:.85rem; opacity:.75; }
    .pill-soft { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:10px; background:#111827; border:1px solid #1f2b3f; }
    .upg-list { display:grid; gap:10px; }
    .upg-row { border:1px solid #1c2637; border-radius:10px; padding:8px; background:#0c111a; }
    .upg-row h4 { margin:0 0 4px; font-size:1rem; }
    .btn-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    @media (min-width: 1100px){
      .container-wide { max-width: 1100px; margin: 0 auto; }
      .searchbar { grid-template-columns: 2fr 1fr; align-items:end; }
    }
  </style>
</head>
<body>
<div class="container container-wide">
  <h1 id="inv-title">Inventory</h1>

  <div class="stack">
    <!-- Inventory Overview -->
    <div class="home-card">
      <h3>Overview</h3>
      <div id="money"></div>
      <div class="row muted">Total Encumbrance: <strong id="enc-total">0</strong></div>

      <!-- Add Funds -->
      <div class="row" style="margin-top:10px;">
        <label class="muted">Add Funds</label>
        <select id="fund-cur" style="min-width:120px;"></select>
        <input id="fund-amt" type="number" step="1" placeholder="Amount" style="width:140px;">
        <input id="fund-note" placeholder="Note (optional)" style="flex:1; min-width:200px;">
        <button id="fund-add" class="btn small">+ Add</button>
      </div>
    </div>

    <!-- Containers + Items -->
    <div class="home-card">
      <h3>Containers & Items</h3>
      <div id="containers"></div>

      <div class="row" style="margin-top:8px;">
        <input id="new-cont-name" placeholder="New container name">
        <button id="add-cont" class="btn small">+ Add Container</button>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="home-card">
      <h3>Recent Transactions</h3>
      <div id="tx" class="list"></div>
    </div>

    <!-- Catalog (add items) -->
    <div class="home-card">
      <h3>Add from Catalog</h3>

      <div class="searchbar">
        <div>
          <div class="row">
            <input id="q" placeholder="Search name…" style="flex:1">
            <button id="search" class="btn small">Search</button>
          </div>
          <div class="search-controls">
            <div>
              <label class="muted">Kind</label>
              <select id="kind">
                <option value="object">Objects</option>
                <option value="weapon">Weapons</option>
                <option value="equipment">Equipment</option>
                <option value="tool">Tools</option>
              </select>
            </div>
            <div>
              <label class="muted">Category</label>
              <select id="cat-select" disabled>
                <option value="__all">All</option>
              </select>
            </div>
            <div>
              <label class="muted">Results</label>
              <select id="limit">
                <option>25</option>
                <option selected>50</option>
                <option>100</option>
              </select>
            </div>
            <div>
              <label class="muted">Price modifier</label>
              <input id="price-mod" type="number" step="0.05" min="0" value="1" style="width:100%;">
            </div>
            <div class="row" style="align-items:end;">
              <button id="clear" class="btn btn-secondary small">Clear</button>
            </div>
          </div>
        </div>

        <div>
          <div class="purchase-controls">
            <div>
              <label class="muted">Container</label>
              <select id="global-cont"></select>
            </div>
            <div>
              <label class="muted">Currency</label>
              <select id="global-cur"></select>
            </div>
          </div>
          <div class="muted" style="margin-top:8px;">Selected container/currency apply to all “Add” actions below.</div>
        </div>
      </div>

      <div id="results" class="list" style="margin-top:8px;"></div>
    </div>

    <div>
      <a class="btn btn-secondary" href="inventory_create.html">← Back</a>
    </div>
  </div>
</div>

<!-- Item Details Modal -->
<div id="item-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="item-title">
  <div class="modal-card">
    <button class="modal-close" id="item-close" aria-label="Close">&times;</button>
    <h2 id="item-title">Item</h2>
    <div id="item-body" class="list" style="margin-top:10px;"></div>

    <!-- Actions for weapons/equipment -->
    <div id="item-actions" style="margin-top:12px;"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization": "Bearer " + token } : {};
const params = new URLSearchParams(location.search);
const invId = params.get("inv");
const isEmbed = params.get("embed") === "1";
const SELF_CONTAINER_ID = "self";

let INV = null;
let LAST_RESULTS = [];
let FILTERED = [];
let PRICE_MOD = 1;

const KIND_PLURAL = { object: "objects", weapon: "weapons", equipment: "equipment", tool: "tools" };
const QUALITIES = ["Adequate","Good","Very Good","Excellent","Legendary","Mythical","Epic","Divine","Unreal"];
const QUALITY_SLOTS = { "Adequate":1,"Good":2,"Very Good":3,"Excellent":4,"Legendary":5,"Mythical":6,"Epic":7,"Divine":8,"Unreal":9 };

function slotsForQuality(q){ return QUALITY_SLOTS[q] || 0; }
function debounce(fn, ms=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }


function broadcastInventoryUpdate(){
  if (!INV) return;
  if (window.parent && window.parent !== window && isEmbed){
    window.parent.postMessage({ type: "inventory-updated", inventory: INV }, location.origin);
  }
}

function applyInventory(inv){
  INV = inv;
  renderInventory();
  populateGlobals();
  broadcastInventoryUpdate();
}

document.addEventListener("DOMContentLoaded", () => {
  loadInventory();
  $("#search").addEventListener("click", doSearch);
  $("#q").addEventListener("keydown", e=>{ if (e.key==="Enter") doSearch(); });
  $("#tag").addEventListener("keydown", e=>{ if (e.key==="Enter") doSearch(); });
  $("#clear").addEventListener("click", clearSearch);
  $("#add-cont").addEventListener("click", addContainer);
  $("#item-close").addEventListener("click", closeItemModal);
  $("#item-modal").addEventListener("click", (e)=>{ if (e.target === $("#item-modal")) closeItemModal(); });
  $("#cat-select").addEventListener("change", applyCategoryFilter);
  $("#fund-add").addEventListener("click", addFunds);
});

async function loadInventory(){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}`, { headers: authHeaders() });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Load failed"); return; }
  applyInventory(j.inventory);
}

function renderInventory(){
  $("#inv-title").textContent = INV.name;

  // money
  const cur = INV.currencies || {};
  $("#money").innerHTML = Object.keys(cur).length
    ? Object.entries(cur).map(([k,v])=>`<span class="pill">${k}: <b>${v}</b></span>`).join(" ")
    : `<span class="muted">No currency set.</span>`;

  // add-funds currency
  const selFund = $("#fund-cur");
  selFund.innerHTML = "";
  const currencies = Object.keys(INV.currencies || {Jelly:0});
  if (!currencies.length) currencies.push("Jelly");
  currencies.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    selFund.appendChild(opt);
  });

  // enc totals
  $("#enc-total").textContent = Number(INV.enc_total || 0).toFixed(1);

  // group items by container
  const grouped = {};
  for (const it of (INV.items || [])){
    const cid = (it.equipped !== false) ? SELF_CONTAINER_ID : (it.container_id || "");
    (grouped[cid] ||= []).push(it);
  }

  // containers
  const box = $("#containers");
  box.innerHTML = "";
  const containers = (INV.containers || []).slice().sort((a,b)=>{
    if (a.id === SELF_CONTAINER_ID) return -1;
    if (b.id === SELF_CONTAINER_ID) return 1;
    return String(a.name||"").localeCompare(String(b.name||""));
  });
  for (const c of containers){
    const items = grouped[c.id] || [];
    const isSelf = c.id === SELF_CONTAINER_ID;
    const card = document.createElement("div");
    card.className = "container-card";

    const head = document.createElement("div");
    head.className = "container-head";
    head.innerHTML = `
      ${isSelf
        ? `<strong>Self (equipped items)</strong>`
        : `<input value="${escapeHtml(c.name)}" data-id="${c.id}" class="cname" type="text">`
      }
      ${isSelf
        ? `<span class="pill">Always included</span>`
        : `<label class="row" style="gap:6px;">
        <input type="checkbox" class="cinc" data-id="${c.id}" ${c.include ? "checked" : ""}>
        include in total
      </label>`
      }
      <span class="pill">enc: <b>${Number(c.enc_total||0).toFixed(1)}</b></span>
      <span class="pill">items: <b>${items.length}</b></span>
      ${isSelf ? "" : `<button class="btn btn-secondary small rename" data-id="${c.id}">Save</button>`}
    `;
    card.appendChild(head);

    // items list for this container
    const list = document.createElement("div");
    list.className = "items";
    if (!items.length){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No items in this container.";
      list.appendChild(empty);
    }else{
      for (const it of items){
        const row = document.createElement("div");
        row.className = "item-row";
        row.title = buildModifierSummary(it) || "";
        const displayName = it.alt_name ? `${escapeHtml(it.alt_name)} <span class="muted">(${escapeHtml(it.name||"Item")})</span>` : escapeHtml(it.name||"Item");
        const totalEnc = (Number(it.enc||0) * Number(it.quantity||1)) || 0;
        const equipped = it.equipped !== false;
        const stowedId = it.stowed_container_id || (it.container_id !== SELF_CONTAINER_ID ? it.container_id : "");

        const info = document.createElement("div");
        info.className = "grow";
        info.innerHTML = `
          <div><b>${displayName}</b></div>
          <div class="muted">x${it.quantity||1} | enc: ${totalEnc.toFixed(1)}</div>
          <div class="muted">${equipped ? '<span class="pill">Equipped</span>' : '<span class="pill" style="background:#331515;border-color:#662222">Unequipped</span>'}</div>
        `;
        const moveTargets = (INV.containers || []).filter(c => c.id !== SELF_CONTAINER_ID);
        const moveWrap = document.createElement("div");
        moveWrap.className = "row";
        moveWrap.style.marginTop = "6px";
        moveWrap.style.gap = "6px";
        const select = document.createElement("select");
        select.className = "move-target";
        select.dataset.id = it.item_id;
        for (const mc of moveTargets){
          const opt = document.createElement("option");
          opt.value = mc.id; opt.textContent = mc.name;
          select.appendChild(opt);
        }
        const preferred = moveTargets.find(mc => mc.id === stowedId);
        if (preferred){ select.value = preferred.id; }
        const moveBtn = document.createElement("button");
        moveBtn.className = "btn small move-btn";
        moveBtn.dataset.id = it.item_id;
        moveBtn.textContent = "Move";
        if (moveTargets.length){
          moveWrap.appendChild(select);
          moveWrap.appendChild(moveBtn);
        }else{
          const hint = document.createElement("div");
          hint.className = "muted";
          hint.textContent = "Add another container to move items.";
          moveWrap.appendChild(hint);
        }
        info.appendChild(moveWrap);

        const toggle = document.createElement("button");
        toggle.className = "btn small";
        if (it.consumable){
          toggle.textContent = "Use";
          toggle.addEventListener("click", async ()=>{
            await useItem(it.item_id);
          });
        }else{
          toggle.textContent = equipped ? "Unequip" : "Equip";
          toggle.addEventListener("click", async ()=>{
            await toggleEquip(it.item_id, !equipped);
          });
        }

        const details = document.createElement("button");
        details.className = "btn small view";
        details.dataset.id = it.item_id;
        details.textContent = "Details";

        row.appendChild(info);
        row.appendChild(toggle);
        row.appendChild(details);
        list.appendChild(row);
      }
    }
    card.appendChild(list);
    box.appendChild(card);
  }

  // save name
  box.querySelectorAll(".rename").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      const name = box.querySelector(`.cname[data-id="${id}"]`).value.trim() || "Container";
      await patchContainer(id, { name });
    });
  });

  // toggle include
  box.querySelectorAll(".cinc").forEach(ch=>{
    ch.addEventListener("change", async ()=>{
      await patchContainer(ch.dataset.id, { include: ch.checked });
    });
  });

  // item details openers
  box.querySelectorAll(".view").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const it = (INV.items || []).find(x => x.item_id === btn.dataset.id);
      if (!it) return;
      openItemModal(it);
    });
  });
  box.querySelectorAll(".move-btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      const sel = box.querySelector(`select.move-target[data-id="${id}"]`);
      const target = sel ? sel.value : "";
      await moveItem(id, target);
    });
  });

  // transactions
  const tx = $("#tx"); tx.innerHTML = "";
  for (const t of (INV.transactions || []).slice(-25).reverse()){
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `<span class="muted">${new Date(t.ts).toLocaleString()}</span> — <b>${t.amount}</b> ${t.currency} — ${escapeHtml(t.note || "")}`;
    tx.appendChild(div);
  }
}

function populateGlobals(){
  // Container selector (global)
  const selC = $("#global-cont");
  selC.innerHTML = "";
  const conts = (INV.containers || []);
  conts.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id; opt.textContent = c.name;
    selC.appendChild(opt);
  });
  const preferred = conts.find(c=>c.id !== SELF_CONTAINER_ID) || conts[0];
  if (preferred){ selC.value = preferred.id; }

  // Currency selector (global)
  const selCur = $("#global-cur");
  selCur.innerHTML = "";
  const currencies = Object.keys(INV.currencies || {Jelly:0});
  if (!currencies.length){ currencies.push("Jelly"); }
  currencies.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    selCur.appendChild(opt);
  });

  // Add-funds currency already populated in renderInventory
}

async function patchContainer(cid, body){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/containers/${encodeURIComponent(cid)}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Update failed"); return; }
  applyInventory(j.inventory);
}

async function addContainer(){
  const name = ($("#new-cont-name").value || "Container").trim();
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/containers`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ name })
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Create failed"); return; }
  $("#new-cont-name").value = "";
  applyInventory(j.inventory);
}

/* ------------- Add Funds ------------- */
async function addFunds(){
  const currency = $("#fund-cur").value || "Jelly";
  const amount = parseInt($("#fund-amt").value || "0", 10);
  const note = ($("#fund-note").value || "Top up").trim();
  if (!amount || amount <= 0){ alert("Enter a positive amount."); return; }
  if (!confirm(`Add +${amount} ${currency} to this inventory?`)) return;

  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/deposit`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ currency, amount, note })
  });
  const j = await r.json();
  if (j.status !== "success"){ alert(j.message || "Deposit failed"); return; }
  $("#fund-amt").value = "";
  $("#fund-note").value = "";
  applyInventory(j.inventory);
}

/* ------------- Catalog search & filter ------------- */

async function doSearch(){
  const q = ($("#q").value || "").trim();
  const tags = ($("#tag").value || "").trim();
  const kind = $("#kind").value;
  const limit = parseInt($("#limit").value || "50", 10);
  PRICE_MOD = parseFloat($("#price-mod").value || "1") || 1;

  const rows = await fetchCatalog(kind, q, limit, tags);
  LAST_RESULTS = rows || [];

  // build category options from results
  buildCategoryOptions(LAST_RESULTS);
  applyCategoryFilter(); // sets FILTERED and renders
}

function getRowCategory(row){
  return row.category || row.subcategory || row.type || "Uncategorized";
}

function buildCategoryOptions(rows){
  const sel = $("#cat-select");
  const set = new Set(rows.map(getRowCategory));
  const cats = ["__all", ...Array.from(set).sort((a,b)=>String(a).localeCompare(String(b)))];

  sel.innerHTML = "";
  for (const c of cats){
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = (c === "__all") ? "All" : c;
    sel.appendChild(opt);
  }
  sel.disabled = rows.length === 0;
  sel.value = "__all";
}

function applyCategoryFilter(){
  const cat = $("#cat-select").value || "__all";
  FILTERED = (cat === "__all")
    ? LAST_RESULTS.slice()
    : LAST_RESULTS.filter(r => getRowCategory(r) === cat);
  renderResults();
}

async function fetchCatalog(kind, q, limit, tags){
  const plural = KIND_PLURAL[kind] || "objects";
  const tryPaths = [
    `/catalog/search?kind=${encodeURIComponent(kind)}&q=${encodeURIComponent(q)}&tags=${encodeURIComponent(tags || "")}&limit=${limit}`,
    `/catalog/${encodeURIComponent(plural)}?q=${encodeURIComponent(q)}&tags=${encodeURIComponent(tags || "")}&limit=${limit}`
  ];
  for (const path of tryPaths){
    try{
      const r = await fetch(path, { headers: authHeaders() });
      const j = await r.json();
      if (j && j.status === "success"){
        const key = (j.objects && "objects") || (j.weapons && "weapons") || (j.equipment && "equipment") || (j.tools && "tools") || "rows";
        const rows = j[key] || j.rows || [];
        return rows.map(x => ({ ...x, __kind: kind }));
      }
    }catch(e){}
  }
  return [];
}

function renderResults(){
  const list = $("#results");
  list.innerHTML = "";

  if (!FILTERED.length){
    list.textContent = "No results.";
    return;
  }

  const globalContainer = $("#global-cont").value;
  const globalCurrency  = $("#global-cur").value || "Jelly";
  const priceMod = PRICE_MOD || 1;

  for (const r of FILTERED){
    const line = document.createElement("div");
    line.className = "row";
    line.style.borderBottom = "1px solid #222";
    line.style.padding = "6px 0";

    const cat = getRowCategory(r);
    const price = (r.price != null) ? `Price: ${r.price}` : "";
    const enc = (r.enc != null) ? `Enc: ${Number(r.enc||0).toFixed(1)}` : "";

    line.innerHTML = `
      <div style="flex:1;min-width:260px;">
        <div><b>${escapeHtml(r.name || r.title || "Item")}</b></div>
        <div class="muted">${escapeHtml(cat)} ${price ? " • "+price : ""} ${enc ? " • "+enc : ""}</div>
      </div>
      <input type="number" min="1" value="1" style="width:90px" class="qty">
      <button class="btn small buy">Add</button>
    `;

    line.querySelector(".buy").addEventListener("click", async ()=>{
      const qty = Math.max(1, parseInt(line.querySelector(".qty").value||"1", 10));
      await buyItem(r.__kind || "object", r.id, qty, globalContainer, globalCurrency, priceMod);
    });

    list.appendChild(line);
  }
}

function clearSearch(){
  $("#q").value = "";
  $("#tag").value = "";
  LAST_RESULTS = [];
  FILTERED = [];
  buildCategoryOptions([]);
  renderResults();
}

/* ------------- Purchase ------------- */

async function buyItem(kind, ref_id, quantity, container_id, currency, price_modifier=1){
  const payload = { kind, ref_id, quantity, container_id, currency, price_modifier };
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/purchase`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Purchase failed"); return; }
  applyInventory(j.inventory);
}


async function moveItem(item_id, container_id){
  if (!container_id){ alert("Pick a target container."); return; }
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ container_id })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Move failed"); return; }
  applyInventory(j.inventory);
}

async function toggleEquip(item_id, equipped){
    const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ equipped })
  });
    const j = await r.json().catch(()=>({}));
    if (j.status !== "success"){ alert(j.message || "Update failed"); return; }
    applyInventory(j.inventory);
  }

function alchemyTierFromPrice(price){
  const ladder = [ [10000,6],[2000,5],[1000,4],[200,3],[100,2],[50,1] ];
  let tier = 1;
  const p = Number(price||0);
  for (const [min,t] of ladder){
    if (p >= min){ tier = t; break; }
  }
  return tier;
}

async function useItem(item_id){
  const currency = $("#global-cur").value || "Jelly";
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/use`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ currency })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Use failed"); return; }
  applyInventory(j.inventory);
}

async function refillAlchemy(item_id){
  const currency = $("#global-cur").value || "Jelly";
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/refill_alchemy`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ currency })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Refill failed"); return; }
  applyInventory(j.inventory);
}

async function sellItem(item_id, price){
  const currency = $("#global-cur").value || "Jelly";
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/sell`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ price, currency })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Sell failed"); return; }
  applyInventory(j.inventory);
}

async function disposeItem(item_id){
  const currency = $("#global-cur").value || "Jelly";
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/dispose`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ currency })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Dispose failed"); return; }
  applyInventory(j.inventory);
}

/* ------- Item Details Modal (incl. upgrades/quality/alt name) ------- */
function openItemModal(it){
  const equipped = it.equipped !== false;
  const qty = Number(it.quantity || 1);
  const encUnit = Number(it.enc || 0);
  const encTotal = encUnit * qty;
  const paidUnit = Number(it.paid_unit ?? it.base_price ?? 0) || 0;
  const totalPaid = paidUnit * qty;

  const titleText = it.alt_name ? `${it.alt_name} (${it.name || "Item"})` : (it.name || "Item");
  $("#item-title").textContent = titleText;
  const body = $("#item-body");
  body.innerHTML = "";
  const actions = $("#item-actions");
  actions.innerHTML = "";

  const nameRow = document.createElement("div");
  nameRow.className = "row";
  nameRow.style.gap = "6px";
  const nameInput = document.createElement("input");
  nameInput.placeholder = "Display name (sets alt name)";
  nameInput.value = it.alt_name || it.name || "";
  nameInput.style.flex = "1";
  const commitName = debounce(async ()=>{ await saveAltName(it.item_id, nameInput.value || ""); }, 500);
  nameInput.addEventListener("input", commitName);
  nameInput.addEventListener("blur", ()=>commitName());
  nameRow.appendChild(nameInput);
  body.appendChild(nameRow);

  const info = document.createElement("div");
  info.className = "info-grid";
  const totalPrice = Number.isFinite(totalPaid) ? totalPaid : 0;
  const cells = [
    { label: "Type", value: it.kind || "object" },
    { label: "Quality", value: it.quality || "—" },
    { label: "Enc (unit)", value: encUnit.toFixed(1) },
    { label: "Enc (total)", value: encTotal.toFixed(1) },
    { label: "Quantity", value: qty },
    { label: "Total price", value: totalPrice.toFixed(0) }
  ];
  cells.forEach(c=>{
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.innerHTML = `<div class="label">${escapeHtml(c.label)}</div><div><strong>${escapeHtml(c.value)}</strong></div>`;
    info.appendChild(cell);
  });
  body.appendChild(info);

  const modLine = buildModifierSummary(it);
  if (modLine){
    const mods = document.createElement("div");
    mods.className = "muted";
    mods.textContent = `Applies: ${modLine}`;
    body.appendChild(mods);
  }

  if (it.kind === "weapon" || it.kind === "equipment"){
    const upSection = document.createElement("div");
    upSection.className = "list";
    upSection.style.marginTop = "10px";

    const capLabel = `${(it.upgrades || []).length} / ${slotsForQuality(it.quality) || 0}`;
    const upHead = document.createElement("div");
    upHead.className = "row";
    upHead.style.alignItems = "center";
    upHead.style.gap = "10px";
    upHead.innerHTML = `<h3 style="margin:0;">Upgrades</h3><span class="pill-soft">${capLabel}</span>`;
    upSection.appendChild(upHead);

    const installRow = document.createElement("div");
    installRow.className = "row";
    installRow.style.gap = "8px";
    const ulabel = document.createElement("label"); ulabel.className = "muted"; ulabel.textContent = "Install upgrade";
    const uselect = document.createElement("select"); uselect.id = "up-select";
    uselect.innerHTML = '<option value="">-- select upgrade --</option>';
    const ubtn = document.createElement("button"); ubtn.className = "btn small"; ubtn.textContent = "Install";
    installRow.appendChild(ulabel); installRow.appendChild(uselect); installRow.appendChild(ubtn);
    upSection.appendChild(installRow);

    loadUpgradeOptions(ulabel, uselect, it);
    ubtn.addEventListener("click", async ()=>{
      const sel = uselect.value;
      if (!sel){ alert("Select an upgrade first."); return; }
      let target = "";
      const meta = (window.UPGRADE_META || {})[sel];
      if (meta && Array.isArray(meta.targets) && meta.targets.length){
        const choice = prompt(`Select target for ${meta.name || "upgrade"} (${meta.targets.join(", ")})`, meta.targets[0]);
        if (!choice || !meta.targets.includes(choice)){ alert("Invalid target."); return; }
        const existing = (it.upgrades || []).filter(u=>u.target===choice).length;
        if (existing >= 2){ alert("Target already has two upgrades."); return; }
        target = choice;
      }
      await installUpgrade(it.item_id, sel, target);
      closeItemModal();
    });

    const upList = document.createElement("div");
    upList.className = "upg-list";
    const ups = it.upgrades || [];
    if (!ups.length){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No upgrades installed.";
      upList.appendChild(empty);
    }else{
      ups.forEach(u=>{
        const meta = (window.UPGRADE_META || {})[u.id] || {};
        const title = meta.name || u.name || u.id || "Upgrade";
        const desc = u.description_html || u.description || meta.description_html || meta.description || "";

        const row = document.createElement("div");
        row.className = "upg-row";

        const head = document.createElement("div");
        head.className = "row";
        head.style.justifyContent = "space-between";
        head.style.alignItems = "center";
        head.innerHTML = `<h4 style="margin:0;">${escapeHtml(title)}</h4>${u.target ? `<span class="pill-soft">Target: ${escapeHtml(u.target)}</span>` : ""}`;
        row.appendChild(head);

        if (desc){
          const dd = document.createElement("div");
          dd.className = "muted";
          dd.innerHTML = desc;
          row.appendChild(dd);
        }

        const btns = document.createElement("div");
        btns.className = "btn-row";
        const rem = document.createElement("button");
        rem.className = "btn btn-secondary small";
        rem.textContent = "Remove";
        rem.addEventListener("click", async ()=>{
          await removeUpgrade(it.item_id, u.id, u.target || "");
          closeItemModal();
        });
        const edit = document.createElement("button");
        edit.className = "btn small";
        edit.textContent = "Edit";
        edit.addEventListener("click", ()=>{ window.open(`upgrades_home.html?id=${encodeURIComponent(u.id)}`, "_blank"); });
        btns.appendChild(rem);
        btns.appendChild(edit);
        row.appendChild(btns);
        upList.appendChild(row);
      });
    }

    upSection.appendChild(upList);
    body.appendChild(upSection);
  }

  const btnRow = document.createElement("div");
  btnRow.className = "btn-row";

  const equipBtn = document.createElement("button");
  equipBtn.className = "btn small";
  equipBtn.textContent = equipped ? "Unequip" : "Equip";
  equipBtn.addEventListener("click", async ()=>{
    await toggleEquip(it.item_id, !equipped);
    closeItemModal();
  });
  btnRow.appendChild(equipBtn);

  const moveWrap = document.createElement("div");
  moveWrap.className = "row";
  moveWrap.style.gap = "6px";
  const moveSel = document.createElement("select");
  const stowedId = it.stowed_container_id || (it.container_id !== SELF_CONTAINER_ID ? it.container_id : "");
  (INV.containers || []).filter(c=>c.id !== SELF_CONTAINER_ID).forEach(c=>{
    const o = document.createElement("option");
    o.value = c.id; o.textContent = c.name;
    moveSel.appendChild(o);
  });
  if (stowedId){ moveSel.value = stowedId; }
  const moveBtn = document.createElement("button");
  moveBtn.className = "btn small";
  moveBtn.textContent = "Move";
  if (!moveSel.children.length){
    moveSel.disabled = true;
    moveBtn.disabled = true;
    moveBtn.title = "Add another container to move items.";
  }
  moveBtn.addEventListener("click", async ()=>{
    await moveItem(it.item_id, moveSel.value || "");
    closeItemModal();
  });
  moveWrap.appendChild(moveSel);
  moveWrap.appendChild(moveBtn);
  btnRow.appendChild(moveWrap);

  const sellBtn = document.createElement("button");
  sellBtn.className = "btn small";
  sellBtn.textContent = "Sell";
  sellBtn.addEventListener("click", async ()=>{
    const fallback = Number(it.base_price ?? it.paid_unit ?? 0) || 0;
    const ask = prompt("Sell price per unit (blank to cancel)", fallback);
    if (ask === null) return;
    const price = Number(ask);
    if (!Number.isFinite(price) || price < 0){ alert("Enter a valid price."); return; }
    await sellItem(it.item_id, price);
    closeItemModal();
  });
  btnRow.appendChild(sellBtn);

  const disposeBtn = document.createElement("button");
  disposeBtn.className = "btn btn-secondary small";
  disposeBtn.textContent = "Dispose";
  disposeBtn.addEventListener("click", async ()=>{
    if (!confirm("Dispose this item? This removes it with no revenue.")) return;
    await disposeItem(it.item_id);
    closeItemModal();
  });
  btnRow.appendChild(disposeBtn);

  const qBtn = document.createElement("button");
  qBtn.className = "btn small";
  qBtn.textContent = "Improve Quality";
  qBtn.addEventListener("click", async ()=>{
    const to = prompt("Upgrade quality to", it.quality || QUALITIES[0]);
    if (!to || to === it.quality) return;
    if (!QUALITIES.includes(to)){ alert("Enter a valid quality name."); return; }
    await upgradeQuality(it.item_id, to);
    closeItemModal();
  });
  btnRow.appendChild(qBtn);

  actions.appendChild(btnRow);

  if (it.consumable){
    const useRow = document.createElement("div");
    useRow.className = "btn-row";
    const useBtn = document.createElement("button");
    useBtn.className = "btn small";
    useBtn.textContent = "Use";
    if ((Number(it.quantity)||0) <= 0) useBtn.disabled = true;
    useBtn.addEventListener("click", async ()=>{
      await useItem(it.item_id);
      closeItemModal();
    });
    useRow.appendChild(useBtn);
    actions.appendChild(useRow);
  }

  if (it.alchemy_tool){
    const tier = alchemyTierFromPrice(it.base_price);
    const cost = 50 * tier;
    const refillRow = document.createElement("div");
    refillRow.className = "btn-row";
    const refillBtn = document.createElement("button");
    refillBtn.className = "btn small";
    refillBtn.textContent = `Refill (+1, ${cost} Jelly)`;
    refillBtn.addEventListener("click", async ()=>{
      await refillAlchemy(it.item_id);
      closeItemModal();
    });
    refillRow.appendChild(refillBtn);
    actions.appendChild(refillRow);
  }

  $("#item-modal").classList.remove("hidden");
}


function closeItemModal(){
  $("#item-modal").classList.add("hidden");
}

/* ------- Item actions API ------- */
async function saveAltName(item_id, alt_name){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ alt_name })
  });
  const j = await r.json();
  if (j.status !== "success"){ alert(j.message || "Save failed"); return; }
  applyInventory(j.inventory);
}

async function upgradeQuality(item_id, to){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/upgrade_quality`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ to })
  });
  const j = await r.json();
  if (j.status !== "success"){ alert(j.message || "Upgrade failed"); return; }
  closeItemModal();
  applyInventory(j.inventory);
}

async function installUpgrade(item_id, upgrade, targetOverride=""){
  const meta = (window.UPGRADE_META || {})[upgrade] || null;
  let target = targetOverride || "";
  if (!target && meta && Array.isArray(meta.targets) && meta.targets.length){
    const counts = {};
    const current = (INV?.items || []).find(i=>i.item_id===item_id);
    const existing = current?.upgrades || [];
    existing.forEach(u=>{ if(u.target){ counts[u.target]=(counts[u.target]||0)+1; } });
    const options = meta.targets.map(t=>`${t} (${counts[t]||0}/2)`).join(", ");
    const choice = prompt(`Select target for ${meta.name || "upgrade"} [${options}]`, meta.targets[0]);
    if (!choice) return;
    if (!meta.targets.includes(choice)){
      alert("Invalid target."); return;
    }
    if ((counts[choice]||0) >= 2){
      alert("Target already has two upgrades."); return;
    }
    target = choice;
  }
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/install_upgrade`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ upgrade_id: upgrade, target })
  });
  const j = await r.json();
  if (j.status !== "success"){ alert(j.message || "Install failed"); return; }
  closeItemModal();
  applyInventory(j.inventory);
}

async function removeUpgrade(item_id, upgrade_id, target=""){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/items/${encodeURIComponent(item_id)}/remove_upgrade`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ upgrade_id, target })
  });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ alert(j.message || "Remove failed"); return; }
  applyInventory(j.inventory);
}

async function fetchUpgrades(kind, slot){
  const qs = [];
  if (kind) qs.push(`kind=${encodeURIComponent(kind)}`);
  if (slot) qs.push(`slot=${encodeURIComponent(slot)}`);
  const url = `/upgrades${qs.length ? '?'+qs.join('&') : ''}`;
  const r = await fetch(url, { headers: { ...authHeaders() } });
  const j = await r.json();
  if (j.status !== "success") throw new Error(j.message || "Load upgrades failed");
  const ups = j.upgrades || [];
  window.UPGRADE_META = window.UPGRADE_META || {};
  ups.forEach(u=>{ window.UPGRADE_META[u.id] = u; });
  return ups;
}

async function loadUpgradeOptions(labelEl, selectEl, it){
  if (!labelEl || !selectEl) return;
  labelEl.textContent = "Install upgrade (loading...)";
  selectEl.innerHTML = "";
  try{
    const slot = it.equipment_slot || it.slot || "";
    const ups = await fetchUpgrades(it.kind, slot);
    if (!ups.length){
      labelEl.textContent = "Install upgrade (none available)";
      const o = document.createElement("option");
      o.textContent = "-- none --";
      selectEl.appendChild(o);
      return;
    }
    labelEl.textContent = "Install upgrade";
    selectEl.innerHTML = '<option value=\"\">-- select upgrade --</option>';
    ups.forEach(u=>{
      const o = document.createElement("option");
      o.value = u.id;
      const ttxt = (u.targets && u.targets.length) ? ` · target: ${u.targets.join("/")}` : "";
      const excl = u.exclusive_group ? ` · excl:${u.exclusive_group}` : "";
      o.textContent = `${u.name}${u.slot ? ` (${u.slot})` : ""}${ttxt}${excl}`;
      selectEl.appendChild(o);
    });
  }catch(e){
    labelEl.textContent = "Install upgrade (error)";
    const o = document.createElement("option");
    o.textContent = "Error loading upgrades";
    selectEl.appendChild(o);
  }
}

/* ------- utils ------- */
function buildModifierSummary(it){
  const out = [];
  const mods = Array.isArray(it?.modifiers) ? it.modifiers : [];
  mods.forEach(m=>{
    const mode = m.mode || "add";
    const val = m.value ?? "";
    const tgt = m.target || "";
    out.push(`${mode} ${val}${tgt ? " -> " + tgt : ""}`);
  });
  const ups = Array.isArray(it?.upgrades) ? it.upgrades : [];
  ups.forEach(u=>{
    const pool = Array.isArray(u.holder_modifiers) && u.holder_modifiers.length
      ? u.holder_modifiers
      : (Array.isArray(u.modifiers) ? u.modifiers : []);
    pool.forEach(m=>{
      const mode = m.mode || "add";
      const val = m.value ?? "";
      const tgt = m.target || "";
      out.push(`${mode} ${val}${tgt ? " -> " + tgt : ""}`);
    });
  });
  return out.join(", ");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }
</script>
</body>
</html>

