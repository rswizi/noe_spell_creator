<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;border:1px solid #444;border-radius:999px;padding:2px 8px;margin-right:6px}
    .list{max-height:58vh;overflow:auto;border:1px solid #222;border-radius:10px;padding:8px}
    .muted{opacity:.8}
  </style>
</head>
<body>
<div class="container">
  <h1 id="inv-title">Inventory</h1>

  <div class="grid">
    <!-- LEFT: Inventory info -->
    <div class="home-card">
      <h3>Overview</h3>
      <div id="money"></div>
      <div class="row muted">Total Encumbrance: <strong id="enc-total">0</strong></div>

      <h3 style="margin-top:10px;">Containers</h3>
      <div id="containers"></div>
      <div class="row" style="margin-top:8px;">
        <input id="new-cont-name" placeholder="New container name">
        <button id="add-cont" class="btn small">+ Add Container</button>
      </div>

      <h3 style="margin-top:10px;">Recent Transactions</h3>
      <div id="tx" class="list"></div>
    </div>

    <!-- RIGHT: Catalog -->
    <div class="home-card">
      <h3>Add from Objects DB</h3>
      <div class="row">
        <input id="q" placeholder="Search objects…" style="flex:1">
        <button id="search" class="btn small">Search</button>
      </div>
      <div id="results" class="list" style="margin-top:8px;"></div>
    </div>
  </div>

  <div style="margin-top:16px;">
    <a class="btn btn-secondary" href="inventory_create.html">← Back</a>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization": "Bearer " + token } : {};
const invId = new URLSearchParams(location.search).get("inv");

let INV = null;

async function loadInventory(){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}`, { headers: authHeaders() });
  const j = await r.json();
  if (j.status !== "success") throw new Error(j.message || "Load failed");
  INV = j.inventory;
  renderInventory();
}

function renderInventory(){
  $("#inv-title").textContent = INV.name;

  // money
  const cur = INV.currencies || {};
  $("#money").innerHTML = Object.keys(cur).length
    ? Object.entries(cur).map(([k,v])=>`<span class="pill">${k}: <b>${v}</b></span>`).join(" ")
    : `<span class="muted">No currency set.</span>`;

  // enc totals
  $("#enc-total").textContent = Number(INV.enc_total || 0).toFixed(1);

  // containers
  const box = $("#containers");
  box.innerHTML = "";
  for (const c of (INV.containers || [])){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input value="${c.name}" data-id="${c.id}" class="cname">
      <label class="row"><input type="checkbox" class="cinc" data-id="${c.id}" ${c.include ? "checked" : ""}> include in total</label>
      <span class="muted">enc: <b>${Number(c.enc_total||0).toFixed(1)}</b></span>
      <button class="btn btn-secondary small rename" data-id="${c.id}">Save</button>
    `;
    box.appendChild(row);
  }
  // save name
  box.querySelectorAll(".rename").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      const name = box.querySelector(`.cname[data-id="${id}"]`).value.trim() || "Container";
      await patchContainer(id, { name });
    });
  });
  // toggle include
  box.querySelectorAll(".cinc").forEach(ch=>{
    ch.addEventListener("change", async ()=>{
      await patchContainer(ch.dataset.id, { include: ch.checked });
    });
  });

  // tx
  const tx = $("#tx"); tx.innerHTML = "";
  for (const t of (INV.transactions || []).slice(-25).reverse()){
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `<span class="muted">${new Date(t.ts).toLocaleString()}</span> — <b>${t.amount}</b> ${t.currency} — ${t.note || ""}`;
    tx.appendChild(div);
  }
}

async function patchContainer(cid, body){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/containers/${encodeURIComponent(cid)}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Update failed"); return; }
  INV = j.inventory;
  renderInventory();
}

$("#add-cont").addEventListener("click", async ()=>{
  const name = ($("#new-cont-name").value || "Container").trim();
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/containers`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ name })
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Create failed"); return; }
  INV = j.inventory;
  $("#new-cont-name").value = "";
  renderInventory();
});

// search objects
$("#search").addEventListener("click", search);
$("#q").addEventListener("keydown", e=>{ if (e.key==="Enter") search(); });

async function search(){
  const q = ($("#q").value || "").trim();
  const r = await fetch(`/catalog/objects?q=${encodeURIComponent(q)}`, { headers: authHeaders() });
  const j = await r.json();
  const list = $("#results");
  list.innerHTML = "";
  const rows = (j && j.objects) || [];
  if (!rows.length){ list.textContent = "No results."; return; }

  for (const o of rows){
    const line = document.createElement("div");
    line.className = "row";
    line.style.borderBottom = "1px solid #222";
    line.style.padding = "6px 0";
    line.innerHTML = `
      <div style="flex:1;min-width:200px;">
        <div><b>${o.name}</b></div>
        <div class="muted">Price: ${o.price ?? 0} — Enc: ${Number(o.enc||0).toFixed(1)}</div>
      </div>
      <input type="number" min="1" value="1" style="width:80px" class="qty">
      <select class="cont"></select>
      <select class="cur"></select>
      <button class="btn small buy">Add</button>
    `;
    // populate containers + currencies for each row
    const selC = line.querySelector(".cont");
    (INV.containers || []).forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id; opt.textContent = c.name;
      selC.appendChild(opt);
    });
    const selCur = line.querySelector(".cur");
    Object.keys(INV.currencies || {Jelly:0}).forEach(k=>{
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = k;
      selCur.appendChild(opt);
    });

    line.querySelector(".buy").addEventListener("click", async ()=>{
      const qty = Math.max(1, parseInt(line.querySelector(".qty").value||"1", 10));
      const container_id = selC.value;
      const currency = selCur.value || "Jelly";
      await buyObject(o.id, qty, container_id, currency);
    });

    $("#results").appendChild(line);
  }
}

async function buyObject(ref_id, quantity, container_id, currency){
  const r = await fetch(`/inventories/${encodeURIComponent(invId)}/purchase`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ kind: "object", ref_id, quantity, container_id, currency })
  });
  const j = await r.json();
  if (j.status !== "success") { alert(j.message || "Purchase failed"); return; }
  INV = j.inventory;
  renderInventory();
}

document.addEventListener("DOMContentLoaded", loadInventory);
</script>
</body>
</html>