<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NoE — Browse Schools (Admin)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .hero{font-size:2rem;margin:12px 0 4px}
    .sub{opacity:.85}
    .card{border:1px solid #333;border-radius:14px;padding:16px;background:#0c0c0c}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid #222;padding:10px;text-align:left}
    .chip{border:1px solid #444;border-radius:12px;padding:1px 8px;margin-right:6px;display:inline-block}
    .modal, .modal-backdrop { display: none; }
    .modal.open, .modal-backdrop.open { display: block; }
    .grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width: 920px){ .grid-2{grid-template-columns:1fr} }
    .fieldset{border:1px solid #2a2a2a;border-radius:10px;padding:10px}
    .fieldset legend{opacity:.85;font-size:.95rem;padding:0 6px}
    .checks{display:grid;grid-template-columns:repeat(4, minmax(120px,1fr));gap:8px}
    @media (max-width: 700px){ .checks{grid-template-columns:repeat(2, minmax(120px,1fr));} }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>NoE Manager</h1>
    <div class="auth-inline">
      <div id="user-chip" class="user-chip">
        <span class="chip-name" id="chip-name"></span>
        <button id="chip-logout" class="btn linklike">Log Out</button>
      </div>
      <button id="open-login" class="btn btn-secondary small">Log In</button>
      <a class="btn btn-secondary small" href="home.html">Back to Spell Manager</a>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">Browse Schools</div>
    <div class="sub">Moderator tools for editing school metadata, including linked skill & intensities.</div>

    <!-- Gate -->
    <div id="auth-gate" class="card" style="display:none;margin-top:12px;">
      <div class="danger"><strong>Unauthorized.</strong> You must be logged in as a moderator or admin.</div>
      <div style="margin-top:8px;"><a class="btn" href="home.html">Log In</a></div>
    </div>

    <div id="content" class="card" style="display:none;margin-top:12px;">
      <div class="row">
        <input id="q" type="text" placeholder="Search by school name…" style="min-width:220px;">
        <button class="btn" id="search">Search</button>
        <span class="spacer"></span>
        <span id="count" class="sub"></span>
        <span id="status" class="sub"></span>
      </div>

      <table class="table" id="t">
        <thead>
          <tr>
            <th style="width:24%">School</th>
            <th style="width:20%">Linked Skill</th>
            <th>Linked Intensities</th>
            <th style="width:20%">Type / Range / AoE</th>
            <th style="width:12%"></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="sub">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <header>
        <div class="modal-title">Log In</div>
        <button class="modal-close" id="close-login" aria-label="Close">✕</button>
      </header>
      <label>Username</label><input id="login-username" type="text">
      <label style="margin-top:8px;">Password</label><input id="login-password" type="password">
      <div id="login-status" class="sub" style="margin-top:8px;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancel-login">Cancel</button>
        <button class="btn" id="login-btn">Log In</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="edit-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" style="max-width:900px;">
      <header>
        <div class="modal-title">Edit School</div>
        <button class="modal-close" id="edit-close" aria-label="Close">✕</button>
      </header>

      <div class="grid-2">
        <div class="fieldset">
          <legend>Basics</legend>
          <label>Name</label>
          <input id="f-name" type="text">
          <div class="row" style="margin-top:8px;">
            <div>
              <label>Type</label>
              <input id="f-type" type="text" placeholder="Simple / …">
            </div>
            <div>
              <label>Range Type</label>
              <input id="f-range" type="text" placeholder="A/B/C">
            </div>
            <div>
              <label>AoE Type</label>
              <input id="f-aoe" type="text" placeholder="A/B/C">
            </div>
            <div style="display:flex;align-items:end;gap:8px;">
              <input id="f-upgrade" type="checkbox"><label for="f-upgrade" style="margin:0;">Upgrade</label>
            </div>
          </div>
        </div>

        <div class="fieldset">
          <legend>Links for MS (Spell List Manager)</legend>
          <label>Linked Skill</label>
          <select id="f-skill">
            <option value="">— none —</option>
            <option value="aura">Aura</option>
            <option value="incantation">Incantation</option>
            <option value="enchantement">Enchantement</option>
            <option value="potential">Potential</option>
            <option value="restoration">Restoration</option>
            <option value="stealth">Stealth</option>
            <option value="investigation">Investigation</option>
            <option value="charm">Charm</option>
            <option value="intimidation">Intimidation</option>
          
            <option value="absorption">Absorption</option>
            <option value="spirit">Spirit</option>
          </select>

          <label style="margin-top:8px;">Linked Intensities</label>
          <div class="checks">
            <label><input type="checkbox" name="ints" value="fire"> Fire</label>
            <label><input type="checkbox" name="ints" value="water"> Water</label>
            <label><input type="checkbox" name="ints" value="wind"> Wind</label>
            <label><input type="checkbox" name="ints" value="earth"> Earth</label>
            <label><input type="checkbox" name="ints" value="sun"> Sun</label>
            <label><input type="checkbox" name="ints" value="moon"> Moon</label>
            <label><input type="checkbox" name="ints" value="lightning"> Lightning</label>
            <label><input type="checkbox" name="ints" value="ki"> Ki</label>
          </div>
          <div class="hint" style="margin-top:6px;">Used to compute MS: take your linked skill total and add the better of (highest linked nature) vs (second-highest linked nature + MAG).</div>
        </div>
      </div>

      <div id="edit-status" class="sub" style="margin-top:8px;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="edit-cancel">Cancel</button>
        <button class="btn" id="edit-save">Save</button>
      </div>

      <pre id="patch" style="margin-top:12px;max-height:220px;overflow:auto;border:1px solid #222;padding:10px;border-radius:10px;display:none;"></pre>
    </div>
  </div>

  <script>
    const API_BASE = ""; // set "/api" if you serve behind a prefix
    let token = localStorage.getItem("auth_token") || "";
    const $ = (s)=>document.querySelector(s);
    const statusEl = document.getElementById("status");

    function isAdmin(){
      return (localStorage.getItem("auth_role") || "") === "admin";
    }

    // ---------- auth ----------
    async function me(){
      if(!token) return {ok:false};
      const r = await fetch(`${API_BASE}/auth/me`, {headers:{Authorization:`Bearer ${token}`}});
      const j = await r.json();
      return (j && j.status==="success") ? {ok:true,user:j} : {ok:false};
    }
    function setIn(u){
      $("#chip-name").textContent = `${u.username} (${u.role})`;
      $("#user-chip").style.display = "flex";
      $("#open-login").style.display = "none";
    }
    function setOut(){
      $("#user-chip").style.display = "none";
      $("#open-login").style.display = "inline-block";
    }
    async function logout(){
      if(token) await fetch(`${API_BASE}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${token}`}});
      localStorage.clear(); token=""; setOut();
      $("#content").style.display="none"; $("#auth-gate").style.display="block";
    }
    document.getElementById("chip-logout").onclick = (e)=>{e.preventDefault();logout();};

    // login modal
    const loginModal = document.getElementById("login-modal");
    const loginBackdrop = document.getElementById("login-backdrop");
    function openLogin(){loginModal.classList.add("open");loginBackdrop.classList.add("open");}
    function closeLogin(){loginModal.classList.remove("open");loginBackdrop.classList.remove("open");$("#login-status").textContent="";}
    document.getElementById("open-login").onclick=(e)=>{e.preventDefault();openLogin();};
    document.getElementById("close-login").onclick=(e)=>{e.preventDefault();closeLogin();};
    document.getElementById("cancel-login").onclick=(e)=>{e.preventDefault();closeLogin();};
    document.getElementById("login-backdrop").onclick=closeLogin;
    document.getElementById("login-btn").onclick=async(e)=>{
      e.preventDefault();
      const username = $("#login-username").value.trim();
      const password = $("#login-password").value;
      const r = await fetch(`${API_BASE}/auth/login`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
      const j = await r.json();
      if(j.status==="success"){ localStorage.setItem("auth_token", j.token); localStorage.setItem("auth_role", j.role); token=j.token; setIn(j); closeLogin(); init(); }
      else $("#login-status").textContent = j.message || "Login failed";
    };

    // ---------- data ----------
    let SCHOOLS = [];
    async function fetchSchools(q=""){
      const url = new URL(`${API_BASE}/admin/schools`, location.origin);
      if(q) url.searchParams.set("name", q);
      const r = await fetch(url.toString().replace(location.origin,""), {headers:{Authorization:`Bearer ${token}`}});
      if(r.status===401 || r.status===403) throw new Error("Unauthorized");
      const j = await r.json();
      return j.schools || [];
    }

    function renderRows(){
      const tb = $("#tbody"); tb.innerHTML="";
      if(!SCHOOLS.length){ tb.innerHTML='<tr><td colspan="5" class="sub">No schools.</td></tr>'; $("#count").textContent=""; return; }
      $("#count").textContent = `${SCHOOLS.length} result(s)`;
      for(const s of SCHOOLS){
        const tr = document.createElement("tr");
        const ints = (s.linked_intensities||[]).map(x=>`<span class="chip">${x}</span>`).join(" ");
        const actions = [
          `<button class="btn btn-secondary small" data-edit="${s.id}">Edit</button>`,
          isAdmin() ? `<button class="btn small" data-clear="${s.id}" style="border-color:#733;">Clear Effects</button>` : ""
        ].filter(Boolean).join(" ");
        tr.innerHTML = `
          <td><div class="k">${s.name||s.id}</div><div class="sub">id: ${s.id}</div></td>
          <td>${s.linked_skill || "—"}</td>
          <td>${ints || "—"}</td>
          <td>${s.school_type||"-"} / ${s.range_type||"-"} / ${s.aoe_type||"-"}</td>
          <td>${actions}</td>
        `;
        tb.appendChild(tr);
      }
      tb.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=> openEdit(btn.getAttribute("data-edit")));
      });
      tb.querySelectorAll("[data-clear]").forEach(btn=>{
        btn.addEventListener("click", ()=> clearSchoolEffects(btn.getAttribute("data-clear")));
      });
    }

    
    async function clearSchoolEffects(id){
      if (!id) return;
      if (!isAdmin()){
        if (statusEl) statusEl.textContent = 'Admin only.';
        return;
      }
      const s = SCHOOLS.find(x=>x.id===id);
      const name = s ? (s.name || s.id) : id;
      if (!confirm(`Clear all effects for ${name}? This deletes the effects and updates spells.`)) return;
      if (statusEl) statusEl.textContent = 'Clearing effects...';
      const r = await fetch(`${API_BASE}/admin/schools/${encodeURIComponent(id)}/clear_effects`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || j.status !== 'success'){
        if (statusEl) statusEl.textContent = j.message || `${r.status} ${r.statusText}`;
        return;
      }
      const msg = j.message || `Cleared ${j.deleted_effects || 0} effect(s) from ${j.touched_spells || 0} spell(s).`;
      if (statusEl) statusEl.textContent = msg;
      if (j.patch_text){
        console.log(j.patch_text);
      }
      setTimeout(()=>{ if (statusEl && statusEl.textContent === msg) statusEl.textContent = ''; }, 2500);
    }

    // ---------- edit modal ----------
    const editModal = document.getElementById("edit-modal");
    const editBackdrop = document.getElementById("edit-backdrop");
    function openEdit(id){
      const s = SCHOOLS.find(x=>x.id===id); if(!s) return;
      $("#f-name").value  = s.name || "";
      $("#f-type").value  = s.school_type || "";
      $("#f-range").value = s.range_type || "";
      $("#f-aoe").value   = s.aoe_type || "";
      $("#f-upgrade").checked = !!s.upgrade;
      $("#f-skill").value = (s.linked_skill || "");
      document.querySelectorAll('input[name="ints"]').forEach(ch => { ch.checked = (s.linked_intensities||[]).includes(ch.value); });
      $("#edit-status").textContent = "";
      $("#patch").style.display="none"; $("#patch").textContent="";
      editModal.classList.add("open"); editBackdrop.classList.add("open");
      editModal.dataset.id = id;
    }
    function closeEdit(){ editModal.classList.remove("open"); editBackdrop.classList.remove("open"); }
    document.getElementById("edit-close").onclick=(e)=>{e.preventDefault();closeEdit();};
    document.getElementById("edit-cancel").onclick=(e)=>{e.preventDefault();closeEdit();};
    editBackdrop.onclick=closeEdit;

    async function saveEdit(){
      const id = editModal.dataset.id;
      const ints = Array.from(document.querySelectorAll('input[name="ints"]:checked')).map(x=>x.value);
      const payload = {
        name: $("#f-name").value.trim(),
        school_type: $("#f-type").value.trim(),
        range_type: $("#f-range").value.trim(),
        aoe_type: $("#f-aoe").value.trim(),
        upgrade: $("#f-upgrade").checked,
        linked_skill: $("#f-skill").value || "",
        linked_intensities: ints
      };
      $("#edit-status").textContent = "Saving…";
      const r = await fetch(`${API_BASE}/admin/schools/${encodeURIComponent(id)}`, {
        method:"PUT",
        headers: {"Content-Type":"application/json", Authorization:`Bearer ${token}`},
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.status!=="success"){ $("#edit-status").textContent = j.message || `${r.status} ${r.statusText}`; return; }
      $("#edit-status").textContent = "Saved.";
      if (j.patch_text){ $("#patch").style.display="block"; $("#patch").textContent = j.patch_text; }
      // refresh list row in memory
      const idx = SCHOOLS.findIndex(x=>x.id===id);
      if (idx>=0) {
        SCHOOLS[idx] = { ...SCHOOLS[idx], ...payload };
      }
      renderRows();
      setTimeout(closeEdit, 500);
    }
    document.getElementById("edit-save").onclick=(e)=>{e.preventDefault();saveEdit();};

    // ---------- page init ----------
    async function init(){
      const auth = await me();
      if(!auth.ok || !["admin","moderator"].includes(localStorage.getItem("auth_role")||"")){
        setOut(); $("#auth-gate").style.display="block"; $("#content").style.display="none"; return;
      }
      setIn(auth.user);
      $("#auth-gate").style.display="none";
      $("#content").style.display="block";

      await doSearch();
    }

    async function doSearch(){
      const q = $("#q").value.trim();
      try{
        SCHOOLS = await fetchSchools(q);
        renderRows();
      }catch(e){
        $("#tbody").innerHTML = `<tr><td colspan="5" class="sub">Error: ${e.message}</td></tr>`;
      }
    }

    document.getElementById("search").onclick=(e)=>{e.preventDefault();doSearch();};

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
