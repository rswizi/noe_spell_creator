<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Equipment — Edit</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .row{display:flex;gap:8px;align-items:center}
    .muted{opacity:.8}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #444;border-radius:999px}
    .grid{display:grid;gap:8px;grid-template-columns:1fr 110px 90px 120px auto;align-items:center}
    /* Modal hardening */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999}
    .modal.hidden{display:none!important}
    .modal-card{position:relative;max-width:90vw;max-height:85vh;overflow:auto;background:#111;border:1px solid #333;border-radius:12px;padding:16px}
    .modal-close{position:absolute;top:8px;right:12px;background:transparent;border:0;font-size:1.6rem;line-height:1;cursor:pointer}
    label>span{display:inline-block;width:140px}
    .mod-row{display:grid;grid-template-columns:1fr 0.9fr 0.6fr 1fr auto;gap:6px;align-items:center}
  </style>
</head>
<body>
<div class="container">
  <h1>Edit Equipment</h1>

  <div class="home-card">
    <div class="row">
      <input id="q" type="text" placeholder="Filter by name/style/type..." />
      <select id="f-cat">
        <option value="">All categories</option>
        <option value="special">Special</option>
        <option value="slot">Slot</option>
        <option value="armor">Armor</option>
      </select>
      <button id="refresh" class="btn small">Refresh</button>
      <span id="info" class="muted" style="margin-left:auto;"></span>
    </div>
    <div class="row" style="margin-top:8px; gap:8px;">
      <label class="muted">New equipment</label>
      <select id="create-cat">
        <option value="special">Special</option>
        <option value="slot">Slot</option>
        <option value="armor">Armor</option>
      </select>
      <button id="create" class="btn small">+ Create</button>
    </div>
  </div>

  <div class="home-card" id="list">Loading…</div>

  <a class="btn btn-secondary" href="equipment_home.html" style="margin-top:12px;">← Back</a>
</div>

<!-- modal -->
<div id="modal" class="modal hidden" aria-hidden="true">
  <div class="modal-card" style="min-width:560px;">
    <button id="close" class="modal-close" aria-label="Close">&times;</button>
    <h3 id="m-title">Edit Equipment</h3>

    <!-- SPECIAL -->
    <div id="form-special" style="display:none">
      <div class="row" style="gap:12px;flex-wrap:wrap;">
        <label><span>Name</span><input id="sp-name" style="min-width:280px"></label>
        <label><span>Price</span><input id="sp-price" type="number" style="width:120px"></label>
        <label><span>Enc.</span><input id="sp-enc" type="number" step="0.1" style="width:100px"></label>
        <label><span>Slot</span>
          <select id="sp-slot">
            <option value="">-- none --</option>
            <option value="head">head</option>
            <option value="arms">arms</option>
            <option value="legs">legs</option>
            <option value="accessory">accessory</option>
            <option value="chest">chest</option>
          </select>
        </label>
        <label><span>Tags</span><input id="sp-tags" placeholder="Comma-separated tags" style="min-width:200px"></label>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:6px;">
        <label><span>Damage</span><input id="sp-dmg" style="min-width:260px"></label>
        <label><span>Range</span><input id="sp-range" style="width:100px"></label>
        <label><span>Hands</span><input id="sp-hands" type="number" style="width:100px"></label>
      </div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Effects</span><input id="sp-effects" style="width:100%"></label></div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Description</span><textarea id="sp-desc" rows="3" style="width:100%"></textarea></label></div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Preinstalled upgrades (ids, comma — use id|target for targeted ones)</span><input id="sp-upgrades" style="width:100%"></label></div>
    </div>

    <!-- SLOT -->
    <div id="form-slot" style="display:none">
      <div class="row" style="gap:12px;flex-wrap:wrap;">
        <label><span>Slot</span>
          <select id="sl-slot"><option>head</option><option>arms</option><option>legs</option><option>accessory</option><option>chest</option></select>
        </label>
        <label><span>Style</span><input id="sl-style" style="min-width:200px"></label>
        <label><span>Price</span><input id="sl-price" type="number" style="width:120px"></label>
        <label><span>Enc.</span><input id="sl-enc" type="number" step="0.1" style="width:100px"></label>
        <label><span>Tags</span><input id="sl-tags" placeholder="Comma-separated tags" style="min-width:200px"></label>
      </div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Description</span><textarea id="sl-desc" rows="3" style="width:100%"></textarea></label></div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Preinstalled upgrades (ids, comma — use id|target for targeted ones)</span><input id="sl-upgrades" style="width:100%"></label></div>
    </div>

    <!-- ARMOR -->
    <div id="form-armor" style="display:none">
      <div class="row" style="gap:12px;flex-wrap:wrap;">
        <label><span>Slot</span>
          <select id="ar-slot"><option>chest</option><option>head</option><option>arms</option><option>legs</option><option>accessory</option></select>
        </label>
        <label><span>Type</span><input id="ar-type" style="min-width:200px"></label>
        <label><span>Enc.</span><input id="ar-enc" type="number" step="0.1" style="width:100px"></label>
        <label><span>HP Bonus</span><input id="ar-hp" type="number" style="width:120px"></label>
        <label><span>MO Penalty</span><input id="ar-mo" type="number" style="width:100px"></label>
        <label><span>Tags</span><input id="ar-tags" placeholder="Comma-separated tags" style="min-width:200px"></label>
      </div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Receptacle</span><input id="ar-receptacle" style="width:100%"></label></div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Effect</span><input id="ar-effect" style="width:100%"></label></div>
      <div class="row" style="margin-top:6px;"><label style="flex:1"><span>Preinstalled upgrades (ids, comma — use id|target for targeted ones)</span><input id="ar-upgrades" style="width:100%"></label></div>
      <div class="row muted" style="margin-top:6px;"><span class="pill">Base price (Adequate): 2528</span></div>
    </div>

    <div class="row" style="margin-top:8px;flex-direction:column;align-items:stretch;gap:8px;">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <strong>Modifiers</strong>
        <button id="mod-add" class="btn small" type="button">+ Modifier</button>
      </div>
      <div id="mod-list"></div>
    </div>
<div class="row" style="margin-top:10px;justify-content:flex-end;">
      <button id="save" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "";
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization":"Bearer "+token } : {};
const $ = s=>document.querySelector(s);

let CACHE=[], EDIT=null;
const modListEl = document.getElementById("mod-list");
const MOD_TARGETS = [
    "char.reflex","char.dexterity","char.body","char.wisdom","char.presence","char.magic","char.willpower","char.tech",
    "skills.reflex.Technicity","skills.reflex.Dodge","skills.reflex.Counter","skills.reflex.Reactivity",
    "skills.dexterity.Accuracy","skills.dexterity.Evasion","skills.dexterity.Stealth","skills.dexterity.Acrobatics",
    "skills.body.Brutality","skills.body.Blocking","skills.body.Resistance","skills.body.Athletics",
    "skills.wisdom.Survival","skills.wisdom.Education","skills.wisdom.Perception","skills.wisdom.Psychology","skills.wisdom.Investigation",
    "skills.presence.Taming","skills.presence.Charm","skills.presence.Charisma","skills.presence.Deception","skills.presence.Persuasion",
    "skills.magic.Aura","skills.magic.Incantation","skills.magic.Enchantment","skills.magic.Restoration","skills.magic.Potential",
    "skills.willpower.Intimidation","skills.willpower.Spirit","skills.willpower.Instinct","skills.willpower.Absorption",
    "skills.tech.Crafting","skills.tech.Sleight of hand","skills.tech.Alchemy","skills.tech.Medicine","skills.tech.Engineering",
    "derived.hp","derived.en","derived.fo","derived.mo","derived.spcap","derived.enc","derived.et","derived.tx",
    "spell_slots.simple","spell_slots.complex",
    "__custom__"
  ];

function addModRow(container, initial={}){
  const row = document.createElement("div");
  row.className = "mod-row";
  const sel = document.createElement("select");
  MOD_TARGETS.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t; opt.textContent = t==="__custom__" ? "Custom..." : t;
    if (t === (initial.target||"")) opt.selected = true;
    sel.appendChild(opt);
  });
  const custom = document.createElement("input");
  custom.placeholder = "Custom target";
  custom.value = (!MOD_TARGETS.includes(initial.target) ? (initial.target||"") : "");
  custom.style.display = sel.value === "__custom__" ? "" : "none";
  sel.addEventListener("change", ()=>{
    custom.style.display = sel.value === "__custom__" ? "" : "none";
    if (sel.value !== "__custom__") custom.value = "";
  });
  const mode = document.createElement("select");
  ["add","mul","set"].forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=m;
    if ((initial.mode||"add")===m) opt.selected=true;
    mode.appendChild(opt);
  });
  const val=document.createElement("input"); val.type="number"; val.step="0.1"; val.value=initial.value ?? 0;
  const note=document.createElement("input"); note.placeholder="Note"; note.value=initial.note||"";
  const rm=document.createElement("button"); rm.className="btn btn-secondary small"; rm.type="button"; rm.textContent="Remove"; rm.onclick=()=>row.remove();
  row.appendChild(sel); row.appendChild(custom); row.appendChild(mode); row.appendChild(val); row.appendChild(note); row.appendChild(rm);
  container.appendChild(row);
}
function setModifiers(container, mods){
  container.innerHTML = "";
  if (mods && mods.length){ mods.forEach(m=> addModRow(container, m)); }
  else { addModRow(container, {}); }
}
function collectModifiers(container){
  const mods=[];
  container.querySelectorAll(".mod-row").forEach(row=>{
    const sel=row.querySelector("select");
    const custom=row.querySelector("input[placeholder='Custom target']");
    const target = sel.value === "__custom__" ? (custom.value||"").trim() : sel.value;
    if (!target) return;
    const mode = row.querySelectorAll("select")[1]?.value || "add";
    const val = parseFloat(row.querySelector("input[type='number']").value||"0");
    const note = row.querySelector("input[placeholder='Note']").value || "";
    mods.push({ target, mode, value: val, note });
  });
  return mods;
}

function row(e){
  const name = e.category==="special" ? e.name
             : e.category==="slot"    ? `${e.slot}: ${e.style}`
             : /* armor */              `Armor — ${e.type}`;
  const price = e.price ?? 0;
  const enc = e.enc ?? 0;
  const cat = e.category;
  return `
    <div class="grid" style="border-bottom:1px solid #222;padding:6px 0;">
      <div><strong>${name}</strong> <span class="muted">[${e.id}]</span>
        <div class="muted small">${(e.description||e.effect||"").slice(0,240)}</div></div>
      <div style="text-align:center;">${cat}</div>
      <div style="text-align:center;">${enc}</div>
      <div style="text-align:center;">${price}</div>
      <div style="display:flex;gap:6px;justify-content:flex-end;">
        <button class="btn" onclick="openEdit('${e.id}')">Edit</button>
        <button class="btn btn-danger" onclick="delOne('${e.id}')">Delete</button>
      </div>
    </div>`;
}

function render(){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const cat = document.getElementById("f-cat").value;
  let list = CACHE.slice();
  if (q) list = list.filter(e =>
    ((e.name||"").toLowerCase().includes(q)) ||
    ((e.style||"").toLowerCase().includes(q)) ||
    ((e.type||"").toLowerCase().includes(q))
  );
  if (cat) list = list.filter(e => e.category===cat);
  document.getElementById("list").innerHTML = list.length ? list.map(row).join("") : "<p>No results.</p>";
  document.getElementById("info").textContent = `${list.length}/${CACHE.length}`;
}

async function load(){
  const r = await fetch(`${API_BASE}/equipment`, { headers: authHeaders() });
  const j = await r.json().catch(()=>({}));
  CACHE = j.equipment || [];
  render();
}

function openEdit(id){
  const e = CACHE.find(x=>x.id===id); if(!e) return;
  EDIT = { ...e };
  document.getElementById("m-title").textContent = `Edit — ${e.id}`;
  fillFormFromEdit();
  const MODAL=document.getElementById("modal");
  MODAL.classList.remove("hidden"); MODAL.setAttribute("aria-hidden","false");
  document.getElementById("close").focus();
}

function openCreate(cat){
  EDIT = { id:null, category: cat };
  document.getElementById("m-title").textContent = `Create ${cat}`;
  fillFormFromEdit(true);
  const MODAL=document.getElementById("modal");
  MODAL.classList.remove("hidden"); MODAL.setAttribute("aria-hidden","false");
  document.getElementById("close").focus();
}

function fillFormFromEdit(isNew=false){
  const e = EDIT || {};
  document.getElementById("form-special").style.display = e.category==="special" ? "block":"none";
  document.getElementById("form-slot").style.display    = e.category==="slot"    ? "block":"none";
  document.getElementById("form-armor").style.display   = e.category==="armor"   ? "block":"none";

  if (e.category==="special"){
    $("#sp-name").value = isNew ? "" : (e.name||"");
    $("#sp-price").value = isNew ? 0 : (e.price ?? 0);
    $("#sp-enc").value   = isNew ? 0 : (e.enc ?? 0);
    $("#sp-slot").value  = e.slot || "";
    $("#sp-dmg").value   = isNew ? "" : (e.damage||"");
    $("#sp-range").value = isNew ? "" : (e.range||"");
    $("#sp-hands").value = isNew ? 1 : (e.hands ?? 1);
    $("#sp-effects").value = isNew ? "" : ((e.effects||[]).join(", "));
    $("#sp-desc").value  = isNew ? "" : (e.description||"");
    $("#sp-upgrades").value = (e.upgrades||[]).join(", ");
    $("#sp-tags").value = (e.tags || []).join(", ");
  } else if (e.category==="slot"){
    $("#sl-slot").value  = e.slot||"head";
    $("#sl-style").value = isNew ? "" : (e.style||"");
    $("#sl-price").value = isNew ? 0 : (e.price ?? 0);
    $("#sl-enc").value   = isNew ? 0 : (e.enc ?? 0);
    $("#sl-desc").value  = isNew ? "" : (e.description||"");
    $("#sl-upgrades").value = (e.upgrades||[]).join(", ");
    $("#sl-tags").value = (e.tags || []).join(", ");
  } else if (e.category==="armor"){
    $("#ar-slot").value = e.slot || "chest";
    $("#ar-type").value = isNew ? "" : (e.type||"");
    $("#ar-enc").value  = isNew ? 0 : (e.enc ?? 0);
    $("#ar-hp").value   = isNew ? 0 : (e.hp_bonus ?? 0);
    $("#ar-mo").value   = isNew ? 0 : (e.mo_penalty ?? 0);
    $("#ar-receptacle").value = isNew ? "" : (e.receptacle||"");
    $("#ar-effect").value     = isNew ? "" : (e.effect||"");
    $("#ar-upgrades").value = (e.upgrades||[]).join(", ");
    $("#ar-tags").value = (e.tags || []).join(", ");
  }

  setModifiers(modListEl, isNew ? [] : (e.modifiers || []));
}
function closeEdit(){
  const MODAL=document.getElementById("modal");
  MODAL.classList.add("hidden"); MODAL.setAttribute("aria-hidden","true");
  EDIT=null;
}
document.getElementById("close").addEventListener("click", closeEdit);
const MODAL=document.getElementById("modal");
MODAL.addEventListener("click",(e)=>{ if(e.target===MODAL) closeEdit(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && !MODAL.classList.contains("hidden")) closeEdit(); });

document.getElementById("save").addEventListener("click", async ()=>{
  if (!EDIT) return;
  let body={};
  if (EDIT.category==="special"){
    body = {
      category:"special",
      name: $("#sp-name").value.trim()||"Unnamed",
      price: Number($("#sp-price").value||0),
      enc:   Number($("#sp-enc").value||0),
      slot:  $("#sp-slot").value,
      damage: $("#sp-dmg").value.trim(),
      range:  $("#sp-range").value.trim(),
      hands:  Number($("#sp-hands").value||1),
      effects: $("#sp-effects").value.split(",").map(s=>s.trim()).filter(Boolean),
      description: $("#sp-desc").value.trim(),
      upgrades: $("#sp-upgrades").value.split(",").map(s=>s.trim()).filter(Boolean),
      tags: $("#sp-tags").value.trim(),
    };
  } else if (EDIT.category==="slot"){
    body = {
      category:"slot",
      slot: $("#sl-slot").value,
      style: $("#sl-style").value.trim()||"Unnamed",
      price: Number($("#sl-price").value||0),
      enc:   Number($("#sl-enc").value||0),
      description: $("#sl-desc").value.trim(),
      upgrades: $("#sl-upgrades").value.split(",").map(s=>s.trim()).filter(Boolean),
      tags: $("#sl-tags").value.trim(),
    };
  } else {
    body = {
      category:"armor",
      slot: $("#ar-slot").value,
      type: $("#ar-type").value.trim()||"Armor",
      enc:  Number($("#ar-enc").value||0),
      hp_bonus: Number($("#ar-hp").value||0),
      mo_penalty: Number($("#ar-mo").value||0),
      receptacle: $("#ar-receptacle").value.trim(),
      effect: $("#ar-effect").value.trim(),
      price: 2528,
      upgrades: $("#ar-upgrades").value.split(",").map(s=>s.trim()).filter(Boolean),
      tags: $("#ar-tags").value.trim(),
    };
  }
  body.modifiers = collectModifiers(modListEl);
  const isNew = !EDIT.id;
  const path = isNew ? "/equipment" : `/equipment/${EDIT.id}`;
  const method = isNew ? "POST" : "PUT";
  const r = await fetch(path, { method, headers:{ "Content-Type":"application/json", ...authHeaders() }, body: JSON.stringify(body) });
  const j = await r.json().catch(()=>({})); if (j.status!=="success") return alert(j.message||"Save failed");
  await load(); closeEdit();
});

async function delOne(id){
  if(!confirm(`Delete ${id}?`)) return;
  const r=await fetch(`/equipment/${id}`,{ method:"DELETE", headers:{ ...authHeaders() }});
  const j=await r.json().catch(()=>({})); if (j.status!=="success") return alert(j.message||"Delete failed");
  CACHE=CACHE.filter(x=>x.id!==id); render();
}

document.addEventListener("DOMContentLoaded", ()=>{
  load();
  document.getElementById("refresh").addEventListener("click", load);
  document.getElementById("q").addEventListener("input", render);
  document.getElementById("f-cat").addEventListener("change", render);
  document.getElementById("mod-add").addEventListener("click", ()=> addModRow(modListEl, {}));
  document.getElementById("create").addEventListener("click", ()=>{
    const cat = document.getElementById("create-cat").value || "slot";
    openCreate(cat);
  });
});
</script>
</body>
</html>

