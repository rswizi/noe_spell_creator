<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Spells</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .hidden { display: none !important; }

    /* Page layout */
    .filter-bar { gap: 10px; flex-wrap: wrap; }
    #preview { background:#0f0f0f; border:1px solid #222; border-radius:12px; padding:14px 16px; }
    #results .effect-entry { display:flex; gap:12px; align-items:center; padding:10px 0; border-bottom:1px solid #222; }
    #results .effect-entry:last-child { border-bottom:0; }
    .btn-outline { background:transparent; border:1px solid #444; color:#ddd; padding:4px 8px; border-radius:8px; cursor:pointer; }
    .btn-outline:hover { border-color:#777; color:#fff; }

    /* Simple modal */
    .modal { position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000; padding:16px; }
    .modal-card { width:min(900px,96vw); max-height:90vh; overflow:auto; background:#111; color:#eee; border-radius:16px; padding:20px 22px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .modal-close { float:right; font-size:28px; line-height:1; background:transparent; border:0; color:#aaa; cursor:pointer; }
    .modal-close:hover { color:#fff; }
    .kv { list-style:none; padding:0; margin:0; }
    .kv li { margin:6px 0; }
    .bulleted { margin-left:18px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Browse Spells</h1>

    <!-- Filters -->
    <div class="home-card" style="margin-bottom:18px;">
      <div class="filter-bar">
        <input id="filter-name" type="text" placeholder="Filter by name..." />
        <select id="filter-category">
          <option value="">All Categories</option>
          <option>Novice</option><option>Apprentice</option><option>Disciple</option>
          <option>Adept</option><option>Mage</option><option>Magister</option>
          <option>High Mage</option><option>Master</option><option>Grand Master</option>
          <option>Archmage</option><option>Supreme Archmage</option><option>Avant-Garde</option>
        </select>
        <select id="filter-school">
          <option value="">All Schools</option>
        </select>

        <label style="display:flex;align-items:center;gap:6px;margin-left:auto;">
          <input type="checkbox" id="filter-fav" />
          <span>Only favorites</span>
        </label>

        <button id="clear-filters">Reset</button>
      </div>
    </div>

    <!-- Preview ABOVE the list -->
    <div class="home-card" style="margin-bottom:18px;">
      <div id="preview">
        <h3>Preview</h3>
        <p>Select a spell below to see a quick summary here.</p>
      </div>
    </div>

    <!-- Results list -->
    <div class="home-card">
      <div id="results"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="home.html">← Back Home</a>
    </div>
  </div>

  <!-- Spell Details Modal -->
  <div id="spell-details-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="spell-details-title">
      <button class="modal-close" id="spell-details-close" aria-label="Close">&times;</button>
      <h2 id="spell-details-title">Spell Details</h2>

      <div class="details-grid">
        <div>
          <h3>Overview</h3>
          <ul class="kv">
            <li><strong>Name:</strong> <span id="detail-name"></span></li>
            <li><strong>School(s):</strong> <span id="detail-school"></span></li>
            <li><strong>Type:</strong> <span id="detail-school-type"></span></li>
            <li><strong>Tier:</strong> <span id="detail-tier"></span></li>
            <li><strong>Range:</strong> <span id="detail-range"></span></li>
            <li><strong>AOE:</strong> <span id="detail-aoe"></span></li>
            <li><strong>Duration:</strong> <span id="detail-duration"></span></li>
            <li><strong>Activation:</strong> <span id="detail-activation"></span></li>
          </ul>
        </div>

        <div>
          <h3>Costs</h3>
          <ul class="kv">
            <li><strong>MP Cost:</strong> <span id="detail-mp"></span></li>
            <li><strong>EN Cost:</strong> <span id="detail-en"></span></li>
            <li><strong>Learning Time:</strong> <span id="detail-learning"></span></li>
          </ul>
        </div>
      </div>

      <div>
        <h3>Description</h3>
        <p id="detail-description"></p>
      </div>

      <div>
        <h3>Effects</h3>
        <ul id="detail-effects" class="bulleted"></ul>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   Auth / Globals
---------------------------- */
const API_BASE = "";
const token = localStorage.getItem("auth_token") || "";

if (!token) {
  alert("Please log in to browse the database.");
  window.location.href = "home.html";
}

const $  = (s)=>document.querySelector(s);
const resultsEl   = $("#results");
const nameEl      = $("#filter-name");
const categoryEl  = $("#filter-category");
const schoolEl    = $("#filter-school");
const favOnlyEl   = $("#filter-fav");

let favIds = new Set();
let cacheById = new Map(); // cache spells by id for preview/details

/* ---------------------------
   Learning time & EN helpers
---------------------------- */
const LEARNING_DAYS = {
  "Novice": 2,
  "Apprentice": 8,
  "Disciple": 10,
  "Adept": 14,
  "Mage": 16,
  "Magister": 20,
  "High Mage": 22,
  "Master": 28,
  "Grand Master": 32,
  "Archmage": 36,
  "Supreme Archmage": 46,
  "Avant-Garde": 50
};

function normTier(t) {
  if (!t) return t;
  const map = {
    "avant-garde": "Avant-Garde",
    "avant garde": "Avant-Garde",
    "Avant-garde": "Avant-Garde"
  };
  return map[t] || t;
}

function getLearningDays(tier, schoolType /* "Simple" | "Complex" */) {
  const base = LEARNING_DAYS[normTier(tier)] ?? 0;
  return (String(schoolType).toLowerCase() === "complex") ? base * 2 : base;
}

// Prefer explicit top-level en_cost, otherwise sum effect ENs.
function computeEN(spell) {
  if (typeof spell.en_cost === 'number') return spell.en_cost;
  if (Array.isArray(spell.effects)) {
    return spell.effects.reduce((sum, ef) => sum + (Number(ef.en_cost) || 0), 0);
  }
  return 0;
}

/* ---------------------------
   Row / List / Preview
---------------------------- */
function rowSpell(s){
  const schools = (s.schools||[]).map(sc=>sc.name).join(", ") || (s.school?.name || s.school || "—");
  const isFav = favIds.has(String(s.id));
  const btnText = isFav ? "Unfavorite" : "Favorite";
  const btnClass = isFav ? "btn btn-secondary" : "btn";

  return `
    <div class="effect-entry">
      <div style="flex:1; cursor:pointer;" onclick="selectForPreview('${String(s.id)}')">
        <div style="font-weight:bold">${s.name} <span style="opacity:.7">[${s.id}]</span></div>
        <div style="opacity:.8;font-size:.95rem">
          ${s.category || "—"} · ${s.activation || "—"} · ${s.range || "—"} · ${s.aoe || "—"} · dur ${s.duration || "—"}
        </div>
        <div style="opacity:.7;font-size:.9rem">Schools: ${schools}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn-outline" onclick="openSpellDetails('${String(s.id)}')">Show details</button>
        <button class="${btnClass}" onclick="toggleFav('${String(s.id)}')">${btnText}</button>
      </div>
    </div>
  `;
}

function renderList(list){
  cacheById.clear();
  for (const s of list) cacheById.set(String(s.id), s);
  resultsEl.innerHTML = list.length ? list.map(rowSpell).join("") : "<p>No spells found.</p>";
}

function renderPreview(spell) {
  const schoolName = (spell.school && (spell.school.name || spell.school)) || (spell.schools?.[0]?.name) || '—';
  const schoolType = (spell.school_type || spell.schoolType || spell.school?.type || 'Simple');
  const tier       = normTier(spell.tier || spell.category || '—');
  const mp         = (spell.mp_cost ?? 0);
  const en         = computeEN(spell);
  const learning   = getLearningDays(tier, schoolType);

  const html = `
    <h3>${spell.name || 'Untitled Spell'}</h3>
    <p><strong>School:</strong> ${schoolName} (${schoolType})</p>
    <p><strong>Tier:</strong> ${tier}</p>
    <p><strong>MP Cost:</strong> ${mp}</p>
    <p><strong>EN Cost:</strong> ${en}</p>
    <p><strong>Learning Time:</strong> ${learning} day${learning===1?'':'s'}</p>
    ${spell.description ? `<p style="margin-top:10px;">${spell.description}</p>` : ''}
  `;
  document.getElementById('preview').innerHTML = html;
}

function selectForPreview(id) {
  const s = cacheById.get(String(id));
  if (s) renderPreview(s);
}

/* ---------------------------
   Modal (Details)
---------------------------- */
async function fetchSpellById(id) {
  try {
    const res = await fetch(`${API_BASE}/spells/${encodeURIComponent(id)}`);
    if (res.ok) {
      const data = await res.json();
      return data.spell ?? data;
    }
  } catch {}
  return cacheById.get(String(id));
}

async function openSpellDetails(spellId) {
  const modal = document.getElementById('spell-details-modal');
  try {
    const spell = await fetchSpellById(spellId);
    if (!spell) throw new Error("Spell not found");

    const schoolNames = (spell.schools || []).map(sc => sc.name).join(", ") || (spell.school?.name || spell.school || '—');
    const schoolType  = (spell.school_type || spell.schoolType || spell.school?.type || 'Simple');
    const tier        = normTier(spell.tier || spell.category || '—');

    document.getElementById('spell-details-title').textContent = spell.name ?? 'Spell Details';
    document.getElementById('detail-name').textContent = spell.name ?? '—';
    document.getElementById('detail-school').textContent = schoolNames;
    document.getElementById('detail-school-type').textContent = schoolType;
    document.getElementById('detail-tier').textContent = tier;
    document.getElementById('detail-range').textContent = spell.range ?? '—';
    document.getElementById('detail-aoe').textContent = spell.aoe ?? '—';
    document.getElementById('detail-duration').textContent = spell.duration ?? '—';
    document.getElementById('detail-activation').textContent = spell.activation ?? '—';
    document.getElementById('detail-description').textContent = spell.description ?? '—';

    document.getElementById('detail-mp').textContent = (spell.mp_cost ?? 0);
    document.getElementById('detail-en').textContent = computeEN(spell);
    const learning = getLearningDays(tier, schoolType);
    document.getElementById('detail-learning').textContent = `${learning} day${learning===1?'':'s'}`;

    const ul = document.getElementById('detail-effects');
    ul.innerHTML = '';
    if (Array.isArray(spell.effects) && spell.effects.length) {
      spell.effects.forEach(ef => {
        const li = document.createElement('li');
        const en = (ef.en_cost != null) ? ` [EN ${ef.en_cost}]` : '';
        const mp = (ef.mp_cost != null) ? ` [MP ${ef.mp_cost}]` : '';
        li.textContent = `${ef.name || ef.title || 'Effect'}: ${ef.description || ''}${mp}${en}`;
        ul.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = '—';
      ul.appendChild(li);
    }

    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
  } catch (e) {
    console.error(e);
    alert('Could not load spell details.');
    closeSpellDetails();
  }
}

function closeSpellDetails() {
  const modal = document.getElementById('spell-details-modal');
  modal.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'spell-details-close') closeSpellDetails();
  if (e.target && e.target.id === 'spell-details-modal') closeSpellDetails();
});

/* ---------------------------
   Data loading / Filters
---------------------------- */
function buildQuery(){
  const p = new URLSearchParams();
  const n = nameEl.value.trim();
  const c = categoryEl.value;
  const sch = schoolEl.value;

  if(n) p.set("name", n);
  if(c) p.set("category", c);
  if(sch) p.set("school", sch);
  p.set("status", "green");              // approved only
  if(favOnlyEl.checked) p.set("favorite", "1");
  return p.toString();
}

async function loadSchools(){
  const res = await fetch(`${API_BASE}/schools`);
  const data = await res.json();
  (data.schools || []).forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} [${s.id}]`;
    schoolEl.appendChild(opt);
  });
}

async function loadFavIds(){
  const res = await fetch(`${API_BASE}/favorites/ids`, { headers: { "Authorization": `Bearer ${token}` }});
  const data = await res.json();
  favIds = new Set((data.ids || []).map(String));
}

async function fetchSpells(){
  const q = buildQuery();
  const url = q ? `${API_BASE}/spells?${q}` : `${API_BASE}/spells`;
  const headers = favOnlyEl.checked ? { "Authorization": `Bearer ${token}` } : {};
  const res = await fetch(url, { headers });
  const data = await res.json();
  let list = data.spells || [];
  if (favOnlyEl.checked) list = list.filter(s => favIds.has(String(s.id)));
  renderList(list);
}

async function toggleFav(id){
  const isFav = favIds.has(String(id));
  const method = isFav ? "DELETE" : "POST";
  const res = await fetch(`${API_BASE}/favorites/${encodeURIComponent(id)}`, {
    method,
    headers: { "Authorization": `Bearer ${token}` }
  });
  const j = await res.json();
  if (j.status === "success") {
    await loadFavIds();
    await fetchSpells();
  } else {
    alert(j.message || "Failed to update favorite.");
  }
}

function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

document.addEventListener("DOMContentLoaded", async ()=>{
  const params = new URLSearchParams(location.search);
  if (params.get("favorites") === "1") favOnlyEl.checked = true;

  await loadSchools();
  await loadFavIds();
  await fetchSpells();

  const run = debounce(fetchSpells, 300);
  nameEl.addEventListener("input", run);
  categoryEl.addEventListener("change", run);
  schoolEl.addEventListener("change", run);
  favOnlyEl.addEventListener("change", fetchSpells);

  $("#clear-filters").addEventListener("click", ()=>{
    nameEl.value = ""; categoryEl.value = ""; schoolEl.value = ""; favOnlyEl.checked = false; fetchSpells();
  });
});
</script>
</body>
</html>