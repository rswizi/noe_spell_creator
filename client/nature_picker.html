<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NoE â€” Nature Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body {
      background: #07060a;
      color: #f3f3f5;
      min-height: 100vh;
    }
    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:20px;
      border-bottom:1px solid #1d1c2a;
      background:linear-gradient(95deg, #0c0b12, #17131f);
      position:sticky;
      top:0;
      z-index:20;
    }
    .topbar h1 {
      font-size:1.4rem;
      margin:0;
    }
    .wrap {
      max-width:980px;
      margin:0 auto;
      padding:24px 16px 40px;
    }
    .hero {
      font-size:2rem;
      margin-bottom:4px;
    }
    .desc {
      color:#b1b0c2;
      max-width:760px;
      margin-bottom:18px;
    }
    .nature-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px,1fr));
      gap:12px;
      margin-bottom:24px;
    }
    .school-section {
      border:1px solid #1d1c2a;
      border-radius:16px;
      padding:18px;
      background:#0c0c14;
      box-shadow:0 10px 25px rgba(0,0,0,.45);
      display:grid;
      gap:12px;
      margin-bottom:16px;
    }
    .school-section:last-child {
      margin-bottom:0;
    }
    .section-header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .section-header h4 {
      margin:0;
      font-size:1rem;
      text-transform:uppercase;
      letter-spacing:.03em;
      color:#d8d6f6;
    }
    .section-header .section-count {
      font-size:.85rem;
      opacity:.8;
    }
    .school-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
      gap:12px;
    }
    .nature-cell {
      border:1px solid #292837;
      border-radius:14px;
      padding:12px;
      text-align:center;
      background:#0d0c13;
      cursor:pointer;
      transition:border .2s ease, transform .2s ease;
    }
    .nature-cell.selected {
      border-color:#c54b4b;
      box-shadow:0 0 14px rgba(197,75,75,0.35);
      transform:translateY(-3px);
    }
    .nature-cell img {
      width:48px;
      height:48px;
      margin-bottom:8px;
    }
    .nature-cell span {
      display:block;
      font-size:1rem;
      font-weight:600;
    }
    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
    }
    .controls .pill {
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #33334b;
      background:#11111c;
      font-size:.9rem;
    }
    .results {
      display:grid;
      gap:12px;
    }
    .school-card {
      border:1px solid #1f1f2c;
      border-radius:14px;
      padding:14px;
      background:#10101a;
      box-shadow:0 8px 18px rgba(0,0,0,0.35);
    }
    .school-card.overlap {
      border-color:#1f6a70;
      box-shadow:0 15px 30px rgba(31,106,112,0.35);
    }
    .school-card header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .school-card header .school-type {
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:#8ee1db;
    }
    .school-card header h3 {
      margin:0;
      font-size:1.1rem;
    }
    .school-card .meta {
      color:#9998b2;
      font-size:.85rem;
    }
    .tags {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }
    .tag {
      border-radius:999px;
      background:#171520;
      border:1px solid #2b2b3b;
      padding:4px 10px;
      font-size:.8rem;
    }
    .school-card.overlap .tags .tag {
      background:#0c2a31;
      border-color:#1f6a70;
      color:#87e4e0;
    }
    .tag.overlap-tag {
      border-color:#1faaaf;
      background:#0d2f33;
      color:#b6fff8;
    }
    #status {
      color:#f66;
      margin-top:12px;
      font-size:.9rem;
    }
    @media (max-width:720px){
      .topbar {
        flex-direction:column;
        gap:10px;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Nature Picker</h1>
    <a class="btn" href="portal.html">Back to Portal</a>
  </div>

  <div class="wrap">
    <div class="hero">Mix Eclipse natures to uncover schools</div>
    <p class="desc">
      Click any combination of natures to see which schools become available.
      Complex schools require every linked nature to be selected; simple schools open
      when their linked intensity is part of the collection.
    </p>

    <div class="nature-grid" id="nature-grid"></div>

    <div class="controls">
      <span id="selected-summary">Selected natures: none</span>
      <span class="pill" id="result-count">â€” schools available</span>
      <span class="pill" id="complex-hint">Complex schools require every linked nature.</span>
    </div>

    <div class="results" id="school-results"></div>
    <div id="status"></div>
  </div>

  <script>
    const API_BASE = "";
    const NATURES = [
      { key: "fire", label: "Fire" },
      { key: "water", label: "Water" },
      { key: "earth", label: "Earth" },
      { key: "wind", label: "Wind" },
      { key: "lightning", label: "Lightning" },
      { key: "sun", label: "Sun" },
      { key: "moon", label: "Moon" },
      { key: "ki", label: "Ki" },
    ];

    const selected = new Set();
    let schools = [];

    const gridEl = document.getElementById("nature-grid");
    const summaryEl = document.getElementById("selected-summary");
    const resultCountEl = document.getElementById("result-count");
    const resultsEl = document.getElementById("school-results");
    const statusEl = document.getElementById("status");

    function normalize(name) {
      return String(name || "").trim().toLowerCase();
    }

    function labelNature(key) {
      if (!key) return "";
      const match = NATURES.find(n => n.key === key.toLowerCase());
      if (match) return match.label;
      return key.charAt(0).toUpperCase() + key.slice(1);
    }

    function drawNatureGrid() {
      gridEl.innerHTML = "";
      NATURES.forEach(nature => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "nature-cell" + (selected.has(nature.key) ? " selected" : "");
        button.innerHTML = `
          <img src="/assets/natures/${nature.key}.svg" alt="${nature.label}">
          <span>${nature.label}</span>
        `;
        button.addEventListener("click", () => {
          if (selected.has(nature.key)) selected.delete(nature.key);
          else selected.add(nature.key);
          drawNatureGrid();
          renderResults();
        });
        gridEl.appendChild(button);
      });
    }

    function updateSummary() {
      if (!selected.size) {
        summaryEl.textContent = "Selected natures: none";
        return;
      }
      const names = NATURES.filter(n => selected.has(n.key)).map(n => n.label);
      summaryEl.textContent = `Selected natures: ${names.join(", ")}`;
    }

    function createSchoolCard(school, options = {}) {
      const card = document.createElement("article");
      const range = school.range_type ? `Range ${school.range_type}` : "";
      const aoe = school.aoe_type ? `AoE ${school.aoe_type}` : "";
      const metaText = [range, aoe].filter(Boolean).join(" â€¢ ");
      const skill = school.linked_skill || "—";
      const typeLabel = school.school_type === "complex" ? "Complex" : "Simple";
      const natures = (school.linked_intensities || []).slice();
      const matches = Array.isArray(options.matchNatures) ? options.matchNatures : [];
      const matchTag = matches.length
        ? `<span class="tag overlap-tag">Overlap: ${matches.map(labelNature).join(" + ")}</span>`
        : "";
      card.className = "school-card" + (options.highlight ? " overlap" : "");
      card.innerHTML = `
        <header>
          <div>
            <h3>${school.name}</h3>
            <div class="meta">${metaText || "—"}</div>
          </div>
          <div class="school-type">${typeLabel}</div>
        </header>
        <div class="tags">
          ${natures.map(n => `<span class="tag">${n}</span>`).join("")}
          ${matchTag}
          <span class="tag">${skill} skill</span>
        </div>
      `;
      return card;
    }

    function createSectionHeader(title, count) {
      const header = document.createElement("div");
      header.className = "section-header";
      const h4 = document.createElement("h4");
      h4.textContent = title;
      const badge = document.createElement("span");
      badge.className = "section-count";
      badge.textContent = `${count} ${count === 1 ? "entry" : "entries"}`;
      header.appendChild(h4);
      header.appendChild(badge);
      return header;
    }

    function renderResults() {
      updateSummary();
      resultsEl.innerHTML = "";
      if (!selected.size) {
        resultCountEl.textContent = "— schools available";
        resultsEl.innerHTML = "<div class='desc'>Pick at least one nature to unlock schools.</div>";
        return;
      }

      const simpleByNature = new Map();
      const complexByNature = new Map();
      Array.from(selected).forEach(nature => {
        simpleByNature.set(nature, []);
        complexByNature.set(nature, []);
      });

      const overlapCandidates = [];
      const overlapIds = new Set();

      schools.forEach(school => {
        const linked = (school.linked_intensities || []).map(normalize).filter(Boolean);
        if (!linked.length) return;
        const linkedSet = new Set(linked);
        const isComplex = (school.school_type || "").toLowerCase() === "complex";

        selected.forEach(nature => {
          if (!linkedSet.has(nature)) return;
          if (isComplex && linkedSet.size === 1) {
            const list = complexByNature.get(nature);
            if (list && !list.some(entry => entry.id === school.id)) {
              list.push(school);
            }
          } else if (!isComplex) {
            const list = simpleByNature.get(nature);
            if (list && !list.some(entry => entry.id === school.id)) {
              list.push(school);
            }
          }
        });

        if (selected.size > 1) {
          const matches = Array.from(linkedSet).filter(n => selected.has(n));
          if (matches.length >= 2 && !overlapIds.has(school.id)) {
            overlapCandidates.push({ school, matches });
            overlapIds.add(school.id);
          }
        }
      });

      const totalSimple = Array.from(simpleByNature.values()).reduce((sum, list) => sum + list.length, 0);
      const overlapCount = overlapCandidates.length;
      resultCountEl.textContent = `${totalSimple} simple school${totalSimple === 1 ? "" : "s"} available`;
      if (overlapCount) {
        resultCountEl.textContent += ` · ${overlapCount} overlapping school${overlapCount === 1 ? "" : "s"}`;
      }

      Array.from(selected).forEach(nature => {
        const simpleList = simpleByNature.get(nature) || [];
        const complexList = complexByNature.get(nature) || [];
        const section = document.createElement("section");
        section.className = "school-section";
        section.appendChild(createSectionHeader(`${labelNature(nature)} simple schools`, simpleList.length));

        if (simpleList.length) {
          const grid = document.createElement("div");
          grid.className = "school-grid";
          simpleList.forEach(school => grid.appendChild(createSchoolCard(school)));
          section.appendChild(grid);
        } else {
          const note = document.createElement("div");
          note.className = "desc";
          note.textContent = "No simple schools tied to this nature yet.";
          section.appendChild(note);
        }

        if (complexList.length) {
          section.appendChild(createSectionHeader(`${labelNature(nature)} complex schools`, complexList.length));
          const grid = document.createElement("div");
          grid.className = "school-grid";
          complexList.forEach(school => grid.appendChild(createSchoolCard(school)));
          section.appendChild(grid);
        }

        resultsEl.appendChild(section);
      });

      if (selected.size > 1) {
        if (overlapCandidates.length) {
          const overlapSection = document.createElement("section");
          overlapSection.className = "school-section";
          overlapSection.appendChild(createSectionHeader("Overlapping schools", overlapCount));
          const grid = document.createElement("div");
          grid.className = "school-grid";
          overlapCandidates.forEach(({ school, matches }) => {
            grid.appendChild(createSchoolCard(school, { highlight: true, matchNatures: matches }));
          });
          overlapSection.appendChild(grid);
          resultsEl.appendChild(overlapSection);
        } else {
          const note = document.createElement("div");
          note.className = "desc";
          note.textContent = "No schools currently overlap two selected natures.";
          resultsEl.appendChild(note);
        }
      }
    }

    async function loadSchools() {
      statusEl.textContent = "Loading schoolsâ€¦";
      try {
        const response = await fetch(`${API_BASE}/schools`);
        const payload = await response.json();
        schools = Array.isArray(payload?.schools) ? payload.schools : [];
        drawNatureGrid();
        renderResults();
        statusEl.textContent = "";
      } catch (error) {
        statusEl.textContent = "Unable to load schools: " + (error.message || "unknown error");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      drawNatureGrid();
      loadSchools();
    });
  </script>
</body>
</html>
