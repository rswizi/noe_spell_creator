<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Import Effects (Admin/Moderator)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="container">
    <h1>Import Effects</h1>

    <div class="home-card">
      <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr));">
        <div>
          <label for="school-name">School Name</label>
          <input id="school-name" type="text" placeholder="e.g. Destruction" />
        </div>
        <div>
          <label for="school-type">School Type</label>
          <select id="school-type">
            <option value="Complex">Complex</option>
            <option value="Simple">Simple</option>
          </select>
        </div>
        <div>
          <label for="range-type">Range Type</label>
          <select id="range-type">
            <option value="C">C</option><option value="B">B</option><option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="aoe-type">AoE Type</label>
          <select id="aoe-type">
            <option value="C">C</option><option value="B">B</option><option value="A">A</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <input id="upgrade" type="checkbox" />
          <label for="upgrade" style="margin:0;">Upgrade?</label>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <input id="replace-duplicates" type="checkbox" />
          <label for="replace-duplicates" style="margin:0;">Replace duplicates</label>
        </div>
      </div>

      <label style="margin-top:14px;">Paste Effects (raw text)</label>
      <textarea id="raw" rows="14" placeholder="Format each entry as:
Name: Description (can span multiple lines)
MP (can be negative, e.g. -2)
EN (can be negative, e.g. -1)"></textarea>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn" id="parse-btn">Parse</button>
        <button class="btn btn-secondary" onclick="location.href='home.html'">‚Üê Back Home</button>
      </div>
    </div>

    <div id="preview-card" class="home-card" style="display:none;">
      <h3>Preview & Edit</h3>
      <p>Review each effect. You can fix names/descriptions/MP/EN (negatives allowed) before saving.</p>
      <div id="errors" style="color:#ff6b6b; margin:8px 0;"></div>
      <div id="table-wrap" style="overflow:auto;">
        <table class="table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;">Name</th>
              <th style="text-align:left;">Description</th>
              <th style="width:120px;">MP</th>
              <th style="width:120px;">EN</th>
            </tr>
          </thead>
          <tbody id="preview-body"></tbody>
        </table>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn" id="confirm-btn">Confirm & Save</button>
        <button class="btn btn-secondary" id="reparse-btn">Re-parse</button>
      </div>
    </div>
  </div>

<script>
const API_BASE = "";
const $ = s => document.querySelector(s);

// Auth guard (admins & moderators)
const token = localStorage.getItem("auth_token") || "";
const role  = (localStorage.getItem("auth_role") || "").toLowerCase();
if (!token || (role !== "admin" && role !== "moderator")) {
  alert("Forbidden: moderators/admins only.");
  window.location.href = "home.html";
}

function authHeaders(extra = {}) {
  return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json", ...extra };
}

// Inputs
const schoolNameInput  = $("#school-name");
const schoolTypeSelect = $("#school-type");
const rangeTypeSelect  = $("#range-type");
const aoeTypeSelect    = $("#aoe-type");
const upgradeCheckbox  = $("#upgrade");

// Table preview model
let PREVIEW = []; // [{name, description, mp_cost, en_cost}]

// ------------ Parsing helpers (accept +/- integers) ------------
function isSignedIntLine(s){ return /^[+-]?\d+$/.test((s||"").trim()); }

// Sanitize inline numeric edits: keep one leading +/-, digits only.
function cleanSignedIntInput(val) {
  val = String(val || "");
  // Remove invalid chars
  val = val.replace(/[^\d+-]/g, "");
  // Keep only first leading sign (if any)
  val = val.replace(/(?!^)[+-]/g, "");
  // Collapse multi-leading zeros like "-0003" -> "-3" (optional)
  const m = val.match(/^([+-]?)(\d*)$/);
  if (!m) return "";
  const sign = m[1] || "";
  let digits = m[2] || "";
  // allow empty digits during typing; treat as "" (we'll coerce to 0 later)
  if (digits.length > 1) digits = digits.replace(/^0+(\d)/, "$1");
  return sign + digits;
}

/**
 * Expected block:
 * Name: Description (can continue on several lines)
 * MP  (signed integer, e.g. -2 or 3)
 * EN  (signed integer, e.g. -1 or 0)
 * [blank line or next entry]
 */
function parseRawBlock(text){
  const lines = text.split(/\r?\n/).map(l => l.trim());
  const out = [];
  let i = 0;

  while (i < lines.length){
    while (i < lines.length && lines[i] === "") i++;
    if (i >= lines.length) break;

    const header = lines[i++];
    if (!header || isSignedIntLine(header))
      throw new Error(`Expected "Name: Description" near line ${i}, got "${header}"`);

    const colonIdx = header.indexOf(":");
    if (colonIdx === -1)
      throw new Error(`Missing ":" in header near line ${i}: "${header}"`);
    const name = header.slice(0, colonIdx).trim();
    let description = header.slice(colonIdx+1).trim();

    // Collect extra description lines up to the MP line
    while (i < lines.length && lines[i] !== "" && !isSignedIntLine(lines[i])) {
      description += (description ? " " : "") + lines[i];
      i++;
    }

    if (i >= lines.length || !isSignedIntLine(lines[i])) {
      throw new Error(`Missing/invalid MP after "${name}". Found: "${lines[i] || ""}"`);
    }
    const mp = parseInt(lines[i++], 10);

    if (i >= lines.length || !isSignedIntLine(lines[i])) {
      throw new Error(`Missing/invalid EN after "${name}". Found: "${lines[i] || ""}"`);
    }
    const en = parseInt(lines[i++], 10);

    out.push({ name, description, mp_cost: mp, en_cost: en });

    while (i < lines.length && lines[i] === "") i++;
  }

  if (!out.length) throw new Error("No effects parsed. Check the text format.");
  return out;
}

// ------------ UI rendering ------------
function renderPreview(){
  const tbody = $("#preview-body");
  tbody.innerHTML = PREVIEW.map((e, idx) => `
    <tr>
      <td><input data-idx="${idx}" data-key="name" value="${(e.name || "").replace(/"/g,'&quot;')}" /></td>
      <td><textarea data-idx="${idx}" data-key="description" rows="2">${e.description || ""}</textarea></td>
      <td><input data-idx="${idx}" data-key="mp_cost" value="${e.mp_cost}" /></td>
      <td><input data-idx="${idx}" data-key="en_cost" value="${e.en_cost}" /></td>
    </tr>
  `).join("");

  // Wire edits back into PREVIEW; allow signed ints
  tbody.querySelectorAll("input,textarea").forEach(el=>{
    el.addEventListener("input", (ev)=>{
      const idx = parseInt(ev.target.dataset.idx,10);
      const key = ev.target.dataset.key;
      let val = ev.target.value;

      if (key === "mp_cost" || key === "en_cost") {
        val = cleanSignedIntInput(val);
        ev.target.value = val;
        // Treat empty/sign-only as 0 for the model
        PREVIEW[idx][key] = (!val || val === "+" || val === "-") ? 0 : parseInt(val, 10);
      } else {
        PREVIEW[idx][key] = val;
      }
    });
  });
}

function validatePreview(){
  const errs = [];
  PREVIEW.forEach((e,i)=>{
    if (!e.name) errs.push(`Row ${i+1}: name is empty`);
    if (typeof e.mp_cost !== "number" || Number.isNaN(e.mp_cost))
      errs.push(`Row ${i+1}: MP is not a valid number`);
    if (typeof e.en_cost !== "number" || Number.isNaN(e.en_cost))
      errs.push(`Row ${i+1}: EN is not a valid number`);
  });
  return errs;
}

// ------------ Events ------------
$("#parse-btn").addEventListener("click", ()=>{
  const schoolName = schoolNameInput.value.trim();
  if (!schoolName) return alert("Please fill School Name first.");

  try{
    PREVIEW = parseRawBlock($("#raw").value);
    $("#errors").textContent = "";
    renderPreview();
    $("#preview-card").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }catch(e){
    $("#preview-card").style.display = "none";
    $("#errors").textContent = e.message;
  }
});

$("#reparse-btn").addEventListener("click", ()=>$("#parse-btn").click());

$("#confirm-btn").addEventListener("click", async ()=>{
  const errs = validatePreview();
  if (errs.length){ $("#errors").innerHTML = errs.join("<br>"); return; }

  const school_name = schoolNameInput.value.trim();
  if (!school_name){ alert("School Name is required."); return; }

  const replaceDupes = document.querySelector("#replace-duplicates").checked;

  const payload = {
    school_name: school_name,
    school_type: schoolTypeSelect.value,
    range_type:  rangeTypeSelect.value,
    aoe_type:    aoeTypeSelect.value,
    upgrade:     upgradeCheckbox.checked,
    replace_duplicates: replaceDupes,
    effects: PREVIEW.map(e => ({
      name: e.name,
      description: e.description || "",
      mp_cost: Number(e.mp_cost),
      en_cost: Number(e.en_cost)
    }))
  };

  try{
    const res = await fetch(`${API_BASE}/effects/bulk_create`, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === "success"){
      alert(`Created ${data.created.length} effect(s) in ${data.school.name} [${data.school.id}].`);
      location.href = "home.html";
    }else{
      $("#errors").textContent = data.message || "Bulk create failed";
    }
  }catch(e){
    console.error(e);
    $("#errors").textContent = "Request failed: " + e.message;
  }
  
});
</script>
</body>
</html>