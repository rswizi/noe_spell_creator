<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE â€” Create Ability</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0b0b0b; color:#f5f5f5; }
    .page { min-height:100vh; display:grid; place-items:start center; }
    .wrap { width:100%; max-width:1080px; padding:24px 16px 40px; }
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
    .topbar h1 { margin:0; font-size:20px; }
    .topbar .right { margin-left:auto; }
    .muted { opacity:.8; font-size:.9rem; }

    a.btn, button.btn, input, select, textarea {
      border-radius:10px; border:1px solid #333; background:#111; color:#f0f0f0;
      padding:8px 10px; font:inherit;
    }
    a.btn:hover, button.btn:hover { background:#181818; }
    textarea { resize:vertical; min-height:80px; }

    .grid { display:grid; gap:16px; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr); align-items:start; }
    @media (max-width:900px) { .grid { grid-template-columns:1fr; } }

    .panel { border:1px solid #262626; border-radius:14px; background:#101010; padding:14px 14px 16px; }
    .panel h2 { margin:0 0 8px; font-size:1rem; }
    .panel h3 { margin:10px 0 6px; font-size:.95rem; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row label { font-size:.88rem; opacity:.85; min-width:90px; }
    .row .grow { flex:1 1 auto; }
    .pill { font-size:.75rem; opacity:.85; border:1px solid #343434; border-radius:999px; padding:2px 7px; }

    .subgrid-2 { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }
    @media (max-width:700px) { .subgrid-2 { grid-template-columns:1fr; } }

    .cost-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:6px; margin-top:6px; }
    .cost-grid label { font-size:.8rem; opacity:.85; }
    .cost-grid input { width:100%; text-align:right; }

    .mod-list { display:grid; gap:8px; margin-top:6px; }
    .mod-row { display:grid; grid-template-columns: 1.2fr 0.7fr 0.7fr auto; gap:6px; align-items:center; }
    .mod-row input, .mod-row select { width:100%; }
    .mod-row button { padding:4px 8px; font-size:.8rem; }
    .mod-row .mod-target-custom { grid-column:1 / span 3; }

    .status-line { margin-top:10px; font-size:.85rem; opacity:.9; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1>Create Ability / Trait</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="abilities_home.html">Back</a>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="panel">
          <h2>Basics</h2>

          <div class="row">
            <label for="ab-name">Name</label>
            <input id="ab-name" class="grow" placeholder="Ex: Blood-Fueled Lunge" />
          </div>

          <div class="row">
            <label for="ab-type">Type</label>
            <select id="ab-type">
              <option value="active">Active</option>
              <option value="passive">Passive</option>
              <option value="mixed">Mixed (Active + Passive)</option>
            </select>
          </div>

          <div class="row">
            <label for="ab-source-cat">Source</label>
            <select id="ab-source-cat" class="grow">
              <option value="Specie">Specie</option>
              <option value="Talent">Talent</option>
              <option value="Archetype">Archetype</option>
              <option value="Expertise">Expertise</option>
              <option value="Awakening">Awakening</option>
              <option value="Apotheosis">Apotheosis</option>
              <option value="Other" selected>Other</option>
            </select>
          </div>

          <div class="row">
            <label for="ab-source-ref">Source Detail</label>
            <input id="ab-source-ref" class="grow" placeholder="Ex: Elf, Boxer, Expert Trackerâ€¦" />
          </div>

          <div class="row">
            <label for="ab-tags">Tags</label>
            <input id="ab-tags" class="grow" placeholder="Comma-separated: mobility, damage, supportâ€¦" />
          </div>

          <h3>General Description</h3>
          <textarea id="ab-description" placeholder="Lore + global explanation of what this ability does."></textarea>

          <!-- SAVE BUTTON HERE => ALWAYS VISIBLE -->
          <button class="btn" id="btn-save" type="button" style="margin-top:14px;">ðŸ’¾ Save Ability</button>
          <div class="status-line" id="status-line">Ready.</div>
        </div>

        <div class="panel" id="panel-passive">
          <h2>Passive Part <span class="pill">always on</span></h2>
          <h3>Passive Description</h3>
          <textarea id="passive-desc" placeholder="Describe the permanent effect (bonuses, resistances, triggersâ€¦)."></textarea>

          <h3 style="margin-top:10px;">Modifiers (optional)</h3>
          <div class="muted" style="margin-bottom:4px;">
            These will later be applied to the character sheet. Pick from the dropdown (skills, characteristics, derived resources) or use
            a custom path if you need something special.
          </div>

          <div class="mod-list" id="mod-list"></div>
          <button class="btn" id="btn-add-mod" type="button">+ Add Modifier</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="panel" id="panel-active">
          <h2>Active Part <span class="pill">needs activation</span></h2>

          <div class="row">
            <label for="act-activation">Activation</label>
            <select id="act-activation" class="grow">
              <option value="Action">Action</option>
              <option value="Free Action">Free Action</option>
              <option value="Special Action">Special Action</option>
              <option value="Ritual">Ritual</option>
            </select>
          </div>

          <div class="subgrid-2">
            <div>
              <label>Range (m / squares)</label>
              <input id="act-range" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label>Area of Effect</label>
              <input id="act-aoe" placeholder="single target, cone 6m, line 10m, burst 3mâ€¦" />
            </div>
          </div>

          <h3 style="margin-top:10px;">Costs</h3>
          <div class="cost-grid">
            <div><label>HP</label><input id="cost-hp" type="number" step="1" value="0" /></div>
            <div><label>EN</label><input id="cost-en" type="number" step="1" value="0" /></div>
            <div><label>MP</label><input id="cost-mp" type="number" step="1" value="0" /></div>
            <div><label>FO</label><input id="cost-fo" type="number" step="1" value="0" /></div>
            <div><label>MO</label><input id="cost-mo" type="number" step="1" value="0" /></div>
            <div><label>TX</label><input id="cost-tx" type="number" step="1" value="0" /></div>
            <div><label>Other label</label><input id="cost-other-label" placeholder="Ex: SP, Tension" /></div>
            <div><label>Other value</label><input id="cost-other-value" type="number" step="1" value="0" /></div>
          </div>
        </div>
      </div>
    </div>

  </div></div>

<script>
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){
  const t=getToken(); if(t) setCookieToken(t);
  return t ? {'Authorization':'Bearer '+t, 'X-Auth-Token':t} : {};
}
async function api(path,opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
  if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status));
  return data;
}

const loginChip    = document.getElementById('login-chip');
const statusLine   = document.getElementById('status-line');
const nameEl       = document.getElementById('ab-name');
const typeEl       = document.getElementById('ab-type');
const sourceCatEl  = document.getElementById('ab-source-cat');
const sourceRefEl  = document.getElementById('ab-source-ref');
const tagsEl       = document.getElementById('ab-tags');
const descEl       = document.getElementById('ab-description');

const panelActive  = document.getElementById('panel-active');
const panelPassive = document.getElementById('panel-passive');
const passiveDescEl= document.getElementById('passive-desc');
const modListEl    = document.getElementById('mod-list');
const btnAddMod    = document.getElementById('btn-add-mod');

const actActivationEl = document.getElementById('act-activation');
const actRangeEl      = document.getElementById('act-range');
const actAoeEl        = document.getElementById('act-aoe');

const costHpEl    = document.getElementById('cost-hp');
const costEnEl    = document.getElementById('cost-en');
const costMpEl    = document.getElementById('cost-mp');
const costFoEl    = document.getElementById('cost-fo');
const costMoEl    = document.getElementById('cost-mo');
const costTxEl    = document.getElementById('cost-tx');
const costOLabelEl= document.getElementById('cost-other-label');
const costOValEl  = document.getElementById('cost-other-value');

const btnSave     = document.getElementById('btn-save');

const CUSTOM_TARGET_VALUE = '__custom__';
const PASSIVE_TARGET_GROUPS = (()=>{
  const characteristics = [
    { key:'body', label:'Body' },
    { key:'willpower', label:'Willpower' },
    { key:'magic', label:'Magic' },
    { key:'presence', label:'Presence' },
    { key:'reflex', label:'Reflex' },
    { key:'dexterity', label:'Dexterity' },
    { key:'tech', label:'Tech' },
  ];
  const skills = [
    { key:'body', label:'Body', skills:['Athletics','Resistance','Melee','Brawl'] },
    { key:'willpower', label:'Willpower', skills:['Spirit','Courage','Discipline','Insight'] },
    { key:'magic', label:'Magic', skills:['Arcana','Spellwork','Alchemy','Ritual'] },
    { key:'presence', label:'Presence', skills:['Charm','Intimidation','Deception','Performance'] },
    { key:'reflex', label:'Reflex', skills:['Stealth','Acrobatics','Aim','Perception'] },
    { key:'dexterity', label:'Dexterity', skills:['Craft','Lockpicking','Tinkering','Drive'] },
    { key:'tech', label:'Tech', skills:['Alchemy'] },
  ];
  const derived = [
    { key:'hp', label:'HP' },
    { key:'en', label:'EN' },
    { key:'fo', label:'FO' },
    { key:'mo', label:'MO' },
    { key:'spcap', label:'SP cap (10% HP)' },
    { key:'enc', label:'Encumbrance' },
    { key:'et', label:'Eclipse Threshold (ET)' },
    { key:'tx', label:'Max Toxicity (TX)' },
  ];
  return [
    { label:'Characteristics', options: characteristics.map(c=>({ value:`char.${c.key}`, label:`${c.label} (modifier)` })) },
    { label:'Skills', options: skills.flatMap(c=> c.skills.map(s=>({ value:`skills.${c.key}.${s}`, label:`${s} (${c.label})` }))) },
    { label:'Derived / Resources', options: derived.map(d=>({ value:`derived.${d.key}`, label:d.label })) },
    { label:'Custom', options:[{ value:CUSTOM_TARGET_VALUE, label:'Custom path...' }]},
  ];
})();

async function checkMe(){
  try{
    const me = await api('/auth/me');
    loginChip.textContent = me.username + ' (' + me.role + ')';
  }catch(e){
    loginChip.textContent = 'Not logged in.';
  }
}

// modifiers UI
function addModifierRow(initial){
  const row = document.createElement('div');
  row.className = 'mod-row';

  const target = document.createElement('select');
  target.className = 'mod-target';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select target...';
  placeholder.disabled = true;
  target.appendChild(placeholder);

  let matchedPreset = false;
  PASSIVE_TARGET_GROUPS.forEach(group=>{
    const og = document.createElement('optgroup');
    og.label = group.label;
    group.options.forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o.value;
      opt.textContent = o.label;
      if (initial?.target === o.value){ opt.selected = true; matchedPreset = true; }
      og.appendChild(opt);
    });
    target.appendChild(og);
  });
  if (!matchedPreset){
    target.value = initial?.target ? CUSTOM_TARGET_VALUE : '';
  }

  const customTarget = document.createElement('input');
  customTarget.className = 'mod-target-custom';
  customTarget.placeholder = 'Custom path (ex: derived.hp)';
  customTarget.value = matchedPreset ? '' : (initial?.target || '');
  customTarget.style.display = (target.value === CUSTOM_TARGET_VALUE) ? '' : 'none';

  target.addEventListener('change', ()=>{
    const useCustom = target.value === CUSTOM_TARGET_VALUE;
    customTarget.style.display = useCustom ? '' : 'none';
    if (!useCustom) customTarget.value = '';
  });

  const mode = document.createElement('select');
  mode.className = 'mod-mode';
  ['add','mul','set'].forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    if ((initial?.mode || 'add') === m) opt.selected = true;
    mode.appendChild(opt);
  });

  const value = document.createElement('input');
  value.className = 'mod-value';
  value.type = 'number';
  value.step = '0.1';
  value.value = initial?.value ?? 0;

  const rm = document.createElement('button');
  rm.type = 'button';
  rm.textContent = 'Remove';
  rm.className = 'btn';
  rm.addEventListener('click', ()=> row.remove());

  row.appendChild(target);
  row.appendChild(mode);
  row.appendChild(value);
  row.appendChild(rm);
  row.appendChild(customTarget);
  modListEl.appendChild(row);
}
btnAddMod.addEventListener('click', ()=> addModifierRow());

// show/hide panels
function updateTypeVisibility(){
  const t = typeEl.value;
  panelActive.style.display  = (t === 'active' || t === 'mixed')  ? '' : 'none';
  panelPassive.style.display = (t === 'passive' || t === 'mixed') ? '' : 'none';
}
typeEl.addEventListener('change', updateTypeVisibility);
updateTypeVisibility();

function buildPayload(){
  const tags = (tagsEl.value || '').split(',')
    .map(t=>t.trim()).filter(Boolean);

  const base = {
    name: nameEl.value || '',
    type: typeEl.value,
    source_category: sourceCatEl.value,
    source_ref: sourceRefEl.value || '',
    tags,
    description: descEl.value || '',
  };

  let active = null;
  if (typeEl.value === 'active' || typeEl.value === 'mixed') {
    active = {
      activation: actActivationEl.value,
      range: Number(actRangeEl.value || 0),
      aoe: actAoeEl.value || '',
      costs: {
        HP: Number(costHpEl.value || 0),
        EN: Number(costEnEl.value || 0),
        MP: Number(costMpEl.value || 0),
        FO: Number(costFoEl.value || 0),
        MO: Number(costMoEl.value || 0),
        TX: Number(costTxEl.value || 0),
        other_label: costOLabelEl.value || '',
        other_value: Number(costOValEl.value || 0),
      }
    };
  }

  let passive = null;
  if (typeEl.value === 'passive' || typeEl.value === 'mixed') {
    const mods = [];
    modListEl.querySelectorAll('.mod-row').forEach(row=>{
      const targetSel = row.querySelector('.mod-target');
      const customTarget = row.querySelector('.mod-target-custom');
      const modeEl   = row.querySelector('.mod-mode');
      const valueEl  = row.querySelector('.mod-value');
      const resolvedTarget = targetSel.value === CUSTOM_TARGET_VALUE ? (customTarget.value || '').trim() : targetSel.value.trim();
      const parsedValue = parseFloat(valueEl.value || '0');
      if (!resolvedTarget) return;
      mods.push({ target: resolvedTarget, mode: modeEl.value, value: parsedValue, note:'' });
    });
    passive = {
      description: passiveDescEl.value || '',
      modifiers: mods,
    };
  }

  const out = base;
  if (active) out.active = active;
  if (passive) out.passive = passive;
  return out;
}

btnSave.addEventListener('click', async ()=>{
  try{
    statusLine.textContent = 'Saving abilityâ€¦';
    const payload = buildPayload();
    const res = await api('/abilities', {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload),
    });
    statusLine.textContent = 'Saved as ' + res.ability.id;
  }catch(err){
    statusLine.textContent = 'Error: ' + err.message;
  }
});

checkMe();
</script>
</body>
</html>
