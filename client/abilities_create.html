<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoE â€” Create Ability</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0b0b0b; color:#f5f5f5; }
    .page { min-height:100vh; display:grid; place-items:start center; }
    .wrap { width:100%; max-width:1080px; padding:24px 16px 40px; }
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
    .topbar h1 { margin:0; font-size:20px; }
    .topbar .right { margin-left:auto; }
    .muted { opacity:.8; font-size:.9rem; }

    a.btn, button.btn, input, select, textarea {
      border-radius:10px; border:1px solid #333; background:#111; color:#f0f0f0;
      padding:8px 10px; font:inherit;
    }
    a.btn:hover, button.btn:hover { background:#181818; }
    textarea { resize:vertical; min-height:80px; }

    .grid { display:grid; gap:16px; grid-template-columns: 1fr; align-items:start; }

    .panel { border:1px solid #262626; border-radius:14px; background:#101010; padding:14px 14px 16px; }
    .panel h2 { margin:0 0 8px; font-size:1rem; }
    .panel h3 { margin:10px 0 6px; font-size:.95rem; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row label { font-size:.88rem; opacity:.85; min-width:90px; }
    .row .grow { flex:1 1 auto; }
    .pill { font-size:.75rem; opacity:.85; border:1px solid #343434; border-radius:999px; padding:2px 7px; }

    .subgrid-2 { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }
    @media (max-width:700px) { .subgrid-2 { grid-template-columns:1fr; } }

    .cost-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:6px; margin-top:6px; }
    .cost-grid label { font-size:.8rem; opacity:.85; }
    .cost-grid input { width:100%; text-align:right; }

    .mod-list { display:grid; gap:8px; margin-top:6px; }
    .mod-row { display:grid; grid-template-columns: minmax(180px,1.2fr) minmax(90px,0.6fr) minmax(90px,0.6fr) auto; gap:8px; align-items:center; }
    .mod-row input, .mod-row select { width:100%; min-width:0; }
    .mod-row .mod-value, .mod-row .choice-max, .mod-row .level-step { width:90px; }
    .mod-row .mod-target { max-width:260px; }
    .mod-row button { padding:4px 8px; font-size:.8rem; }
    .mod-row .mod-target-custom { grid-column:1 / span 2; }
    .mod-row .group-wrap { grid-column:1 / -1; display:grid; grid-template-columns: 1fr; gap:8px; align-items:center; }
    .mod-row .group-wrap .muted { grid-column:1 / -1; }
    .roll-list { display:grid; gap:8px; margin-top:6px; }
    .roll-row { display:grid; grid-template-columns: minmax(180px,1.4fr) minmax(140px,0.9fr) minmax(140px,0.9fr) minmax(140px,0.9fr) auto; gap:8px; align-items:center; }
    .roll-row input, .roll-row select { width:100%; min-width:0; }
    .roll-row button { padding:4px 8px; font-size:.8rem; }
    .skill-roll-grid { display:grid; gap:6px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-top:6px; }
    .skill-roll-group { border:1px solid #242424; border-radius:10px; padding:8px; background:#121212; }
    .skill-roll-group strong { font-size:.85rem; }
    .skill-roll-option { display:flex; align-items:center; gap:6px; font-size:.85rem; }

    .status-line { margin-top:10px; font-size:.85rem; opacity:.9; }

    .rich-editor { border:1px solid #333; border-radius:12px; background:#0f0f0f; }
    .rich-toolbar { display:flex; flex-wrap:wrap; gap:6px; padding:6px 8px; border-bottom:1px solid #1f1f1f; }
    .rich-toolbar button { padding:6px 8px; font-size:.9rem; border-radius:8px; border:1px solid #2d2d2d; background:#161616; color:#f3f3f3; cursor:pointer; }
    .rich-toolbar button:hover { background:#1f1f1f; }
    .rich-toolbar button:active { background:#222; }
    .rich-area { min-height:130px; padding:10px; outline:none; }
    .rich-area:empty:before { content: attr(data-placeholder); color:#777; }
    .rich-area table { width:100%; border-collapse:collapse; margin-top:6px; }
    .rich-area th, .rich-area td { border:1px solid #333; padding:6px; }
  </style>
</head>
<body>
  <div class="page"><div class="wrap">

    <div class="topbar">
      <h1>Create Ability / Trait</h1>
      <span id="login-chip" class="muted right"></span>
      <a class="btn" href="abilities_home.html">Back</a>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="panel">
          <h2>Basics</h2>

          <div class="row">
            <label for="ab-name">Name</label>
            <input id="ab-name" class="grow" placeholder="Ex: Blood-Fueled Lunge" />
          </div>

          <div class="row">
            <label for="ab-type">Type</label>
            <select id="ab-type">
              <option value="active">Active</option>
              <option value="passive">Passive</option>
              <option value="mixed">Mixed (Active + Passive)</option>
            </select>
          </div>

      <div class="row">
        <label for="ab-source-cat">Source</label>
        <select id="ab-source-cat" class="grow">
          <option value="Specie">Specie</option>
          <option value="Boon">Boon</option>
          <option value="Talent">Talent</option>
          <option value="Archetype">Archetype</option>
              <option value="Expertise">Expertise</option>
              <option value="Divine Manifestation">Divine Manifestation</option>
              <option value="Awakening">Awakening</option>
              <option value="Apotheosis">Apotheosis</option>
              <option value="Other" selected>Other</option>
            </select>
          </div>

          <div class="row">
        <label for="ab-source-ref">Source Detail</label>
        <input id="ab-source-ref" class="grow" placeholder="Ex: Elf, Boxer, Expert Trackerâ€¦" />
      </div>

      <div id="arc-meta" class="row" style="flex-direction:column; align-items:flex-start; display:none; gap:8px; margin-top:4px;">
        <div class="row" style="width:100%; gap:8px; align-items:center;">
          <label style="min-width:140px;">Archetype Version</label>
          <input id="ab-arc-version" type="number" min="1" value="1" style="width:120px;">
          <label style="min-width:140px;">Original Rank</label>
          <input id="ab-arc-orig-rank" type="number" min="1" max="12" value="1" style="width:120px;">
        </div>
        <div class="row" style="width:100%; gap:8px; align-items:center; flex-wrap:wrap;">
          <label style="min-width:140px;">Replaces Ability</label>
          <div style="display:flex; gap:6px; align-items:center; flex:1; min-width:260px;">
            <input id="ab-arc-repl-search" class="grow" placeholder="Search ability by name...">
            <select id="ab-arc-repl-source" style="min-width:180px;">
              <option value="">Any source</option>
              <option value="Specie">Specie</option>
              <option value="Boon">Boon</option>
              <option value="Talent">Talent</option>
              <option value="Archetype">Archetype</option>
              <option value="Expertise">Expertise</option>
              <option value="Divine Manifestation">Divine Manifestation</option>
              <option value="Awakening">Awakening</option>
              <option value="Apotheosis">Apotheosis</option>
              <option value="Other">Other</option>
            </select>
            <select id="ab-arc-repl" style="flex:1; min-width:200px;">
              <option value="">-- none --</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <label for="ab-tags">Tags</label>
        <input id="ab-tags" class="grow" placeholder="Comma-separated: mobility, damage, supportâ€¦" />
      </div>

          <h3>General Description</h3>
          <div id="ab-description-editor" class="rich-editor">
            <div class="rich-toolbar">
              <button type="button" data-cmd="bold" title="Bold">Bold</button>
              <button type="button" data-cmd="italic" title="Italic">Italic</button>
              <button type="button" data-cmd="underline" title="Underline">Underline</button>
              <button type="button" data-cmd="table" title="Insert 2x2 table">Table</button>
              <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
            </div>
            <div class="rich-area" contenteditable="true" data-placeholder="Lore + global explanation of what this ability does."></div>
          </div>

          <!-- SAVE BUTTON HERE => ALWAYS VISIBLE -->
          <button class="btn" id="btn-save" type="button" style="margin-top:14px;">ðŸ’¾ Save Ability</button>
          <div class="status-line" id="status-line">Ready.</div>
        </div>

        <div class="panel" id="panel-passive">
          <h2>Passive Part <span class="pill">always on</span></h2>
          <h3>Passive Description</h3>
          <div id="passive-desc-editor" class="rich-editor">
            <div class="rich-toolbar">
              <button type="button" data-cmd="bold" title="Bold">Bold</button>
              <button type="button" data-cmd="italic" title="Italic">Italic</button>
              <button type="button" data-cmd="underline" title="Underline">Underline</button>
              <button type="button" data-cmd="table" title="Insert 2x2 table">Table</button>
              <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
            </div>
            <div class="rich-area" contenteditable="true" data-placeholder="Describe the permanent effect (bonuses, resistances, triggers...)."></div>
          </div>

          <h3 style="margin-top:10px;">Modifiers (optional)</h3>
          <div class="muted" style="margin-bottom:4px;">
            These will later be applied to the character sheet. Pick from the dropdown (skills, characteristics, derived resources) or use
            a custom path if you need something special. Groups make options mutually exclusive; max choices only applies to [Choice] targets.
          </div>

          <div class="mod-list" id="mod-list"></div>
          <button class="btn" id="btn-add-mod" type="button">+ Add Modifier</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="panel" id="panel-active">
          <h2>Active Part <span class="pill">needs activation</span></h2>

          <div class="row">
            <label for="act-activation">Activation</label>
            <select id="act-activation" class="grow">
              <option value="Action">Action</option>
              <option value="Free Action">Free Action</option>
              <option value="Special Action">Special Action</option>
              <option value="Ritual">Ritual</option>
            </select>
          </div>

          <div class="subgrid-2">
            <div>
              <label>Range (m / squares)</label>
              <input id="act-range" type="number" min="0" step="1" value="0" />
            </div>
            <div>
              <label>Area of Effect</label>
              <input id="act-aoe" placeholder="single target, cone 6m, line 10m, burst 3mâ€¦" />
            </div>
          </div>

          <h3 style="margin-top:10px;">Costs</h3>
          <div class="cost-grid">
            <div><label>HP</label><input id="cost-hp" type="number" step="1" value="0" /></div>
            <div><label>EN</label><input id="cost-en" type="number" step="1" value="0" /></div>
            <div><label>MP</label><input id="cost-mp" type="number" step="1" value="0" /></div>
            <div><label>FO</label><input id="cost-fo" type="number" step="1" value="0" /></div>
            <div><label>MO</label><input id="cost-mo" type="number" step="1" value="0" /></div>
            <div><label>TX</label><input id="cost-tx" type="number" step="1" value="0" /></div>
            <div><label>Other label</label><input id="cost-other-label" placeholder="Ex: SP, Tension" /></div>
            <div><label>Other value</label><input id="cost-other-value" type="number" step="1" value="0" /></div>
          </div>
          <label class="row" style="gap:6px; margin-top:6px;">
            <input type="checkbox" id="costs-active">
            <span class="muted">Active cost?</span>
          </label>

          <h3 style="margin-top:10px;">Rolls</h3>
          <div class="muted" style="margin-bottom:4px;">
            Add damage, healing, restoration, or custom rolls for this ability. Use ID for nature-based dice.
          </div>
          <div id="roll-list" class="roll-list"></div>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px;">
            <button class="btn" id="btn-add-roll" type="button">+ Add Roll</button>
            <label class="row" style="gap:6px; margin:0;">
              <input type="checkbox" id="roll-skill-required">
              <span class="muted">Requires skill roll</span>
            </label>
          </div>
          <div class="muted" id="roll-skill-note" style="margin-top:6px; display:none;">Allowed skills (choose one or more).</div>
          <div id="roll-skill-options" class="skill-roll-grid" style="display:none;"></div>
        </div>
      </div>
    </div>

  </div></div>

<script>
function getToken(){ return localStorage.getItem('auth_token') || ''; }
function setCookieToken(tok){ if(!tok) return; document.cookie = `token=${tok}; path=/; SameSite=Lax`; }
function authHeaders(){
  const t=getToken(); if(t) setCookieToken(t);
  return t ? {'Authorization':'Bearer '+t, 'X-Auth-Token':t} : {};
}
async function api(path,opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get('content-type') || '';
  const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
  if(!resp.ok || data.status==='error') throw new Error(data.message || ('HTTP '+resp.status));
  return data;
}

function setupRichTextEditor(containerId, placeholder=''){
  const container = document.getElementById(containerId);
  if (!container) throw new Error('Missing rich text container '+containerId);
  const area = container.querySelector('.rich-area');
  if (!area) throw new Error('Missing rich text area in '+containerId);
  if (placeholder) area.setAttribute('data-placeholder', placeholder);

  const sanitizePastedHtml = (html, text) => {
    if (html){
      const doc = new DOMParser().parseFromString(html, 'text/html');
      doc.querySelectorAll('*').forEach(el=>{
        el.removeAttribute('color');
        el.style.color = '';
        if (el.getAttribute('style') === '') el.removeAttribute('style');
      });
      return doc.body.innerHTML;
    }
    if (text != null){
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    return '';
  };
  area.addEventListener('paste', (e)=>{
    const html = e.clipboardData?.getData('text/html');
    const text = e.clipboardData?.getData('text/plain');
    if (html || text){
      e.preventDefault();
      const cleaned = sanitizePastedHtml(html, text);
      if (cleaned) document.execCommand('insertHTML', false, cleaned);
    }
  });

  const normalizeHtml = (html)=>{
    const text = (area.textContent || '').replace(/\u00a0/g, ' ').trim();
    const raw = (html || '').trim();
    if (!text) return '';
    return raw;
  };

  container.querySelectorAll('[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      area.focus();
      const cmd = btn.dataset.cmd;
      if (cmd === 'table'){
        const tbl = '<table class=\"rte-table\"><tbody><tr><td>Cell 1</td><td>Cell 2</td></tr><tr><td>Cell 3</td><td>Cell 4</td></tr></tbody></table>';
        document.execCommand('insertHTML', false, tbl);
      }else{
        document.execCommand(cmd, false, null);
      }
    });
  });

  return {
    el: area,
    getHTML: ()=> normalizeHtml(area.innerHTML),
    setHTML: (html='')=>{ area.innerHTML = html || ''; },
  };
}

const loginChip    = document.getElementById('login-chip');
const statusLine   = document.getElementById('status-line');
const nameEl       = document.getElementById('ab-name');
const typeEl       = document.getElementById('ab-type');
const sourceCatEl  = document.getElementById('ab-source-cat');
const arcMetaEl    = document.getElementById('arc-meta');
const arcVersionEl = document.getElementById('ab-arc-version');
const arcOrigRankEl= document.getElementById('ab-arc-orig-rank');
const arcReplSel   = document.getElementById('ab-arc-repl');
const arcReplSearch= document.getElementById('ab-arc-repl-search');
const arcReplSource= document.getElementById('ab-arc-repl-source');
const sourceRefEl  = document.getElementById('ab-source-ref');
const tagsEl       = document.getElementById('ab-tags');
const descEditor   = setupRichTextEditor('ab-description-editor', 'Lore + global explanation of what this ability does.');

const panelActive  = document.getElementById('panel-active');
const panelPassive = document.getElementById('panel-passive');
const passiveEditor= setupRichTextEditor('passive-desc-editor', 'Describe the permanent effect (bonuses, resistances, triggers...).');
const modListEl    = document.getElementById('mod-list');
const btnAddMod    = document.getElementById('btn-add-mod');

const actActivationEl = document.getElementById('act-activation');
const actRangeEl      = document.getElementById('act-range');
const actAoeEl        = document.getElementById('act-aoe');

const costHpEl    = document.getElementById('cost-hp');
const costEnEl    = document.getElementById('cost-en');
const costMpEl    = document.getElementById('cost-mp');
const costFoEl    = document.getElementById('cost-fo');
const costMoEl    = document.getElementById('cost-mo');
const costTxEl    = document.getElementById('cost-tx');
const costOLabelEl= document.getElementById('cost-other-label');
const costOValEl  = document.getElementById('cost-other-value');
const costsActiveEl = document.getElementById('costs-active');
const rollListEl  = document.getElementById('roll-list');
const btnAddRoll  = document.getElementById('btn-add-roll');
const rollSkillEl = document.getElementById('roll-skill-required');
const rollSkillOptionsEl = document.getElementById('roll-skill-options');
const rollSkillNoteEl = document.getElementById('roll-skill-note');

const btnSave     = document.getElementById('btn-save');

const DEFAULT_NATURES = ['Fire','Water','Earth','Lightning','Wind','Sun','Moon','Ki'];
const DEFAULT_CHARACTERISTICS = ['Reflex','Dexterity','Body','Wisdom','Presence','Magic','Willpower','Tech'];
const ROLL_KINDS = [
  { value:'damage', label:'Damage' },
  { value:'true_damage', label:'True Damage' },
  { value:'heal_hp', label:'HP Heal' },
  { value:'restore_fo', label:'FO Restore' },
  { value:'restore_en', label:'EN Restore' },
  { value:'sp_gain', label:'SP Gain' },
  { value:'custom', label:'Custom' },
];
const DAMAGE_TYPES = ['Neutral','Fire','Water','Earth','Wind','Lightning','Sun','Moon','Ki','Magic'];
const ABILITY_SKILL_GROUPS = [
  { label:'Reflex', skills:['Technicity','Dodge','Counter','Reactivity'] },
  { label:'Dexterity', skills:['Accuracy','Evasion','Stealth','Acrobatics'] },
  { label:'Body', skills:['Brutality','Blocking','Resistance','Athletics'] },
  { label:'Wisdom', skills:['Survival','Education','Perception','Psychology','Investigation'] },
  { label:'Presence', skills:['Taming','Charm','Charisma','Deception','Persuasion'] },
  { label:'Magic', skills:['Aura','Incantation','Enchantment','Restoration','Potential'] },
  { label:'Willpower', skills:['Intimidation','Spirit','Instinct','Absorption'] },
  { label:'Tech', skills:['Crafting','Sleight of hand','Alchemy','Medicine','Engineering'] },
];
const CUSTOM_TARGET_VALUE = '__custom__';
const PASSIVE_TARGET_GROUPS = (()=>{
  const characteristics = [
    { key:'reflex',    label:'Reflex' },
    { key:'dexterity', label:'Dexterity' },
    { key:'body',      label:'Body' },
    { key:'wisdom',    label:'Wisdom' },
    { key:'presence',  label:'Presence' },
    { key:'magic',     label:'Magic' },
    { key:'willpower', label:'Willpower' },
    { key:'tech',      label:'Tech' },
  ];
  const skills = [
    { key:'reflex',    label:'Reflex',    skills:['Technicity','Dodge','Counter','Reactivity'] },
    { key:'dexterity', label:'Dexterity', skills:['Accuracy','Evasion','Stealth','Acrobatics'] },
    { key:'body',      label:'Body',      skills:['Brutality','Blocking','Resistance','Athletics'] },
    { key:'wisdom',    label:'Wisdom',    skills:['Survival','Education','Perception','Psychology','Investigation'] },
    { key:'presence',  label:'Presence',  skills:['Taming','Charm','Charisma','Deception','Persuasion'] },
    { key:'magic',     label:'Magic',     skills:['Aura','Incantation','Enchantment','Restoration','Potential'] },
    { key:'willpower', label:'Willpower', skills:['Intimidation','Spirit','Instinct','Absorption'] },
    { key:'tech',      label:'Tech',      skills:['Crafting','Sleight of hand','Alchemy','Medicine','Engineering'] },
  ];
    const derived = [
      { key:'hp', label:'HP' },
      { key:'en', label:'EN' },
      { key:'fo', label:'FO' },
      { key:'mo', label:'MO' },
      { key:'complex_schools', label:'Complex schools' },
      { key:'spcap', label:'SP cap (10% HP)' },
      { key:'enc', label:'Encumbrance' },
      { key:'et', label:'Eclipse Threshold (ET)' },
      { key:'tx', label:'Max Toxicity (TX)' },
      { key:'weapon_neutral', label:'Neutral weapon damage' },
      { key:'talent_max', label:'Talent Max' },
      { key:'max_expertise', label:'Max Expertise' },
      { key:'max_divine_manifestation', label:'Max Divine Manifestation' },
      { key:'max_awakenings', label:'Max Awakenings' },
      { key:'craftomancy_max', label:'Max Craftomancies' },
      { key:'skill_points', label:'Skill point pool' },
      { key:'stat_points', label:'Characteristic point pool' },
      { key:'sublimation_slots', label:'Sublimation slots' },
    ];
  const skillGroups = characteristics.map(c=>({ value:`choice:skills.by_char.${c.key}`, label:`[Choice] Skills linked to ${c.label}` }));
  const intensityOpts = DEFAULT_NATURES.map(n=>({ value:`intensities.${n}`, label:`Intensity: ${n}` }));
  const schoolByNature = DEFAULT_NATURES.map(n=>({ value:`choice:schools.by_nature.${n}`, label:`[Choice] MS for schools linked to ${n}` }));
  const allSkillNames = Array.from(new Set(skills.flatMap(c=> c.skills || [])));
  const schoolBySkill = allSkillNames.map(s=>({ value:`choice:schools.by_skill.${s}`, label:`[Choice] MS for schools using ${s}` }));
  const magicDmgSpell = DEFAULT_NATURES.map(n=>({ value:`magic_damage.spell.${n}`, label:`Magic Damage on spells/animarma (${n})` }));
  const magicDmgWeapon = DEFAULT_NATURES.map(n=>({ value:`magic_damage.weapon.${n}`, label:`Magic Damage on weapons (${n})` }));
  const choiceOpts = [
    { value:'choice:skill_ms', label:'[Choice] MS by linked skill (any)' },
    { value:'choice:nature_ms', label:'[Choice] MS by linked nature (any)' },
    { value:'choice:char_skill', label:'[Choice] Skill linked to characteristic (any)' },
    { value:'choice:intensity_any', label:'[Choice] Pick one Intensity' },
  ];
  const skillGroupOptions = [...skillGroups, ...choiceOpts];
  const spellSlots = [
    { value:'spell_slots.simple', label:'Simple Spell Slots' },
    { value:'spell_slots.complex', label:'Complex Spell Slots' },
  ];
  return [
    { label:'Characteristics', options: characteristics.map(c=>({ value:`char.${c.key}`, label:`${c.label} (modifier)` })) },
    { label:'Skills', options: skills.flatMap(c=> c.skills.map(s=>({ value:`skills.${c.key}.${s}`, label:`${s} (${c.label})` }))) },
    { label:'Skill Groups (choice)', options: skillGroupOptions },
    { label:'Magic Schools by Nature (choice)', options: schoolByNature },
    { label:'Magic Schools by Skill (choice)', options: [...schoolBySkill, { value:'choice:school_any', label:'[Choice] Pick schools (any)' }] },
    { label:'Intensities', options: intensityOpts },
    { label:'Magic Damage', options: [...magicDmgSpell, ...magicDmgWeapon] },
    { label:'Derived / Resources', options: derived.map(d=>({ value:`derived.${d.key}`, label:d.label })) },
    { label:'Spell Slots', options: spellSlots },
    { label:'Custom', options:[{ value:CUSTOM_TARGET_VALUE, label:'Custom path...' }]},
  ];
})();

let ALL_ABILITIES = [];
let SCHOOLS_CACHE = null;

async function loadSchoolsCached(){
  if (SCHOOLS_CACHE) return SCHOOLS_CACHE;
  try{
    const res = await api('/schools');
    SCHOOLS_CACHE = res.schools || [];
  }catch(e){
    console.warn('[AbilityCreate] Could not fetch schools', e);
    SCHOOLS_CACHE = [];
  }
  return SCHOOLS_CACHE;
}

async function checkMe(){
  try{
    const me = await api('/auth/me');
    loginChip.textContent = me.username + ' (' + me.role + ')';
  }catch(e){
    loginChip.textContent = 'Not logged in.';
  }
}

// modifiers UI
function addModifierRow(initial){
  const row = document.createElement('div');
  row.className = 'mod-row';

  const target = document.createElement('select');
  target.className = 'mod-target';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select target...';
  placeholder.disabled = true;
  target.appendChild(placeholder);

  let matchedPreset = false;
  PASSIVE_TARGET_GROUPS.forEach(group=>{
    const og = document.createElement('optgroup');
    og.label = group.label;
    group.options.forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o.value;
      opt.textContent = o.label;
      if (initial?.target === o.value){ opt.selected = true; matchedPreset = true; }
      og.appendChild(opt);
    });
    target.appendChild(og);
  });
  if (!matchedPreset){
    target.value = initial?.target ? CUSTOM_TARGET_VALUE : '';
  }

  const customTarget = document.createElement('input');
  customTarget.className = 'mod-target-custom';
  customTarget.placeholder = 'Custom path (ex: derived.hp)';
  customTarget.value = matchedPreset ? '' : (initial?.target || '');
  customTarget.style.display = (target.value === CUSTOM_TARGET_VALUE) ? '' : 'none';

  const choiceMax = document.createElement('input');
  choiceMax.className = 'choice-max';
  choiceMax.type = 'number';
  choiceMax.min = '0';
  choiceMax.placeholder = 'Max choices (0 = unlimited)';
  choiceMax.value = initial?.choice?.max_choices ?? 1;
  choiceMax.style.display = 'none';

  const levelRow = document.createElement('div');
  levelRow.style.gridColumn = '1 / -1';
  levelRow.style.display = 'grid';
  levelRow.style.gridTemplateColumns = 'auto 1fr';
  levelRow.style.gap = '8px';
  const levelToggle = document.createElement('input');
  levelToggle.type = 'checkbox';
  levelToggle.className = 'level-toggle';
  levelToggle.id = `lvl-${Math.random().toString(36).slice(2)}`;
  levelToggle.checked = Number(initial?.level_step || 0) > 0;
  const levelLabel = document.createElement('label');
  levelLabel.setAttribute('for', levelToggle.id);
  levelLabel.textContent = 'Scale by level (adds +1 every X levels)';
  const levelStep = document.createElement('input');
  levelStep.type = 'number';
  levelStep.className = 'level-step';
  levelStep.min = '1';
  levelStep.placeholder = 'Levels per +1 (default 10)';
  levelStep.value = Number(initial?.level_step ?? 10);
  levelStep.disabled = !levelToggle.checked;
  const syncLevel = ()=>{
    levelStep.disabled = !levelToggle.checked;
    if (levelToggle.checked && !levelStep.value) levelStep.value = 10;
  };
  levelToggle.addEventListener('change', syncLevel);
  syncLevel();
  levelRow.appendChild(levelToggle);
  const levelWrap = document.createElement('div');
  levelWrap.style.display = 'grid';
  levelWrap.style.gridTemplateColumns = '1fr';
  levelWrap.style.gap = '4px';
  levelWrap.appendChild(levelLabel);
  levelWrap.appendChild(levelStep);
  levelRow.appendChild(levelWrap);

  const mode = document.createElement('select');
  mode.className = 'mod-mode';
  ['add','mul','set'].forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    if ((initial?.mode || 'add') === m) opt.selected = true;
    mode.appendChild(opt);
  });

  const value = document.createElement('input');
  value.className = 'mod-value';
  value.type = 'number';
  value.step = '0.1';
  value.value = initial?.value ?? 0;

  const rm = document.createElement('button');
  rm.type = 'button';
  rm.textContent = 'Remove';
  rm.className = 'btn';
  rm.addEventListener('click', ()=> row.remove());

  const groupWrap = document.createElement('div');
  groupWrap.className = 'group-wrap';
  const groupInput = document.createElement('input');
  groupInput.className = 'mod-group';
  groupInput.placeholder = 'Group (mutually exclusive, optional)';
  groupInput.value = initial?.group || '';
  const groupHint = document.createElement('div');
  groupHint.className = 'muted';
  groupHint.textContent = 'Same group = mutually exclusive (pick one).';
  const syncGroupState = ()=>{
    const hasGroup = !!groupInput.value.trim();
    if (!hasGroup) groupInput.value = '';
  };
  groupInput.addEventListener('input', syncGroupState);
  groupWrap.appendChild(groupInput);
  groupWrap.appendChild(groupHint);

  const appendSchoolsToSelect = (schools)=>{
    if (!Array.isArray(schools) || !schools.length) return;
    const og = document.createElement('optgroup');
    og.label = 'Magic Schools (all)';
    schools.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = `schools.${s.id}`;
      opt.textContent = `${s.name} (${s.school_type||'simple'})`;
      if (initial?.target === opt.value){ opt.selected = true; }
      og.appendChild(opt);
    });
    target.appendChild(og);
  };
  if (SCHOOLS_CACHE && SCHOOLS_CACHE.length) appendSchoolsToSelect(SCHOOLS_CACHE);
  else{
    loadSchoolsCached().then(appendSchoolsToSelect).catch(()=>{});
  }

  const syncChoiceState = ()=>{
    const isChoice = (target.value || '').startsWith('choice:');
    choiceMax.style.display = isChoice ? '' : 'none';
    if (!isChoice) choiceMax.value = 1;
  };
  target.addEventListener('change', ()=>{
    const useCustom = target.value === CUSTOM_TARGET_VALUE;
    customTarget.style.display = useCustom ? '' : 'none';
    if (!useCustom) customTarget.value = '';
    syncChoiceState();
  });
  syncChoiceState();

  row.appendChild(target);
  row.appendChild(mode);
  row.appendChild(value);
  row.appendChild(rm);
  row.appendChild(customTarget);
  row.appendChild(choiceMax);
  row.appendChild(levelRow);
  row.appendChild(groupWrap);
  modListEl.appendChild(row);
}
btnAddMod.addEventListener('click', ()=> addModifierRow());

function renderSkillRollOptions(selected = []){
  if (!rollSkillOptionsEl) return;
  const selectedSet = new Set((selected || []).map(s=> String(s || '').toLowerCase()));
  rollSkillOptionsEl.innerHTML = '';
  ABILITY_SKILL_GROUPS.forEach(group=>{
    const wrap = document.createElement('div');
    wrap.className = 'skill-roll-group';
    const title = document.createElement('strong');
    title.textContent = group.label;
    wrap.appendChild(title);
    (group.skills || []).forEach(skill=>{
      const row = document.createElement('label');
      row.className = 'skill-roll-option';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = skill;
      cb.checked = selectedSet.has(String(skill).toLowerCase());
      row.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = skill;
      row.appendChild(span);
      wrap.appendChild(row);
    });
    rollSkillOptionsEl.appendChild(wrap);
  });
}
function readSkillRollOptions(){
  if (!rollSkillOptionsEl) return [];
  return Array.from(rollSkillOptionsEl.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb=> String(cb.value || '').trim())
    .filter(Boolean);
}
function updateSkillRollVisibility(){
  if (!rollSkillOptionsEl) return;
  const show = !!rollSkillEl?.checked;
  rollSkillOptionsEl.style.display = show ? '' : 'none';
  if (rollSkillNoteEl) rollSkillNoteEl.style.display = show ? '' : 'none';
}
rollSkillEl?.addEventListener('change', updateSkillRollVisibility);
renderSkillRollOptions([]);
updateSkillRollVisibility();

function addRollRow(initial){
  if (!rollListEl) return;
  const row = document.createElement('div');
  row.className = 'roll-row';

  const expr = document.createElement('input');
  expr.className = 'roll-expr';
  expr.placeholder = 'Expression (ex: 2d6 + 4 or 2 ID + 5)';
  expr.value = initial?.expr || initial?.expression || '';

  const kind = document.createElement('select');
  kind.className = 'roll-kind';
  ROLL_KINDS.forEach(opt=>{
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    kind.appendChild(o);
  });
  kind.value = initial?.kind || initial?.reason || 'damage';

  const dmgType = document.createElement('select');
  dmgType.className = 'roll-dmg-type';
  DAMAGE_TYPES.forEach(t=>{
    const o = document.createElement('option');
    o.value = t;
    o.textContent = t;
    dmgType.appendChild(o);
  });
  const initType = (initial?.damage_type || initial?.damageType || '').trim();
  if (initType && DAMAGE_TYPES.some(t=> t.toLowerCase() === initType.toLowerCase())){
    dmgType.value = DAMAGE_TYPES.find(t=> t.toLowerCase() === initType.toLowerCase()) || 'Neutral';
  }else{
    dmgType.value = 'Neutral';
  }

  const label = document.createElement('input');
  label.className = 'roll-label';
  label.placeholder = 'Custom label';
  label.value = initial?.label || initial?.custom_label || '';

  const rm = document.createElement('button');
  rm.className = 'btn small';
  rm.type = 'button';
  rm.textContent = 'X';
  rm.addEventListener('click', ()=> row.remove());

  const syncVisibility = ()=>{
    const k = kind.value;
    const showDmg = k === 'damage';
    const showLabel = k === 'custom';
    dmgType.style.display = showDmg ? '' : 'none';
    label.style.display = showLabel ? '' : 'none';
  };
  kind.addEventListener('change', syncVisibility);
  syncVisibility();

  row.appendChild(expr);
  row.appendChild(kind);
  row.appendChild(dmgType);
  row.appendChild(label);
  row.appendChild(rm);
  rollListEl.appendChild(row);
}
btnAddRoll?.addEventListener('click', ()=> addRollRow());

// show/hide panels
function updateTypeVisibility(){
  const t = typeEl.value;
  panelActive.style.display  = (t === 'active' || t === 'mixed')  ? '' : 'none';
  panelPassive.style.display = (t === 'passive' || t === 'mixed') ? '' : 'none';
}
typeEl.addEventListener('change', updateTypeVisibility);
updateTypeVisibility();

function updateArchetypeMeta(){
  const isArc = (sourceCatEl.value || '').toLowerCase() === 'archetype';
  arcMetaEl.style.display = isArc ? '' : 'none';
}
sourceCatEl.addEventListener('change', updateArchetypeMeta);
updateArchetypeMeta();

async function loadAbilitiesForReplace(){
  try{
    const res = await api('/abilities');
    ALL_ABILITIES = res.abilities || [];
    renderReplaceOptions();
  }catch(e){
    console.error('Failed to load abilities list', e);
  }
}

function renderReplaceOptions(filter="", selected=arcReplSel.value){
  const term = (filter||"").toLowerCase();
  const src = (arcReplSource?.value || "").toLowerCase();
  const base = ALL_ABILITIES.filter(a=>{
    const nameOk = !term || (a.name||"").toLowerCase().includes(term);
    const sourceOk = !src || (a.source_category||"").toLowerCase().includes(src);
    return nameOk && sourceOk;
  });
  const selectedDoc = selected ? ALL_ABILITIES.find(a=>a.id===selected) : null;
  const opts = selectedDoc && !base.some(a=>a.id===selectedDoc.id) ? [selectedDoc, ...base] : base;
  arcReplSel.innerHTML = `<option value="">-- none --</option>` + opts.map(a=>`<option value="${a.id}">${a.name} (${a.id})</option>`).join("");
  arcReplSel.value = selected || "";
}
arcReplSearch.addEventListener('input', ()=>{
  clearTimeout(arcReplSearch._t);
  arcReplSearch._t = setTimeout(()=> renderReplaceOptions(arcReplSearch.value, arcReplSel.value), 200);
});
arcReplSource?.addEventListener('change', ()=> renderReplaceOptions(arcReplSearch.value, arcReplSel.value));

async function buildPayload(){
  const tags = (tagsEl.value || '').split(',')
    .map(t=>t.trim()).filter(Boolean);

  const base = {
    name: nameEl.value || '',
    type: typeEl.value,
    source_category: sourceCatEl.value,
    source_ref: sourceRefEl.value || '',
    tags,
    description: descEditor.getHTML(),
  };

  let active = null;
  if (typeEl.value === 'active' || typeEl.value === 'mixed') {
    const rolls = [];
    for (const row of rollListEl?.querySelectorAll('.roll-row') || []){
      const exprEl = row.querySelector('.roll-expr');
      const kindEl = row.querySelector('.roll-kind');
      const dmgTypeEl = row.querySelector('.roll-dmg-type');
      const labelEl = row.querySelector('.roll-label');
      const expr = (exprEl?.value || '').trim();
      if (!expr) continue;
      const kind = kindEl?.value || 'custom';
      const roll = { expr, kind };
      if (kind === 'damage') roll.damage_type = dmgTypeEl?.value || 'Neutral';
      if (kind === 'true_damage') roll.damage_type = 'True';
      if (kind === 'custom') roll.label = (labelEl?.value || '').trim();
      rolls.push(roll);
    }
    active = {
      activation: actActivationEl.value,
      range: Number(actRangeEl.value || 0),
      aoe: actAoeEl.value || '',
      costs: {
        HP: Number(costHpEl.value || 0),
        EN: Number(costEnEl.value || 0),
        MP: Number(costMpEl.value || 0),
        FO: Number(costFoEl.value || 0),
        MO: Number(costMoEl.value || 0),
        TX: Number(costTxEl.value || 0),
        other_label: costOLabelEl.value || '',
        other_value: Number(costOValEl.value || 0),
      },
      costs_active: !!costsActiveEl?.checked,
      rolls,
      requires_skill_roll: !!rollSkillEl?.checked,
      skill_roll_skills: rollSkillEl?.checked ? readSkillRollOptions() : []
    };
  }

  let passive = null;
  if (typeEl.value === 'passive' || typeEl.value === 'mixed') {
    const mods = [];
    for (const row of modListEl.querySelectorAll('.mod-row')){
      const targetSel = row.querySelector('.mod-target');
      const customTarget = row.querySelector('.mod-target-custom');
      const modeEl   = row.querySelector('.mod-mode');
      const valueEl  = row.querySelector('.mod-value');
      const choiceMaxEl = row.querySelector('.choice-max');
      const groupEl  = row.querySelector('.mod-group');
      const levelToggle = row.querySelector('.level-toggle');
      const levelStepEl = row.querySelector('.level-step');

      const resolvedTarget = targetSel.value === CUSTOM_TARGET_VALUE ? (customTarget.value || '').trim() : targetSel.value.trim();
      const parsedValue = parseFloat(valueEl.value || '0');
      if (!resolvedTarget) continue;
      const modPayload = { target: resolvedTarget, mode: modeEl.value, value: parsedValue, note:'' };
      if (resolvedTarget.startsWith('choice:')){
        const kind = resolvedTarget.replace('choice:','');
        modPayload.choice = { kind, max_choices: Math.max(0, Number(choiceMaxEl?.value || 0)) || 1, choices: [], restrict: [] };
      }
      if (levelToggle?.checked){
        const step = Math.max(1, Number(levelStepEl?.value || 10));
        modPayload.level_step = step;
      }
      const groupName = (groupEl?.value || '').trim();
      if (groupName) modPayload.group = groupName;
      mods.push(modPayload);
    }
    passive = {
      description: passiveEditor.getHTML(),
      modifiers: mods,
    };
  }

  const out = base;
  if (active) out.active = active;
  if (passive) out.passive = passive;
  if ((sourceCatEl.value || '').toLowerCase() === 'archetype'){
    out.archetype_original_rank = Number(arcOrigRankEl.value || 0);
    out.archetype_version = Number(arcVersionEl.value || 1);
    out.archetype_replaces = (arcReplSel.value || '').trim();
  }
  return out;
}

btnSave.addEventListener('click', async ()=>{
  try{
    statusLine.textContent = 'Saving ability...';
    const payload = await buildPayload();
    const res = await api('/abilities', {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload),
    });
    if (res.status === 'pending'){
      statusLine.textContent = 'Submitted for review.';
      return;
    }
    try{
      const check = await api('/abilities/'+encodeURIComponent(res.ability.id));
      const same = JSON.stringify(payload.passive?.modifiers||[]) === JSON.stringify(check.ability?.passive?.modifiers||[]);
      statusLine.textContent = same ? 'Saved as ' + res.ability.id : 'Saved as ' + res.ability.id + ' (server differs)';
    }catch(e){
      console.warn('[AbilityCreate] Could not refetch ability for verification', e);
      statusLine.textContent = 'Saved as ' + res.ability.id + ' (verify console)';
    }
  }catch(err){
    statusLine.textContent = 'Error: ' + err.message;
  }
});

checkMe();
loadAbilitiesForReplace();
</script>
</body>
</html>
