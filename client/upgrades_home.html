<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Upgrades</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { border:1px solid #222; border-radius:12px; padding:12px; background:#0b0b0b; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, select { width:100%; }
    .mod-row{display:grid;grid-template-columns:1fr 0.8fr 0.6fr 1fr auto;gap:6px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>Upgrades (Moderator)</h1>
    <div class="card">
      <div class="row">
        <label class="muted">Kind</label>
        <select id="kind">
          <option value="weapon">Weapon</option>
          <option value="equipment">Equipment</option>
        </select>
        <label class="muted">Slot (equipment)</label>
        <select id="slot">
          <option value="">Any</option>
          <option>head</option>
          <option>arms</option>
          <option>legs</option>
          <option>accessory</option>
          <option>chest</option>
        </select>
        <label class="muted">Name</label>
        <input id="name" placeholder="Name">
        <label class="muted">Description</label>
        <input id="desc" placeholder="Short description">
        <label class="row" style="gap:6px;">
          <input type="checkbox" id="unique"> <span class="muted">Unique</span>
        </label>
        <div class="row" style="width:100%;justify-content:space-between;align-items:center;">
          <strong>Modifiers</strong>
          <button id="mod-add" class="btn small" type="button">+ Modifier</button>
        </div>
        <div id="mod-list" style="width:100%;"></div>
        <button id="create" class="btn">Create / Update</button>
        <span id="status" class="muted"></span>
        <input id="editing" type="hidden" value="">
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <h3>Existing</h3>
        <div class="row">
          <label class="muted">Filter kind</label>
          <select id="filter-kind"><option value="">Any</option><option value="weapon">Weapon</option><option value="equipment">Equipment</option></select>
          <label class="muted">Slot</label>
          <select id="filter-slot"><option value="">Any</option><option>head</option><option>arms</option><option>legs</option><option>accessory</option><option>chest</option></select>
          <button class="btn small" id="refresh">Refresh</button>
        </div>
      </div>
      <div id="list" class="grid"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="inventory_manage.html">← Back</a>
    </div>
  </div>

<script>
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization": "Bearer " + token } : {};
const $ = s => document.querySelector(s);

const MOD_TARGETS = [
  "char.reflex","char.dexterity","char.body","char.wisdom","char.presence","char.magic","char.willpower","char.tech",
  "skills.reflex.Technicity","skills.reflex.Dodge","skills.reflex.Counter","skills.reflex.Reactivity",
  "skills.dexterity.Accuracy","skills.dexterity.Evasion","skills.dexterity.Stealth","skills.dexterity.Acrobatics",
  "skills.body.Brutality","skills.body.Blocking","skills.body.Resistance","skills.body.Athletics",
  "skills.wisdom.Survival","skills.wisdom.Education","skills.wisdom.Perception","skills.wisdom.Psychology","skills.wisdom.Investigation",
  "skills.presence.Taming","skills.presence.Charm","skills.presence.Charisma","skills.presence.Deception","skills.presence.Persuasion",
  "skills.magic.Aura","skills.magic.Incantation","skills.magic.Enchantment","skills.magic.Restoration","skills.magic.Potential",
  "skills.willpower.Intimidation","skills.willpower.Spirit","skills.willpower.Instinct","skills.willpower.Absorption",
  "skills.tech.Crafting","skills.tech.Sleight of hand","skills.tech.Alchemy","skills.tech.Medicine","skills.tech.Engineering",
  "derived.hp","derived.en","derived.fo","derived.mo","derived.spcap","derived.enc","derived.et","derived.tx",
  "__custom__"
];

function modsToString(mods){
  return (mods||[]).map(m=>`${m.target}:${m.mode||"add"}:${m.value||0}`).join(", ");
}

function addModRow(container, initial={}){
  const row=document.createElement("div");
  row.className="mod-row";
  const sel=document.createElement("select");
  MOD_TARGETS.forEach(t=>{
    const o=document.createElement("option");
    o.value=t; o.textContent = t==="__custom__" ? "Custom..." : t;
    if (t === (initial.target||"")) o.selected = true;
    sel.appendChild(o);
  });
  const custom=document.createElement("input");
  custom.placeholder="Custom target";
  custom.value = (!MOD_TARGETS.includes(initial.target) ? (initial.target||"") : "");
  custom.style.display = sel.value === "__custom__" ? "" : "none";
  sel.addEventListener("change", ()=>{
    custom.style.display = sel.value === "__custom__" ? "" : "none";
    if (sel.value !== "__custom__") custom.value = "";
  });
  const mode=document.createElement("select");
  ["add","mul","set"].forEach(m=>{
    const o=document.createElement("option");
    o.value=m; o.textContent=m;
    if ((initial.mode||"add")===m) o.selected=true;
    mode.appendChild(o);
  });
  const val=document.createElement("input");
  val.type="number"; val.step="0.1"; val.value = initial.value ?? 0;
  const note=document.createElement("input");
  note.placeholder="Note"; note.value = initial.note || "";
  const rm=document.createElement("button");
  rm.className="btn btn-secondary small";
  rm.type="button"; rm.textContent="Remove";
  rm.onclick=()=>row.remove();
  row.appendChild(sel); row.appendChild(custom); row.appendChild(mode); row.appendChild(val); row.appendChild(note); row.appendChild(rm);
  container.appendChild(row);
}

function setModifiers(container, mods){
  container.innerHTML = "";
  if (mods && mods.length){ mods.forEach(m=>addModRow(container, m)); }
  else addModRow(container, {});
}
function collectModifiers(container){
  const mods=[];
  container.querySelectorAll(".mod-row").forEach(row=>{
    const sel=row.querySelector("select");
    const custom=row.querySelector("input[placeholder='Custom target']");
    const target = sel.value === "__custom__" ? (custom.value||"").trim() : sel.value;
    if (!target) return;
    const mode = row.querySelectorAll("select")[1]?.value || "add";
    const val = parseFloat(row.querySelector("input[type='number']").value||"0");
    const note = row.querySelector("input[placeholder='Note']").value || "";
    mods.push({ target, mode, value: val, note });
  });
  return mods;
}

async function loadList(){
  const kind = $("#filter-kind").value || "";
  const slot = $("#filter-slot").value || "";
  const qs = [];
  if (kind) qs.push("kind="+encodeURIComponent(kind));
  if (slot) qs.push("slot="+encodeURIComponent(slot));
  const r = await fetch(`/upgrades${qs.length ? "?"+qs.join("&") : ""}`, { headers: authHeaders() });
  const j = await r.json();
  const box = $("#list"); box.innerHTML = "";
  if (j.status !== "success"){ box.textContent = j.message || "Error"; return; }
  (j.upgrades||[]).forEach(u=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div><b>${u.name}</b> (${u.kind}${u.slot ? " · "+u.slot : ""}) ${u.unique ? "· Unique" : ""}</div>
      <div class="muted">${u.description || ""}</div>
      <div class="muted">Mods: ${modsToString(u.modifiers)}</div>
      <div class="row" style="margin-top:6px; gap:6px;">
        <button class="btn small edit">Edit</button>
        <button class="btn btn-secondary small del">Delete</button>
      </div>
    `;
    card.querySelector(".edit").addEventListener("click", ()=>{
      $("#editing").value = u.id;
      $("#kind").value = u.kind;
      $("#slot").value = u.slot || "";
      $("#name").value = u.name;
      $("#unique").checked = !!u.unique;
      $("#desc").value = u.description || "";
      setModifiers(document.getElementById("mod-list"), u.modifiers || []);
      $("#status").textContent = `Editing ${u.id}`;
    });
    card.querySelector(".del").addEventListener("click", async ()=>{
      if (!confirm(`Delete upgrade ${u.name}?`)) return;
      const r2 = await fetch(`/upgrades/${encodeURIComponent(u.id)}`, { method:"DELETE", headers: authHeaders() });
      const j2 = await r2.json();
      if (j2.status !== "success"){ alert(j2.message || "Delete failed"); return; }
      loadList();
    });
    box.appendChild(card);
  });
}

async function saveUpgrade(){
  const body = {
    kind: $("#kind").value,
    slot: $("#slot").value,
    name: $("#name").value,
    description: $("#desc").value,
    unique: $("#unique").checked,
    modifiers: collectModifiers(document.getElementById("mod-list")),
  };
  const editing = $("#editing").value;
  const path = editing ? `/upgrades/${encodeURIComponent(editing)}` : "/upgrades";
  const method = editing ? "PUT" : "POST";
  const r = await fetch(path, {
    method,
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (j.status !== "success"){ $("#status").textContent = j.message || "Save failed"; return; }
  $("#status").textContent = "Saved.";
  $("#editing").value = "";
  loadList();
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("#create").addEventListener("click", saveUpgrade);
  $("#refresh").addEventListener("click", loadList);
  $("#mod-add").addEventListener("click", ()=> addModRow(document.getElementById("mod-list"), {}));
  setModifiers(document.getElementById("mod-list"), []);
  loadList();
});
</script>
</body>
</html>
