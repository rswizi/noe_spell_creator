<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Effects</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .hidden { display:none!important; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #222; }
    .row:last-child { border-bottom:0; }
    .row .meta { opacity:.8; font-size:.95rem; }
    .btn-outline { background:transparent; border:1px solid #444; color:#ddd; padding:4px 8px; border-radius:8px; cursor:pointer; }
    .btn-outline:hover { border-color:#777; color:#fff; }
    .modal { position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000; padding:16px; }
    .modal-card { width:min(720px, 96vw); max-height:90vh; overflow:auto; background:#111; color:#eee; border-radius:16px; padding:20px 22px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .modal-close { float:right; font-size:28px; line-height:1; background:transparent; border:0; color:#aaa; cursor:pointer; }
    .modal-close:hover { color:#fff; }
    label small { opacity:.7; margin-left:8px; }
    input[type="number"] { width:120px; }

    .rich-editor { border:1px solid #333; border-radius:12px; background:#0f0f0f; }
    .rich-toolbar { display:flex; flex-wrap:wrap; gap:6px; padding:6px 8px; border-bottom:1px solid #1f1f1f; }
    .rich-toolbar button { padding:6px 8px; font-size:.9rem; border-radius:8px; border:1px solid #2d2d2d; background:#161616; color:#f3f3f3; cursor:pointer; }
    .rich-toolbar button:hover { background:#1f1f1f; }
    .rich-toolbar button:active { background:#222; }
    .rich-area { min-height:130px; padding:10px; outline:none; }
    .rich-area:empty:before { content: attr(data-placeholder); color:#777; }
    .rich-area table { width:100%; border-collapse:collapse; margin-top:6px; }
    .rich-area th, .rich-area td { border:1px solid #333; padding:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Browse Effects</h1>

    <div class="home-card" style="margin-bottom:18px;">
      <div class="filter-bar">
        <input id="filter-name" type="text" placeholder="Filter by name‚Ä¶" />
        <select id="filter-school">
          <option value="">All Schools</option>
        </select>
        <button id="clear-filters">Reset</button>
      </div>
      <div>
        <button id="btn-dedupe" class="btn btn-secondary">üßπ Delete Duplicates‚Ä¶</button>
      </div>
    </div>

    <div class="home-card">
      <div id="list" class="scrollbox"></div>
    </div>

    <div style="margin-top:16px;">
      <a class="btn btn-secondary" href="home.html">‚Üê Back Home</a>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="edit-title">
      <button class="modal-close" id="edit-close" aria-label="Close">‚úï</button>
      <h2 id="edit-title">Edit Effect</h2>

      <div class="form">
        <label>Name
          <input id="ef-name" type="text" />
        </label>
        <label>Description</label>
        <div id="ef-desc-editor" class="rich-editor" style="margin-bottom:10px;">
          <div class="rich-toolbar">
            <button type="button" data-cmd="bold" title="Bold">Bold</button>
            <button type="button" data-cmd="italic" title="Italic">Italic</button>
            <button type="button" data-cmd="underline" title="Underline">Underline</button>
            <button type="button" data-cmd="table" title="Insert 2x2 table">Table</button>
            <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
          </div>
          <div class="rich-area" contenteditable="true" data-placeholder="Effect description (rich text supported)"></div>
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <label>MP Cost <small>(integer)</small>
            <input id="ef-mp" type="number" step="1" />
          </label>
          <label>EN Cost <small>(integer)</small>
            <input id="ef-en" type="number" step="1" />
          </label>
          <label>School
            <select id="ef-school"></select>
          </label>
        </div>
      </div>

      <div id="edit-status" style="margin-top:10px; color:#ffb84a;"></div>

      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn btn-secondary" id="edit-cancel">Cancel</button>
        <button class="btn" id="edit-save">Save</button>
      </div>
    </div>
  </div>

<div id="dupe-modal" class="modal hidden" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="dupe-title">
    <button class="modal-close" id="dupe-close" aria-label="Close">&times;</button>
    <h2 id="dupe-title">Duplicate Effects</h2>
    <div id="dupe-content" style="max-height:60vh; overflow:auto; margin-top:10px;"></div>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
      <button class="btn btn-secondary" id="dupe-cancel">Cancel</button>
      <button class="btn" id="dupe-confirm">Delete All Duplicates</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "";
const token = localStorage.getItem("auth_token") || "";
const role  = localStorage.getItem("auth_role");

if (!token || (role !== "admin" && role !== "moderator")) {
  alert("Forbidden: moderators/admins only.");
  window.location.href = "home.html";
}

function setupRichTextEditor(containerId, placeholder=''){
  const container = document.getElementById(containerId);
  if (!container) throw new Error('Missing rich text container '+containerId);
  const area = container.querySelector('.rich-area');
  if (!area) throw new Error('Missing rich text area in '+containerId);
  if (placeholder) area.setAttribute('data-placeholder', placeholder);

  const normalizeHtml = (html)=>{
    const text = (area.textContent || '').replace(/\u00a0/g, ' ').trim();
    const raw = (html || '').trim();
    if (!text) return '';
    return raw;
  };

  container.querySelectorAll('[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      area.focus();
      const cmd = btn.dataset.cmd;
      if (cmd === 'table'){
        const tbl = '<table class="rte-table"><tbody><tr><td>Cell 1</td><td>Cell 2</td></tr><tr><td>Cell 3</td><td>Cell 4</td></tr></tbody></table>';
        document.execCommand('insertHTML', false, tbl);
      }else{
        document.execCommand(cmd, false, null);
      }
    });
  });

  return {
    el: area,
    getHTML: ()=> normalizeHtml(area.innerHTML),
    setHTML: (html='')=>{ area.innerHTML = html || ''; },
  };
}

const $ = s => document.querySelector(s);
const listEl = $("#list");
const nameEl = $("#filter-name");
const schoolEl = $("#filter-school");

// edit modal fields
const modal = $("#edit-modal");
const statusEl = $("#edit-status");
const nameInput = $("#ef-name");
const descEditor = setupRichTextEditor('ef-desc-editor', 'Effect description (rich text supported)');
const mpInput = $("#ef-mp");
const enInput = $("#ef-en");
const schoolInput = $("#ef-school");

let schools = [];
let effects = [];
let currentEditId = null;

function authHeaders() {
  return { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
}

function openModal() { modal.classList.remove("hidden"); modal.setAttribute("aria-hidden", "false"); }
function closeModal() { modal.classList.add("hidden"); modal.setAttribute("aria-hidden", "true"); statusEl.textContent=""; currentEditId = null; }

// load schools into filters and modal select
async function loadSchools() {
  const r = await fetch(`${API_BASE}/schools`);
  const j = await r.json();
  schools = j.schools || [];
  // page filter
  for (const s of schools) {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} [${s.id}]`;
    schoolEl.appendChild(opt);
  }
  // modal select
  schoolInput.innerHTML = "";
  for (const s of schools) {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} [${s.id}]`;
    schoolInput.appendChild(opt);
  }
}

function buildQuery() {
  const p = new URLSearchParams();
  const n = nameEl.value.trim();
  const s = schoolEl.value;
  if (n) p.set("name", n);
  if (s) p.set("school", s);
  return p.toString();
}

async function fetchEffects() {
  const q = buildQuery();
  const url = q ? `${API_BASE}/admin/effects?${q}` : `${API_BASE}/admin/effects`;
  const r = await fetch(url, { headers: authHeaders() });
  const j = await r.json();
  if (j.status !== "success") {
    listEl.innerHTML = `<p style="color:#ff4a4a;">${j.message || "Failed to load effects."}</p>`;
    return;
  }
  effects = j.effects || [];
  renderList();
}

function renderList() {
  if (!effects.length) { listEl.innerHTML = "<p>No effects found.</p>"; return; }
  listEl.innerHTML = effects.map(e => {
    const schoolName = e.school_name || e.school || "‚Äî";
    return `
      <div class="row">
        <div style="min-width:0;">
          <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            [${e.id}] ${e.name}
          </div>
          <div class="meta">School: ${schoolName} ¬∑ MP ${e.mp_cost} ¬∑ EN ${e.en_cost}</div>
        </div>
        <div style="display:flex; gap:8px; flex-shrink:0;">
          <button class="btn" onclick="editEffect('${e.id}')">Edit</button>
          <button class="btn btn-secondary" onclick="deleteEffect('${e.id}')">Delete</button>
        </div>
      </div>
    `;
  }).join("");
}

window.editEffect = function(id) {
  const ef = effects.find(x => String(x.id) === String(id));
  if (!ef) return;
  currentEditId = ef.id;
  $("#edit-title").textContent = `Edit Effect [${ef.id}]`;
  nameInput.value = ef.name || "";
  descEditor.setHTML(ef.description || "");
  mpInput.value = Number(ef.mp_cost ?? 0);
  enInput.value = Number(ef.en_cost ?? 0);
  schoolInput.value = ef.school || "";
  openModal();
};

window.deleteEffect = async function(id) {
  if (!confirm(`Delete effect [${id}]? This will update all spells using it.`)) return;
  const r = await fetch(`${API_BASE}/admin/effects/${encodeURIComponent(id)}`, { method:"DELETE", headers: authHeaders() });
  const j = await r.json();
  if (j.status === "success") {
    // Offer patch-note download if provided
    if (j.patch_text) downloadTxt(`patch_effect_${id}.txt`, j.patch_text);
    await fetchEffects();
  } else {
    alert(j.message || "Delete failed.");
  }
};

function downloadTxt(filename, text) {
  const blob = new Blob([text], {type: "text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

$("#edit-save").addEventListener("click", async () => {
  if (!currentEditId) return;
  statusEl.textContent = "Saving and recomputing spells‚Ä¶";
  const payload = {
    name: nameInput.value.trim(),
    description: descEditor.getHTML(),
    mp_cost: Number(mpInput.value),
    en_cost: Number(enInput.value),
    school: schoolInput.value
  };
  const r = await fetch(`${API_BASE}/admin/effects/${encodeURIComponent(currentEditId)}`, {
    method: "PUT",
    headers: authHeaders(),
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  if (j.status === "success") {
    statusEl.textContent = "Saved.";
    closeModal();
    if (j.patch_text) downloadTxt(`patch_effect_${currentEditId}.txt`, j.patch_text);
    await fetchEffects();
  } else {
    statusEl.textContent = j.message || "Save failed.";
  }
});

$("#edit-close").addEventListener("click", closeModal);
$("#edit-cancel").addEventListener("click", closeModal);

document.addEventListener("DOMContentLoaded", async () => {
  await loadSchools();
  await fetchEffects();

  const run = () => fetchEffects();
  $("#clear-filters").addEventListener("click", () => { nameEl.value=""; schoolEl.value=""; fetchEffects(); });
  nameEl.addEventListener("input", run);
  schoolEl.addEventListener("change", run);
});

const authToken = localStorage.getItem("auth_token") || "";
function authHeaders() {
  return authToken ? { "Authorization": `Bearer ${authToken}` } : {};
}

function openDupeModal() {
  const m = document.getElementById("dupe-modal");
  m.classList.remove("hidden");
  m.setAttribute("aria-hidden", "false");
}
function closeDupeModal() {
  const m = document.getElementById("dupe-modal");
  m.classList.add("hidden");
  m.setAttribute("aria-hidden", "true");
  document.getElementById("dupe-content").innerHTML = "";
}

async function previewDuplicates() {
  const res = await fetch(`/admin/effects/duplicates`, { headers: { ...authHeaders() }});
  const j = await res.json();
  const box = document.getElementById("dupe-content");

  if (j.status !== "success") {
    box.innerHTML = `<p style="color:#ff6a6a;">Failed to load duplicates.</p>`;
    return;
  }
  if (!j.groups.length) {
    box.innerHTML = `<p>No duplicate groups found (name + description are identical).</p>`;
    return;
  }

  // Build a simple list
  const html = j.groups.map(g => {
    const desc = (g.description || "").replace(/\s+/g, " ").slice(0, 240);
    const ids  = g.ids.join(", ");
    return `
      <div style="border:1px solid #333;border-radius:8px;padding:10px;margin:8px 0;">
        <div><strong>${g.name}</strong></div>
        <div style="opacity:.8; font-size:.95rem; margin:4px 0;">${desc || "(no description)"}</div>
        <div class="tiny">Count: ${g.count} ‚Äî Keep: <code>${g.keep}</code> ‚Äî Remove: <code>${g.remove.join(", ")}</code></div>
        <div class="tiny">All IDs: ${ids}</div>
      </div>
    `;
  }).join("");

  box.innerHTML = `
    <p>The following groups have identical <em>name</em> and <em>description</em>. For each group the lowest ID will be kept and all others deleted. Any spells referencing the removed IDs will be updated to the kept ID.</p>
    ${html}
  `;
}

async function applyDuplicates() {
  const btn = document.getElementById("dupe-confirm");
  btn.disabled = true;
  try {
    const res = await fetch(`/admin/effects/duplicates`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ apply: true })
    });
    const j = await res.json();
    if (j.status !== "success") throw new Error(j.message || "Failed to dedupe.");
    alert(j.message || `Removed ${j.deleted_effects} duplicates; updated ${j.touched_spells} spells.`);
    closeDupeModal();
    // refresh your effect list here:
    if (typeof loadEffectsTable === "function") loadEffectsTable();
  } catch (e) {
    alert(e.message || "Request failed.");
  } finally {
    btn.disabled = false;
  }
}

// Hooks
document.getElementById("btn-dedupe").addEventListener("click", async () => {
  await previewDuplicates();
  openDupeModal();
});
document.getElementById("dupe-close").addEventListener("click", closeDupeModal);
document.getElementById("dupe-cancel").addEventListener("click", closeDupeModal);
document.getElementById("dupe-confirm").addEventListener("click", applyDuplicates);
document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "dupe-modal") closeDupeModal();
});

</script>
</body>
</html>
