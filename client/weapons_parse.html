<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weapons — Parse (Moderator)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .scroll{max-height:440px;overflow:auto}
    table.table td,table.table th{padding:8px;border-bottom:1px solid #2a2a2a}
    input[type="number"]{width:92px}.muted{opacity:.8}.danger{color:#ff6b6b}
  </style>
</head>
<body>
<div class="container">
  <h1>Parse Weapons</h1>

  <div class="home-card">
    <div class="row">
      <div>
        <label class="small muted">Targeting Skill</label><br/>
        <label><input type="radio" name="skill" value="Technicity" checked> Technicity</label>
        <label><input type="radio" name="skill" value="Brutality"> Brutality</label>
        <label><input type="radio" name="skill" value="Accuracy"> Accuracy</label>
        <label><input type="radio" name="skill" value="Aura"> Aura</label>
      </div>
      <div>
        <label class="small muted">Tags (applied to all)</label><br/>
        <input id="tags" placeholder="Comma-separated tags" />
      </div>
    </div>

    <p class="muted">For each weapon, provide:
      <em>Name</em>, a paragraph of <em>Description</em>, then the headings and values exactly in this order:
      Damage / Range / Hands / Attributes / Price (Jelly) / Enc.</p>

<textarea id="raw" rows="16" placeholder="Chokuto
An ancient sword from the East, with a straight blade sharpened on one side. Simple but effective, it is the legacy of ancient martial traditions.
Damage
2d6+4+M(REF)
Range
1
Hands
1
Attributes
Destruction, Speed
Price (Jelly)
1530
Enc.
5

Rapier
An elegant and elongated sword from the Central Continent, designed for refined duels. Its complex grip provides superior protection, favoring Technicity over strength.
Damage
2d6+4+M(REF)
Range
1
Hands
1
Attributes
Armor Piercing, Speed
Price (Jelly)
1530
Enc.
5"></textarea>

    <div class="row" style="margin-top:8px">
      <label class="muted"><input type="checkbox" id="replace-dup"> Replace duplicates</label>
      <button id="parse" class="btn">Parse</button>
      <button id="clear-db" class="btn btn-secondary">Clear weapon DB</button>
      <button id="clear" class="btn btn-secondary">Clear</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <div id="preview-card" class="home-card" style="display:none;">
    <h3 style="margin:0 0 8px;">Preview &amp; Edit <span class="chip"><span id="count">0</span> row(s)</span></h3>
    <div id="errors" class="danger" style="min-height:1.2em;"></div>
    <div class="scroll">
      <table class="table" style="width:100%;border-collapse:collapse;">
        <thead>
          <tr>
            <th>Name</th><th>Skill</th><th>Damage</th><th>Range</th><th>Hands</th>
            <th>Attributes</th><th>Price</th><th>Enc.</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="save" class="btn">Save to Database</button>
      <button id="reparse" class="btn btn-secondary">Re-parse</button>
    </div>
  </div>

  <a class="btn btn-secondary" href="weapons_home.html" style="margin-top:12px;">← Back</a>
</div>

<script>
const API_BASE = "";
const token = localStorage.getItem("auth_token") || "";
const authHeaders = () => token ? { "Authorization":"Bearer "+token } : {};
let PREVIEW = [];

const H = ["damage","range","hands","attributes","price (jelly)","enc."];

function skill(){ return (document.querySelector('input[name="skill"]:checked')||{}).value || "Technicity"; }
const norm = s => (s||"").trim();
const isHead = s => H.includes(norm(s).toLowerCase());

function parseBlocks(txt){
  const lines = txt.split(/\r?\n/);
  let i = 0, out = [];
  const LABELS = ["damage","range","hands","attributes","price (jelly)","enc."];
  const LABEL_ALIASES = { "effects": "attributes" };

  const norm = s => (s||"").trim();
  const skipBlanks = () => { while (i < lines.length && !norm(lines[i])) i++; };

  const nextIsHeadingsBlock = () => {
    if (i + LABELS.length > lines.length) return false;
    for (let k = 0; k < LABELS.length; k++){
      const raw = norm(lines[i + k]).toLowerCase();
      const key = LABEL_ALIASES[raw] || raw;
      if (key !== LABELS[k]) return false;
    }
    return true;
  };

  const needPair = (label) => {
    skipBlanks();
    const raw = norm(lines[i]).toLowerCase();
    const key = LABEL_ALIASES[raw] || raw;
    if (i >= lines.length || key !== label) {
      throw new Error(`Expected heading "${label}" near line ${i+1}, found "${norm(lines[i]||"")}"`);
    }
    i++; skipBlanks();
    if (i >= lines.length) throw new Error(`Missing value for "${label}"`);
    return norm(lines[i++]);
  };

  const readValuesBlock = () => {
    const vals = {};
    // consume the 6 heading lines
    i += LABELS.length;
    for (const label of LABELS){
      skipBlanks();
      if (i >= lines.length) throw new Error(`Missing value for "${label}"`);
      vals[label] = norm(lines[i++]);
    }
    return vals;
  };

  const splitRow = (line) => {
    if (!line) return [];
    if (line.includes('\t')) return line.split('\t').map(s=>s.trim()).filter(Boolean);
    return line.split(/\s{2,}/).map(s=>s.trim()).filter(Boolean);
  };

  const rowHasAllLabels = (line) => {
    const low = norm(line).toLowerCase();
    return LABELS.every(l=> low.includes(l.replace(/\s+/g,' ')));
  };

  const readRowLayout = () => {
    const headLine = norm(lines[i] || '');
    if (!rowHasAllLabels(headLine)) return null;
    const heads = splitRow(headLine).map(h=> (LABEL_ALIASES[h.toLowerCase()] || h.toLowerCase()));
    const normHeads = heads.map(h=> h.replace(/\s+/g,' '));
    const expect = LABELS.map(h=> h.replace(/\s+/g,' '));
    if (!expect.every(h=> normHeads.includes(h))) return null;
    i++;
    skipBlanks();
    if (i >= lines.length) throw new Error('Missing values row after headings');
    const valsRow = splitRow(norm(lines[i++]));
    if (valsRow.length < LABELS.length) throw new Error('Not enough values in row layout');
    const vals = {};
    LABELS.forEach((label, idx)=>{
      vals[label] = valsRow[idx] ?? '';
    });
    return vals;
  };

  while (i < lines.length){
    // skip blanks before a record
    skipBlanks();
    if (i >= lines.length) break;

    // Name
    const name = norm(lines[i++]);
    if (!name) throw new Error(`Line ${i}: missing weapon name`);

    // Description (until we meet the first "Damage")
    const descLines = [];
    while (i < lines.length && norm(lines[i]).toLowerCase() !== "damage"){
      const s = norm(lines[i++]);
      if (s) descLines.push(s);
    }
    const description = descLines.join(" ");

    // Two supported layouts:
    // A) headings block then 6 values
    // B) heading→value repeated 6 times
    let vals;
    if (nextIsHeadingsBlock()){
      vals = readValuesBlock();
    } else {
      const rowVals = readRowLayout();
      if (rowVals){
        vals = rowVals;
      } else {
        vals = {};
        for (const label of LABELS){
          vals[label] = needPair(label);
        }
      }
    }

    const pr  = Number(vals["price (jelly)"]);
    const enc = Number(vals["enc."]);
    const hands = Number(vals["hands"]);
    if (!Number.isFinite(pr))  throw new Error(`Invalid price for "${name}"`);
    if (!Number.isFinite(enc)) throw new Error(`Invalid enc. for "${name}"`);
    if (!Number.isFinite(hands)) throw new Error(`Invalid hands for "${name}"`);

    const fxRaw = String(vals["attributes"]||"");
    let magazineSize = 0;
    let fx = fxRaw.split(",").map(s=>s.trim()).filter(Boolean);
    fx = fx.filter(f=>{
      const m = f.match(/^magazine\s*\((\d+)\)/i) || f.match(/^magazine\s+(\d+)/i);
      if (m){
        magazineSize = Number(m[1] || 0) || magazineSize;
        return false;
      }
      return !/^magazine$/i.test(f);
    });

    out.push({
      name,
      description,
      damage: String(vals["damage"]||""),
      range: String(vals["range"]||""),
      hands,
      effects: fx,
      magazine_size: magazineSize,
      price: Math.trunc(pr),
      enc
    });
  }
  return out;
}

function renderPreview(list){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = list.map((e,i)=>`
    <tr>
      <td><input value="${e.name.replace(/"/g,'&quot;')}" data-i="${i}" data-k="name" /></td>
      <td>${skill()}</td>
      <td><input value="${e.damage.replace(/"/g,'&quot;')}" data-i="${i}" data-k="damage" /></td>
      <td style="text-align:center;"><input value="${e.range}" data-i="${i}" data-k="range" /></td>
      <td style="text-align:center;"><input type="number" value="${e.hands}" data-i="${i}" data-k="hands" /></td>
      <td><input value="${(e.effects||[]).join(', ').replace(/"/g,'&quot;')}" data-i="${i}" data-k="effects" /></td>
      <td style="text-align:center;"><input type="number" value="${e.price}" data-i="${i}" data-k="price" /></td>
      <td style="text-align:center;"><input type="number" step="0.1" value="${e.enc}" data-i="${i}" data-k="enc" /></td>
    </tr>
  `).join("");
  document.getElementById("count").textContent = String(list.length);
  document.getElementById("preview-card").style.display = "block";
  document.getElementById("errors").textContent = "";
}

document.addEventListener("input",(ev)=>{
  const t = ev.target; if (!t || t.dataset.i===undefined) return;
  const i=+t.dataset.i, k=t.dataset.k, v=t.value;
  if (k==="hands" || k==="price" || k==="enc") PREVIEW[i][k] = Number(v||0);
  else if (k==="effects") PREVIEW[i][k] = v.split(",").map(s=>s.trim()).filter(Boolean);
  else PREVIEW[i][k] = v;
});

document.getElementById("parse").addEventListener("click", ()=>{
  try{ PREVIEW = parseBlocks(document.getElementById("raw").value); renderPreview(PREVIEW); }
  catch(err){
    document.getElementById("preview-card").style.display="block";
    document.getElementById("tbody").innerHTML="";
    document.getElementById("count").textContent="0";
    document.getElementById("errors").textContent=err.message||String(err);
  }
});
document.getElementById("clear").addEventListener("click", ()=>{ document.getElementById("raw").value=""; document.getElementById("preview-card").style.display="none"; PREVIEW=[]; });
document.getElementById("reparse").addEventListener("click", ()=>document.getElementById("parse").click());
document.getElementById("clear-db").addEventListener("click", async ()=>{
  const typed = prompt('Type DELETE_ALL_WEAPONS to clear the weapon database.');
  if ((typed || "").trim() !== "DELETE_ALL_WEAPONS") return;
  try{
    const res = await fetch("/admin/weapons/clear", {
      method:"POST",
      headers:{ "Content-Type":"application/json", ...authHeaders() },
      body: JSON.stringify({ confirm:"DELETE_ALL_WEAPONS" })
    });
    const j = await res.json().catch(()=>({}));
    if (j.status !== "success") throw new Error(j.detail || j.message || "Clear failed.");
    alert(`Cleared weapons: ${j.deleted}`);
  }catch(err){
    document.getElementById("errors").textContent = err.message || String(err);
  }
});

document.getElementById("save").addEventListener("click", async ()=>{
  if (!PREVIEW.length) return;
  try{
    const tags = (document.getElementById("tags").value || "").split(",").map(s=>s.trim()).filter(Boolean);
    const items = PREVIEW.map(x=>({
      name:x.name, description:x.description, damage:x.damage, range:String(x.range),
      hands:Number(x.hands), effects:x.effects, price:Number(x.price), enc:Number(x.enc),
      tags: tags,
      magazine_size: Number(x.magazine_size || 0)
    }));
    const res = await fetch(`/weapons/bulk_create`, {
      method:"POST",
      headers:{ "Content-Type":"application/json", ...authHeaders() },
      body: JSON.stringify({ skill: skill(), items, replace_duplicates: document.getElementById("replace-dup")?.checked })
    });
    const j = await res.json().catch(()=>({}));
    if (j.status!=="success") throw new Error(j.message || j.detail || "Save failed.");
    alert(`Created ${j.created.length} weapon(s) (+ Animarma). Skipped ${j.skipped.length} duplicate(s).`);
    PREVIEW=[]; document.getElementById("preview-card").style.display="none"; document.getElementById("raw").value="";
  }catch(err){ document.getElementById("errors").textContent = err.message||String(err); }
});
</script>
</body>
</html>
