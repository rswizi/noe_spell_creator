<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Campaign</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      color-scheme: dark;
      --ink:#f6f2ea;
      --muted:#b7b2a8;
      --bg:#0b0c10;
      --panel:#161924;
      --border:#2a2f3a;
      --accent:#c9a227;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Source Sans 3","Trebuchet MS",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(201,162,39,0.2), transparent 60%),
        linear-gradient(180deg, var(--bg), #0a0b10 60%, #07080c);
      min-height:100vh;
    }
    .page{max-width:880px;margin:0 auto;padding:30px 16px 70px;}
    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px;}
    .topbar h1{margin:0;font-family:"Cinzel","Times New Roman",serif;font-size:1.9rem;letter-spacing:.06em;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #3a3f49;font-size:.82rem;color:var(--muted);}
    .panel{
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      background:linear-gradient(150deg, rgba(22,25,36,0.96), rgba(10,11,16,0.92));
      display:grid;gap:12px;
    }
    label{font-size:.9rem;color:var(--muted);}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a2f3a;background:#11131d;color:var(--ink);}
    textarea{min-height:140px;resize:vertical;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .btn{
      border-radius:999px;border:1px solid #3a3f49;
      padding:8px 14px;background:#121521;color:var(--ink);
    }
    .btn:hover{border-color:#5c626f;}
    .muted{color:var(--muted);}
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <h1>Create Campaign</h1>
      <span id="login-chip" class="pill">Checking login...</span>
      <a class="btn" href="campaign_manager.html">Back</a>
    </div>

    <div class="panel">
      <div>
        <label for="camp-name">Campaign name</label>
        <input id="camp-name" placeholder="Ashfall Requiem" />
      </div>

      <div>
        <label for="camp-desc">Description</label>
        <textarea id="camp-desc" placeholder="Set the tone, theme, and starting point."></textarea>
      </div>

      <div>
        <label for="camp-avatar">Campaign avatar</label>
        <input id="camp-avatar" type="file" accept="image/png,image/jpeg" />
      </div>

      <div class="row">
        <button class="btn" id="create-btn">Create Campaign</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const nameEl = document.getElementById('camp-name');
    const descEl = document.getElementById('camp-desc');
    const avatarEl = document.getElementById('camp-avatar');

    function authHeaders(){
      const t = localStorage.getItem('auth_token') || '';
      return t ? { Authorization: 'Bearer ' + t, 'X-Auth-Token': t } : {};
    }
    async function api(path,opt={}){
      const headers = Object.assign({}, opt.headers||{}, authHeaders());
      const resp = await fetch(path, { credentials:'include', ...opt, headers });
      const ct = resp.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await resp.json() : { status:'error', message: await resp.text() };
      if (!resp.ok || data.status === 'error') throw new Error(data.message || `HTTP ${resp.status}`);
      return data;
    }
    async function checkMe(){
      try{
        const me = await api('/auth/me');
        document.getElementById('login-chip').textContent = `${me.username} (${me.role})`;
      }catch{
        document.getElementById('login-chip').textContent = 'Not logged in';
      }
    }

    document.getElementById('create-btn').addEventListener('click', async ()=>{
      const name = (nameEl.value || '').trim();
      const description = (descEl.value || '').trim();
      if (!name){ alert('Enter a campaign name'); return; }
      try{
        statusEl.textContent = 'Creating...';
        const res = await api('/campaigns', {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify({ name, description })
        });
        const cid = res.campaign?.id || '';
        const file = avatarEl.files?.[0];
        if (cid && file){
          const fd = new FormData();
          fd.append('file', file);
          await fetch(`/campaigns/${encodeURIComponent(cid)}/avatar`, { method:'POST', headers: authHeaders(), body: fd, credentials:'include' });
        }
        if (cid){
          location.href = `campaign_view.html?cid=${encodeURIComponent(cid)}`;
        }else{
          statusEl.textContent = 'Created, but missing campaign id.';
        }
      }catch(e){
        statusEl.textContent = e.message;
      }
    });

    checkMe();
  </script>
</body>
</html>
