<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign</title>
  <style>
    :root { color-scheme: dark; --bg:#14090c; --bg-2:#0c0b12; --panel:#121219; --border:#252533; --accent:#c53535; --text:#f3f3f5; }
    body { margin:0; font-family:"Segoe UI","Inter",-apple-system,BlinkMacSystemFont,sans-serif; color:var(--text); background:linear-gradient(180deg,#1a0c0f 0%,#0b0b10 100%); }
    .page{min-height:100vh; display:grid; place-items:start center;}
    .wrap{width:100%; max-width:1100px; padding:28px 16px 60px;}
    .topbar{display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap;}
    h1{margin:0; font-size:24px;}
    button, select, input{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#181821; color:var(--text);}
    button:hover{background:#1f1f2a; border-color:#2f2f42;}
    .section{border:1px solid var(--border); border-radius:14px; padding:12px; background:var(--panel); box-shadow:0 8px 24px rgba(0,0,0,0.25); margin-bottom:12px;}
    .grid{display:grid; gap:10px;}
    .folder{border:1px dashed #333; border-radius:12px; padding:10px; min-height:40px;}
    .char-card{display:flex; gap:10px; align-items:center; padding:8px; border:1px solid #252533; border-radius:12px; background:#11111a;}
    .avatar{width:52px; height:52px; border:1px solid #333; border-radius:12px; overflow:hidden; background:#0b0b10; flex-shrink:0; display:grid; place-items:center;}
    .avatar img{width:100%; height:100%; object-fit:cover;}
    .muted{opacity:.8; font-size:.9rem;}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid #2f2f3f; font-size:.82rem;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  </style>
</head>
<body>
  <div class="page"><div class="wrap">
    <div class="topbar">
      <h1 id="title">Campaign</h1>
      <a class="btn" href="campaign_manager.html">Back</a>
      <span id="login-chip" class="muted" style="margin-left:auto;"></span>
      <span id="status" class="muted"></span>
    </div>

    <div class="section">
      <div class="row" style="align-items:flex-end;">
        <div class="grid" style="min-width:220px;">
          <span class="muted">Assign character</span>
          <select id="char-select"></select>
        </div>
        <div class="grid" style="min-width:180px;">
          <span class="muted">Assign to (member)</span>
          <select id="user-select"></select>
        </div>
        <div class="grid" style="min-width:200px;">
          <span class="muted">Folder path</span>
          <input id="folder-input" placeholder="e.g. Party/Tank">
        </div>
        <label class="row muted" style="gap:6px;">
          <input type="checkbox" id="editable-gm"> GM can edit
        </label>
        <button id="assign-btn">Assign</button>
      </div>
    </div>

    <div class="section">
      <div class="muted">Drag characters between folders to move them</div>
      <div class="row" style="margin:8px 0; gap:8px;">
        <input id="add-folder-input" placeholder="New folder path (e.g. Party/Tank)" style="flex:1; min-width:240px;">
        <button id="add-folder-btn">Add folder</button>
      </div>
      <div id="folders" class="grid" style="margin-top:10px;"></div>
    </div>
  </div></div>

<script>
const params = new URLSearchParams(location.search);
const CID = params.get("cid") || "";
const loginChip = document.getElementById("login-chip");
const statusEl = document.getElementById("status");
const titleEl = document.getElementById("title");
const charSelect = document.getElementById("char-select");
const userSelect = document.getElementById("user-select");
const folderInput = document.getElementById("folder-input");
const editableGmEl = document.getElementById("editable-gm");
const foldersEl = document.getElementById("folders");
const addFolderInput = document.getElementById("add-folder-input");
const addFolderBtn = document.getElementById("add-folder-btn");

let CAMPAIGN = null;
let MY_CHARS = [];

function authHeaders(){
  const tok = localStorage.getItem("auth_token") || "";
  return tok ? { "Authorization":"Bearer "+tok, "X-Auth-Token":tok } : {};
}
async function api(path,opt={}){
  const headers = Object.assign({}, opt.headers||{}, authHeaders());
  const resp = await fetch(path, { credentials:'include', ...opt, headers });
  const ct = resp.headers.get("content-type") || "";
  const data = ct.includes("application/json") ? await resp.json() : { status:"error", message: await resp.text() };
  if (!resp.ok || data.status==="error") throw new Error(data.message || `HTTP ${resp.status}`);
  return data;
}

async function loadMe(){
  loginChip.textContent = "Checking...";
  try{
    const me = await api("/auth/me");
    loginChip.textContent = `${me.username} (${me.role})`;
    return me;
  }catch(e){
    loginChip.textContent = "Not logged in";
    throw e;
  }
}

function buildSelects(){
  // characters
  charSelect.innerHTML = "";
  MY_CHARS.forEach(ch=>{
    const o = document.createElement("option");
    o.value = ch.id; o.textContent = ch.name || ch.id;
    charSelect.appendChild(o);
  });
  // members
  userSelect.innerHTML = '<option value=\"\">Unassigned</option>';
  if (CAMPAIGN){
    const all = [CAMPAIGN.owner].concat(CAMPAIGN.members || []);
    all.forEach(u=>{
      const o = document.createElement("option");
      o.value = u; o.textContent = u;
      userSelect.appendChild(o);
    });
  }
}

function folderTreeFromChars(chars){
  const tree = {};
  // include empty folders
  (CAMPAIGN?.folders || []).forEach(f=>{
    const path = (f||"").split("/").filter(Boolean);
    let node = tree;
    path.forEach(p=>{
      node[p] = node[p] || {};
      node = node[p];
    });
    node.__items = node.__items || [];
  });
  chars.forEach(c=>{
    const path = (c.folder || "").split("/").filter(Boolean);
    let node = tree;
    path.forEach(p=>{
      node[p] = node[p] || {};
      node = node[p];
    });
    node.__items = node.__items || [];
    node.__items.push(c);
  });
  return tree;
}

function renderTree(node, prefix=[]){
  const container = document.createElement("div");
  container.className = "folder";
  container.dataset.folder = prefix.join("/");
  container.addEventListener("dragover", e=> e.preventDefault());
  container.addEventListener("drop", async (e)=>{
    e.preventDefault();
    const charId = e.dataTransfer.getData("text/plain");
    await moveChar(charId, prefix.join("/"));
  });
  const title = prefix.length ? prefix.join("/") : "(root)";
  container.innerHTML = `<div class="muted">${title}</div>`;
  const items = (node.__items || []);
  items.forEach(c=>{
    const card = document.createElement("div");
    card.className = "char-card";
    card.draggable = true;
    card.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain", c.character_id); });
    card.innerHTML = `
      <div class="avatar"><img src="/characters/${encodeURIComponent(c.character_id)}/avatar" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9WUZPi8AAAAASUVORK5CYII=';"></div>
      <div class="grow">
        <div><strong>${c.character_id}</strong></div>
        <div class="muted">Assigned: ${c.assigned_to || "Unassigned"} â€¢ ${c.editable_by_gm ? "GM editable" : "View only"}</div>
      </div>
      <button class="btn small req" title="Request edit">Request edit</button>
    `;
    card.querySelector(".req").addEventListener("click", ()=> requestEdit(c.character_id));
    container.appendChild(card);
  });
  Object.keys(node).filter(k=>k!=="__items").forEach(k=>{
    container.appendChild(renderTree(node[k], prefix.concat([k])));
  });
  return container;
}

function renderCampaign(){
  if (!CAMPAIGN) return;
  titleEl.textContent = CAMPAIGN.name;
  foldersEl.innerHTML = "";
  const tree = folderTreeFromChars(CAMPAIGN.characters || []);
  foldersEl.appendChild(renderTree(tree, []));
  buildSelects();
}

async function loadCampaign(){
  const res = await api(`/campaigns/${encodeURIComponent(CID)}`);
  CAMPAIGN = res.campaign;
  renderCampaign();
}

async function loadCharacters(){
  const res = await api('/characters');
  MY_CHARS = res.characters || [];
}

async function assignChar(){
  const character_id = charSelect.value || "";
  if (!character_id){ alert("Select a character"); return; }
  const assigned_to = userSelect.value || "";
  const folder = folderInput.value || "";
  const editable_by_gm = !!editableGmEl.checked;
  statusEl.textContent = "Assigning...";
  await api(`/campaigns/${encodeURIComponent(CID)}/assign_character`, {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ character_id, assigned_to, folder, editable_by_gm })
  });
  await loadCampaign();
  statusEl.textContent = "Assigned.";
}

async function moveChar(charId, folderPath){
  statusEl.textContent = "Moving...";
  await api(`/campaigns/${encodeURIComponent(CID)}/characters/${encodeURIComponent(charId)}`, {
    method:"PATCH",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ folder: folderPath })
  });
  await loadCampaign();
  statusEl.textContent = "Moved.";
}

async function requestEdit(charId){
  statusEl.textContent = "Requesting...";
  await api(`/campaigns/${encodeURIComponent(CID)}/request_edit`, {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ character_id: charId })
  });
  statusEl.textContent = "Request sent.";
}

document.getElementById("assign-btn").addEventListener("click", assignChar);
addFolderBtn.addEventListener("click", async ()=>{
  const f = (addFolderInput.value || "").trim();
  if (!f){ alert("Enter folder path"); return; }
  statusEl.textContent = "Adding folder...";
  try{
    await api(`/campaigns/${encodeURIComponent(CID)}/folders`, {
      method:"PATCH",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ folder: f })
    });
    addFolderInput.value = "";
    await loadCampaign();
    statusEl.textContent = "Folder added.";
  }catch(e){
    statusEl.textContent = e.message;
    alert(e.message);
  }
});

loadMe()
  .then(loadCharacters)
  .then(loadCampaign)
  .catch(e=>{ statusEl.textContent = e.message; });
</script>
</body>
</html>
