<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Archetypes Admin</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0;
      background:radial-gradient(circle at 20% 20%, #18151d 0%, #0b0b0f 45%, #050508 100%);
      color:#f3f3f5;
      font-family: "Segoe UI", system-ui, sans-serif;
      min-height:100vh;
    }
    .page{max-width:1080px;margin:0 auto;padding:24px 16px 60px;}
    h1{margin:0 0 10px;font-size:24px;}
    .muted{opacity:.8;font-size:.95rem;}
    .card{
      border:1px solid #2a2a3a;
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg,#12121a,#0e0e14);
      box-shadow:0 18px 40px rgba(0,0,0,0.45);
      margin-bottom:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .stack{display:flex;flex-direction:column;gap:8px;}
    label{font-size:.92rem;}
    input,select,textarea{
      padding:9px 11px;
      border:1px solid #2a2a3a;
      border-radius:10px;
      background:#181821;
      color:#f3f3f5;
      min-width:0;
    }
    textarea{min-height:70px;resize:vertical;}
    button{
      padding:9px 12px;
      border:1px solid #c53535;
      border-radius:10px;
      background:#c53535;
      color:#fff;
      cursor:pointer;
      transition:.15s ease;
    }
    button.subtle{background:#1c1c24;border-color:#3a3a46;color:#e5e5e8;}
    button:hover{filter:brightness(1.08);}
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid #222;padding:8px;text-align:left;}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #333;background:#14141b;}
    .section-title{margin:0 0 6px;font-size:16px;}
    .two-col{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:900px){ .two-col{grid-template-columns:2fr 1fr;} }
    .rule-row,.rank-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    .rule-row select,.rule-row input{min-width:120px;}
    .rank-row select{min-width:200px; flex:1;}
  </style>
</head>
<body>
  <div class="page">
    <h1>Archetypes (Moderator)</h1>
    <div class="muted" style="margin-bottom:14px;">Build archetypes, wire abilities and versions, and enforce prerequisites (highest/2nd/3rd stat or minimum values). Hybrid sources pull from existing archetypes.</div>

    <div class="row" style="margin-bottom:12px; justify-content:space-between;">
      <div class="row" style="gap:10px; align-items:center;">
        <h1 style="margin:0;">Archetypes (Moderator)</h1>
      </div>
      <a class="subtle" href="abilities_home.html" style="text-decoration:none; padding:8px 12px; border-radius:10px; border:1px solid #3a3a46; background:#1c1c24; color:#e5e5e8;">Back</a>
    </div>
    <div class="two-col">
      <div class="card stack">
        <div class="row">
          <input id="arc-name" placeholder="Name" style="flex:1;">
          <label class="row" style="gap:6px;"><input type="checkbox" id="arc-hybrid"> Hybrid</label>
          <button id="arc-save">Save / Update</button>
          <input type="hidden" id="arc-editing" value="">
        </div>
        <div class="row">
          <textarea id="arc-prereq-text" placeholder="Prerequisite description" style="flex:1;"></textarea>
        </div>
        <div id="sources-block" class="card" style="margin:0;">
          <div class="section-title">Source archetypes (for hybrids)</div>
          <div id="arc-sources" class="row" style="align-items:flex-start;"></div>
        </div>

        <div class="card" style="margin:0;">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div class="section-title">Prerequisite rules</div>
            <button class="subtle" id="pr-add">+ Add rule</button>
          </div>
          <div id="pr-list" class="stack"></div>
        </div>

        <div class="card" style="margin:0;">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div class="section-title">Ranks (12 fixed)</div>
          </div>
          <div class="row" style="margin:6px 0 10px;">
            <label for="arc-ability-tag-filter">Filter abilities by tag</label>
            <input id="arc-ability-tag-filter" placeholder="Comma-separated tags" style="flex:1;">
          </div>
          <div id="rank-list" class="stack"></div>
        </div>
        <div id="arc-status" class="muted"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div>
            <div class="section-title">Existing archetypes</div>
            <div class="muted" style="margin-top:2px;">Select to edit or delete.</div>
          </div>
          <button class="subtle" id="arc-refresh">Refresh</button>
        </div>
        <div id="arc-list" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

<script>
const token = localStorage.getItem('auth_token') || "";
const authHeaders = () => token ? { "Authorization": "Bearer " + token } : {};
const $ = s=>document.querySelector(s);
let ABILITIES = [];
let ARCHETYPES = [];
const abilityTagFilterEl = document.getElementById('arc-ability-tag-filter');

function parseTagFilter(val){
  return String(val || '').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
}
function abilityMatchesTags(a, tags){
  if (!tags.length) return true;
  const abTags = (a?.tags || []).map(t=> String(t || '').toLowerCase()).filter(Boolean);
  return tags.some(t=> abTags.includes(t));
}
function filteredAbilities(){
  const tags = parseTagFilter(abilityTagFilterEl?.value);
  if (!tags.length) return ABILITIES.slice();
  return ABILITIES.filter(a=> abilityMatchesTags(a, tags));
}

function optionLabelAbility(a){
  return `${a.name || 'Ability'} (${a.id})`;
}

function populateAbilitySelect(sel, selectedId=""){
  const base = filteredAbilities();
  const selected = selectedId ? ABILITIES.find(a=> a.id === selectedId) : null;
  const list = selected && !base.some(a=> a.id === selectedId) ? [selected, ...base] : base;
  sel.innerHTML = `<option value="">-- choose ability --</option>` + list.map(a=>`<option value="${a.id}" ${a.id===selectedId?'selected':''}>${optionLabelAbility(a)}</option>`).join("");
}

function populateReplaceSelect(sel, selectedId=""){
  sel.innerHTML = `<option value="">-- none --</option>` + ABILITIES.map(a=>`<option value="${a.id}" ${a.id===selectedId?'selected':''}>${optionLabelAbility(a)}</option>`).join("");
}

function renderSources(){
  const box = $("#arc-sources");
  box.innerHTML = "";
  ARCHETYPES.forEach(a=>{
    const id = `src-${a.id}`;
    const lbl = document.createElement('label');
    lbl.className = "row";
    lbl.style.gap = "6px";
    lbl.innerHTML = `<input type="checkbox" value="${a.id}" id="${id}"> <span>${a.name}</span>`;
    box.appendChild(lbl);
  });
}

function setSelectedSources(ids=[]){
  const set = new Set(ids||[]);
  document.querySelectorAll('#arc-sources input[type="checkbox"]').forEach(cb=>{
    cb.checked = set.has(cb.value);
  });
}

function getSelectedSources(){
  const out = [];
  document.querySelectorAll('#arc-sources input[type="checkbox"]:checked').forEach(cb=> out.push(cb.value));
  return out;
}

function ruleRow(rule={}){
  const div = document.createElement('div');
  div.className = 'rule-row';
  const val = rule.value ?? '';
  const type = rule.type || 'highest';
  const key = rule.key || '';
  div.innerHTML = `
    <select class="pr-attr">
      <option value="">Characteristic</option>
      <option value="reflex">Reflex</option><option value="dexterity">Dexterity</option><option value="body">Body</option>
      <option value="wisdom">Wisdom</option><option value="presence">Presence</option><option value="magic">Magic</option>
      <option value="willpower">Willpower</option><option value="tech">Tech</option>
    </select>
    <select class="pr-type">
      <option value="highest">Highest</option>
      <option value="second">Second highest</option>
      <option value="third">Third highest</option>
      <option value="min">Not lower than</option>
    </select>
    <input class="pr-val" type="number" placeholder="Value" style="width:100px; display:${type==='min'?'block':'none'};" value="${type==='min'?val:''}">
    <button class="subtle pr-del">Remove</button>
  `;
  div.querySelector('.pr-attr').value = key;
  div.querySelector('.pr-type').value = type;
  div.querySelector('.pr-type').addEventListener('change', (e)=>{
    div.querySelector('.pr-val').style.display = e.target.value === 'min' ? 'block' : 'none';
  });
  div.querySelector('.pr-del').addEventListener('click', ()=>div.remove());
  return div;
}

function rankRow(idx, r={}){
  const div = document.createElement('div');
  div.className = 'rank-row';
  div.innerHTML = `
    <div class="pill">Rank ${idx+1}</div>
    <select class="rk-abil" style="flex:1; min-width:220px;"></select>
  `;
  populateAbilitySelect(div.querySelector('.rk-abil'), r.ability_id || "");
  return div;
}

function collectDoc(){
  const ranks=[];
  document.querySelectorAll('#rank-list .rank-row').forEach((row, idx)=>{
    ranks.push({
      rank: idx + 1,
      ability_id: row.querySelector('.rk-abil').value.trim(),
    });
  });
  const charOrder = [];
  const charMin = {};
  document.querySelectorAll('#pr-list .rule-row').forEach(row=>{
    const attr = row.querySelector('.pr-attr').value;
    const typ = row.querySelector('.pr-type').value;
    const val = row.querySelector('.pr-val').value;
    if(!attr) return;
    if(typ === 'min'){
      if(val !== "") charMin[attr] = Number(val);
    }else{
      const pos = typ === 'highest' ? 1 : typ === 'second' ? 2 : 3;
      charOrder.push({key: attr, position: pos});
    }
  });
  return {
    name: $("#arc-name").value.trim(),
    hybrid: $("#arc-hybrid").checked,
    sources: getSelectedSources(),
    prereq_text: $("#arc-prereq-text").value.trim(),
    prereq_rules:{
      char_order: charOrder,
      char_min: charMin
    },
    ranks
  };
}

async function saveArchetype(){
  const body = collectDoc();
  const editing = $("#arc-editing").value;
  const path = editing ? `/archetypes/${encodeURIComponent(editing)}` : "/archetypes";
  const method = editing ? "PUT" : "POST";
  $("#arc-status").textContent = "Saving...";
  const r = await fetch(path, { method, headers:{ "Content-Type":"application/json", ...authHeaders() }, body: JSON.stringify(body)});
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ $("#arc-status").textContent = j.message || "Save failed"; return; }
  $("#arc-status").textContent = "Saved.";
  $("#arc-editing").value = editing || j.archetype?.id || "";
  loadList();
}

function loadToForm(a){
  $("#arc-editing").value = a.id;
  $("#arc-name").value = a.name || "";
  $("#arc-hybrid").checked = !!a.hybrid;
  setSelectedSources(a.sources || []);
  $("#arc-prereq-text").value = a.prereq_text || "";
  const rl = $("#rank-list"); rl.innerHTML = "";
  const ranks = a.ranks || [];
  for (let i=0; i<12; i++){
    rl.appendChild(rankRow(i, ranks[i] || {}));
  }
  const pl = $("#pr-list"); pl.innerHTML = "";
  const rules = [];
  const order = a.prereq_rules?.char_order || [];
  order.forEach(r=> rules.push({key:r.key, type: r.position===2?'second': r.position===3?'third':'highest'}));
  if (!order.length && a.prereq_rules?.mag_highest){
    rules.push({key:"magic", type:"highest"});
  }
  const charMin = a.prereq_rules?.char_min || {};
  Object.keys(charMin).forEach(k=> rules.push({key:k, type:'min', value: charMin[k]}));
  if (!rules.length) rules.push({});
  rules.forEach(r=> pl.appendChild(ruleRow(r)));
}

async function loadList(){
  const box = $("#arc-list"); box.innerHTML = "Loading...";
  const r = await fetch("/archetypes", { headers: authHeaders() });
  const j = await r.json().catch(()=>({}));
  if (j.status !== "success"){ box.textContent = j.message || "Load failed"; return; }
  ARCHETYPES = j.archetypes || [];
  renderSources();
  box.innerHTML = "";
  ARCHETYPES.forEach(a=>{
    const div = document.createElement('div'); div.className='card';
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div><b>${a.name}</b> ${a.hybrid?'<span class="pill">Hybrid</span>':''}</div>
        <div class="row">
          <button class="subtle edit">Edit</button>
          <button class="subtle del">Delete</button>
        </div>
      </div>
      <div class="muted">${a.prereq_text || ''}</div>
      <div class="muted" style="margin-top:4px;">Ranks: ${(a.ranks||[]).length}</div>
    `;
    div.querySelector('.edit').addEventListener('click', ()=> loadToForm(a));
    div.querySelector('.del').addEventListener('click', async ()=>{
      if (!confirm(`Delete archetype ${a.name}?`)) return;
      const r2 = await fetch(`/archetypes/${encodeURIComponent(a.id)}`, { method:"DELETE", headers: authHeaders() });
      const j2 = await r2.json().catch(()=>({}));
      if (j2.status !== "success"){ alert(j2.message || "Delete failed"); return; }
      loadList();
    });
    box.appendChild(div);
  });
}

async function loadAbilities(){
  const resp = await fetch("/abilities", { headers: authHeaders() });
  const j = await resp.json().catch(()=>({}));
  if (j.status !== "success") { console.error("Failed to load abilities", j); return; }
  ABILITIES = j.abilities || [];
  // refresh selects
  document.querySelectorAll('.rk-abil').forEach(sel=> populateAbilitySelect(sel, sel.value));
}

abilityTagFilterEl?.addEventListener('input', ()=>{
  document.querySelectorAll('.rk-abil').forEach(sel=> populateAbilitySelect(sel, sel.value));
});

document.getElementById("arc-save").addEventListener("click", saveArchetype);
document.getElementById("arc-refresh").addEventListener("click", loadList);
document.getElementById("pr-add").addEventListener("click", ()=> document.getElementById("pr-list").appendChild(ruleRow({})));
(()=>{
  const rl = document.getElementById("rank-list");
  rl.innerHTML = "";
  for (let i=0; i<12; i++){ rl.appendChild(rankRow(i, {})); }
})();
document.getElementById("pr-list").appendChild(ruleRow({}));

loadAbilities().then(loadList);
</script>
</body>
</html>
